<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é£æœˆ</title>
  
  <subtitle>æ¸…å¦‚é£ï¼Œæ˜å¦‚æœˆ</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://xwxz.github.io/"/>
  <updated>2019-09-18T12:11:29.113Z</updated>
  <id>http://xwxz.github.io/</id>
  
  <author>
    <name>é£æœˆ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>nginxä¹‹proxy</title>
    <link href="http://xwxz.github.io/uncategorized/"/>
    <id>http://xwxz.github.io/uncategorized/</id>
    <published>2019-09-12T07:22:26.000Z</published>
    <updated>2019-09-18T12:11:29.113Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘é¡¹ç›®ä¸­ä½¿ç”¨åˆ°nginxçš„åå‘ä»£ç†ï¼Œè¿™é‡Œæ•´ç†è®°å½•ä¸€ç•ªã€‚å®˜æ–¹<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank" rel="noopener">æ–‡æ¡£åœ°å€</a>ã€‚</p><h2 id="ä¸ºä½•ä»£ç†"><a href="#ä¸ºä½•ä»£ç†" class="headerlink" title="ä¸ºä½•ä»£ç†"></a>ä¸ºä½•ä»£ç†</h2><p><strong>æ­£å‘ä»£ç†ï¼ˆforward proxyï¼‰</strong>ï¼šæ˜¯ä¸€ä¸ªä½äºå®¢æˆ·ç«¯å’Œç›®æ ‡æœåŠ¡å™¨ä¹‹é—´çš„æœåŠ¡å™¨(ä»£ç†æœåŠ¡å™¨)ï¼Œä¸ºäº†ä»ç›®æ ‡æœåŠ¡å™¨å–å¾—å†…å®¹ï¼Œå®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚å¹¶æŒ‡å®šç›®æ ‡ï¼Œç„¶åä»£ç†æœåŠ¡å™¨å‘ç›®æ ‡æœåŠ¡å™¨è½¬äº¤è¯·æ±‚å¹¶å°†è·å¾—çš„å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>æœ‰æ—¶å€™ï¼Œç”¨æˆ·æƒ³è¦è®¿é—®æŸå›½å¤–ç½‘ç«™ï¼Œè¯¥ç½‘ç«™æ— æ³•åœ¨å›½å†…ç›´æ¥è®¿é—®ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥è®¿é—®åˆ°ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œè¿™ä¸ªä»£ç†æœåŠ¡å™¨å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªå›½å¤–ç½‘ç«™ã€‚è¿™æ ·å‘¢ï¼Œç”¨æˆ·å¯¹è¯¥å›½å¤–ç½‘ç«™çš„è®¿é—®å°±éœ€è¦é€šè¿‡ä»£ç†æœåŠ¡å™¨æ¥è½¬å‘è¯·æ±‚ï¼Œå¹¶ä¸”è¯¥ä»£ç†æœåŠ¡å™¨ä¹Ÿä¼šå°†è¯·æ±‚çš„å“åº”å†è¿”å›ç»™ç”¨æˆ·ã€‚è¿™ä¸ªä¸Šç½‘çš„è¿‡ç¨‹å°±æ˜¯ç”¨åˆ°äº†æ­£å‘ä»£ç†ã€‚</p><a id="more"></a><p><img src="æ­£å‘ä»£ç†.png" alt="æ­£å‘ä»£ç†"></p><p><strong>æ­£å‘ä»£ç†ï¼Œå…¶å®æ˜¯â€ä»£ç†æœåŠ¡å™¨â€ä»£ç†äº†â€å®¢æˆ·ç«¯â€ï¼Œå»å’Œâ€ç›®æ ‡æœåŠ¡å™¨â€è¿›è¡Œäº¤äº’ã€‚</strong></p><p>æ­£å‘ä»£ç†çš„ç”¨é€”ï¼š</p><p>1ï¼‰çªç ´è®¿é—®é™åˆ¶</p><p>2ï¼‰æé«˜è®¿é—®é€Ÿåº¦</p><p>3ï¼‰éšè—å®¢æˆ·ç«¯çœŸå®IP</p><p><strong>åå‘ä»£ç†ï¼ˆreverse proxyï¼‰</strong>ï¼šæ˜¯æŒ‡ä»¥ä»£ç†æœåŠ¡å™¨æ¥æ¥å—internetä¸Šçš„è¿æ¥è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™å†…éƒ¨ç½‘ç»œä¸Šçš„æœåŠ¡å™¨ï¼Œå¹¶å°†ä»æœåŠ¡å™¨ä¸Šå¾—åˆ°çš„ç»“æœè¿”å›ç»™internetä¸Šè¯·æ±‚è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶ä»£ç†æœåŠ¡å™¨å¯¹å¤–å°±è¡¨ç°ä¸ºä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ã€‚é€šè¿‡åå‘ä»£ç†æœåŠ¡å™¨è®¿é—®ç›®æ ‡æœåŠ¡å™¨æ—¶ï¼Œå®¢æˆ·ç«¯æ˜¯ä¸çŸ¥é“çœŸæ­£çš„ç›®æ ‡æœåŠ¡å™¨æ˜¯è°çš„ï¼Œç”šè‡³ä¸çŸ¥é“è‡ªå·±è®¿é—®çš„æ˜¯ä¸€ä¸ªä»£ã€‚</p><p>ç”¨çš„æœ€å¤šçš„å°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œæä¾›webæœåŠ¡çš„æœåŠ¡å™¨ä¸æ­¢ä¸€å°ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªé›†ç¾¤ï¼Œæ­¤æ—¶å°±éœ€è¦ä¸€å°ç»Ÿä¸€å¯¹å¤–çš„ä»£ç†æœåŠ¡å™¨æ¥æ¥æ”¶è½¬å‘ç›¸åº”è¯·æ±‚åˆ°åç«¯çœŸæ­£å¤„ç†è¯·æ±‚çš„webæœåŠ¡å™¨ä¸Šã€‚è¿™ä¸ªä»£ç†æœåŠ¡å™¨ä¸€èˆ¬ä¹Ÿå«è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ã€‚</p><p><img src="åå‘ä»£ç†.png" alt="åå‘ä»£ç†"></p><p><strong>åå‘ä»£ç†ï¼Œå…¶å®æ˜¯â€ä»£ç†æœåŠ¡å™¨â€ä»£ç†äº†â€ç›®æ ‡æœåŠ¡å™¨â€ï¼Œå»å’Œâ€å®¢æˆ·ç«¯â€è¿›è¡Œäº¤äº’ã€‚</strong></p><p>åå‘ä»£ç†ç”¨é€”ï¼š</p><p>1ï¼‰éšè—çœŸå®æœåŠ¡å™¨IPï¼ˆä¸€èˆ¬è´Ÿè½½å‡è¡¡ä¼šæä¾›VIPï¼‰</p><p>2ï¼‰è´Ÿè½½å‡è¡¡ï¼ˆå¹³å‡çœŸå®æœåŠ¡å™¨çš„è´Ÿè½½ï¼‰</p><p>3ï¼‰æé«˜è®¿é—®é€Ÿåº¦ï¼ˆä¸»è¦æ˜¯å¯ä»¥ç¼“å­˜éƒ¨åˆ†çŸ­æ—¶é—´å†…é‡å¤è®¿é—®çš„é™æ€èµ„æºï¼‰</p><p>4ï¼‰æä¾›å®‰å…¨ä¿éšœï¼ˆå¯ä»¥ä½œä¸ºåç«¯æœåŠ¡çš„é˜²ç«å¢™ï¼Œé˜»æŒ¡éƒ¨åˆ†webæ”»å‡»ï¼Œæä¾›è®¿é—®è®¤è¯ç­‰ï¼‰</p><p><strong>æ­£å‘ä»£ç†å’Œåå‘ä»£ç†çš„åŒºåˆ«</strong></p><p>è™½ç„¶æ­£å‘ä»£ç†æœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨æ‰€å¤„çš„ä½ç½®éƒ½æ˜¯å®¢æˆ·ç«¯å’ŒçœŸå®æœåŠ¡å™¨ä¹‹é—´ï¼Œæ‰€åšçš„äº‹æƒ…ä¹Ÿéƒ½æ˜¯æŠŠå®¢æˆ·ç«¯çš„è¯·æ±‚è½¬å‘ç»™æœåŠ¡å™¨ï¼Œå†æŠŠæœåŠ¡å™¨çš„å“åº”è½¬å‘ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯äºŒè€…ä¹‹é—´è¿˜æ˜¯æœ‰ä¸€å®šçš„å·®å¼‚çš„ã€‚</p><p>1ã€æ­£å‘ä»£ç†å…¶å®æ˜¯å®¢æˆ·ç«¯çš„ä»£ç†ï¼Œå¸®åŠ©å®¢æˆ·ç«¯è®¿é—®å…¶æ— æ³•è®¿é—®çš„æœåŠ¡å™¨èµ„æºã€‚åå‘ä»£ç†åˆ™æ˜¯æœåŠ¡å™¨çš„ä»£ç†ï¼Œå¸®åŠ©æœåŠ¡å™¨åšè´Ÿè½½å‡è¡¡ï¼Œå®‰å…¨é˜²æŠ¤ç­‰ã€‚</p><p>2ã€æ­£å‘ä»£ç†ä¸€èˆ¬æ˜¯å®¢æˆ·ç«¯æ¶è®¾çš„ï¼Œæ¯”å¦‚åœ¨è‡ªå·±çš„æœºå™¨ä¸Šå®‰è£…ä¸€ä¸ªä»£ç†è½¯ä»¶ã€‚è€Œåå‘ä»£ç†ä¸€èˆ¬æ˜¯æœåŠ¡å™¨æ¶è®¾çš„ï¼Œæ¯”å¦‚åœ¨è‡ªå·±çš„æœºå™¨é›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ã€‚</p><p>3ã€æ­£å‘ä»£ç†ä¸­ï¼ŒæœåŠ¡å™¨ä¸çŸ¥é“çœŸæ­£çš„å®¢æˆ·ç«¯åˆ°åº•æ˜¯è°ï¼Œä»¥ä¸ºè®¿é—®è‡ªå·±çš„å°±æ˜¯çœŸå®çš„å®¢æˆ·ç«¯ã€‚è€Œåœ¨åå‘ä»£ç†ä¸­ï¼Œå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸæ­£çš„æœåŠ¡å™¨æ˜¯è°ï¼Œä»¥ä¸ºè‡ªå·±è®¿é—®çš„å°±æ˜¯çœŸå®çš„æœåŠ¡å™¨ã€‚</p><p>4ã€æ­£å‘ä»£ç†å’Œåå‘ä»£ç†çš„ä½œç”¨å’Œç›®çš„ä¸åŒã€‚æ­£å‘ä»£ç†ä¸»è¦æ˜¯ç”¨æ¥è§£å†³è®¿é—®é™åˆ¶é—®é¢˜ã€‚è€Œåå‘ä»£ç†åˆ™æ˜¯æä¾›è´Ÿè½½å‡è¡¡ã€å®‰å…¨é˜²æŠ¤ç­‰ä½œç”¨ã€‚äºŒè€…å‡èƒ½æé«˜è®¿é—®é€Ÿåº¦ã€‚</p><h2 id="Nginxåå‘ä»£ç†"><a href="#Nginxåå‘ä»£ç†" class="headerlink" title="Nginxåå‘ä»£ç†"></a>Nginxåå‘ä»£ç†</h2><p>nginxåå‘ä»£ç†ä¸»è¦æ¶‰åŠåˆ°<code>ngx_http_proxy_module</code>ï¼Œå¤§éƒ¨åˆ†æƒ…å†µå¯èƒ½ä¼šå€ŸåŠ©<code>ngx_http_upstream_module</code>æ¨¡å—ã€‚ä»Šå¤©ä¸»è¦è®²è§£è¿™ä¸¤ä¸ªæ¨¡å—ã€‚</p><p><code>ngx_http_proxy_module</code>æ¨¡å—å°†è¯·æ±‚è½¬å‘åˆ°å…¶ä»–æœåŠ¡å™¨ã€‚ä¸¾ä¸ªå®˜æ–¹ğŸŒ°ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span>       http://localhost:8000;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host      <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ngx_http_upstream_module</code>æ¨¡å—ä¸»è¦ç”¨äºå®šä¹‰ä¸€ç»„å¯ç”¨äºå„ç§passæµå‘çš„æœåŠ¡ã€‚ä¸¾ä¸ªå®˜æ–¹ğŸŒ°</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com       weight=<span class="number">5</span>;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com:<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span> unix:/tmp/backend3;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server</span> backup1.example.com:<span class="number">8080</span>   backup;</span><br><span class="line">    <span class="attribute">server</span> backup2.example.com:<span class="number">8080</span>   backup;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é…ç½®æŒ‡ä»¤è¯¦è§£"><a href="#é…ç½®æŒ‡ä»¤è¯¦è§£" class="headerlink" title="é…ç½®æŒ‡ä»¤è¯¦è§£"></a>é…ç½®æŒ‡ä»¤è¯¦è§£</h2><h3 id="proxy-pass"><a href="#proxy-pass" class="headerlink" title="proxy_pass"></a>proxy_pass</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_pass URL;</span><br><span class="line">Default:â€”</span><br><span class="line">Context:location, if in location, limit_except</span><br></pre></td></tr></table></figure><p>æ­¤æŒ‡ä»¤ç”¨äºæŒ‡å®šwebåç«¯æœåŠ¡åœ°å€ï¼Œè®¾ç½®åè®®ã€åœ°å€å’Œå¯é€‰URIï¼Œæ ¼å¼ä¸ºï¼šåè®®(http|https)://+åœ°å€+(/URI)ï¼Œå…¶ä¸­åœ°å€å¯ä»¥ä¸ºåŸŸåã€IPã€IP:PORTã€Unix Domain Socketä»¥åŠserver groupï¼Œä¸¾ä¸ªğŸŒ°ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç¤ºä¾‹1:åŸŸå+ç«¯å£</span></span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:8000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¤ºä¾‹2: Unix Domain Socket,è¿™é‡Œçš„domainéœ€è¦ä»¥ "unix:" å¼€å¤´ï¼Œä»¥ ":" ç»“æŸ</span></span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line"><span class="attribute">proxy_pass</span> http://unix:/tmp/backend.socket:/uri/;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¤ºä¾‹3: åœ°å€ä¸ºserver group</span></span><br><span class="line"><span class="attribute">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com       weight=<span class="number">5</span>;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com:<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span> unix:/tmp/backend3;</span><br><span class="line">    <span class="attribute">server</span> backup1.example.com:<span class="number">8080</span>   backup;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœdomainè¢«è§£æä¸ºå¤šä¸ªåœ°å€ï¼Œè¿™äº›åœ°å€å°†è¢«å¾ªç¯ä½¿ç”¨ï¼Œè¿™å¯ä»¥å®ç°è´Ÿè½½å‡è¡¡äº†ã€‚</p><h4 id="å…³äºURI"><a href="#å…³äºURI" class="headerlink" title="å…³äºURI"></a>å…³äºURI</h4><p>é’ˆå¯¹è®¾ç½®äº†URIçš„æƒ…å†µï¼ŒåŸå§‹è¯·æ±‚çš„URIä¸­åŒ¹é…ä¸Šlocationçš„éƒ¨åˆ†ï¼Œå°†è¢«è®¾ç½®ä¸­çš„URIæ›¿æ¢ï¼Œä¸¾ä¸ªğŸŒ°ï¼šåŸå§‹URLä¸º <code>http://domain/proxy/index.html</code> ä»£ç†è®¾ç½®çš„URIä¸º<code>/aaa/</code>ï¼Œåˆ™åŸURIä¸­çš„<code>/proxy/</code>å°†è¢«æ›¿æ¢ä¸º<code>/aaa/</code>ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŒ¹é…/proxy/ "/proxy/" å°†è¢« "/aaa/"æ›¿æ¢</span></span><br><span class="line"><span class="attribute">location</span> /proxy/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1/aaa/;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># æœ€ç»ˆä»£ç†åˆ°URLï¼šhttp://127.0.0.1/aaa/test.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç›¸å¯¹äºå‰ä¸€ç§ï¼Œæœ€åå°‘ä¸€ä¸ª / ï¼‰</span></span><br><span class="line"><span class="attribute">location</span> /proxy/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1/aaa;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#ä»£ç†åˆ°URLï¼šhttp://127.0.0.1/aaatest.html</span></span><br></pre></td></tr></table></figure><p><strong>æ‰€ä»¥ï¼Œåªè¦è®¾ç½®äº†uriï¼Œåˆ™ä¼šå°†åŒ¹é…ä¸Šçš„éƒ¨åˆ†è¿›è¡Œå­—ç¬¦ä¸²æ›¿æ¢ã€‚</strong></p><p>å¦‚æœåªè®¾ç½®äº†domainï¼Œæ²¡æœ‰è®¾ç½®URIï¼Œåˆ™locationåŒ¹é…åˆ°è¯·æ±‚ä¸­çš„åŸå§‹URIä¼šé™„åŠ åœ¨domainåé¢ï¼Œä½œä¸ºURI</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å‡è®¾ä¸‹é¢å››ç§æƒ…å†µåˆ†åˆ«ç”¨ http://192.168.1.1/proxy/test.html è¿›è¡Œè®¿é—®ã€‚</span></span><br><span class="line"><span class="attribute">location</span> /proxy/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#ä»£ç†åˆ°URLï¼šhttp://127.0.0.1/proxy/test.html</span></span><br></pre></td></tr></table></figure><h3 id="proxy-set-header"><a href="#proxy-set-header" class="headerlink" title="proxy_set_header"></a>proxy_set_header</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_set_header field value;</span><br><span class="line">Default:proxy_set_header Host $proxy_host;</span><br><span class="line"><span class="attribute">proxy_set_header</span> Connection close;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure><p>å…è®¸é‡æ–°å®šä¹‰æˆ–è€…æ·»åŠ å‘å¾€åç«¯æœåŠ¡å™¨çš„è¯·æ±‚å¤´ã€‚å…¶å€¼å¯ä»¥åŒ…å«æ–‡æœ¬ã€å˜é‡æˆ–è€…äºŒè€…çš„ç»„åˆï¼Œå½“ä¸”ä»…å½“å½“å‰é…ç½®çº§åˆ«ä¸­æ²¡æœ‰å®šä¹‰<code>proxy_set_header</code>æŒ‡ä»¤æ—¶ï¼Œä¼šä»ä¸Šé¢çš„çº§åˆ«ç»§æ‰¿é…ç½®ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸¤ä¸ªè¯·æ±‚å¤´ä¼šè¢«é‡æ–°å®šä¹‰ã€‚</p><p>å…³äºproxy_set_headeråŠŸèƒ½å¯ä»¥è®¾ç½®åå‘ä»£ç†åçš„http headerä¸­çš„<code>$host</code>,<code>$http_host</code>,<code>$proxy_host</code>ï¼Œé‚£ä¹ˆè¿™å‡ ä¸ªæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><p>proxy_hostï¼šæ˜¯proxy_passåé¢æŒ‡å®šçš„host</p><p>http_hostå’Œhostï¼šéƒ½æ˜¯åŸå§‹çš„hostå­—æ®µï¼Œæ¯”å¦‚è¯·æ±‚çš„åœ°å€ä¸º<a href="http://www.demo.comï¼Œ" target="_blank" rel="noopener">www.demo.comï¼Œ</a> é‚£ä¹ˆåå‘ä»£ç†ä¹‹åè¿˜æ˜¯<a href="http://www.demo.com" target="_blank" rel="noopener">www.demo.com</a> ï¼Œä½†æ˜¯å¦‚æœå®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„headerä¸­æ²¡æœ‰hostå­—æ®µæ—¶ï¼Œåˆ™é‡‡ç”¨é»˜è®¤çš„ã€‚</p><p>ä¸¾ä¸ªğŸŒ°ï¼š</p><p>å®¢æˆ·ç«¯ï¼ˆè¯·æ±‚webæœåŠ¡ï¼‰  :    192.168.1.1</p><p>nginxä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨:    192.168.1.136</p><p>nginxä½œä¸ºåç«¯webæœåŠ¡å™¨:    192.168.1.137</p><p>å°†å·¦ä¾§åŒ¹é…åˆ°çš„<code>/proxy_path/</code>å¼€å¤´çš„urlå…¨éƒ¨è½¬å‘åˆ°åç«¯æœåŠ¡å™¨192.168.223.137ã€‚</p><p>å°†136ä»£ç†æœåŠ¡å™¨ï¼Œ137åç«¯æœåŠ¡å™¨çš„log_formatä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> main <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" <span class="variable">$http_host</span> <span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" "<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯è®¿é—®<code>http://192.168.1.136:8080/proxy_path/index.html</code></p><h4 id="1-proxy-set-header-Host-host"><a href="#1-proxy-set-header-Host-host" class="headerlink" title="1) proxy_set_header Host $host;"></a>1) proxy_set_header Host $host;</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">192.168.1.136</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="attribute">location</span><span class="regexp"> ^~/proxy_path/</span> &#123;</span><br><span class="line">         <span class="attribute">root</span> <span class="string">"/www/html"</span>;</span><br><span class="line">         <span class="attribute">index</span> index.html;</span><br><span class="line">         <span class="attribute">proxy_pass</span> http://192.168.1.137/;</span><br><span class="line">         <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„Hostå°±æ˜¯å¯¹åº”æ—¥å¿—ä¸­çš„http_hostã€‚</p><p>æŸ¥çœ‹ä»£ç†æœåŠ¡å™¨ã€åç«¯æœåŠ¡å™¨å‡èƒ½åœ¨æ—¥å¿—ä¸­å¯å‘ç°http_hostå‡ä¸º192.168.1.136:8080ã€‚</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192</span><span class="variable">.168</span><span class="variable">.1</span><span class="variable">.1</span> - - [<span class="number">18</span>/Jul/<span class="number">2017</span>:<span class="number">10</span>:<span class="number">21</span>:<span class="number">25</span> +<span class="number">0800</span>] <span class="string">"GET /favicon.ico HTTP/1.1"</span> <span class="number">192</span><span class="variable">.168</span><span class="variable">.1</span><span class="variable">.136</span>:<span class="number">8080</span> <span class="number">404</span> <span class="number">24</span> <span class="string">"http://192.168.1.136:8080/proxy_path/index.html"</span> <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36"</span> <span class="string">"-"</span></span><br></pre></td></tr></table></figure><h4 id="2-proxy-set-header-Host-proxy-host"><a href="#2-proxy-set-header-Host-proxy-host" class="headerlink" title="2) proxy_set_header Host $proxy_host;"></a>2) proxy_set_header Host $proxy_host;</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">192.168.1.136</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span><span class="regexp"> ^~/proxy_path/</span> &#123;</span><br><span class="line">         <span class="attribute">root</span> <span class="string">"/www/html"</span>;</span><br><span class="line">         <span class="attribute">index</span> index.html;</span><br><span class="line">         <span class="attribute">proxy_pass</span> http://192.168.1.137/;</span><br><span class="line">         <span class="attribute">proxy_set_header</span> Host <span class="variable">$proxy_host</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæŸ¥çœ‹136ä»£ç†æœåŠ¡å™¨çš„æ—¥å¿—ï¼š</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192</span><span class="variable">.168</span><span class="variable">.1</span><span class="variable">.1</span> - - [<span class="number">18</span>/Jul/<span class="number">2017</span>:<span class="number">10</span>:<span class="number">30</span>:<span class="number">12</span> +<span class="number">0800</span>] <span class="string">"GET /proxy_path/index.html HTTP/1.1"</span> <span class="number">192</span><span class="variable">.168</span><span class="variable">.1</span><span class="variable">.136</span>:<span class="number">8080</span> <span class="number">304</span> <span class="number">0</span> <span class="string">"-"</span> <span class="string">"Mozilla/5.0(Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36"</span> <span class="string">"-"</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºwindowsæ˜¯136çš„å®¢æˆ·ç«¯ï¼Œè¯·æ±‚çš„hostä¸º192.168.223.136:8080ï¼Œè€Œnginxä»£ç†æœåŠ¡å™¨ä½œä¸º137åç«¯æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œå°†è¯·æ±‚çš„æŠ¥æ–‡é¦–éƒ¨é‡æ–°å°è£…ï¼Œå°†proxy_hostå°è£…ä¸ºè¯·æ±‚çš„hostã€‚</p><p>é‚£ä¹ˆ137ä¸Šé¢æ—¥å¿—è¯·æ±‚çš„hostå°±æ˜¯å…¶è‡ªèº«ï¼Œproxy_hostå°±æ˜¯ä»£ç†æœåŠ¡å™¨è¯·æ±‚çš„hostï¼Œä¹Ÿå°±æ˜¯åç«¯æœåŠ¡å™¨137</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192</span><span class="variable">.168</span><span class="variable">.1</span><span class="variable">.136</span> <span class="string">"192.168.1.1"</span> - - [<span class="number">18</span>/Jul/<span class="number">2017</span>:<span class="number">10</span>:<span class="number">30</span>:<span class="number">12</span> +<span class="number">0800</span>] <span class="string">"GET /index.html HTTP/1.0"</span> <span class="string">"192.168.1.137"</span> <span class="number">304</span> <span class="number">0</span> <span class="string">"-"</span> <span class="string">"Mozilla/5.0(Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36"</span> <span class="string">"192.168.1.1"</span></span><br></pre></td></tr></table></figure><p>åŒç†ï¼Œproxy_portä¹Ÿå³ä¸ºåç«¯æœåŠ¡å™¨137çš„webç«¯å£80ã€‚</p><h4 id="3ï¼‰-X-Real-IP-remote-addr"><a href="#3ï¼‰-X-Real-IP-remote-addr" class="headerlink" title="3ï¼‰ X-Real-IP $remote_addr;"></a>3ï¼‰ X-Real-IP $remote_addr;</h4><p>å°†<code>$remote_addr</code>çš„å€¼æ”¾è¿›å˜é‡X-Real-IPä¸­ï¼Œæ­¤å˜é‡åå¯å˜ï¼Œ<code>$remote_addr</code>çš„å€¼ä¸ºå®¢æˆ·ç«¯çš„ip</p><p>nginxè½¬å‘136æœåŠ¡å™¨æ—¥å¿—æ ¼å¼ä¸ºï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> main <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" <span class="variable">$http_host</span> '</span></span><br><span class="line"><span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line"><span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br></pre></td></tr></table></figure><p>nginxåç«¯137æœåŠ¡å™¨çš„æ—¥å¿—æ ¼å¼ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> main <span class="string">'<span class="variable">$remote_addr</span> "<span class="variable">$http_x_real_ip</span>" - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" "<span class="variable">$http_host</span>" '</span></span><br><span class="line"><span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line"><span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br></pre></td></tr></table></figure><p>ä¸¤è€…åŒºåˆ«åœ¨äº<code>$http_x_real_ip</code>ï¼Œæ·»åŠ äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œé€šè¿‡è®¾ç½®å°†çœŸå®å®¢æˆ·ç«¯IPä¼ é€’åˆ°äº†æœåŠ¡ç«¯ã€‚</p><h4 id="4ï¼‰X-Forwarded-For-ä¸­çš„-remote-addr-VS-proxy-add-x-forwarded-for"><a href="#4ï¼‰X-Forwarded-For-ä¸­çš„-remote-addr-VS-proxy-add-x-forwarded-for" class="headerlink" title="4ï¼‰X-Forwarded-For ä¸­çš„ $remote_addr VS $proxy_add_x_forwarded_for"></a>4ï¼‰X-Forwarded-For ä¸­çš„ <code>$remote_addr</code> VS <code>$proxy_add_x_forwarded_for</code></h4><p><code>$proxy_add_x_forwarded_for</code>å˜é‡åŒ…å«å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¸­çš„â€X-Forwarded-Forâ€ï¼Œä¸<code>$remote_addr</code>ä¸¤éƒ¨åˆ†ï¼Œä»–ä»¬ä¹‹é—´ç”¨é€—å·åˆ†å¼€ã€‚</p><p>ä¸¾ä¸ªğŸŒ°ï¼Œ135ã€136ã€137ä¸‰å°æœºå™¨å‡è®¾ç½®ä¸ºï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"><span class="comment">#æ—¥å¿—æ ¼å¼</span></span><br><span class="line"><span class="attribute">log_format</span> main <span class="string">'<span class="variable">$remote_addr</span> "<span class="variable">$http_x_real_ip</span>" - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" "<span class="variable">$http_host</span>" '</span></span><br><span class="line"><span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line"><span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br></pre></td></tr></table></figure><p>ä»£ç†æƒ…å†µå¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="äºŒçº§ä»£ç†.png" alt="äºŒçº§ä»£ç†"></p><p>135æœºå™¨ä¸Šçœ‹åˆ°çš„æ—¥å¿—ä¸­http_x_forwarded_forä¸ºçœŸå®å®¢æˆ·ç«¯192.168.1.1ï¼Œå› ä¸ºæ­¤æ—¶ä»–çš„â€X-Forwarded-Forâ€éƒ¨åˆ†æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥åªæœ‰<code>$remote_addr</code></p><p>136æœºå™¨ä¸Šçœ‹åˆ°çš„æ—¥å¿—ä¸­http_x_forwarded_forä¸ºâ€192.168.1.1, 192.168.1.135â€</p><p>137æœºå™¨ä¸Šçœ‹åˆ°çš„æ—¥å¿—ä¸­http_x_forwarded_forä¸ºâ€192.168.1.1, 192.168.1.135, 192.168.1.136â€</p><h3 id="proxy-send-timeout"><a href="#proxy-send-timeout" class="headerlink" title="proxy_send_timeout"></a>proxy_send_timeout</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_send_timeout time;</span><br><span class="line">Default:proxy_send_timeout 60s;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure><p>è®¾ç½®ä»£ç†æœåŠ¡å™¨ä¸åç«¯æœåŠ¡å™¨çš„è¯·æ±‚å‘é€è¶…æ—¶æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´åªä¼šåœ¨è¿ç»­çš„ä¸¤æ¬¡å†™æ“ä½œä¸­ç”Ÿæ•ˆï¼Œå¦‚æœåœ¨æ­¤æœŸé—´åç«¯æ²¡æœ‰å†æ¥æ”¶æ•°æ®ï¼Œåˆ™è¿æ¥ä¼šè¢«æ–­å¼€ã€‚</p><h3 id="proxy-read-timeout"><a href="#proxy-read-timeout" class="headerlink" title="proxy_read_timeout"></a>proxy_read_timeout</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_read_timeout time;</span><br><span class="line">Default:proxy_read_timeout 60s;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure><p>å®šä¹‰ä»åç«¯è¯»å–æ•°æ®çš„è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤60s</p><h3 id="proxy-set-body"><a href="#proxy-set-body" class="headerlink" title="proxy_set_body"></a>proxy_set_body</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_set_body value;</span><br><span class="line">Default:â€”</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure><p>å…è®¸é‡æ–°å®šä¹‰è¯·æ±‚ä½“ï¼Œè¿™é‡Œçš„valueå¯ä»¥æ˜¯æ–‡æœ¬ã€å˜é‡ã€æˆ–è€…äºŒè€…çš„ç»„åˆã€‚</p><h3 id="proxy-bind"><a href="#proxy-bind" class="headerlink" title="proxy_bind"></a>proxy_bind</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_bind address [transparent] | off;</span><br><span class="line">Default:â€”</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure><p>æ­¤æŒ‡ä»¤ç”¨äºç»‘å®šä»£ç†åç«¯webæœåŠ¡å™¨æ”¶åˆ°çš„è¯·æ±‚æŠ¥æ–‡é‡Œæºipç«¯å£:</p><p>1ï¼‰å¦‚æœè®¾å®šä¸ºå›ºå®šçš„IPï¼Œé‚£ä¹ˆåç«¯çœŸæ­£çœ‹åˆ°çš„å°±æ˜¯è¿™ä¸ªå›ºå®šçš„IP</p><p>2ï¼‰å¦‚æœå¡«å†™çš„<code>$remote_addr</code>åˆ™çœ‹åˆ°çš„æ˜¯çœŸå®clientçš„IP</p><p>3ï¼‰å¦‚æœè®¾ç½®ä¸ºoffï¼Œåˆ™ç³»ç»Ÿä¼šè‡ªåŠ¨è®¾ç½®æœ¬æœºIPå’ŒéšæœºæŒ‡å®šä¸€ä¸ªç«¯å£</p><p><strong>transparent</strong>ï¼šå‚æ•°çš„ä½œç”¨æ˜¯é€ä¼ å®¢æˆ·ç«¯IPï¼Œä½¿ç”¨æ­¤å‚æ•°ï¼Œåœ¨linuxä¸Šï¼Œåœ¨1.13.1ä»¥ä¸‹ç‰ˆæœ¬éœ€è¦è¶…çº§ç”¨æˆ·æƒé™ã€‚</p><p>å¦‚ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:8000;</span><br><span class="line">    <span class="attribute">proxy_bind</span> <span class="variable">$remote_addr</span> transparent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="proxy-next-upstream"><a href="#proxy-next-upstream" class="headerlink" title="proxy_next_upstream"></a>proxy_next_upstream</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_next_upstream error | timeout | invalid_header | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | http_429 | non_idempotent | off ...;</span><br><span class="line">Default:proxy_next_upstream error timeout;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure><p>æŒ‡å®šåœ¨åç«¯è¿”å›ç›¸åº”æƒ…å†µä¸‹è½¬å‘åˆ°ä¸‹ä¸€å°æœåŠ¡å™¨ã€‚</p><blockquote><p><strong>error</strong>      ï¼š å’Œåç«¯æœåŠ¡å™¨å»ºç«‹è¿æ¥æ—¶ï¼Œæˆ–è€…å‘åç«¯æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œæˆ–è€…ä»åç«¯æœåŠ¡å™¨æ¥æ”¶å“åº”å¤´æ—¶ï¼Œå‡ºç°é”™è¯¯<br><strong>timeout</strong> ï¼šå’Œåç«¯æœåŠ¡å™¨å»ºç«‹è¿æ¥æ—¶ï¼Œæˆ–è€…å‘åç«¯æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œæˆ–è€…ä»åç«¯æœåŠ¡å™¨æ¥æ”¶å“åº”å¤´æ—¶ï¼Œå‡ºç°è¶…æ—¶<br><strong>invalid_header</strong> ï¼š åç«¯æœåŠ¡å™¨è¿”å›ç©ºå“åº”æˆ–è€…éæ³•å“åº”å¤´<br><strong>http_500</strong> ï¼š åç«¯æœåŠ¡å™¨è¿”å›çš„å“åº”çŠ¶æ€ç ä¸º500<br><strong>http_502</strong> ï¼š åç«¯æœåŠ¡å™¨è¿”å›çš„å“åº”çŠ¶æ€ç ä¸º502<br><strong>http_503</strong> ï¼š åç«¯æœåŠ¡å™¨è¿”å›çš„å“åº”çŠ¶æ€ç ä¸º503<br><strong>http_504</strong> ï¼š åç«¯æœåŠ¡å™¨è¿”å›çš„å“åº”çŠ¶æ€ç ä¸º504<br><strong>http_404</strong> ï¼š åç«¯æœåŠ¡å™¨è¿”å›çš„å“åº”çŠ¶æ€ç ä¸º404<br><strong>off</strong>            ï¼š åœæ­¢å°†è¯·æ±‚å‘é€ç»™ä¸‹ä¸€å°åç«¯æœåŠ¡å™¨</p></blockquote><p>ä¸¾ä¸ªğŸŒ°ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_next_upstream</span> http_500 | http_502 | http_503 | http_504 |http_404</span><br></pre></td></tr></table></figure><p>å½“å…¶ä¸­ä¸€å°æœåŠ¡å™¨è¿”å›é”™è¯¯ç 404,500â€¦ç­‰é”™è¯¯æ—¶ï¼Œå¯ä»¥åˆ†é…åˆ°ä¸‹ä¸€å°æœåŠ¡å™¨ç»§ç»­å¤„ç†ï¼Œæé«˜å¹³å°è®¿é—®æˆåŠŸç‡ï¼Œå¤šç”¨äºè´Ÿè½½å‡è¡¡ã€‚</p><p>é’ˆå¯¹æœåŠ¡ç«¯è¿”å›error timeoutæ—¶ï¼Œå¦‚æœé‡‡ç”¨é»˜è®¤è®¾ç½®ï¼Œåˆ™ä¼šç»§ç»­å°†è¯·æ±‚è½¬å‘ç»™ä¸‹ä¸€ä¸ªæœåŠ¡å™¨ç»§ç»­å¤„ç†ã€‚å¦‚æœè¯·æ±‚è®¾è®¡åˆ°å……å€¼ç­‰æƒ…å†µï¼Œæœ‰å¯èƒ½è¢«å……å€¼å¤šæ¬¡ï¼Œæ­¤æ—¶å¯ä»¥å°†proxy_next_upstreamè®¾ç½®ä¸ºoffã€‚<strong>å½“ç„¶åç«¯æœåŠ¡è‡ªå·±åšå¹‚ç­‰å¤„ç†éå¸¸æœ‰å¿…è¦ã€‚</strong></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘é¡¹ç›®ä¸­ä½¿ç”¨åˆ°nginxçš„åå‘ä»£ç†ï¼Œè¿™é‡Œæ•´ç†è®°å½•ä¸€ç•ªã€‚å®˜æ–¹&lt;a href=&quot;http://nginx.org/en/docs/http/ngx_http_proxy_module.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;æ–‡æ¡£åœ°å€&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä¸ºä½•ä»£ç†&quot;&gt;&lt;a href=&quot;#ä¸ºä½•ä»£ç†&quot; class=&quot;headerlink&quot; title=&quot;ä¸ºä½•ä»£ç†&quot;&gt;&lt;/a&gt;ä¸ºä½•ä»£ç†&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;æ­£å‘ä»£ç†ï¼ˆforward proxyï¼‰&lt;/strong&gt;ï¼šæ˜¯ä¸€ä¸ªä½äºå®¢æˆ·ç«¯å’Œç›®æ ‡æœåŠ¡å™¨ä¹‹é—´çš„æœåŠ¡å™¨(ä»£ç†æœåŠ¡å™¨)ï¼Œä¸ºäº†ä»ç›®æ ‡æœåŠ¡å™¨å–å¾—å†…å®¹ï¼Œå®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚å¹¶æŒ‡å®šç›®æ ‡ï¼Œç„¶åä»£ç†æœåŠ¡å™¨å‘ç›®æ ‡æœåŠ¡å™¨è½¬äº¤è¯·æ±‚å¹¶å°†è·å¾—çš„å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ã€‚&lt;/p&gt;
&lt;p&gt;æœ‰æ—¶å€™ï¼Œç”¨æˆ·æƒ³è¦è®¿é—®æŸå›½å¤–ç½‘ç«™ï¼Œè¯¥ç½‘ç«™æ— æ³•åœ¨å›½å†…ç›´æ¥è®¿é—®ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥è®¿é—®åˆ°ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œè¿™ä¸ªä»£ç†æœåŠ¡å™¨å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªå›½å¤–ç½‘ç«™ã€‚è¿™æ ·å‘¢ï¼Œç”¨æˆ·å¯¹è¯¥å›½å¤–ç½‘ç«™çš„è®¿é—®å°±éœ€è¦é€šè¿‡ä»£ç†æœåŠ¡å™¨æ¥è½¬å‘è¯·æ±‚ï¼Œå¹¶ä¸”è¯¥ä»£ç†æœåŠ¡å™¨ä¹Ÿä¼šå°†è¯·æ±‚çš„å“åº”å†è¿”å›ç»™ç”¨æˆ·ã€‚è¿™ä¸ªä¸Šç½‘çš„è¿‡ç¨‹å°±æ˜¯ç”¨åˆ°äº†æ­£å‘ä»£ç†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="nginx" scheme="http://xwxz.github.io/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>fpmæºç ä¹‹é…ç½®è§£æ</title>
    <link href="http://xwxz.github.io/php-fpm-02/"/>
    <id>http://xwxz.github.io/php-fpm-02/</id>
    <published>2018-09-06T09:51:43.000Z</published>
    <updated>2019-03-05T08:47:14.621Z</updated>
    
    <content type="html"><![CDATA[<p>â€‹    æ˜¯ä¸æ˜¯ç»å¸¸åœ¨ç½‘ä¸Šçœ‹åˆ°php-fpm.confçš„å„ç§é…ç½®é¡¹ï¼Ÿä»€ä¹ˆpm.max_childrenã€pm.min_spare_serversã€pm.status_pathã€listenç­‰ç­‰ã€‚ä»–ä»¬åˆ°åº•ä»£è¡¨ä»€ä¹ˆæ„æ€å­˜æ”¾åœ¨é‚£ä¸ªæ–‡ä»¶é‡Œå‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥ä¸€æ¢ç©¶ç«Ÿã€‚</p><a id="more"></a><p>åœ¨fpmæºç åˆæ¢æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†æºç ç›®å½•ã€‚å…¶ä¸­æåˆ°ä¸¤ä¸ªæ–‡ä»¶ï¼š<code>php-fpm.conf.in</code> å’Œ<code>www.conf.in</code>,è¿™ä¸¤ä¸ªæ–‡ä»¶åœ¨å®‰è£…å®Œphp-fpmä¹‹åå¯¹åº”çš„æ˜¯<code>php-fpm.conf</code>å’Œ<code></code>php-fpm.d/<a href="http://www.conf`ä¸¤ä¸ªæ–‡ä»¶ã€‚æˆ‘ä»¬å…·ä½“æ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªæ–‡ä»¶é‡Œé¢çš„é…ç½®æŒ‡ä»¤ã€‚" target="_blank" rel="noopener">www.conf`ä¸¤ä¸ªæ–‡ä»¶ã€‚æˆ‘ä»¬å…·ä½“æ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªæ–‡ä»¶é‡Œé¢çš„é…ç½®æŒ‡ä»¤ã€‚</a></p><h3 id="php-fpm-conf"><a href="#php-fpm-conf" class="headerlink" title="php-fpm.conf"></a>php-fpm.conf</h3><p>â€‹    å­˜æ”¾php-fpmå…¨å±€é…ç½®</p><h4 id="pidï¼š"><a href="#pidï¼š" class="headerlink" title="pidï¼š"></a>pidï¼š</h4><p>â€‹    æ­¤æŒ‡ä»¤ç”¨äºé…ç½®php-fpmè¿è¡Œæ—¶ä¸»è¿›ç¨‹çš„pidå­˜æ”¾ä½ç½®ï¼Œé»˜è®¤åœ¨å®‰è£…ç›®å½•çš„var/runç›®å½•ä¸‹ã€‚</p><h4 id="error-log"><a href="#error-log" class="headerlink" title="error_log:"></a>error_log:</h4><p>â€‹    è®¾ç½®fpmæ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœè®¾ç½®ä¸ºsyslogï¼Œåˆ™ä¸ä¼šå†™æœ¬åœ°æ—¥å¿—æ–‡ä»¶ï¼Œä¼šç›´æ¥å‘é€ç»™syslogdã€‚</p><h4 id="syslog-facility"><a href="#syslog-facility" class="headerlink" title="syslog.facility:"></a>syslog.facility:</h4><p>â€‹    è®¾ç½®æ—¥å¿—ç¨‹åºçš„æ‰§è¡Œæ–¹å¼ï¼Œé»˜è®¤daemonï¼Œå¸¸é©»åå°ç±»å‹ã€‚</p><h4 id="syslog-identï¼š"><a href="#syslog-identï¼š" class="headerlink" title="syslog.identï¼š"></a>syslog.identï¼š</h4><p>â€‹    fpmæ—¥å¿—æ–‡ä»¶å‰ç¼€ï¼Œå¦‚æœæœ‰å¤šä¸ªfpmè¿è¡Œï¼Œå¯ä»¥ä¸ºæ¯ä¸€ä¸ªå•ç‹¬è®¾ç½®å‰ç¼€ï¼Œé»˜è®¤php-fpm</p><h4 id="log-levelï¼š"><a href="#log-levelï¼š" class="headerlink" title="log_levelï¼š"></a>log_levelï¼š</h4><p>â€‹    fpmæ—¥å¿—çº§åˆ«ï¼Œé»˜è®¤noticeï¼Œå¯é€‰å€¼ï¼šalert, error, warning, notice, debug</p><h4 id="emergency-restart-thresholdå’Œemergency-restart-interval"><a href="#emergency-restart-thresholdå’Œemergency-restart-interval" class="headerlink" title="emergency_restart_thresholdå’Œemergency_restart_interval"></a>emergency_restart_thresholdå’Œemergency_restart_interval</h4><p>â€‹    è¡¨ç¤ºåœ¨emergency_restart_intervalæ‰€è®¾å€¼å†…å‡ºç°SIGSEGVæˆ–è€…SIGBUSé”™è¯¯çš„php-cgiè¿›ç¨‹æ•°å¦‚æœè¶…è¿‡emergency_restart_thresholdä¸ªphp-fpmå°±ä¼šä¼˜é›…é‡å¯ã€‚è¿™ä¸¤ä¸ªé€‰é¡¹ä¸€èˆ¬ä¿æŒé»˜è®¤å€¼ã€‚</p><p>â€‹    <strong>SIGBUS(Bus error)</strong>æ„å‘³ç€æŒ‡é’ˆæ‰€å¯¹åº”çš„åœ°å€æ˜¯æœ‰æ•ˆåœ°å€ï¼Œä½†æ€»çº¿ä¸èƒ½æ­£å¸¸ä½¿ç”¨è¯¥æŒ‡é’ˆã€‚é€šå¸¸æ˜¯æœªå¯¹é½çš„æ•°æ®è®¿é—®æ‰€è‡´ã€‚</p><p>â€‹    <strong>SIGSEGV(Segment fault)</strong>æ„å‘³ç€æŒ‡é’ˆæ‰€å¯¹åº”çš„åœ°å€æ˜¯æ— æ•ˆåœ°å€ï¼Œæ²¡æœ‰ç‰©ç†å†…å­˜å¯¹åº”è¯¥åœ°å€ã€‚</p><h4 id="process-control-timeout"><a href="#process-control-timeout" class="headerlink" title="process_control_timeout"></a>process_control_timeout</h4><p>â€‹    è®¾ç½®å­è¿›ç¨‹æ¥å—ä¸»è¿›ç¨‹å¤ç”¨ä¿¡å·çš„è¶…æ—¶æ—¶é—´. å¯ç”¨å•ä½: s(ç§’), m(åˆ†), h(å°æ—¶), æˆ–è€… d(å¤©) é»˜è®¤å•ä½: s(ç§’). é»˜è®¤å€¼: 0ã€‚</p><h4 id="process-max"><a href="#process-max" class="headerlink" title="process.max"></a>process.max</h4><p>â€‹    fpmèƒ½å¤Ÿforkçš„æœ€å¤§è¿›ç¨‹æ•°ï¼Œå¦‚æœè®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰é™åˆ¶ã€‚ä¸»è¦ä¸ºfpmçš„dynamicæ¨¡å¼é‡Œpoolè®¾ç½®ã€‚</p><h4 id="process-priority"><a href="#process-priority" class="headerlink" title="process.priority"></a>process.priority</h4><p>â€‹    åœ¨ä½¿ç”¨rootè´¦æˆ·å¯åŠ¨fpm masterè¿›ç¨‹æ—¶ï¼Œè®¾ç½®masterè¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚ä¼˜å…ˆçº§ä»-19ï½20ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="comment">; FPM Configuration ;</span></span><br><span class="line"><span class="comment">;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; All relative paths in this configuration file are relative to PHP's install</span></span><br><span class="line"><span class="comment">; prefix (@prefix@). This prefix can be dynamically changed by using the</span></span><br><span class="line"><span class="comment">; '-p' argument from the command line.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;;;;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="comment">; Global Options ;</span></span><br><span class="line"><span class="comment">;;;;;;;;;;;;;;;;;;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="comment">; Pid file</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> the default prefix is @EXPANDED_LOCALSTATEDIR@</span></span><br><span class="line"><span class="comment">; Default Value: none</span></span><br><span class="line"><span class="comment">;pid = run/php-fpm.pid</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Error log file</span></span><br><span class="line"><span class="comment">; If it's set to "syslog", log is sent to syslogd instead of being written</span></span><br><span class="line"><span class="comment">; into a local file.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> the default prefix is @EXPANDED_LOCALSTATEDIR@</span></span><br><span class="line"><span class="comment">; Default Value: log/php-fpm.log</span></span><br><span class="line"><span class="comment">;error_log = log/php-fpm.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; syslog_facility is used to specify what type of program is logging the</span></span><br><span class="line"><span class="comment">; message. This lets syslogd specify that messages from different facilities</span></span><br><span class="line"><span class="comment">; will be handled differently.</span></span><br><span class="line"><span class="comment">; See syslog(3) for possible values (ex daemon equiv LOG_DAEMON)</span></span><br><span class="line"><span class="comment">; Default Value: daemon</span></span><br><span class="line"><span class="comment">;syslog.facility = daemon</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; syslog_ident is prepended to every message. If you have multiple FPM</span></span><br><span class="line"><span class="comment">; instances running on the same server, you can change the default value</span></span><br><span class="line"><span class="comment">; which must suit common needs.</span></span><br><span class="line"><span class="comment">; Default Value: php-fpm</span></span><br><span class="line"><span class="comment">;syslog.ident = php-fpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Log level</span></span><br><span class="line"><span class="comment">; Possible Values: alert, error, warning, notice, debug</span></span><br><span class="line"><span class="comment">; Default Value: notice</span></span><br><span class="line"><span class="comment">;log_level = notice</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; If this number of child processes exit with SIGSEGV or SIGBUS within the time</span></span><br><span class="line"><span class="comment">; interval set by emergency_restart_interval then FPM will restart. A value</span></span><br><span class="line"><span class="comment">; of '0' means 'Off'.</span></span><br><span class="line"><span class="comment">; Default Value: 0</span></span><br><span class="line"><span class="comment">;emergency_restart_threshold = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Interval of time used by emergency_restart_interval to determine when</span></span><br><span class="line"><span class="comment">; a graceful restart will be initiated.  This can be useful to work around</span></span><br><span class="line"><span class="comment">; accidental corruptions in an accelerator's shared memory.</span></span><br><span class="line"><span class="comment">; Available Units: s(econds), m(inutes), h(ours), or d(ays)</span></span><br><span class="line"><span class="comment">; Default Unit: seconds</span></span><br><span class="line"><span class="comment">; Default Value: 0</span></span><br><span class="line"><span class="comment">;emergency_restart_interval = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Time limit for child processes to wait for a reaction on signals from master.</span></span><br><span class="line"><span class="comment">; Available units: s(econds), m(inutes), h(ours), or d(ays)</span></span><br><span class="line"><span class="comment">; Default Unit: seconds</span></span><br><span class="line"><span class="comment">; Default Value: 0</span></span><br><span class="line"><span class="comment">;process_control_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The maximum number of processes FPM will fork. This has been designed to control</span></span><br><span class="line"><span class="comment">; the global number of processes when using dynamic PM within a lot of pools.</span></span><br><span class="line"><span class="comment">; Use it with caution.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> A value of 0 indicates no limit</span></span><br><span class="line"><span class="comment">; Default Value: 0</span></span><br><span class="line"><span class="comment">; process.max = 128</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Specify the nice(2) priority to apply to the master process (only if set)</span></span><br><span class="line"><span class="comment">; The value can vary from -19 (highest priority) to 20 (lowest priority)</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> - It will only work if the FPM master process is launched as root</span></span><br><span class="line"><span class="comment">;       - The pool process will inherit the master process priority</span></span><br><span class="line"><span class="comment">;         unless specified otherwise</span></span><br><span class="line"><span class="comment">; Default Value: no set</span></span><br><span class="line"><span class="comment">; process.priority = -19</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Send FPM to background. Set to 'no' to keep FPM in foreground for debugging.</span></span><br><span class="line"><span class="comment">; Default Value: yes</span></span><br><span class="line"><span class="comment">;daemonize = yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set open file descriptor rlimit for the master process.</span></span><br><span class="line"><span class="comment">; Default Value: system defined value</span></span><br><span class="line"><span class="comment">;rlimit_files = 1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set max core size rlimit for the master process.</span></span><br><span class="line"><span class="comment">; Possible Values: 'unlimited' or an integer greater or equal to 0</span></span><br><span class="line"><span class="comment">; Default Value: system defined value</span></span><br><span class="line"><span class="comment">;rlimit_core = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Specify the event mechanism FPM will use. The following is available:</span></span><br><span class="line"><span class="comment">; - select     (any POSIX os)</span></span><br><span class="line"><span class="comment">; - poll       (any POSIX os)</span></span><br><span class="line"><span class="comment">; - epoll      (linux &gt;= 2.5.44)</span></span><br><span class="line"><span class="comment">; - kqueue     (FreeBSD &gt;= 4.1, OpenBSD &gt;= 2.9, NetBSD &gt;= 2.0)</span></span><br><span class="line"><span class="comment">; - /dev/poll  (Solaris &gt;= 7)</span></span><br><span class="line"><span class="comment">; - port       (Solaris &gt;= 10)</span></span><br><span class="line"><span class="comment">; Default Value: not set (auto detection)</span></span><br><span class="line"><span class="comment">;events.mechanism = epoll</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; When FPM is built with systemd integration, specify the interval,</span></span><br><span class="line"><span class="comment">; in seconds, between health report notification to systemd.</span></span><br><span class="line"><span class="comment">; Set to 0 to disable.</span></span><br><span class="line"><span class="comment">; Available Units: s(econds), m(inutes), h(ours)</span></span><br><span class="line"><span class="comment">; Default Unit: seconds</span></span><br><span class="line"><span class="comment">; Default value: 10</span></span><br><span class="line"><span class="comment">;systemd_interval = 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="comment">; Pool Definitions ;</span></span><br><span class="line"><span class="comment">;;;;;;;;;;;;;;;;;;;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Multiple pools of child processes may be started with different listening</span></span><br><span class="line"><span class="comment">; ports and different management options.  The name of the pool will be</span></span><br><span class="line"><span class="comment">; used in logs and stats. There is no limitation on the number of pools which</span></span><br><span class="line"><span class="comment">; FPM can handle. Your system will tell you anyway :)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Include one or more files. If glob(3) exists, it is used to include a bunch of</span></span><br><span class="line"><span class="comment">; files from a glob(3) pattern. This directive can be used everywhere in the</span></span><br><span class="line"><span class="comment">; file.</span></span><br><span class="line"><span class="comment">; Relative path can also be used. They will be prefixed by:</span></span><br><span class="line"><span class="comment">;  - the global prefix if it's been set (-p argument)</span></span><br><span class="line"><span class="comment">;  - @prefix@ otherwise</span></span><br><span class="line"><span class="attr">include</span>=@php_fpm_sysconfdir@/php-fpm.d/*.conf</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;â€‹    æ˜¯ä¸æ˜¯ç»å¸¸åœ¨ç½‘ä¸Šçœ‹åˆ°php-fpm.confçš„å„ç§é…ç½®é¡¹ï¼Ÿä»€ä¹ˆpm.max_childrenã€pm.min_spare_serversã€pm.status_pathã€listenç­‰ç­‰ã€‚ä»–ä»¬åˆ°åº•ä»£è¡¨ä»€ä¹ˆæ„æ€å­˜æ”¾åœ¨é‚£ä¸ªæ–‡ä»¶é‡Œå‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥ä¸€æ¢ç©¶ç«Ÿã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="php/fpm/02" scheme="http://xwxz.github.io/categories/php-fpm-02/"/>
    
    
      <category term="fpm" scheme="http://xwxz.github.io/tags/fpm/"/>
    
      <category term="æºç " scheme="http://xwxz.github.io/tags/%E6%BA%90%E7%A0%81/"/>
    
      <category term="php" scheme="http://xwxz.github.io/tags/php/"/>
    
  </entry>
  
  <entry>
    <title>fpmæºç ä¹‹åˆæ¢ã€åŸåˆ›ã€‘</title>
    <link href="http://xwxz.github.io/php-fpm-01/"/>
    <id>http://xwxz.github.io/php-fpm-01/</id>
    <published>2018-07-23T16:00:00.000Z</published>
    <updated>2018-09-06T09:56:54.611Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡åœ¨php-7.2.0ç‰ˆæœ¬ä¸‹è¿›è¡Œåˆ†æã€‚ä¸»è¦ä»‹ç»fpmç›®å½•æ–‡ä»¶ï¼Œå¹¶ä»‹ç»fpmå…¥å£æ–‡ä»¶ã€‚</p><a id="more"></a><h1 id="1ã€fpmç›®å½•"><a href="#1ã€fpmç›®å½•" class="headerlink" title="1ã€fpmç›®å½•"></a>1ã€fpmç›®å½•</h1><p>fpmä½äº<code>php_src/sapi</code>ç›®å½•ä¸‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ CREDITS //fpmåç§°å’Œè´¡çŒ®è€…åˆ—è¡¨</span><br><span class="line">â”œâ”€â”€ LICENSE //å£°æ˜</span><br><span class="line">â”œâ”€â”€ Makefile.frag //makeæ—¶ä½¿ç”¨çš„æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ config.m4 //æ„å»ºfpmæ‰©å±•çš„é…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ fpm //fpmæºç ç›®å½•</span><br><span class="line">â”œâ”€â”€ init.d.php-fpm.in //fpmæä¾›ç»™init.dç¨‹åºä½¿ç”¨çš„é…ç½®</span><br><span class="line">â”œâ”€â”€ php-fpm.8.in </span><br><span class="line">â”œâ”€â”€ php-fpm.conf.in //fpmè¿è¡Œæ—¶çš„é…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ php-fpm.service.in //fpmæä¾›ç»™systemdç®¡ç†æ—¶ä½¿ç”¨çš„é…ç½®</span><br><span class="line">â”œâ”€â”€ status.html.in // fpmè¿è¡Œæ—¶çŠ¶æ€æŸ¥çœ‹é¡µé¢</span><br><span class="line">â”œâ”€â”€ tests //æµ‹è¯•fpmçš„è„šæœ¬</span><br><span class="line">â””â”€â”€ www.conf.in //fpmè¿è¡Œæ—¶é…ç½®ï¼Œè¿™ä¸ªä¸»è¦æ˜¯poolæ± é…ç½®ç®¡ç†</span><br></pre></td></tr></table></figure><p>linuxç®¡ç†è¿›ç¨‹æœ‰ä¸¤ç§å¸¸è§æ–¹å¼ï¼ŒcentOS7ä»¥ä¸‹ï¼ŒåŸºæœ¬é‡‡ç”¨init.dæ¥ç®¡ç†æ“ä½œç³»ç»Ÿçš„å¯åŠ¨ï¼Œè€ŒcentOS7å¼€å§‹ä½¿ç”¨systemdæ¥ç®¡ç†ç³»ç»Ÿçš„å¯åŠ¨ï¼Œå…³äºè¿™ä¸¤ç§å¯åŠ¨æ–¹å¼ï¼Œè¶…å‡ºæœ¬æ–‡æ‰€è®²è¿°çš„èŒƒå›´ï¼Œè¿™é‡Œåªç»™å‡ºç›¸å…³é“¾æ¥ã€‚systemdï¼Œé˜®ä¸€å³°è€å¸ˆçš„ä¸€ç¯‡æ–‡ç« ï¼Œè®²è§£çš„éå¸¸æµ…æ˜¾æ˜“æ‡‚ï¼Œ<a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html" target="_blank" rel="noopener">Systemdå…¥é—¨</a>ã€‚initè¿™é‡Œæ²¡æœ‰æ‰¾åˆ°æ¯”è¾ƒå¥½çš„ï¼Œç»™å‡ºç»´åŸºç™¾ç§‘çš„è§£é‡Šã€‚<a href="https://zh.wikipedia.org/wiki/Init" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/Init</a></p><p>ä¹‹æ‰€ä»¥è¦æåŠinitå’Œsystemdï¼Œä¸»è¦æ˜¯åœ¨æˆ‘ä»¬çš„fpmç›®å½•ä¸‹ï¼Œä¸ºè¿™ä¸¤ä¸ªç¨‹åºæä¾›äº†ç›¸åº”çš„ç®¡ç†é…ç½®ã€‚å…·ä½“é…ç½®è¿™é‡Œä¸å±•å¼€è¯¦è¿°äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥äº†è§£ç›¸å…³èµ„æ–™ã€‚</p><h2 id="fpmç›®å½•"><a href="#fpmç›®å½•" class="headerlink" title="fpmç›®å½•"></a>fpmç›®å½•</h2><p>å­˜æ”¾fpmæºç çš„ç›®å½•ï¼Œfpmé‡‡ç”¨cè¯­è¨€ç¼–å†™ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œ<code>.c</code>å’Œ<code>.h</code>æ–‡ä»¶ï¼Œå…¶è¯¦ç»†ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">php-7.2.0/sapi/fpm</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ events //fpmäº‹ä»¶å¤„ç†ç›¸å…³æºç </span><br><span class="line">â”‚Â Â  â”œâ”€â”€ devpoll.c</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ devpoll.h</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ epoll.c</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ epoll.h</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kqueue.c</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kqueue.h</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ poll.c</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ poll.h</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ port.c</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ port.h</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ select.c</span><br><span class="line">â”‚Â Â  â””â”€â”€ select.h</span><br><span class="line">â”œâ”€â”€ fpm.c //fpmä¸»ç¨‹åºå®ç°</span><br><span class="line">â”œâ”€â”€ fpm.h //fpmä¸»ç¨‹åºå¤´æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ fpm_arrays.h //fpmæ•°ç»„ç›¸å…³</span><br><span class="line">â”œâ”€â”€ fpm_atomic.h //fpmåŸå­æ“ä½œç›¸å…³</span><br><span class="line">â”œâ”€â”€ fpm_children.c //fpmå­è¿›ç¨‹ç›¸å…³</span><br><span class="line">â”œâ”€â”€ fpm_children.h </span><br><span class="line">â”œâ”€â”€ fpm_cleanup.c </span><br><span class="line">â”œâ”€â”€ fpm_cleanup.h //fpmå†…å­˜æ¸…ç†</span><br><span class="line">â”œâ”€â”€ fpm_clock.c</span><br><span class="line">â”œâ”€â”€ fpm_clock.h //fpmæ—¶é’Ÿç®¡ç†</span><br><span class="line">â”œâ”€â”€ fpm_conf.c</span><br><span class="line">â”œâ”€â”€ fpm_conf.h //fpmè¿è¡Œæ—¶é…ç½®è§£æï¼ŒåŒ…æ‹¬è¿è¡Œæ–¹å¼ã€è¿›ç¨‹æ± ç­‰çš„é…ç½®</span><br><span class="line">â”œâ”€â”€ fpm_config.h //fpmè®¡æ•°å™¨é…ç½®</span><br><span class="line">â”œâ”€â”€ fpm_env.c</span><br><span class="line">â”œâ”€â”€ fpm_env.h //fpmç¯å¢ƒå˜é‡</span><br><span class="line">â”œâ”€â”€ fpm_events.c</span><br><span class="line">â”œâ”€â”€ fpm_events.h //fpmäº‹ä»¶å¤„ç†ç›¸å…³</span><br><span class="line">â”œâ”€â”€ fpm_log.c</span><br><span class="line">â”œâ”€â”€ fpm_log.h //fpmæ—¥å¿—ç›¸å…³</span><br><span class="line">â”œâ”€â”€ fpm_main.c //fpmå…¥å£æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ fpm_php.c</span><br><span class="line">â”œâ”€â”€ fpm_php.h //fpmä¸­phpä¸zendçš„ä¸­é—´äº¤äº’</span><br><span class="line">â”œâ”€â”€ fpm_php_trace.c</span><br><span class="line">â”œâ”€â”€ fpm_php_trace.h //fpmæ‰§è¡Œæ ˆ</span><br><span class="line">â”œâ”€â”€ fpm_process_ctl.c</span><br><span class="line">â”œâ”€â”€ fpm_process_ctl.h //fpmè¿›ç¨‹æ§åˆ¶</span><br><span class="line">â”œâ”€â”€ fpm_request.c </span><br><span class="line">â”œâ”€â”€ fpm_request.h //fpmè¯·æ±‚å¤„ç†</span><br><span class="line">â”œâ”€â”€ fpm_scoreboard.c</span><br><span class="line">â”œâ”€â”€ fpm_scoreboard.h //fpmçš„è®¡æ•°å™¨ï¼Œä¸»è¦ç”¨äºç®¡ç†work</span><br><span class="line">â”œâ”€â”€ fpm_shm.c</span><br><span class="line">â”œâ”€â”€ fpm_shm.h //fpmå…±äº«å†…å­˜åˆ†é…å¤„ç†</span><br><span class="line">â”œâ”€â”€ fpm_signals.c</span><br><span class="line">â”œâ”€â”€ fpm_signals.h //fpmä¿¡å·å¤„ç†</span><br><span class="line">â”œâ”€â”€ fpm_sockets.c </span><br><span class="line">â”œâ”€â”€ fpm_sockets.h //fpmå¥—æ¥å­—å¤„ç†</span><br><span class="line">â”œâ”€â”€ fpm_status.c</span><br><span class="line">â”œâ”€â”€ fpm_status.h //fpmçŠ¶æ€ç®¡ç†</span><br><span class="line">â”œâ”€â”€ fpm_stdio.c</span><br><span class="line">â”œâ”€â”€ fpm_stdio.h //fpmè¾“å…¥è¾“å‡ºç®¡ç†</span><br><span class="line">â”œâ”€â”€ fpm_str.h //fpmå­—ç¬¦ä¸²å¤åˆ¶</span><br><span class="line">â”œâ”€â”€ fpm_systemd.c </span><br><span class="line">â”œâ”€â”€ fpm_systemd.h //fpmä¸systemdé€šä¿¡ç®¡ç†</span><br><span class="line">â”œâ”€â”€ fpm_trace.c</span><br><span class="line">â”œâ”€â”€ fpm_trace.h //fpmè°ƒç”¨æ ˆç›¸å…³</span><br><span class="line">â”œâ”€â”€ fpm_trace_mach.c //fpm masterè¿›ç¨‹æ£€æµ‹ç›¸å…³</span><br><span class="line">â”œâ”€â”€ fpm_trace_pread.c //fpmè¿›ç¨‹çŠ¶æ€æ£€æµ‹ç›¸å…³</span><br><span class="line">â”œâ”€â”€ fpm_trace_ptrace.c</span><br><span class="line">â”œâ”€â”€ fpm_unix.c</span><br><span class="line">â”œâ”€â”€ fpm_unix.h //å¤„ç†unixæ–‡ä»¶ç³»ç»Ÿç›¸å…³</span><br><span class="line">â”œâ”€â”€ fpm_worker_pool.c</span><br><span class="line">â”œâ”€â”€ fpm_worker_pool.h //fpm å·¥ä½œè¿›ç¨‹æ± ç›¸å…³</span><br><span class="line">â”œâ”€â”€ zlog.c</span><br><span class="line">â””â”€â”€ zlog.h //fpmæ—¥å¿—è®°å½•</span><br></pre></td></tr></table></figure><h2 id="fpmå…¥å£ç¨‹åº"><a href="#fpmå…¥å£ç¨‹åº" class="headerlink" title="fpmå…¥å£ç¨‹åº"></a>fpmå…¥å£ç¨‹åº</h2><p><strong>FPM(FastCGI Process Manager)</strong>æ˜¯PHP FastCGIè¿è¡Œæ¨¡å¼çš„ä¸€ä¸ªè¿›ç¨‹ç®¡ç†å™¨ï¼Œä»å®ƒçš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼ŒFPMçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯è¿›ç¨‹ç®¡ç†ï¼Œé‚£ä¹ˆå®ƒç”¨æ¥ç®¡ç†ä»€ä¹ˆè¿›ç¨‹å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»å…¥å£ç¨‹åºå¼€å§‹ï¼Œä¸€ç‚¹ä¸€ç‚¹æ­å¼€å…¶ç¥ç§˜é¢çº±ã€‚åˆ†æä¸€ä¸ªç¨‹åºï¼Œæ‰¾å‡†å…¥å£æ˜¯å…³é”®ï¼Œæ‰¾åˆ°å…¥å£åæ ¹æ®ä¸»è„‰ç»œå¾€ä¸‹æ‹å³å¯ã€‚æŒ‰ç…§è¿™æ ·çš„æŒ‡å¯¼æ€æƒ³ï¼Œé‚£æˆ‘ä»¬å°±å¼€å§‹å§ã€‚</p><p><strong>php_src/sapi/fpm/fpm/fpm_main.cï¼š</strong>fpmå…¥å£ç¨‹åºï¼Œæ‰¾åˆ°mainå…¥å£å‡½æ•°ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹fpmå¯åŠ¨æ‰§è¡Œçš„ä¸»è¦æµç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//æ³¨å†ŒSAPI:å°†å…¨å±€å˜é‡sapi_moduleè®¾ç½®ä¸ºcgi_sapi_module</span></span><br><span class="line">    sapi_startup(&amp;cgi_sapi_module);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//æ‰§è¡Œphp_module_starup()</span></span><br><span class="line">    <span class="keyword">if</span> (cgi_sapi_module.startup(&amp;cgi_sapi_module) == FAILURE) &#123;</span><br><span class="line">        <span class="keyword">return</span> FPM_EXIT_SOFTWARE;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> &gt; fpm_init(...))&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    fpm_is_running = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    fcgi_fd = fpm_run(&amp;max_requests);<span class="comment">//åé¢éƒ½æ˜¯workerè¿›ç¨‹çš„æ“ä½œï¼Œmasterè¿›ç¨‹ä¸ä¼šèµ°åˆ°ä¸‹é¢ï¼Œå› ä¸ºåœ¨fpm_runä¸­å·²ç»æ ¹æ®work_poolè¿›è¡Œå­è¿›ç¨‹forkäº†</span></span><br><span class="line">    parent = <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">request = fpm_init_request(fcgi_fd);<span class="comment">//åˆå§‹åŒ–è¯·æ±‚ï¼Œå¼€è¾Ÿå†…å­˜ç©ºé—´ã€è®¾ç½®è¯·æ±‚ç›¸å…³çš„ç¯å¢ƒå˜é‡ã€ç»‘å®šsocketç­‰</span></span><br><span class="line">zend_first_try &#123;<span class="comment">//å¼€å§‹ä¸€ä¸ªtry</span></span><br><span class="line">        <span class="keyword">while</span> (EXPECTED(fcgi_accept_request(request) &gt;= <span class="number">0</span>)) &#123;<span class="comment">//é˜»å¡ç­‰å¾…è¯·æ±‚åˆ°æ¥ï¼Œå…³äºfpmå¦‚ä½•æ¥å—è¯·æ±‚ï¼Œåé¢ä¼šæœ‰æ–‡ç« ä¸“é—¨è®²è§£</span></span><br><span class="line">            ...</span><br><span class="line">            init_request_info();<span class="comment">//åˆå§‹åŒ–è¯·æ±‚ç»“æ„ï¼ŒåŒ…æ‹¬PATH_INFOã€SCRIPT_NAMEã€REQUEST_URIã€SCRIPT_FILENAMEç­‰</span></span><br><span class="line">            fpm_request_info();<span class="comment">//å°†cgiä¸­çš„è¯·æ±‚ä¿¡æ¯å¤åˆ¶åˆ°fpmè¯·æ±‚ä¸­</span></span><br><span class="line">            php_request_startup()<span class="comment">//phpè¯·æ±‚å¤„ç†å¼€å§‹</span></span><br><span class="line">            fpm_status_handle_request()<span class="comment">//å¤„ç†fpmå¯åŠ¨åçŠ¶æ€æ£€æµ‹ï¼Œå¦‚æœçŠ¶æ€ä¸å¤ªå¯¹ï¼Œå°±è·³è¿‡åé¢çš„å¤„ç†ï¼Œç»“æŸè¯·æ±‚</span></span><br><span class="line">            ...</span><br><span class="line">            php_fopen_primary_script(&amp;file_handle)<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            fpm_request_executing();<span class="comment">//è¯·æ±‚æ‰§è¡Œ</span></span><br><span class="line">            php_execute_script(&amp;file_handle);<span class="comment">//æ‰§è¡Œè„šæœ¬</span></span><br><span class="line">            ...</span><br><span class="line">            fpm_request_end();<span class="comment">//è¯·æ±‚æ‰§è¡Œç»“æŸ</span></span><br><span class="line">            php_request_shutdown((<span class="keyword">void</span> *) <span class="number">0</span>);<span class="comment">//è¯·æ±‚å…³é—­</span></span><br><span class="line">            ...</span><br><span class="line">            requests++;</span><br><span class="line">            <span class="keyword">if</span> (UNEXPECTED(max_requests &amp;&amp; (requests == max_requests))) &#123;<span class="comment">//åˆ¤æ–­ä¸€ä¸ªå­è¿›ç¨‹å¤„ç†çš„è¯·æ±‚æ•°ï¼Œå¦‚æœè¾¾åˆ°å¤„ç†ä¸Šçº¿å°±å…‰è£é€€å‡º</span></span><br><span class="line">                fcgi_request_set_keep(request, <span class="number">0</span>);</span><br><span class="line">                fcgi_finish_request(request, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">    &#125;</span><br><span class="line">        fcgi_destroy_request(request);<span class="comment">//é”€æ¯fpmè¯·æ±‚</span></span><br><span class="line">fcgi_shutdown();<span class="comment">//fcgiå…³é—­</span></span><br><span class="line">&#125; zend_catch &#123;</span><br><span class="line">exit_status = FPM_EXIT_SOFTWARE;</span><br><span class="line">&#125; zend_end_try();</span><br><span class="line">    </span><br><span class="line">    php_module_shutdown();<span class="comment">//å…³é—­æ¨¡å—</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> exit_status;<span class="comment">//è¿›ç¨‹é€€å‡º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€äº›å…¥å£æ–‡ä»¶å¹²çš„äº‹æƒ…ï¼š</p><ol><li>åˆå§‹åŒ–æ•°æ®ç»“æ„</li><li>è§£æå‘½ä»¤è¡Œå‚æ•°</li><li>åˆå§‹åŒ–fpm_init</li><li>æ‰§è¡Œfpm_run</li><li>å¯åŠ¨ç›‘å¬ç«¯å£å¹¶å¤„ç†è¯·æ±‚ï¼ˆæ­¤å¤„ä¸»è¿›ç¨‹æ˜¯ä¸ä¼šèµ°åˆ°çš„ï¼‰</li></ol><p>ä¸‹é¢ä¸€ç¯‡æ–‡ç« å°†ä¼šè®²è§£fpmçš„è¿›ç¨‹æ˜¯å¦‚ä½•ç®¡ç†çš„</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡åœ¨php-7.2.0ç‰ˆæœ¬ä¸‹è¿›è¡Œåˆ†æã€‚ä¸»è¦ä»‹ç»fpmç›®å½•æ–‡ä»¶ï¼Œå¹¶ä»‹ç»fpmå…¥å£æ–‡ä»¶ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="php/fpm/01" scheme="http://xwxz.github.io/categories/php-fpm-01/"/>
    
    
      <category term="PHP" scheme="http://xwxz.github.io/tags/PHP/"/>
    
      <category term="æºç åˆ†æ" scheme="http://xwxz.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
      <category term="fpm" scheme="http://xwxz.github.io/tags/fpm/"/>
    
  </entry>
  
  <entry>
    <title>fpmæºç è§£æå‡†å¤‡ã€åŸåˆ›ã€‘</title>
    <link href="http://xwxz.github.io/php-fpm/"/>
    <id>http://xwxz.github.io/php-fpm/</id>
    <published>2018-07-22T16:00:00.000Z</published>
    <updated>2019-03-05T08:47:20.064Z</updated>
    
    <content type="html"><![CDATA[<p>â€‹    ä¹‹å‰çœ‹è¿‡ç½‘ä¸Šé›¶æ•£çš„å…³äºphp-fpmåˆ†æçš„æ–‡ç« ï¼Œè¦ä¹ˆä¸å…¨ï¼Œè¦ä¹ˆå°±æ˜¯è®²è§£php-fpmçš„é…ç½®æ–‡ä»¶çš„ï¼Œè¿˜æœ‰å°±æ˜¯è®²è§£nginxä¸php-fpmä¹‹é—´é€šä¿¡é…ç½®çš„ã€‚å…³äºphp-fpmä¸­çš„è¿›ç¨‹ç®¡ç†ã€ä¿¡å·ç®¡ç†ã€äº‹ä»¶å¤„ç†ã€æ—¶é’Ÿç®¡ç†ã€è¯·æ±‚å¤„ç†ç­‰å‡ ä¹ä¸ºé›¶ã€‚æ•…æœ¬ç€å­¦ä¹ çš„å®—æ—¨å¯¹fpmæºç è¿›è¡Œè§£è¯»ã€‚æœ¬ç³»åˆ—é‡‡ç”¨php-7.2.0ç‰ˆæœ¬ä¸­çš„php-fpmè¿›è¡Œåˆ†ç³»åˆ—è®²è§£ã€‚æœ¬ç³»åˆ—å…±åˆ†ä¸º5èŠ‚ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><a id="more"></a><ol><li><a href="http://xwxz.github.io/php-fpm-01/#more">fpmæºç ä¹‹åˆæ¢</a></li><li><a href="">fpmæºç ä¹‹é…ç½®è§£æ</a></li><li><a href="">fpmæºç ä¹‹è¿›ç¨‹ç®¡ç†</a></li><li><a href="">fpmæºç ä¹‹ä¿¡å·å¤„ç†</a></li><li><a href="">fpmæºç ä¹‹äº‹ä»¶ç®¡ç†</a></li><li><a href="">fpmæºç ä¹‹è¯·æ±‚å¤„ç†</a></li></ol><p>æºç åœ°å€ï¼š<a href="https://github.com/php/php-src" target="_blank" rel="noopener">https://github.com/php/php-src</a></p><h2 id="æºç æŸ¥çœ‹å·¥å…·"><a href="#æºç æŸ¥çœ‹å·¥å…·" class="headerlink" title="æºç æŸ¥çœ‹å·¥å…·"></a>æºç æŸ¥çœ‹å·¥å…·</h2><p>sublime+vim</p><h2 id="ä»€ä¹ˆæ˜¯-Zend-ä»€ä¹ˆæ˜¯-PHP"><a href="#ä»€ä¹ˆæ˜¯-Zend-ä»€ä¹ˆæ˜¯-PHP" class="headerlink" title="ä»€ä¹ˆæ˜¯ Zend ? ä»€ä¹ˆæ˜¯ PHP ?"></a>ä»€ä¹ˆæ˜¯ Zend ? ä»€ä¹ˆæ˜¯ PHP ?</h2><p><em>Zend</em>æ˜¯è¯­è¨€å¼•æ“ï¼ŒPHPå†…æ ¸ã€‚PHPæ˜¯ä»å¤–å±‚å±•ç°çš„å®Œæ•´ç³»ç»Ÿã€‚å’‹ä¸€å¬ä¼¼ä¹æœ‰ç‚¹æ¨¡ç³Šä¸æ¸…ï¼Œä½†æ˜¯å…¶å®å¹¶ä¸å¤æ‚ï¼Œä¸ºäº†å®ç°ä¸€ä¸ª web è„šæœ¬è§£é‡Šå™¨ï¼Œä½ éœ€è¦ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>ç¬¬ä¸€ï¼š<strong>è§£é‡Šå™¨éƒ¨åˆ†</strong> åˆ†æè¾“å…¥ä»£ç ï¼Œç¿»è¯‘ä»£ç ï¼Œç„¶åæ‰§è¡Œä»£ç ã€‚</li><li>ç¬¬äºŒï¼š<strong>åŠŸèƒ½éƒ¨åˆ†</strong> å®Œæˆè¯­è¨€çš„åŠŸèƒ½ï¼ˆå‡½æ•°ï¼Œç­‰ç­‰ï¼‰ã€‚</li><li>ç¬¬ä¸‰ï¼š<strong>æ¥å£éƒ¨åˆ†</strong> ä¸webé€šä¿¡</li></ol><p><img src="http://php.net/manual/zh/images/befd863081615f539082d9ff76bf7b39-zend.01-internal-structure.png" alt="img"></p><h2 id="ç»„æˆæ‰©å±•çš„æ–‡ä»¶"><a href="#ç»„æˆæ‰©å±•çš„æ–‡ä»¶" class="headerlink" title="ç»„æˆæ‰©å±•çš„æ–‡ä»¶"></a>ç»„æˆæ‰©å±•çš„æ–‡ä»¶</h2><p>ç»è¿‡ä¸Šé¢çš„å¤ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“PHPç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­æœ€å®¹æ˜“æ‰©å±•çš„å°±æ˜¯moduleséƒ¨åˆ†ï¼Œè€Œfpmä¹Ÿæ˜¯ä»¥phpæ‰©å±•çš„å½¢å¼å­˜åœ¨çš„ï¼Œé‚£ä¹ˆåœ¨å¼€å§‹è®²è§£fpmæºç ä¹‹å‰ï¼Œæˆ‘ç®€å•ä»‹ç»ä¸‹phpæ‰©å±•ã€‚è¿™é‡Œå‚è€ƒçš„æ˜¯<a href="http://php.net/manual/zh/internals2.structure.php" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><p>ä¸ç®¡é€šè¿‡ä»€ä¹ˆæ–¹å¼åˆ›å»ºçš„æ‰©å±•ï¼Œéƒ½è‡³å°‘åŒ…å«ä»¥ä¸‹å››ä¸ªæ–‡ä»¶ï¼š</p><p><strong>config.m4</strong></p><pre><code>unixæ„å»ºç³»ç»Ÿé…ç½® [å‚è€ƒ](http://php.net/manual/zh/internals2.buildsys.configunix.php)</code></pre><p><strong>config.w32</strong></p><pre><code>windowsæ„å»ºç³»ç»Ÿé…ç½®</code></pre><p><strong>php_xxx.h</strong></p><pre><code>xxxä¸ºæ‰©å±•åå­—ï¼Œå½“å°†æ‰©å±•ä½œä¸ºé™æ€æ¨¡å—æ„å»ºå¹¶æ”¾å…¥PHPäºŒè¿›åˆ¶åŒ…æ—¶ï¼Œæ„å»ºç³»ç»Ÿä¼šè¦æ±‚ç”¨php_åŠ æ‰©å±•çš„åç§°å‘½åçš„å¤´æ–‡ä»¶åŒ…å«ä¸€ä¸ªå¯¹æ‰©å±•æ¨¡å—ç»“æ„çš„æŒ‡é’ˆå®šä¹‰ã€‚å°±åƒå…¶ä»–å¤´æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶ç»å¸¸åŒ…å«é™„åŠ çš„å®ã€åŸå‹å’Œå…¨å±€å˜é‡ã€‚</code></pre><p><strong>xxx.c</strong></p><pre><code>ä¸»è¦çš„æ‰©å±•æºæ–‡ä»¶ã€‚æŒ‰æƒ¯ä¾‹ï¼Œæ­¤æ–‡ä»¶åå°±æ˜¯æ‰©å±•çš„åç§°ï¼Œæ¯”å¦‚è¿™é‡Œçš„xxxï¼Œä½†ä¸æ˜¯å¿…éœ€çš„ã€‚æ­¤æ–‡ä»¶åŒ…å«æ¨¡å—ç»“æ„å®šä¹‰ã€INIæ¡ç›®ã€ç®¡ç†å‡½æ•°ã€ç”¨æˆ·ç©ºé—´å‡½æ•°å’Œå…¶ä»–æ‰©å±•æ‰€éœ€çš„å†…å®¹ã€‚</code></pre><p>æ‰©å±•åº”åŒ…å«ä»»æ„æ•°é‡çš„å¤´æ–‡ä»¶ã€æºæ–‡ä»¶ã€å•å…ƒæµ‹è¯•å’Œå…¶ä»–æ”¯æŒæ–‡ä»¶ã€‚æ­¤å››ä¸ªæ–‡ä»¶ä»…å¤Ÿç»„æˆæœ€å°çš„æ‰©å±•ã€‚</p><p>æ¯”å¦‚é€šè¿‡phpæºæ–‡ä»¶ä¸­<code>$path/php-7.2.0/ext/ext_skel</code>å‘½ä»¤ç”Ÿæˆçš„xxxæ‰©å±•ï¼Œå…¶ç›®å½•å¦‚ä¸‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ CREDITS //çº¯æ–‡æœ¬æ ¼å¼åˆ—å‡ºäº†æ‰©å±•çš„è´¡çŒ®è€…å’Œï¼ˆæˆ– ï¼‰ç»´æŠ¤è€…</span><br><span class="line">â”œâ”€â”€ EXPERIMENTAL</span><br><span class="line">â”œâ”€â”€ config.m4</span><br><span class="line">â”œâ”€â”€ config.w32</span><br><span class="line">â”œâ”€â”€ php_xxx.h</span><br><span class="line">â”œâ”€â”€ tests //æµ‹è¯•æ‰©å±•çš„æµ‹è¯•æ–‡ä»¶ï¼Œphpæ‰©å±•ä½¿ç”¨phpæ¥æµ‹è¯•</span><br><span class="line">â”‚Â Â  â””â”€â”€ 001.phpt</span><br><span class="line">â”œâ”€â”€ xxx.c</span><br><span class="line">â””â”€â”€ xxx.php</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<strong>xxx.php</strong>å†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦ç”¨äºæµ‹è¯•æ‰©å±•ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$br = (php_sapi_name() == <span class="string">"cli"</span>)? <span class="string">""</span>:<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!extension_loaded(<span class="string">'xxx'</span>)) &#123;</span><br><span class="line">dl(<span class="string">'xxx.'</span> . PHP_SHLIB_SUFFIX);</span><br><span class="line">&#125;</span><br><span class="line">$module = <span class="string">'xxx'</span>;</span><br><span class="line">$functions = get_extension_funcs($module);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Functions available in the test extension:$br\n"</span>;</span><br><span class="line"><span class="keyword">foreach</span>($functions <span class="keyword">as</span> $func) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $func.<span class="string">"$br\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$br\n"</span>;</span><br><span class="line">$function = <span class="string">'confirm_'</span> . $module . <span class="string">'_compiled'</span>;</span><br><span class="line"><span class="keyword">if</span> (extension_loaded($module)) &#123;</span><br><span class="line">$str = $function($module);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">$str = <span class="string">"Module $module is not compiled into PHP"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$str\n"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Cè¯­è¨€åŸºç¡€çŸ¥è¯†å¤ä¹ "><a href="#Cè¯­è¨€åŸºç¡€çŸ¥è¯†å¤ä¹ " class="headerlink" title="Cè¯­è¨€åŸºç¡€çŸ¥è¯†å¤ä¹ "></a>Cè¯­è¨€åŸºç¡€çŸ¥è¯†å¤ä¹ </h2><h3 id="extern"><a href="#extern" class="headerlink" title="extern"></a>extern</h3><p>ç”¨åœ¨å˜é‡æˆ–å‡½æ•°çš„å£°æ˜å‰ï¼Œç”¨æ¥è¯´æ˜â€æ­¤å˜é‡/å‡½æ•°æ˜¯åœ¨åˆ«å¤„å®šä¹‰çš„ï¼Œè¦åœ¨æ­¤å¤„å¼•ç”¨â€ã€‚</p><p>å¯¹å˜é‡è€Œè¨€ï¼Œå˜é‡çš„å£°æ˜æœ‰ä¸¤ç§æƒ…å†µï¼š</p><p>1ã€ ä¸€ç§æ˜¯éœ€è¦å»ºç«‹å­˜å‚¨ç©ºé—´çš„ï¼Œä¸ç”¨åŠ externï¼›</p><p>2ã€å¦ä¸€ç§æ˜¯ä¸éœ€è¦å»ºç«‹å­˜å‚¨ç©ºé—´ï¼Œéœ€è¦åŠ extern ã€‚å¦‚æœä½ æƒ³åœ¨æœ¬æºæ–‡ä»¶ä¸­ä½¿ç”¨å¦ä¸€ä¸ªæºæ–‡ä»¶çš„å˜é‡ï¼Œå°±éœ€è¦åœ¨ä½¿ç”¨å‰ç”¨externå£°æ˜è¯¥å˜é‡ï¼Œæˆ–è€…åœ¨å¤´æ–‡ä»¶ä¸­ç”¨externå£°æ˜è¯¥å˜é‡ï¼›</p><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> a;<span class="comment">//å£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡a</span></span><br><span class="line"><span class="keyword">int</span> a; <span class="comment">//å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> a =<span class="number">0</span> ;<span class="comment">//å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡a å¹¶ç»™åˆå€¼</span></span><br><span class="line"><span class="keyword">int</span> a =<span class="number">0</span>;<span class="comment">//å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡a,å¹¶ç»™åˆå€¼</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„å˜é‡å®šä¹‰æ™ºèƒ½å‡ºç°åœ¨ä¸€å¤„ï¼Œè€Œå¤–éƒ¨å¼•ç”¨å£°æ˜å¯ä»¥å‡ºç°å¤šæ¬¡ã€‚</p><p>å¯¹å‡½æ•°è€Œè¨€ï¼Œå¦‚æœä½ æƒ³åœ¨æœ¬æºæ–‡ä»¶ä¸­ä½¿ç”¨å¦ä¸€ä¸ªæºæ–‡ä»¶çš„å‡½æ•°ï¼Œå°±éœ€è¦åœ¨ä½¿ç”¨å‰ç”¨å£°æ˜è¯¥å‡½æ•°ï¼Œå£°æ˜å‡½æ•°åŠ ä¸åŠ externéƒ½æ²¡å…³ç³»ï¼Œæ‰€ä»¥åœ¨å¤´æ–‡ä»¶ä¸­å‡½æ•°å¯ä»¥ä¸ç”¨åŠ externã€‚</p><h3 id="memset"><a href="#memset" class="headerlink" title="memset"></a>memset</h3><p><strong>å†…å­˜ç”³è¯·å¹¶åˆå§‹åŒ–å‡½æ•°</strong>ï¼šå°†sæ‰€æŒ‡å‘çš„æŸä¸€å—å†…å­˜ä¸­çš„ånä¸ªå­—èŠ‚çš„å†…å®¹å…¨éƒ¨è®¾ç½®ä¸ºchæŒ‡å®šçš„ASCIIå€¼ï¼Œç¬¬ä¸€ä¸ªå€¼ä¸ºæŒ‡å®šçš„å†…å­˜åœ°å€ï¼Œå—çš„å¤§å°ç”±ç¬¬ä¸‰ä¸ªå‚æ•°å†³å®šã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memset</span><span class="params">(<span class="keyword">void</span> *s, <span class="keyword">int</span> ch, <span class="keyword">size_t</span> n)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><p><strong>åŠ¨æ€å†…å­˜åˆ†é…ï¼š</strong>å…¨ç§°æ˜¯memory allocationï¼Œç”¨äºç”³è¯·ä¸€å—è¿ç»­çš„æŒ‡å®šå¤§å°çš„å†…å­˜å—åŒºåŸŸä»¥<code>void*</code>ç±»å‹è¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸåœ°å€ã€‚å…¶ä¸­<code>void*</code>è¡¨ç¤ºæœªç¡®å®šç±»å‹çš„æŒ‡é’ˆã€‚å…¶å¯ä»¥é€šè¿‡ç±»å‹è½¬æ¢å¼ºåˆ¶è½¬æ¢ä¸ºä»»ä½•å…¶ä»–ç±»å‹çš„æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="æŒ‡é’ˆ"><a href="#æŒ‡é’ˆ" class="headerlink" title="æŒ‡é’ˆ"></a>æŒ‡é’ˆ</h3><p><strong>æŒ‡é’ˆæ˜¯ç¨‹åºæ•°æ®åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œè€ŒæŒ‡é’ˆå˜é‡æ˜¯ç”¨æ¥ä¿å­˜è¿™äº›åœ°å€çš„å˜é‡ã€‚</strong></p><p>æˆ‘ä»¬æŒ‡çŸ¥é“ï¼šCè¯­è¨€ä¸­çš„æ•°ç»„æ˜¯æŒ‡ ä¸€ç±» ç±»å‹ï¼Œæ•°ç»„å…·ä½“åŒºåˆ†ä¸º  int ç±»å‹æ•°ç»„ï¼Œdoubleç±»å‹æ•°ç»„,charæ•°ç»„ ç­‰ç­‰ã€‚åŒæ ·æŒ‡é’ˆ è¿™ä¸ªæ¦‚å¿µä¹Ÿæ³›æŒ‡ ä¸€ç±» æ•°æ®ç±»å‹ï¼ŒintæŒ‡é’ˆç±»å‹ï¼ŒdoubleæŒ‡é’ˆç±»å‹ï¼ŒcharæŒ‡é’ˆç±»å‹ç­‰ç­‰ã€‚</p><p>é€šå¸¸ï¼Œæˆ‘ä»¬ç”¨intç±»å‹ä¿å­˜ä¸€äº›æ•´å‹çš„æ•°æ®ï¼Œå¦‚ int num = 97 ï¼Œ æˆ‘ä»¬ä¹Ÿä¼šç”¨charæ¥å­˜å‚¨å­—ç¬¦ï¼š char ch = â€˜aâ€™ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¿…é¡»çŸ¥é“ï¼šä»»ä½•ç¨‹åºæ•°æ®è½½å…¥å†…å­˜åï¼Œåœ¨å†…å­˜éƒ½æœ‰ä»–ä»¬çš„åœ°å€ï¼Œè¿™å°±æ˜¯æŒ‡é’ˆã€‚è€Œä¸ºäº†ä¿å­˜ä¸€ä¸ªæ•°æ®åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œæˆ‘ä»¬å°±éœ€è¦æŒ‡é’ˆå˜é‡ã€‚</p><h3 id="void-ç±»å‹æŒ‡é’ˆ"><a href="#void-ç±»å‹æŒ‡é’ˆ" class="headerlink" title="void *ç±»å‹æŒ‡é’ˆ"></a>void *ç±»å‹æŒ‡é’ˆ</h3><p>ç”±äºvoidæ˜¯ç©ºç±»å‹ï¼Œå› æ­¤<code>void *</code>ç±»å‹çš„æŒ‡é’ˆåªä¿å­˜äº†æŒ‡é’ˆçš„å€¼ï¼Œè€Œä¸¢å¤±äº†ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬ä¸çŸ¥é“ä»–æŒ‡å‘çš„æ•°æ®æ˜¯ä»€ä¹ˆç±»å‹çš„ï¼ŒåªæŒ‡å®šè¿™ä¸ªæ•°æ®åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€ï¼Œå¦‚æœæƒ³è¦å®Œæ•´çš„æå–æŒ‡å‘çš„æ•°æ®ï¼Œç¨‹åºå‘˜å°±å¿…é¡»å¯¹è¿™ä¸ªæŒ‡é’ˆåšå‡ºæ­£ç¡®çš„ç±»å‹è½¬æ¢ï¼Œç„¶åå†è§£æŒ‡é’ˆã€‚å› ä¸ºï¼Œç¼–è¯‘å™¨ä¸å…è®¸ç›´æ¥å¯¹<code>void *</code>ç±»å‹çš„æŒ‡é’ˆåšè§£æŒ‡é’ˆæ“ä½œã€‚</p><h3 id="struct"><a href="#struct" class="headerlink" title="struct"></a>struct</h3><p>structä¸ºç»“æ„ä½“å…³é”®å­—ï¼Œtagä¸ºç»“æ„ä½“çš„æ ‡å¿—ï¼Œmember-listä¸ºç»“æ„ä½“æˆå‘˜åˆ—è¡¨ï¼Œå…¶å¿…é¡»åˆ—å‡ºå…¶æ‰€æœ‰æˆå‘˜ï¼›variable-listä¸ºæ­¤ç»“æ„ä½“å£°æ˜çš„å˜é‡ã€‚ç»“æ„ä½“çš„2ç§å®šä¹‰æ–¹å¼ï¼š</p><p><strong>å¸¸è§„å®šä¹‰</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Student</span> //ç»“æ„ä½“å®šä¹‰</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">char</span> name[<span class="number">20</span>];</span><br><span class="line"><span class="keyword">int</span> age;</span><br><span class="line"><span class="keyword">int</span>score[<span class="number">5</span>];</span><br><span class="line">&#125;ï¼›</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Student</span> <span class="title">s1</span> = &#123;</span><span class="string">"zhangsan"</span>,<span class="number">22</span>,&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">10</span>&#125;&#125;; <span class="comment">//ç»“æ„ä½“å˜é‡å£°æ˜å¹¶åˆå§‹åŒ–</span></span><br></pre></td></tr></table></figure><p><strong>å°¾éƒ¨å®šä¹‰</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">char</span>name[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">int</span>age;</span><br><span class="line"><span class="keyword">int</span>score[<span class="number">5</span>];</span><br><span class="line">&#125;stu1 = &#123;<span class="string">"å¼ ä¸‰"</span>,<span class="number">20</span>,&#123;<span class="number">150</span>,<span class="number">110</span>,<span class="number">20</span>,<span class="number">34</span>,<span class="number">114</span>&#125;&#125;ï¼Œstu2; <span class="comment">//åŒ¿åç»“æ„ä½“å®šä¹‰æ—¶å£°æ˜å˜é‡å¹¶åˆå§‹åŒ–</span></span><br></pre></td></tr></table></figure><h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><p><strong>1. staticå…¨å±€å˜é‡</strong></p><p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªè¿›ç¨‹åœ¨å†…å­˜ä¸­çš„å¸ƒå±€å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1ftl178ha0pj305o0iyt8t.jpg" alt=""></p><pre><code>å…¶ä¸­.textæ®µä¿å­˜è¿›ç¨‹æ‰€æ‰§è¡Œçš„ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ.dataæ®µä¿å­˜è¿›ç¨‹æ‰€æœ‰çš„å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œ.bssæ®µä¿å­˜è¿›ç¨‹æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼ˆå…¶ä»–æ®µä¸­è¿˜æœ‰å¾ˆå¤šä¹±ä¸ƒå…«ç³Ÿçš„æ®µï¼Œæš‚ä¸”ä¸è¡¨ï¼‰ã€‚åœ¨è¿›ç¨‹çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼Œ.dataæ®µå’Œ.bssæ®µå†…çš„æ•°æ®æ—¶è·Ÿæ•´ä¸ªè¿›ç¨‹åŒç”Ÿå…±æ­»çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿›ç¨‹ç»“æŸä¹‹åè¿™äº›æ•°æ®æ‰ä¼šå¯¿ç»ˆå°±å¯ã€‚å½“ä¸€ä¸ªè¿›ç¨‹çš„å…¨å±€å˜é‡è¢«å£°æ˜ä¸ºstaticä¹‹åï¼Œå®ƒçš„ä¸­æ–‡åå«**é™æ€å…¨å±€å˜é‡**ã€‚é™æ€å…¨å±€å˜é‡å’Œå…¶ä»–çš„å…¨å±€å˜é‡çš„å­˜å‚¨åœ°ç‚¹å¹¶æ²¡æœ‰åŒºåˆ«ï¼Œéƒ½æ˜¯åœ¨.dataæ®µï¼ˆå·²åˆå§‹åŒ–ï¼‰æˆ–è€….bssæ®µï¼ˆæœªåˆå§‹åŒ–ï¼‰å†…ï¼Œä½†æ˜¯**å®ƒåªåœ¨å®šä¹‰å®ƒçš„æºæ–‡ä»¶å†…æœ‰æ•ˆï¼Œå…¶ä»–æºæ–‡ä»¶æ— æ³•è®¿é—®å®ƒ**ã€‚æ‰€ä»¥ï¼Œæ™®é€šå…¨å±€å˜é‡ç©¿ä¸Šstaticå¤–è¡£åï¼Œå®ƒå°±å˜æˆäº†æ–°å¨˜ï¼Œå·²å¿ƒæœ‰æ‰€å±ï¼Œåªèƒ½è¢«å®šä¹‰å®ƒçš„æºæ–‡ä»¶ï¼ˆæ–°éƒï¼‰ä¸­çš„å˜é‡æˆ–å‡½æ•°è®¿é—®ã€‚</code></pre><p>æ™®é€šçš„å±€éƒ¨å˜é‡åœ¨æ ˆç©ºé—´ä¸Šåˆ†é…ï¼Œè¿™ä¸ªå±€éƒ¨å˜é‡æ‰€åœ¨çš„å‡½æ•°è¢«å¤šæ¬¡è°ƒç”¨æ—¶ï¼Œæ¯æ¬¡è°ƒç”¨è¿™ä¸ªå±€éƒ¨å˜é‡åœ¨æ ˆä¸Šçš„ä½ç½®éƒ½ä¸ä¸€å®šç›¸åŒã€‚å±€éƒ¨å˜é‡ä¹Ÿå¯ä»¥åœ¨å †ä¸ŠåŠ¨æ€åˆ†é…ï¼Œä½†æ˜¯è®°å¾—ä½¿ç”¨å®Œè¿™ä¸ªå †ç©ºé—´åè¦é‡Šæ”¾ä¹‹ã€‚</p><p><strong>2. é™æ€å±€éƒ¨å˜é‡</strong></p><p>staticå±€éƒ¨å˜é‡ä¸­æ–‡åå«<strong>é™æ€å±€éƒ¨å˜é‡</strong>ã€‚å®ƒä¸æ™®é€šçš„å±€éƒ¨å˜é‡æ¯”èµ·æ¥æœ‰å¦‚ä¸‹å‡ ä¸ªåŒºåˆ«ï¼š</p><pre><code>1ï¼‰**ä½ç½®**ï¼šé™æ€å±€éƒ¨å˜é‡è¢«ç¼–è¯‘å™¨æ”¾åœ¨å…¨å±€å­˜å‚¨åŒº.dataï¼ˆæ³¨æ„ï¼šä¸åœ¨.bssæ®µå†…ï¼ŒåŸå› è§3ï¼‰ï¼‰ï¼Œæ‰€ä»¥å®ƒè™½ç„¶æ˜¯å±€éƒ¨çš„ï¼Œä½†æ˜¯åœ¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­å­˜åœ¨ã€‚     2ï¼‰**è®¿é—®æƒé™ï¼š**é™æ€å±€éƒ¨å˜é‡åªèƒ½è¢«å…¶ä½œç”¨åŸŸå†…çš„å˜é‡æˆ–å‡½æ•°è®¿é—®ã€‚ä¹Ÿå°±æ˜¯è¯´è™½ç„¶å®ƒä¼šåœ¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­å­˜åœ¨ï¼Œç”±äºå®ƒæ˜¯staticçš„ï¼Œå®ƒä¸èƒ½è¢«å…¶ä»–çš„å‡½æ•°å’Œæºæ–‡ä»¶è®¿é—®ã€‚     3ï¼‰**å€¼ï¼š**é™æ€å±€éƒ¨å˜é‡å¦‚æœæ²¡æœ‰è¢«ç”¨æˆ·åˆå§‹åŒ–ï¼Œåˆ™ä¼šè¢«ç¼–è¯‘å™¨è‡ªåŠ¨èµ‹å€¼ä¸º0ï¼Œä»¥åæ¯æ¬¡è°ƒç”¨é™æ€å±€éƒ¨å˜é‡çš„æ—¶å€™éƒ½ç”¨ä¸Šæ¬¡è°ƒç”¨åçš„å€¼ã€‚è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨é™æ€å±€éƒ¨å˜é‡çš„æ—¶å€™éƒ½ä¿®æ”¹å®ƒç„¶åç¦»å¼€ï¼Œä¸‹æ¬¡è¯»çš„æ—¶å€™ä»å…¨å±€å­˜å‚¨åŒºè¯»å‡ºçš„é™æ€å±€éƒ¨å˜é‡å°±æ˜¯ä¸Šæ¬¡ä¿®æ”¹åçš„å€¼ã€‚</code></pre><p><strong>3. ç§æœ‰å‡½æ•°</strong></p><pre><code>å½“ä½ çš„ç¨‹åºä¸­æœ‰å¾ˆå¤šä¸ªæºæ–‡ä»¶çš„æ—¶å€™ï¼Œä½ è‚¯å®šä¼šè®©æŸä¸ªæºæ–‡ä»¶åªæä¾›ä¸€äº›å¤–ç•Œéœ€è¦çš„æ¥å£ï¼Œå…¶ä»–çš„å‡½æ•°å¯èƒ½æ˜¯ä¸ºäº†å®ç°è¿™äº›æ¥å£è€Œç¼–å†™ï¼Œè¿™äº›å…¶ä»–çš„å‡½æ•°ä½ å¯èƒ½å¹¶ä¸å¸Œæœ›è¢«å¤–ç•Œï¼ˆéæœ¬æºæ–‡ä»¶ï¼‰æ‰€çœ‹åˆ°ï¼Œè¿™æ—¶å€™å°±å¯ä»¥ç”¨staticä¿®é¥°è¿™äº›â€œå…¶ä»–çš„å‡½æ•°â€ã€‚</code></pre><p><strong>æ‰€ä»¥staticå‡½æ•°çš„ä½œç”¨åŸŸæ˜¯æœ¬æºæ–‡ä»¶ï¼ŒæŠŠå®ƒæƒ³è±¡ä¸ºé¢å‘å¯¹è±¡ä¸­çš„privateå‡½æ•°å°±å¯ä»¥äº†ã€‚</strong></p><h2 id="PHPæºç çŸ¥è¯†"><a href="#PHPæºç çŸ¥è¯†" class="headerlink" title="PHPæºç çŸ¥è¯†"></a>PHPæºç çŸ¥è¯†</h2><h3 id="å®ï¼ˆMacroï¼‰"><a href="#å®ï¼ˆMacroï¼‰" class="headerlink" title="å®ï¼ˆMacroï¼‰"></a>å®ï¼ˆMacroï¼‰</h3><p>è®¡ç®—æœºç§‘å­¦é‡Œçš„å®æ˜¯ä¸€ç§æŠ½è±¡ï¼ˆAbstractionï¼‰ï¼Œå®ƒæ ¹æ®ä¸€ç³»åˆ—é¢„å®šä¹‰çš„è§„åˆ™æ›¿æ¢ä¸€å®šçš„æ–‡æœ¬æ¨¡å¼ã€‚è§£é‡Šå™¨æˆ–ç¼–è¯‘å™¨åœ¨é‡åˆ°å®æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œè¿™ä¸€æ¨¡å¼æ›¿æ¢ã€‚å…³äºå®çš„è¯¦ç»†è§£é‡Šï¼Œå¯ä»¥å‚è€ƒ<a href="https://blog.csdn.net/hanchaoman/article/details/8809951/" target="_blank" rel="noopener">è¿™é‡Œ</a></p><p>PHPæºç ä¸­å¤§é‡çš„ä½¿ç”¨å®å®šä¹‰ï¼ŒçŸ¥é“ä»¥ä¸‹å‡ ä¸ªå®ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç†è§£PHPæºç ã€‚</p><p><strong>EGå®ï¼š</strong>å­˜åœ¨äºzend_globals_macros.hä¸­ï¼Œzendæ‰§è¡Œå™¨ç›¸å…³çš„å…¨å±€å˜é‡executor_globalsï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Executor */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> EG(v) ZEND_TSRMG(executor_globals_id, zend_executor_globals *, v)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> EG(v) (executor_globals.v)</span></span><br><span class="line"><span class="keyword">extern</span> ZEND_API zend_executor_globals executor_globals;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p><strong>CGå®ï¼š</strong>å­˜åœ¨äºzend_globals_macros.hä¸­ï¼Œzendç¼–è¯‘å™¨ç›¸å…³çš„å…¨å±€å˜é‡compiler_globalsï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CG(v) ZEND_TSRMG(compiler_globals_id, zend_compiler_globals *, v)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CG(v) (compiler_globals.v)</span></span><br><span class="line"><span class="keyword">extern</span> ZEND_API <span class="class"><span class="keyword">struct</span> _<span class="title">zend_compiler_globals</span> <span class="title">compiler_globals</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="function">ZEND_API <span class="keyword">int</span> <span class="title">zendparse</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>PHP-named Zend macro wrappersï¼š</strong> ä½äºphp.hæ–‡ä»¶ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_FNZEND_FN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_MNZEND_MN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_NAMED_FUNCTIONZEND_NAMED_FUNCTION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_FUNCTIONZEND_FUNCTION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_METHOD  ZEND_METHOD</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_FEZEND_FE</span></span><br></pre></td></tr></table></figure><p><strong>Zend å®å®šä¹‰ï¼š</strong>ä½äºzend_API.hæ–‡ä»¶ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_FN(name) zif_##name</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_MN(name) zim_##name</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_NAMED_FUNCTION(name)void name(INTERNAL_FUNCTION_PARAMETERS)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_FUNCTION(name)ZEND_NAMED_FUNCTION(ZEND_FN(name))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_METHOD(classname, name)ZEND_NAMED_FUNCTION(ZEND_MN(classname##_##name))</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;â€‹    ä¹‹å‰çœ‹è¿‡ç½‘ä¸Šé›¶æ•£çš„å…³äºphp-fpmåˆ†æçš„æ–‡ç« ï¼Œè¦ä¹ˆä¸å…¨ï¼Œè¦ä¹ˆå°±æ˜¯è®²è§£php-fpmçš„é…ç½®æ–‡ä»¶çš„ï¼Œè¿˜æœ‰å°±æ˜¯è®²è§£nginxä¸php-fpmä¹‹é—´é€šä¿¡é…ç½®çš„ã€‚å…³äºphp-fpmä¸­çš„è¿›ç¨‹ç®¡ç†ã€ä¿¡å·ç®¡ç†ã€äº‹ä»¶å¤„ç†ã€æ—¶é’Ÿç®¡ç†ã€è¯·æ±‚å¤„ç†ç­‰å‡ ä¹ä¸ºé›¶ã€‚æ•…æœ¬ç€å­¦ä¹ çš„å®—æ—¨å¯¹fpmæºç è¿›è¡Œè§£è¯»ã€‚æœ¬ç³»åˆ—é‡‡ç”¨php-7.2.0ç‰ˆæœ¬ä¸­çš„php-fpmè¿›è¡Œåˆ†ç³»åˆ—è®²è§£ã€‚æœ¬ç³»åˆ—å…±åˆ†ä¸º5èŠ‚ï¼Œå…·ä½“å¦‚ä¸‹ï¼š&lt;/p&gt;
    
    </summary>
    
      <category term="php/fpm" scheme="http://xwxz.github.io/categories/php-fpm/"/>
    
    
      <category term="PHP" scheme="http://xwxz.github.io/tags/PHP/"/>
    
      <category term="æºç åˆ†æ" scheme="http://xwxz.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
      <category term="fpm" scheme="http://xwxz.github.io/tags/fpm/"/>
    
  </entry>
  
  <entry>
    <title>Cè¯­è¨€æŒ‡é’ˆè¯¦è§£ã€è½¬è½½ã€‘</title>
    <link href="http://xwxz.github.io/c-pointer-01/"/>
    <id>http://xwxz.github.io/c-pointer-01/</id>
    <published>2018-07-21T16:00:00.000Z</published>
    <updated>2019-09-18T12:18:15.726Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>â€‹    ä¸€ç›´å¯¹cè¯­è¨€æŒ‡é’ˆæœ‰ç§ææƒ§å¿ƒç†ï¼Œè§‰å¾—ç†è§£èµ·æ¥ç‰¹åˆ«è´¹åŠ²ï¼Œç›´åˆ°çœ‹åˆ°è¿™ç¯‡æ–‡ç« ï¼Œæ‰çªç„¶è§‰å¾—å¤§å­¦é‡Œcè¯­è¨€ç®€ç›´å‘äººã€‚</p><a id="more"></a> <h2 id="ä¸ºä»€ä¹ˆéœ€è¦æŒ‡é’ˆ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦æŒ‡é’ˆ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦æŒ‡é’ˆ?"></a>ä¸ºä»€ä¹ˆéœ€è¦æŒ‡é’ˆ?</h2><p>æŒ‡é’ˆè§£å†³äº†ä¸€äº›ç¼–ç¨‹ä¸­åŸºæœ¬çš„é—®é¢˜ã€‚</p><p>ç¬¬ä¸€ï¼ŒæŒ‡é’ˆçš„ä½¿ç”¨ä½¿å¾—ä¸åŒåŒºåŸŸçš„ä»£ç å¯ä»¥è½»æ˜“çš„å…±äº«å†…å­˜æ•°æ®ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡æ•°æ®çš„å¤åˆ¶è¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼Œä½†æ˜¯è¿™æ ·å¾€å¾€æ•ˆç‡ä¸å¤ªå¥½ï¼Œå› ä¸ºè¯¸å¦‚ç»“æ„ä½“ç­‰å¤§å‹æ•°æ®ï¼Œå ç”¨çš„å­—èŠ‚æ•°å¤šï¼Œå¤åˆ¶å¾ˆæ¶ˆè€—æ€§èƒ½ã€‚ä½†ä½¿ç”¨æŒ‡é’ˆå°±å¯ä»¥å¾ˆå¥½çš„é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºä»»ä½•ç±»å‹çš„æŒ‡é’ˆå ç”¨çš„å­—èŠ‚æ•°éƒ½æ˜¯ä¸€æ ·çš„ï¼ˆæ ¹æ®å¹³å°ä¸åŒï¼Œæœ‰4å­—èŠ‚æˆ–è€…8å­—èŠ‚æˆ–è€…å…¶ä»–å¯èƒ½ï¼‰ã€‚</p><p>ç¬¬äºŒï¼ŒæŒ‡é’ˆä½¿å¾—ä¸€äº›å¤æ‚çš„é“¾æ¥æ€§çš„æ•°æ®ç»“æ„çš„æ„å»ºæˆä¸ºå¯èƒ½ï¼Œæ¯”å¦‚é“¾è¡¨ï¼Œé“¾å¼äºŒå‰æ ‘ç­‰ç­‰ã€‚</p><p>ç¬¬ä¸‰ï¼Œæœ‰äº›æ“ä½œå¿…é¡»ä½¿ç”¨æŒ‡é’ˆã€‚å¦‚æ“ä½œç”³è¯·çš„å †å†…å­˜ã€‚è¿˜æœ‰ï¼šCè¯­è¨€ä¸­çš„ä¸€åˆ‡å‡½æ•°è°ƒç”¨ä¸­ï¼Œå€¼ä¼ é€’éƒ½æ˜¯â€œæŒ‰å€¼ä¼ é€’â€çš„ï¼Œå¦‚æœæˆ‘ä»¬è¦åœ¨å‡½æ•°ä¸­ä¿®æ”¹è¢«ä¼ é€’è¿‡æ¥çš„å¯¹è±¡ï¼Œå°±å¿…é¡»é€šè¿‡è¿™ä¸ªå¯¹è±¡çš„æŒ‡é’ˆæ¥å®Œæˆã€‚</p><h2 id="æŒ‡é’ˆæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æŒ‡é’ˆæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æŒ‡é’ˆæ˜¯ä»€ä¹ˆï¼Ÿ"></a>æŒ‡é’ˆæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>æˆ‘ä»¬æŒ‡çŸ¥é“ï¼šCè¯­è¨€ä¸­çš„æ•°ç»„æ˜¯æŒ‡ ä¸€ç±» ç±»å‹ï¼Œæ•°ç»„å…·ä½“åŒºåˆ†ä¸º  int ç±»å‹æ•°ç»„ï¼Œdoubleç±»å‹æ•°ç»„,charæ•°ç»„ ç­‰ç­‰ã€‚åŒæ ·æŒ‡é’ˆ è¿™ä¸ªæ¦‚å¿µä¹Ÿæ³›æŒ‡ ä¸€ç±» æ•°æ®ç±»å‹ï¼ŒintæŒ‡é’ˆç±»å‹ï¼ŒdoubleæŒ‡é’ˆç±»å‹ï¼ŒcharæŒ‡é’ˆç±»å‹ç­‰ç­‰ã€‚</p><p>é€šå¸¸ï¼Œæˆ‘ä»¬ç”¨intç±»å‹ä¿å­˜ä¸€äº›æ•´å‹çš„æ•°æ®ï¼Œå¦‚ int num = 97 ï¼Œ æˆ‘ä»¬ä¹Ÿä¼šç”¨charæ¥å­˜å‚¨å­—ç¬¦ï¼š char ch = â€˜aâ€™ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¿…é¡»çŸ¥é“ï¼šä»»ä½•ç¨‹åºæ•°æ®è½½å…¥å†…å­˜åï¼Œåœ¨å†…å­˜éƒ½æœ‰ä»–ä»¬çš„åœ°å€ï¼Œè¿™å°±æ˜¯æŒ‡é’ˆã€‚è€Œä¸ºäº†ä¿å­˜ä¸€ä¸ªæ•°æ®åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œæˆ‘ä»¬å°±éœ€è¦æŒ‡é’ˆå˜é‡ã€‚</p><p>å› æ­¤ï¼š<strong>æŒ‡é’ˆæ˜¯ç¨‹åºæ•°æ®åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œè€ŒæŒ‡é’ˆå˜é‡æ˜¯ç”¨æ¥ä¿å­˜è¿™äº›åœ°å€çš„å˜é‡ã€‚</strong></p><p> <img src="006tKfTcly1ftkpv5yfupj30bj03ugly.png" alt=""></p><h2 id="ä¸ºä»€ä¹ˆç¨‹åºä¸­çš„æ•°æ®ä¼šæœ‰è‡ªå·±çš„åœ°å€ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆç¨‹åºä¸­çš„æ•°æ®ä¼šæœ‰è‡ªå·±çš„åœ°å€ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆç¨‹åºä¸­çš„æ•°æ®ä¼šæœ‰è‡ªå·±çš„åœ°å€ï¼Ÿ"></a>ä¸ºä»€ä¹ˆç¨‹åºä¸­çš„æ•°æ®ä¼šæœ‰è‡ªå·±çš„åœ°å€ï¼Ÿ</h2><p>å¼„æ¸…è¿™ä¸ªé—®é¢˜æˆ‘ä»¬éœ€è¦ä»æ“ä½œç³»ç»Ÿçš„è§’åº¦å»è®¤çŸ¥å†…å­˜ã€‚</p><p>ç”µè„‘ç»´ä¿®å¸ˆå‚…çœ¼ä¸­çš„å†…å­˜æ˜¯è¿™æ ·çš„ï¼šå†…å­˜åœ¨ç‰©ç†ä¸Šæ˜¯ç”±ä¸€ç»„DRAMèŠ¯ç‰‡ç»„æˆçš„ã€‚</p><p>è€Œä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ï¼Œæˆ‘ä»¬ä¸éœ€è¦äº†è§£å†…å­˜çš„ç‰©ç†ç»“æ„ï¼Œæ“ä½œç³»ç»Ÿå°†RAMç­‰ç¡¬ä»¶å’Œè½¯ä»¶ç»“åˆèµ·æ¥ï¼Œç»™ç¨‹åºå‘˜æä¾›çš„ä¸€ç§å¯¹å†…å­˜ä½¿ç”¨çš„æŠ½è±¡ã€‚,è¿™ç§æŠ½è±¡æœºåˆ¶ä½¿å¾—ç¨‹åºä½¿ç”¨çš„æ˜¯è™šæ‹Ÿå­˜å‚¨å™¨,è€Œä¸æ˜¯ç›´æ¥æ“ä½œå’Œä½¿ç”¨çœŸå®å­˜åœ¨çš„ç‰©ç†å­˜å‚¨å™¨ã€‚æ‰€æœ‰çš„è™šæ‹Ÿåœ°å€å½¢æˆçš„é›†åˆå°±æ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚ </p><p><img src="006tNc79ly1ftk3cl2y2oj30j807g3zn.png" alt="img"></p><p>åœ¨ç¨‹åºå‘˜çœ¼ä¸­çš„å†…å­˜åº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·çš„ã€‚</p><p><img src="006tNc79ly1ftk3csnsi9j30gi037jr8.png" alt="img"></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå†…å­˜æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ï¼Œçº¿æ€§çš„å­—èŠ‚æ•°ç»„ï¼ˆå¹³å¦å¯»å€ï¼‰ã€‚æ¯ä¸€ä¸ªå­—èŠ‚éƒ½æ˜¯å›ºå®šçš„å¤§å°ï¼Œç”±8ä¸ªäºŒè¿›åˆ¶ä½ç»„æˆã€‚æœ€å…³é”®çš„æ˜¯ï¼Œæ¯ä¸€ä¸ªå­—èŠ‚éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·,ç¼–å·ä»0å¼€å§‹ï¼Œä¸€ç›´åˆ°æœ€åä¸€ä¸ªå­—èŠ‚ã€‚å¦‚ä¸Šå›¾ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ª256Mçš„å†…å­˜ï¼Œä»–ä¸€å…±æœ‰256x1024x1024  = 268435456ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå®ƒçš„åœ°å€èŒƒå›´å°±æ˜¯ 0 ~268435455  ã€‚</p><p><strong>ç”±äºå†…å­˜ä¸­çš„æ¯ä¸€ä¸ªå­—èŠ‚éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼Œå› æ­¤ï¼Œåœ¨ç¨‹åºä¸­ä½¿ç”¨çš„å˜é‡ï¼Œå¸¸é‡ï¼Œç”šè‡³æ•°å‡½æ•°ç­‰æ•°æ®ï¼Œå½“ä»–ä»¬è¢«è½½å…¥åˆ°å†…å­˜ä¸­åï¼Œéƒ½æœ‰è‡ªå·±å”¯ä¸€çš„ä¸€ä¸ªç¼–å·ï¼Œè¿™ä¸ªç¼–å·å°±æ˜¯è¿™ä¸ªæ•°æ®çš„åœ°å€ã€‚æŒ‡é’ˆå°±æ˜¯è¿™æ ·å½¢æˆçš„ã€‚</strong></p><p>ä¸‹é¢ç”¨ä»£ç è¯´æ˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> ch = <span class="string">'a'</span>;</span><br><span class="line">    <span class="keyword">int</span>  num = <span class="number">97</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"ch çš„åœ°å€:%p\n"</span>,&amp;ch);   <span class="comment">//ch çš„åœ°å€:0028FF47</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"numçš„åœ°å€:%p\n"</span>,&amp;num);  <span class="comment">//numçš„åœ°å€:0028FF40</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‡é’ˆçš„å€¼å®è´¨æ˜¯å†…å­˜å•å…ƒï¼ˆå³å­—èŠ‚ï¼‰çš„ç¼–å·ï¼Œæ‰€ä»¥æŒ‡é’ˆ å•ç‹¬ä»æ•°å€¼ä¸Šçœ‹ï¼Œä¹Ÿæ˜¯æ•´æ•°ï¼Œä»–ä»¬ä¸€èˆ¬ç”¨16è¿›åˆ¶è¡¨ç¤ºã€‚æŒ‡é’ˆçš„å€¼ï¼ˆè™šæ‹Ÿåœ°å€å€¼ï¼‰ä½¿ç”¨ä¸€ä¸ªæœºå™¨å­—çš„å¤§å°æ¥å­˜å‚¨,ä¹Ÿå°±æ˜¯è¯´,å¯¹äºä¸€ä¸ªæœºå™¨å­—ä¸ºwä½çš„ç”µè„‘è€Œè¨€,å®ƒçš„è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯0~2w ï¼ 1 ,ç¨‹åºæœ€å¤šèƒ½è®¿é—®2wä¸ªå­—èŠ‚ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆxpè¿™ç§32ä½ç³»ç»Ÿæœ€å¤§æ”¯æŒ4GBå†…å­˜çš„åŸå› äº†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å¤§è‡´ç”»å‡ºå˜é‡chå’Œnumåœ¨å†…å­˜æ¨¡å‹ä¸­çš„å­˜å‚¨ã€‚ï¼ˆå‡è®¾ charå 1ä¸ªå­—èŠ‚ï¼Œintå 4å­—èŠ‚ï¼‰</p><h2 id="å˜é‡å’Œå†…å­˜"><a href="#å˜é‡å’Œå†…å­˜" class="headerlink" title="å˜é‡å’Œå†…å­˜"></a>å˜é‡å’Œå†…å­˜</h2><p> ä¸ºäº†ç®€å•èµ·è§ï¼Œè¿™é‡Œå°±ç”¨ä¸Šé¢ä¾‹å­ä¸­çš„  int num = 97 è¿™ä¸ªå±€éƒ¨å˜é‡æ¥åˆ†æå˜é‡åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ¨¡å‹ã€‚</p><p>å·²çŸ¥ï¼šnumçš„ç±»å‹æ˜¯intï¼Œå ç”¨äº†4ä¸ªå­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼Œå…¶å€¼æ˜¯97ï¼Œåœ°å€æ˜¯0028FF40ã€‚æˆ‘ä»¬ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å»åˆ†æã€‚</p><p><strong>1ã€å†…å­˜çš„æ•°æ®</strong></p><pre><code>å†…å­˜çš„æ•°æ®å°±æ˜¯å˜é‡çš„å€¼å¯¹åº”çš„äºŒè¿›åˆ¶ï¼Œä¸€åˆ‡éƒ½æ˜¯äºŒè¿›åˆ¶ã€‚97çš„äºŒè¿›åˆ¶æ˜¯ : 00000000 00000000 00000000 0110000 , ä½†ä½¿ç”¨çš„**å°ç«¯æ¨¡å¼**å­˜å‚¨æ—¶ï¼Œä½ä½æ•°æ®å­˜æ”¾åœ¨ä½åœ°å€ï¼Œæ‰€ä»¥å›¾ä¸­ç”»çš„æ—¶å€™æ˜¯å€’è¿‡æ¥çš„ã€‚</code></pre><p><strong>2ã€å†…å­˜æ•°æ®çš„ç±»å‹</strong></p><pre><code>å†…å­˜çš„æ•°æ®ç±»å‹å†³å®šäº†è¿™ä¸ªæ•°æ®å ç”¨çš„å­—èŠ‚æ•°ï¼Œä»¥åŠè®¡ç®—æœºå°†å¦‚ä½•è§£é‡Šè¿™äº›å­—èŠ‚ã€‚numçš„ç±»å‹æ˜¯intï¼Œå› æ­¤å°†è¢«è§£é‡Šä¸º ä¸€ä¸ªæ•´æ•°ã€‚</code></pre><p><strong>3ã€å†…å­˜æ•°æ®çš„åç§°</strong></p><pre><code>å†…å­˜çš„åç§°å°±æ˜¯å˜é‡åã€‚å®è´¨ä¸Šï¼Œå†…å­˜æ•°æ®éƒ½æ˜¯ä»¥åœ°å€æ¥æ ‡è¯†çš„ï¼Œæ ¹æœ¬æ²¡æœ‰å†…å­˜çš„åç§°è¿™ä¸ªè¯´æ³•ï¼Œè¿™åªæ˜¯é«˜çº§è¯­è¨€æä¾›çš„æŠ½è±¡æœºåˆ¶ ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ“ä½œå†…å­˜æ•°æ®ã€‚è€Œä¸”åœ¨Cè¯­è¨€ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å†…å­˜æ•°æ®éƒ½æœ‰åç§°ï¼Œä¾‹å¦‚ä½¿ç”¨mallocç”³è¯·çš„å †å†…å­˜å°±æ²¡æœ‰ã€‚</code></pre><p><strong>4ã€å†…å­˜æ•°æ®çš„åœ°å€</strong></p><pre><code>å¦‚æœä¸€ä¸ªç±»å‹å ç”¨çš„å­—èŠ‚æ•°å¤§äº1ï¼Œåˆ™å…¶å˜é‡çš„åœ°å€å°±æ˜¯åœ°å€å€¼æœ€å°çš„é‚£ä¸ªå­—èŠ‚çš„åœ°å€ã€‚å› æ­¤numçš„åœ°å€æ˜¯ 0028FF40ã€‚ å†…å­˜çš„åœ°å€ç”¨äºæ ‡è¯†è¿™ä¸ªå†…å­˜å—ã€‚</code></pre><p><strong>5ã€å†…å­˜æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸ</strong></p><pre><code>numæ˜¯mainå‡½æ•°ä¸­çš„å±€éƒ¨å˜é‡ï¼Œå› æ­¤å½“mainå‡½æ•°è¢«å¯åŠ¨æ—¶ï¼Œå®ƒè¢«åˆ†é…äºæ ˆå†…å­˜ä¸Šï¼Œå½“mainæ‰§è¡Œç»“æŸæ—¶ï¼Œæ¶ˆäº¡ã€‚    </code></pre><p>å¦‚æœä¸€ä¸ªæ•°æ®ä¸€ç›´å ç”¨ç€ä»–çš„å†…å­˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯´ä»–æ˜¯â€œæ´»ç€çš„â€ï¼Œå¦‚æœä»–å ç”¨çš„å†…å­˜è¢«å›æ”¶äº†ï¼Œåˆ™è¿™ä¸ªæ•°æ®å°±â€œæ¶ˆäº¡äº†â€ã€‚Cè¯­è¨€ä¸­çš„ç¨‹åºæ•°æ®ä¼šæŒ‰ç…§ä»–ä»¬å®šä¹‰çš„ä½ç½®ï¼Œæ•°æ®çš„ç§ç±»ï¼Œä¿®é¥°çš„å…³é”®å­—ç­‰å› ç´ ï¼Œå†³å®šä»–ä»¬çš„ç”Ÿå‘½å‘¨æœŸç‰¹æ€§ã€‚å®è´¨ä¸Šæˆ‘ä»¬ç¨‹åºä½¿ç”¨çš„å†…å­˜ä¼šè¢«é€»è¾‘ä¸Šåˆ’åˆ†ä¸ºï¼š   æ ˆåŒºï¼Œå †åŒºï¼Œé™æ€æ•°æ®åŒºï¼Œæ–¹æ³•åŒºã€‚ä¸åŒçš„åŒºåŸŸçš„æ•°æ®æœ‰ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸã€‚</p><pre><code>æ— è®ºä»¥åè®¡ç®—æœºç¡¬ä»¶å¦‚ä½•å‘å±•ï¼Œå†…å­˜å®¹é‡éƒ½æ˜¯æœ‰é™çš„ï¼Œå› æ­¤æ¸…æ¥šç†è§£ç¨‹åºä¸­æ¯ä¸€ä¸ªç¨‹åºæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸæ˜¯éå¸¸é‡è¦çš„ã€‚æˆ‘ä¼šåœ¨ä»¥åçš„æ–‡ç« ä¸­å†å¯¹Cè¯­è¨€çš„å†…å­˜ç®¡ç†åšå‡ºä»‹ç»ï¼Œæ•¬è¯·æœŸå¾…ã€‚</code></pre><p>â€‹     </p><h2 id="æŒ‡é’ˆå˜é‡-å’Œ-æŒ‡å‘å…³ç³»"><a href="#æŒ‡é’ˆå˜é‡-å’Œ-æŒ‡å‘å…³ç³»" class="headerlink" title="æŒ‡é’ˆå˜é‡ å’Œ æŒ‡å‘å…³ç³»"></a>æŒ‡é’ˆå˜é‡ å’Œ æŒ‡å‘å…³ç³»</h2><p>ç”¨æ¥ä¿å­˜ æŒ‡é’ˆ çš„å˜é‡ï¼Œå°±æ˜¯æŒ‡é’ˆå˜é‡ã€‚å¦‚æœæŒ‡é’ˆå˜é‡p1ä¿å­˜äº†å˜é‡ numçš„åœ°å€ï¼Œåˆ™å°±è¯´ï¼šp1æŒ‡å‘äº†å˜é‡numï¼Œä¹Ÿå¯ä»¥è¯´p1æŒ‡å‘äº†numæ‰€åœ¨çš„å†…å­˜å— ï¼Œè¿™ç§æŒ‡å‘å…³ç³»ï¼Œåœ¨å›¾ä¸­ä¸€èˆ¬ç”¨ ç®­å¤´è¡¨ç¤ºã€‚</p><p> <img src="006tNc79ly1ftk3dmiyo0j30ln06tdg0.png" alt="img"></p><p>ä¸Šå›¾ä¸­ï¼ŒæŒ‡é’ˆå˜é‡p1æŒ‡å‘äº†numæ‰€åœ¨çš„å†…å­˜å— ï¼Œå³ä»åœ°å€0028FF40å¼€å§‹çš„4ä¸ªbyte çš„å†…å­˜å—ã€‚</p><p><strong>å®šä¹‰æŒ‡é’ˆå˜é‡</strong></p><p>Cè¯­è¨€ä¸­ï¼Œå®šä¹‰å˜é‡æ—¶ï¼Œåœ¨å˜é‡å å‰ å†™ä¸€ä¸ª * æ˜Ÿå·ï¼Œè¿™ä¸ªå˜é‡å°±å˜æˆäº†å¯¹åº”å˜é‡ç±»å‹çš„æŒ‡é’ˆå˜é‡ã€‚å¿…è¦æ—¶è¦åŠ ( ) æ¥é¿å…ä¼˜å…ˆçº§çš„é—®é¢˜ã€‚</p><p>å¼•ç”³ï¼šCè¯­è¨€ä¸­ï¼Œå®šä¹‰å˜é‡æ—¶ï¼Œåœ¨å®šä¹‰çš„æœ€å‰é¢å†™ä¸Štypedef ï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡åå°±æˆäº†ä¸€ç§ç±»å‹ï¼Œå³è¿™ä¸ªç±»å‹çš„åŒä¹‰è¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a ; <span class="comment">//intç±»å‹å˜é‡ a</span></span><br><span class="line"><span class="keyword">int</span> *a ; <span class="comment">//int* å˜é‡a</span></span><br><span class="line"><span class="keyword">int</span> arr[<span class="number">3</span>]; <span class="comment">//arræ˜¯åŒ…å«3ä¸ªintå…ƒç´ çš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">int</span> (* arr )[<span class="number">3</span>]; <span class="comment">//arræ˜¯ä¸€ä¸ªæŒ‡å‘åŒ…å«3ä¸ªintå…ƒç´ çš„æ•°ç»„çš„æŒ‡é’ˆå˜é‡</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------å„ç§ç±»å‹çš„æŒ‡é’ˆ------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>* p_int; <span class="comment">//æŒ‡å‘intç±»å‹å˜é‡çš„æŒ‡é’ˆ </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span>* p_double; <span class="comment">//æŒ‡å‘idoubleç±»å‹å˜é‡çš„æŒ‡é’ˆ </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Student</span> *<span class="title">p_struct</span>;</span> <span class="comment">//ç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>(*p_func)(<span class="keyword">int</span>,<span class="keyword">int</span>); <span class="comment">//æŒ‡å‘è¿”å›ç±»å‹ä¸ºintï¼Œæœ‰2ä¸ªintå½¢å‚çš„å‡½æ•°çš„æŒ‡é’ˆ </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>(*p_arr)[<span class="number">3</span>]; <span class="comment">//æŒ‡å‘å«æœ‰3ä¸ªintå…ƒç´ çš„æ•°ç»„çš„æŒ‡é’ˆ </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>** p_pointer; <span class="comment">//æŒ‡å‘ ä¸€ä¸ªæ•´å½¢å˜é‡æŒ‡é’ˆçš„æŒ‡é’ˆ</span></span><br></pre></td></tr></table></figure><p><strong>å–åœ°å€</strong></p><p>æ—¢ç„¶æœ‰äº†æŒ‡é’ˆå˜é‡ï¼Œé‚£å°±å¾—è®©ä»–ä¿å­˜å…¶å®ƒå˜é‡çš„åœ°å€ï¼Œä½¿ç”¨&amp; è¿ç®—ç¬¦å–å¾—ä¸€ä¸ªå˜é‡çš„åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a , <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num = <span class="number">97</span>;</span><br><span class="line">    <span class="keyword">float</span> score = <span class="number">10.00F</span>;</span><br><span class="line">    <span class="keyword">int</span> arr[<span class="number">3</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-----------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>* p_num = &amp;num;</span><br><span class="line">    <span class="keyword">float</span>* p_score = &amp;score;</span><br><span class="line">    <span class="keyword">int</span> (*p_arr)[<span class="number">3</span>] = &amp;arr;           </span><br><span class="line">    <span class="keyword">int</span> (*fp_add)(<span class="keyword">int</span> ,<span class="keyword">int</span> )  = add;  <span class="comment">//p_addæ˜¯æŒ‡å‘å‡½æ•°addçš„å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‰¹æ®Šçš„æƒ…å†µï¼Œä»–ä»¬å¹¶ä¸ä¸€å®šéœ€è¦ä½¿ç”¨&amp;å–åœ°å€ï¼š</p><ul><li>æ•°ç»„åçš„å€¼å°±æ˜¯è¿™ä¸ªæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ã€‚</li><li>å‡½æ•°åçš„å€¼å°±æ˜¯è¿™ä¸ªå‡½æ•°çš„åœ°å€ã€‚</li><li>å­—ç¬¦ä¸²å­—é¢å€¼å¸¸é‡ä½œä¸ºå³å€¼æ—¶ï¼Œå°±æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²å¯¹åº”çš„å­—ç¬¦æ•°ç»„çš„åç§°,ä¹Ÿå°±æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚ </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a , <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> arr[<span class="number">3</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">    <span class="comment">//-----------------------</span></span><br><span class="line">    <span class="keyword">int</span>* p_first = arr;</span><br><span class="line">    <span class="keyword">int</span> (*fp_add)(<span class="keyword">int</span> ,<span class="keyword">int</span> )  =  add;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* msg = <span class="string">"Hello world"</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£åœ°å€</strong></p><p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°æ®çš„æŒ‡é’ˆå˜é‡å¹²ä»€ä¹ˆï¼Ÿå½“ç„¶ä½¿ç”¨é€šè¿‡å®ƒæ¥æ“ä½œï¼ˆè¯»/å†™ï¼‰å®ƒæŒ‡å‘çš„æ•°æ®å•¦ã€‚å¯¹ä¸€ä¸ªæŒ‡é’ˆè§£åœ°å€ï¼Œå°±å¯ä»¥å–åˆ°è¿™ä¸ªå†…å­˜æ•°æ®ï¼Œè§£åœ°å€ çš„å†™æ³•ï¼Œå°±æ˜¯åœ¨æŒ‡é’ˆçš„å‰é¢åŠ ä¸€ä¸ª*å·ã€‚</p><p>è§£æŒ‡é’ˆçš„å®è´¨æ˜¯ï¼šä»æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜å—ä¸­å–å‡ºè¿™ä¸ªå†…å­˜æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> age = <span class="number">19</span>;</span><br><span class="line">    <span class="keyword">int</span>*p_age = &amp;age;</span><br><span class="line">    *p_age  = <span class="number">20</span>;  <span class="comment">//é€šè¿‡æŒ‡é’ˆä¿®æ”¹æŒ‡å‘çš„å†…å­˜æ•°æ®</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"age = %d\n"</span>,*p_age);   <span class="comment">//é€šè¿‡æŒ‡é’ˆè¯»å–æŒ‡å‘çš„å†…å­˜æ•°æ®</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"age = %d\n"</span>,age);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æŒ‡é’ˆä¹‹é—´çš„èµ‹å€¼</strong></p><p>æŒ‡é’ˆèµ‹å€¼å’Œintå˜é‡èµ‹å€¼ä¸€æ ·ï¼Œå°±æ˜¯å°†åœ°å€çš„å€¼æ‹·è´ç»™å¦å¤–ä¸€ä¸ªã€‚æŒ‡é’ˆä¹‹é—´çš„èµ‹å€¼æ˜¯ä¸€ç§æµ…æ‹·è´ï¼Œæ˜¯åœ¨å¤šä¸ªç¼–ç¨‹å•å…ƒä¹‹é—´å…±äº«å†…å­˜æ•°æ®çš„é«˜æ•ˆçš„æ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int* p1  = &amp; num;</span><br><span class="line">int* p3 = p1;</span><br><span class="line"></span><br><span class="line">//é€šè¿‡æŒ‡é’ˆ p1 ã€ p3 éƒ½å¯ä»¥å¯¹å†…å­˜æ•°æ® num è¿›è¡Œè¯»å†™ï¼Œå¦‚æœ2ä¸ªå‡½æ•°åˆ†åˆ«ä½¿ç”¨äº†p1 å’Œp3ï¼Œé‚£ä¹ˆè¿™2ä¸ªå‡½æ•°å°±å…±äº«äº†æ•°æ®numã€‚</span><br></pre></td></tr></table></figure><p><img src="006tNc79ly1ftk3ebder1j30p104v0st.png" alt="img"></p><p><strong>ç©ºæŒ‡é’ˆ</strong></p><p>æŒ‡å‘ç©ºï¼Œæˆ–è€…è¯´ä¸æŒ‡å‘ä»»ä½•ä¸œè¥¿ã€‚åœ¨Cè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬è®©æŒ‡é’ˆå˜é‡èµ‹å€¼ä¸ºNULLè¡¨ç¤ºä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œè€ŒCè¯­è¨€ä¸­ï¼ŒNULLå®è´¨æ˜¯ ((void*)0) ï¼Œ  åœ¨C++ä¸­ï¼ŒNULLå®è´¨æ˜¯0ã€‚</p><p>æ¢ç§è¯´æ³•ï¼šä»»ä½•ç¨‹åºæ•°æ®éƒ½ä¸ä¼šå­˜å‚¨åœ¨åœ°å€ä¸º0çš„å†…å­˜å—ä¸­ï¼Œå®ƒæ˜¯è¢«æ“ä½œç³»ç»Ÿé¢„ç•™çš„å†…å­˜å—ã€‚ </p><p>ä¸‹é¢ä»£ç æ‘˜è‡ª stdlib.h</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#ifdef __cplusplus</span><br><span class="line">     #define NULL    0</span><br><span class="line">#else    </span><br><span class="line">     #define NULL    ((void *)0)</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure><p> <strong>åæŒ‡é’ˆ</strong></p><p>æŒ‡é’ˆå˜é‡çš„å€¼æ˜¯NULLï¼Œæˆ–è€…æœªçŸ¥çš„åœ°å€å€¼ï¼Œæˆ–è€…æ˜¯å½“å‰åº”ç”¨ç¨‹åºä¸å¯è®¿é—®çš„åœ°å€å€¼ï¼Œè¿™æ ·çš„æŒ‡é’ˆå°±æ˜¯åæŒ‡é’ˆï¼Œä¸èƒ½å¯¹ä»–ä»¬åšè§£æŒ‡é’ˆæ“ä½œï¼Œå¦åˆ™ç¨‹åºä¼šå‡ºç°è¿è¡Œæ—¶é”™è¯¯ï¼Œå¯¼è‡´ç¨‹åºæ„å¤–ç»ˆæ­¢ã€‚</p><p>ä»»ä½•ä¸€ä¸ªæŒ‡é’ˆå˜é‡åœ¨åš è§£åœ°å€æ“ä½œå‰ï¼Œéƒ½å¿…é¡»ä¿è¯å®ƒæŒ‡å‘çš„æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ç”¨çš„å†…å­˜å—ï¼Œå¦åˆ™å°±ä¼šå‡ºé”™ã€‚åæŒ‡é’ˆæ˜¯é€ æˆCè¯­è¨€Bugçš„æœ€é¢‘ç¹çš„åŸå› ä¹‹ä¸€ã€‚ </p><p>ä¸‹é¢çš„ä»£ç å°±æ˜¯é”™è¯¯çš„ç¤ºä¾‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">opp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="keyword">int</span>*p = <span class="literal">NULL</span>;</span><br><span class="line">     *p = <span class="number">10</span>;      <span class="comment">//Oops! ä¸èƒ½å¯¹NULLè§£åœ°å€</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="keyword">int</span>*p;</span><br><span class="line">     *p = <span class="number">10</span>;      <span class="comment">//Oops! ä¸èƒ½å¯¹ä¸€ä¸ªæœªçŸ¥çš„åœ°å€è§£åœ°å€</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="keyword">int</span>*p = (<span class="keyword">int</span>*)<span class="number">1000</span>; </span><br><span class="line">     *p =<span class="number">10</span>;      <span class="comment">//Oops!   ä¸èƒ½å¯¹ä¸€ä¸ªå¯èƒ½ä¸å±äºæœ¬ç¨‹åºçš„å†…å­˜çš„åœ°å€çš„æŒ‡é’ˆè§£åœ°å€</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æŒ‡é’ˆçš„2ä¸ªé‡è¦å±æ€§"><a href="#æŒ‡é’ˆçš„2ä¸ªé‡è¦å±æ€§" class="headerlink" title="æŒ‡é’ˆçš„2ä¸ªé‡è¦å±æ€§"></a>æŒ‡é’ˆçš„2ä¸ªé‡è¦å±æ€§</h2><p>æŒ‡é’ˆä¹Ÿæ˜¯ä¸€ç§æ•°æ®ï¼ŒæŒ‡é’ˆå˜é‡ä¹Ÿæ˜¯ä¸€ç§å˜é‡ï¼Œå› æ­¤æŒ‡é’ˆ è¿™ç§æ•°æ®ä¹Ÿç¬¦åˆå‰é¢ å˜é‡å’Œå†…å­˜ ä¸»é¢˜ä¸­çš„ç‰¹æ€§ã€‚ è¿™é‡Œæˆ‘åªæƒ³å¼ºè°ƒ2ä¸ªå±æ€§ï¼š æŒ‡é’ˆçš„ç±»å‹ï¼ŒæŒ‡é’ˆçš„å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num = <span class="number">97</span>;</span><br><span class="line">    <span class="keyword">int</span> *p1  = &amp;num;</span><br><span class="line">    <span class="keyword">char</span>* p2 = (<span class="keyword">char</span>*)(&amp;num);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,*p1);    <span class="comment">//è¾“å‡º  97</span></span><br><span class="line">    <span class="built_in">putchar</span>(*p2);          <span class="comment">//è¾“å‡º  a</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‡é’ˆçš„å€¼ï¼šå¾ˆå¥½ç†è§£ï¼Œå¦‚ä¸Šé¢çš„num å˜é‡ ï¼Œå…¶åœ°å€çš„å€¼å°±æ˜¯0028FF40 ï¼Œå› æ­¤ p1çš„å€¼å°±æ˜¯0028FF40ã€‚æ•°æ®çš„åœ°å€ç”¨äºåœ¨å†…å­˜ä¸­å®šä½å’Œæ ‡è¯†è¿™ä¸ªæ•°æ®ï¼Œå› ä¸ºä»»ä½•2ä¸ªå†…å­˜ä¸é‡å çš„ä¸åŒæ•°æ®çš„åœ°å€éƒ½æ˜¯ä¸åŒçš„ã€‚</p><p>æŒ‡é’ˆçš„ç±»å‹ï¼šæŒ‡é’ˆçš„ç±»å‹å†³å®šäº†è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜çš„å­—èŠ‚æ•°å¹¶å¦‚ä½•è§£é‡Šè¿™äº›å­—èŠ‚ä¿¡æ¯ã€‚ä¸€èˆ¬æŒ‡é’ˆå˜é‡çš„ç±»å‹è¦å’Œå®ƒæŒ‡å‘çš„æ•°æ®çš„ç±»å‹åŒ¹é…ã€‚</p><p>ç”±äºnumçš„åœ°å€æ˜¯0028FF40ï¼Œå› æ­¤p1  å’Œ  p2çš„å€¼éƒ½æ˜¯0028FF40</p><p>*p1  :  å°†ä»åœ°å€0028FF40 å¼€å§‹è§£æï¼Œå› ä¸ºp1æ˜¯intç±»å‹æŒ‡é’ˆï¼Œintå 4å­—èŠ‚ï¼Œå› æ­¤å‘åè¿ç»­å–4ä¸ªå­—èŠ‚ï¼Œå¹¶å°†è¿™4ä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶æ•°æ®è§£æä¸ºä¸€ä¸ªæ•´æ•° 97ã€‚</p><p>*p2  :  å°†ä»åœ°å€0028FF40 å¼€å§‹è§£æï¼Œå› ä¸ºp2æ˜¯charç±»å‹æŒ‡é’ˆï¼Œcharå 1å­—èŠ‚ï¼Œå› æ­¤å‘åè¿ç»­å–1ä¸ªå­—èŠ‚ï¼Œå¹¶å°†è¿™1ä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶æ•°æ®è§£æä¸ºä¸€ä¸ªå­—ç¬¦ï¼Œå³â€™aâ€™ã€‚ </p><p>åŒæ ·çš„åœ°å€ï¼Œå› ä¸ºæŒ‡é’ˆçš„ç±»å‹ä¸åŒï¼Œå¯¹å®ƒæŒ‡å‘çš„å†…å­˜çš„è§£é‡Šå°±ä¸åŒï¼Œå¾—åˆ°çš„å°±æ˜¯ä¸åŒçš„æ•°æ®ã€‚</p><p><strong>void*ç±»å‹æŒ‡é’ˆ</strong> </p><p>ç”±äºvoidæ˜¯ç©ºç±»å‹ï¼Œå› æ­¤void<em>ç±»å‹çš„æŒ‡é’ˆåªä¿å­˜äº†æŒ‡é’ˆçš„å€¼ï¼Œè€Œä¸¢å¤±äº†ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬ä¸çŸ¥é“ä»–æŒ‡å‘çš„æ•°æ®æ˜¯ä»€ä¹ˆç±»å‹çš„ï¼ŒåªæŒ‡å®šè¿™ä¸ªæ•°æ®åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€ï¼Œå¦‚æœæƒ³è¦å®Œæ•´çš„æå–æŒ‡å‘çš„æ•°æ®ï¼Œç¨‹åºå‘˜å°±å¿…é¡»å¯¹è¿™ä¸ªæŒ‡é’ˆåšå‡ºæ­£ç¡®çš„ç±»å‹è½¬æ¢ï¼Œç„¶åå†è§£æŒ‡é’ˆã€‚å› ä¸ºï¼Œç¼–è¯‘å™¨ä¸å…è®¸ç›´æ¥å¯¹void</em>ç±»å‹çš„æŒ‡é’ˆåšè§£æŒ‡é’ˆæ“ä½œã€‚</p><h2 id="ç»“æ„ä½“å’ŒæŒ‡é’ˆ"><a href="#ç»“æ„ä½“å’ŒæŒ‡é’ˆ" class="headerlink" title="ç»“æ„ä½“å’ŒæŒ‡é’ˆ"></a>ç»“æ„ä½“å’ŒæŒ‡é’ˆ</h2><p>ç»“æ„ä½“æŒ‡é’ˆæœ‰ç‰¹æ®Šçš„è¯­æ³•ï¼š  -&gt; ç¬¦å· </p><p>å¦‚æœpæ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆï¼Œåˆ™å¯ä»¥ä½¿ç”¨ p -&gt;ã€æˆå‘˜ã€‘ çš„æ–¹æ³•è®¿é—®ç»“æ„ä½“çš„æˆå‘˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">31</span>];</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">float</span> score;</span><br><span class="line">&#125;Student;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Student stu = &#123;<span class="string">"Bob"</span> , <span class="number">19</span>, <span class="number">98.0</span>&#125;;</span><br><span class="line">    Student*ps = &amp;stu;</span><br><span class="line"></span><br><span class="line">    ps-&gt;age = <span class="number">20</span>;</span><br><span class="line">    ps-&gt;score = <span class="number">99.0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"name:%s age:%d\n"</span>,ps-&gt;name,ps-&gt;age);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ•°ç»„å’ŒæŒ‡é’ˆ"><a href="#æ•°ç»„å’ŒæŒ‡é’ˆ" class="headerlink" title="æ•°ç»„å’ŒæŒ‡é’ˆ"></a>æ•°ç»„å’ŒæŒ‡é’ˆ</h2><p>1ã€æ•°ç»„åä½œä¸ºå³å€¼çš„æ—¶å€™ï¼Œå°±æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> arr[<span class="number">3</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span>*p_first = arr;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,*p_first);  <span class="comment">//1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2ã€æŒ‡å‘æ•°ç»„å…ƒç´ çš„æŒ‡é’ˆ æ”¯æŒ é€’å¢ é€’å‡ è¿ç®—ã€‚ï¼ˆå®è´¨ä¸Šæ‰€æœ‰æŒ‡é’ˆéƒ½æ”¯æŒé€’å¢é€’å‡ è¿ç®— ï¼Œä½†åªæœ‰åœ¨æ•°ç»„ä¸­ä½¿ç”¨æ‰æ˜¯æœ‰æ„ä¹‰çš„ï¼‰ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> arr[<span class="number">3</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span>*p = arr;</span><br><span class="line">    <span class="keyword">for</span>(;p!=arr+<span class="number">3</span>;p++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,*p); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3ã€p= p+1 æ„æ€æ˜¯ï¼Œè®©pæŒ‡å‘åŸæ¥æŒ‡å‘çš„å†…å­˜å—çš„ä¸‹ä¸€ä¸ªç›¸é‚»çš„ç›¸åŒç±»å‹çš„å†…å­˜å—ã€‚</p><pre><code>åŒä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå…ƒç´ çš„æŒ‡é’ˆä¹‹é—´å¯ä»¥åšå‡æ³•è¿ç®—ï¼Œæ­¤æ—¶ï¼ŒæŒ‡é’ˆä¹‹å·®ç­‰äºä¸‹æ ‡ä¹‹å·®ã€‚</code></pre><p>4ã€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p[n]    == *(p+n)</span><br><span class="line">p[n][m] == *(*(p+n)+ m )</span><br></pre></td></tr></table></figure><p> 5ã€å½“å¯¹æ•°ç»„åä½¿ç”¨sizeofæ—¶ï¼Œè¿”å›çš„æ˜¯æ•´ä¸ªæ•°ç»„å ç”¨çš„å†…å­˜å­—èŠ‚æ•°ã€‚å½“æŠŠæ•°ç»„åèµ‹å€¼ç»™ä¸€ä¸ªæŒ‡é’ˆåï¼Œå†å¯¹æŒ‡é’ˆä½¿ç”¨sizeofè¿ç®—ç¬¦ï¼Œè¿”å›çš„æ˜¯æŒ‡é’ˆçš„å¤§å°ã€‚ </p><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¹ˆå°†ä¸€ä¸ªæ•°ç»„ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œéœ€è¦å¦å¤–ç”¨ä¸€ä¸ªå‚æ•°ä¼ é€’æ•°ç»„å…ƒç´ ä¸ªæ•°çš„åŸå› äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> arr[<span class="number">3</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span>*p = arr;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"sizeof(arr)=%d\n"</span>,<span class="keyword">sizeof</span>(arr));  <span class="comment">//sizeof(arr)=12</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"sizeof(p)=%d\n"</span>,<span class="keyword">sizeof</span>(p));   <span class="comment">//sizeof(p)=4</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‡½æ•°å’ŒæŒ‡é’ˆ"><a href="#å‡½æ•°å’ŒæŒ‡é’ˆ" class="headerlink" title="å‡½æ•°å’ŒæŒ‡é’ˆ"></a>å‡½æ•°å’ŒæŒ‡é’ˆ</h2><p><strong>å‡½æ•°çš„å‚æ•°å’ŒæŒ‡é’ˆ</strong></p><p>Cè¯­è¨€ä¸­ï¼Œå®å‚ä¼ é€’ç»™å½¢å‚ï¼Œæ˜¯æŒ‰å€¼ä¼ é€’çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‡½æ•°ä¸­çš„å½¢å‚æ˜¯å®å‚çš„æ‹·è´ä»½ï¼Œå½¢å‚å’Œå®å‚åªæ˜¯åœ¨å€¼ä¸Šé¢ä¸€æ ·ï¼Œè€Œä¸æ˜¯åŒä¸€ä¸ªå†…å­˜æ•°æ®å¯¹è±¡ã€‚è¿™å°±æ„å‘³ç€ï¼šè¿™ç§æ•°æ®ä¼ é€’æ˜¯å•å‘çš„ï¼Œå³ä»è°ƒç”¨è€…ä¼ é€’ç»™è¢«è°ƒå‡½æ•°ï¼Œè€Œè¢«è°ƒå‡½æ•°æ— æ³•ä¿®æ”¹ä¼ é€’çš„å‚æ•°è¾¾åˆ°å›ä¼ çš„æ•ˆæœã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    a++;      <span class="comment">//åœ¨å‡½æ•°ä¸­æ”¹å˜çš„åªæ˜¯è¿™ä¸ªå‡½æ•°çš„å±€éƒ¨å˜é‡aï¼Œè€Œéšç€å‡½æ•°æ‰§è¡Œç»“æŸï¼Œaè¢«é”€æ¯ã€‚ageè¿˜æ˜¯åŸæ¥çš„ageï¼Œçº¹ä¸ä¸åŠ¨ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> age = <span class="number">19</span>;</span><br><span class="line">    change(age);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"age = %d\n"</span>,age);   <span class="comment">// age = 19</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‡½æ•°çš„è¿”å›å€¼æ¥å›ä¼ æ•°æ®ï¼Œåœ¨ç®€å•çš„æƒ…å†µä¸‹æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å¦‚æœè¿”å›å€¼æœ‰å…¶å®ƒç”¨é€”ï¼ˆä¾‹å¦‚è¿”å›å‡½æ•°çš„æ‰§è¡ŒçŠ¶æ€é‡ï¼‰ï¼Œæˆ–è€…è¦å›ä¼ çš„æ•°æ®ä¸æ­¢ä¸€ä¸ªï¼Œè¿”å›å€¼å°±è§£å†³ä¸äº†äº†ã€‚</p><p>ä¼ é€’å˜é‡çš„æŒ‡é’ˆå¯ä»¥è½»æ¾è§£å†³ä¸Šè¿°é—®é¢˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span>* pa)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    (*pa)++;   <span class="comment">//å› ä¸ºä¼ é€’çš„æ˜¯ageçš„åœ°å€ï¼Œå› æ­¤paæŒ‡å‘å†…å­˜æ•°æ®ageã€‚å½“åœ¨å‡½æ•°ä¸­å¯¹æŒ‡é’ˆpaè§£åœ°å€æ—¶ï¼Œ</span></span><br><span class="line">               <span class="comment">//ä¼šç›´æ¥å»å†…å­˜ä¸­æ‰¾åˆ°ageè¿™ä¸ªæ•°æ®ï¼Œç„¶åæŠŠå®ƒå¢1ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> age = <span class="number">19</span>;</span><br><span class="line">    change(&amp;age);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"age = %d\n"</span>,age);   <span class="comment">// age = 20</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¥ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„ï¼Œç”¨å‡½æ•°äº¤æ¢2ä¸ªå˜é‡çš„å€¼çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap_bad</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap_ok</span><span class="params">(<span class="keyword">int</span>*pa,<span class="keyword">int</span>*pb)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">3</span>;</span><br><span class="line">    swap_bad(a,b);       <span class="comment">//Can`t swap;</span></span><br><span class="line">    swap_ok(&amp;a,&amp;b);      <span class="comment">//OK</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é”™è¯¯çš„å†™æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap_bad</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> t;</span><br><span class="line">    t=a;</span><br><span class="line">    a=b;</span><br><span class="line">    b=t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ­£ç¡®çš„å†™æ³•ï¼šé€šè¿‡æŒ‡é’ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap_ok</span><span class="params">(<span class="keyword">int</span>*pa,<span class="keyword">int</span>*pb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> t;</span><br><span class="line">    t=*pa;</span><br><span class="line">    *pa=*pb;</span><br><span class="line">    *pb=t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="006tNc79ly1ftk3c02qu7j30ex087jrn.png" alt="img"></p><p><img src="006tNc79ly1ftk3br7ffij30es07qwep.png" alt="img"></p><p>æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡æŒ‡é’ˆä¼ é€’æ•°æ®ç»™å‡½æ•°ä¸æ˜¯ä¸ºäº†åœ¨å‡½æ•°ä¸­æ”¹å˜ä»–æŒ‡å‘çš„å¯¹è±¡ï¼Œç›¸åï¼Œæˆ‘ä»¬é˜²æ­¢è¿™ä¸ªç›®æ ‡æ•°æ®è¢«æ”¹å˜ã€‚ä¼ é€’æŒ‡é’ˆåªæ˜¯ä¸ºäº†é¿å…æ‹·è´å¤§å‹æ•°æ®ã€‚</p><p>è€ƒè™‘ä¸€ä¸ªç»“æ„ä½“ç±»å‹Studentã€‚æˆ‘ä»¬é€šè¿‡showå‡½æ•°è¾“å‡ºStudentå˜é‡çš„æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">31</span>];</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">float</span> score;</span><br><span class="line">&#125;Student;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰“å°Studentå˜é‡ä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">const</span> Student * ps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"name:%s , age:%d , score:%.2f\n"</span>,ps-&gt;name,ps-&gt;age,ps-&gt;score);   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åªæ˜¯åœ¨showå‡½æ•°ä¸­å–è¯»Studentå˜é‡çš„ä¿¡æ¯ï¼Œè€Œä¸ä¼šå»ä¿®æ”¹å®ƒï¼Œä¸ºäº†é˜²æ­¢æ„å¤–ä¿®æ”¹ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å¸¸é‡æŒ‡é’ˆå»çº¦æŸã€‚å¦å¤–æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æŒ‡é’ˆè€Œä¸æ˜¯ç›´æ¥ä¼ é€’Studentå˜é‡å‘¢ï¼Ÿ</p><p>ä»å®šä¹‰çš„ç»“æ„çœ‹å‡ºï¼ŒStudentå˜é‡çš„å¤§å°è‡³å°‘æ˜¯39ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆé€šè¿‡å‡½æ•°ç›´æ¥ä¼ é€’å˜é‡ï¼Œå®å‚èµ‹å€¼æ•°æ®ç»™å½¢å‚éœ€è¦æ‹·è´è‡³å°‘39ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œæä¸é«˜æ•ˆã€‚è€Œä¼ é€’å˜é‡çš„æŒ‡é’ˆå´å¿«å¾ˆå¤šï¼Œå› ä¸ºåœ¨åŒä¸€ä¸ªå¹³å°ä¸‹ï¼Œæ— è®ºä»€ä¹ˆç±»å‹çš„æŒ‡é’ˆå¤§å°éƒ½æ˜¯å›ºå®šçš„ï¼šX86æŒ‡é’ˆ4å­—èŠ‚ï¼ŒX64æŒ‡é’ˆ8å­—èŠ‚ï¼Œè¿œè¿œæ¯”ä¸€ä¸ªStudentç»“æ„ä½“å˜é‡å°ã€‚</p><p><strong>å‡½æ•°çš„æŒ‡é’ˆ</strong></p><p>æ¯ä¸€ä¸ªå‡½æ•°æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§ç¨‹åºæ•°æ®ï¼Œä¸€ä¸ªå‡½æ•°åŒ…å«äº†å¤šæ¡æ‰§è¡Œè¯­å¥ï¼Œå®ƒè¢«ç¼–è¯‘åï¼Œå®è´¨ä¸Šæ˜¯å¤šæ¡æœºå™¨æŒ‡ä»¤çš„åˆé›†ã€‚åœ¨ç¨‹åºè½½å…¥åˆ°å†…å­˜åï¼Œå‡½æ•°çš„æœºå™¨æŒ‡ä»¤å­˜æ”¾åœ¨ä¸€ä¸ªç‰¹å®šçš„é€»è¾‘åŒºåŸŸï¼šä»£ç åŒºã€‚æ—¢ç„¶æ˜¯å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œé‚£ä¹ˆå‡½æ•°ä¹Ÿæ˜¯æœ‰è‡ªå·±çš„æŒ‡é’ˆçš„ã€‚</p><p>Cè¯­è¨€ä¸­ï¼Œå‡½æ•°åä½œä¸ºå³å€¼æ—¶ï¼Œå°±æ˜¯è¿™ä¸ªå‡½æ•°çš„æŒ‡é’ˆã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>,msg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span>(*p)(<span class="keyword">const</span> <span class="keyword">char</span>*) = echo;   <span class="comment">//å‡½æ•°æŒ‡é’ˆå˜é‡æŒ‡å‘echoè¿™ä¸ªå‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    p(<span class="string">"Hello "</span>);      <span class="comment">//é€šè¿‡å‡½æ•°çš„æŒ‡é’ˆpè°ƒç”¨å‡½æ•°ï¼Œç­‰ä»·äºecho("Hello ")</span></span><br><span class="line">    echo(<span class="string">"World\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="const-å’Œ-æŒ‡é’ˆ"><a href="#const-å’Œ-æŒ‡é’ˆ" class="headerlink" title="const å’Œ æŒ‡é’ˆ"></a>const å’Œ æŒ‡é’ˆ</h2><p>conståˆ°åº•ä¿®é¥°è°ï¼Ÿè°æ‰æ˜¯ä¸å˜çš„ï¼Ÿ</p><p>ä¸‹é¢æ˜¯æˆ‘æ€»ç»“çš„ç»éªŒï¼Œåˆ†äº«ä¸€ä¸‹ã€‚</p><p>å¦‚æœconst åé¢æ˜¯ä¸€ä¸ªç±»å‹ï¼Œåˆ™è·³è¿‡æœ€è¿‘çš„åŸå­ç±»å‹ï¼Œä¿®é¥°åé¢çš„æ•°æ®ã€‚ï¼ˆåŸå­ç±»å‹æ˜¯ä¸å¯å†åˆ†å‰²çš„ç±»å‹ï¼Œå¦‚int, short , charï¼Œä»¥åŠtypedefåŒ…è£…åçš„ç±»å‹ï¼‰</p><p>å¦‚æœconståé¢å°±æ˜¯ä¸€ä¸ªæ•°æ®ï¼Œåˆ™ç›´æ¥ä¿®é¥°è¿™ä¸ªæ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">const</span> *p1 = &amp;a;        <span class="comment">//conståé¢æ˜¯*p1ï¼Œå®è´¨æ˜¯æ•°æ®aï¼Œåˆ™ä¿®é¥°*p1ï¼Œé€šè¿‡p1ä¸èƒ½ä¿®æ”¹açš„å€¼</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span>*p2 =  &amp;a;        <span class="comment">//conståé¢æ˜¯intç±»å‹ï¼Œåˆ™è·³è¿‡int ï¼Œä¿®é¥°*p2ï¼Œ æ•ˆæœåŒä¸Š</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>* <span class="keyword">const</span> p3 = <span class="literal">NULL</span>;      <span class="comment">//conståé¢æ˜¯æ•°æ®p3ã€‚ä¹Ÿå°±æ˜¯æŒ‡é’ˆp3æœ¬èº«æ˜¯const .</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span>* <span class="keyword">const</span> p4 = &amp;a;  <span class="comment">// é€šè¿‡p4ä¸èƒ½æ”¹å˜a çš„å€¼ï¼ŒåŒæ—¶p4æœ¬èº«ä¹Ÿæ˜¯ const</span></span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">const</span>* <span class="keyword">const</span> p5 = &amp;a;  <span class="comment">//æ•ˆæœåŒä¸Š</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span>* <span class="keyword">pint_t</span>;  <span class="comment">//å°† int* ç±»å‹ åŒ…è£…ä¸º pint_t,åˆ™pint_t ç°åœ¨æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŸå­ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">int</span> a  = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">pint_t</span> p1 = &amp;a;  <span class="comment">//åŒæ ·ï¼Œconstè·³è¿‡ç±»å‹pint_tï¼Œä¿®é¥°p1ï¼ŒæŒ‡é’ˆp1æœ¬èº«æ˜¯const</span></span><br><span class="line">    <span class="keyword">pint_t</span> <span class="keyword">const</span> p2 = &amp;a;  <span class="comment">//const ç›´æ¥ä¿®é¥°pï¼ŒåŒä¸Š</span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ·±æ‹·è´å’Œæµ…æ‹·è´"><a href="#æ·±æ‹·è´å’Œæµ…æ‹·è´" class="headerlink" title="æ·±æ‹·è´å’Œæµ…æ‹·è´"></a>æ·±æ‹·è´å’Œæµ…æ‹·è´</h2><p>å¦‚æœ2ä¸ªç¨‹åºå•å…ƒï¼ˆä¾‹å¦‚2ä¸ªå‡½æ•°ï¼‰æ˜¯é€šè¿‡æ‹·è´ ä»–ä»¬æ‰€å…±äº«çš„æ•°æ®çš„ æŒ‡é’ˆæ¥å·¥ä½œçš„ï¼Œè¿™å°±æ˜¯æµ…æ‹·è´ï¼Œå› ä¸ºçœŸæ­£è¦è®¿é—®çš„æ•°æ®å¹¶æ²¡æœ‰è¢«æ‹·è´ã€‚å¦‚æœè¢«è®¿é—®çš„æ•°æ®è¢«æ‹·è´äº†ï¼Œåœ¨æ¯ä¸ªå•å…ƒä¸­éƒ½æœ‰è‡ªå·±çš„ä¸€ä»½ï¼Œå¯¹ç›®æ ‡æ•°æ®çš„æ“ä½œç›¸äº’ ä¸å—å½±å“ï¼Œåˆ™å«åšæ·±æ‹·è´ã€‚ <img src="006tNc79ly1ftk3bhux9vj30ov07z3z1.png" alt="img"></p><h2 id="é™„åŠ çŸ¥è¯†"><a href="#é™„åŠ çŸ¥è¯†" class="headerlink" title="é™„åŠ çŸ¥è¯†"></a>é™„åŠ çŸ¥è¯†</h2><p><strong>æŒ‡é’ˆå’Œå¼•ç”¨è¿™ä¸ª2ä¸ªåè¯çš„åŒºåˆ«</strong>ã€‚ä»–ä»¬æœ¬è´¨ä¸Šæ¥è¯´æ˜¯åŒæ ·çš„ä¸œè¥¿ã€‚æŒ‡é’ˆå¸¸ç”¨åœ¨Cè¯­è¨€ä¸­ï¼Œè€Œå¼•ç”¨ï¼Œåˆ™ç”¨äºè¯¸å¦‚Javaï¼ŒC#ç­‰ åœ¨è¯­è¨€å±‚é¢å°è£…äº†å¯¹æŒ‡é’ˆçš„ç›´æ¥æ“ä½œçš„ç¼–ç¨‹è¯­è¨€ä¸­ã€‚</p><p><strong>å¤§ç«¯æ¨¡å¼å’Œå°ç«¯æ¨¡å¼</strong></p><p>1) Little-Endianå°±æ˜¯ä½ä½å­—èŠ‚æ’æ”¾åœ¨å†…å­˜çš„ä½åœ°å€ç«¯ï¼Œé«˜ä½å­—èŠ‚æ’æ”¾åœ¨å†…å­˜çš„é«˜åœ°å€ç«¯ã€‚ä¸ªäººPCå¸¸ç”¨ï¼ŒIntel X86å¤„ç†å™¨æ˜¯å°ç«¯æ¨¡å¼ã€‚</p><p>2) B i g-Endianå°±æ˜¯é«˜ä½å­—èŠ‚æ’æ”¾åœ¨å†…å­˜çš„ä½åœ°å€ç«¯ï¼Œä½ä½å­—èŠ‚æ’æ”¾åœ¨å†…å­˜çš„é«˜åœ°å€ç«¯ã€‚</p><p>é‡‡ç”¨å¤§ç«¯æ–¹å¼ è¿›è¡Œæ•°æ®å­˜æ”¾ç¬¦åˆäººç±»çš„æ­£å¸¸æ€ç»´ï¼Œè€Œé‡‡ç”¨å°ç«¯æ–¹å¼è¿›è¡Œæ•°æ®å­˜æ”¾åˆ©äºè®¡ç®—æœºå¤„ç†ã€‚æœ‰äº›æœºå™¨åŒæ—¶æ”¯æŒå¤§ç«¯å’Œå°ç«¯æ¨¡å¼,é€šè¿‡é…ç½®æ¥è®¾å®šå®é™…çš„ç«¯æ¨¡å¼ã€‚</p><p>å‡å¦‚ shortç±»å‹å ç”¨2ä¸ªå­—èŠ‚ï¼Œä¸”å­˜å‚¨çš„åœ°å€ä¸º0x30ã€‚</p><p>short a = 1;</p><p>å¦‚ä¸‹å›¾ï¼š</p><p> <img src="006tNc79ly1ftk3b0tdykj307x03umx0.png" alt=""></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//æµ‹è¯•æœºå™¨ä½¿ç”¨çš„æ˜¯å¦ä¸ºå°ç«¯æ¨¡å¼ã€‚æ˜¯ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</span></span><br><span class="line"><span class="comment">//è¿™ä¸ªæ–¹æ³•åˆ¤åˆ«çš„ä¾æ®å°±æ˜¯ï¼šCè¯­è¨€ä¸­ä¸€ä¸ªå¯¹è±¡çš„åœ°å€å°±æ˜¯è¿™ä¸ªå¯¹è±¡å ç”¨çš„å­—èŠ‚ä¸­ï¼Œåœ°å€å€¼æœ€å°çš„é‚£ä¸ªå­—èŠ‚çš„åœ°å€ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isSmallIndain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">int</span> val = <span class="string">'A'</span>;</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">char</span>* p = (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)&amp;val;  <span class="comment">//C/C++ï¼šå¯¹äºå¤šå­—èŠ‚æ•°æ®ï¼Œå–åœ°å€æ˜¯å–çš„æ•°æ®å¯¹è±¡çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯æ•°æ®çš„ä½åœ°å€</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> *p == <span class="string">'A'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬ç¯‡æ–‡ç« è½¬è½½è‡ªåšå®¢å›­ï¼Œ<a href="https://www.cnblogs.com/lulipro/p/7460206.html" target="_blank" rel="noopener">åŸæ–‡</a> éå¸¸æ„Ÿè°¢åŸä½œè€…çš„ç²¾å½©è®²è§£ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;â€‹    ä¸€ç›´å¯¹cè¯­è¨€æŒ‡é’ˆæœ‰ç§ææƒ§å¿ƒç†ï¼Œè§‰å¾—ç†è§£èµ·æ¥ç‰¹åˆ«è´¹åŠ²ï¼Œç›´åˆ°çœ‹åˆ°è¿™ç¯‡æ–‡ç« ï¼Œæ‰çªç„¶è§‰å¾—å¤§å­¦é‡Œcè¯­è¨€ç®€ç›´å‘äººã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="c/pointer/01" scheme="http://xwxz.github.io/categories/c-pointer-01/"/>
    
    
      <category term="æŒ‡é’ˆ" scheme="http://xwxz.github.io/tags/%E6%8C%87%E9%92%88/"/>
    
      <category term="Cè¯­è¨€" scheme="http://xwxz.github.io/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>mallocå‡½æ•°è¯¦è§£ã€è½¬è½½ã€‘</title>
    <link href="http://xwxz.github.io/c-malloc-01/"/>
    <id>http://xwxz.github.io/c-malloc-01/</id>
    <published>2018-07-21T16:00:00.000Z</published>
    <updated>2019-03-05T08:46:50.457Z</updated>
    
    <content type="html"><![CDATA[<p>â€‹    å¾ˆå¤šå­¦è¿‡Cçš„äººå¯¹mallocéƒ½ä¸æ˜¯å¾ˆäº†è§£ï¼ŒçŸ¥é“ä½¿ç”¨mallocè¦åŠ å¤´æ–‡ä»¶,çŸ¥é“mallocæ˜¯åˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜ï¼ŒçŸ¥é“å’Œfreeå‡½æ•°æ˜¯ä¸€èµ·ç”¨çš„ã€‚ä½†æ˜¯ä½†æ˜¯ï¼šä¸€éƒ¨åˆ†äººè¿˜æ˜¯å°†ï¼šmallocå½“ä½œç³»ç»Ÿæ‰€æä¾›çš„æˆ–è€…æ˜¯Cçš„å…³é”®å­—ï¼Œäº‹å®ä¸Šï¼šmallocåªæ˜¯Cæ ‡å‡†åº“ä¸­æä¾›çš„ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼Œè€Œä¸”å¾ˆå¤šå¾ˆå¤šäººéƒ½å¯¹mallocçš„å…·ä½“å®ç°æœºåˆ¶ä¸æ˜¯å¾ˆäº†è§£ã€‚</p><a id="more"></a><h1 id="1-malloc"><a href="#1-malloc" class="headerlink" title="1 malloc"></a>1 malloc</h1><h2 id="1-1-å…³äºmallocä»¥åŠç›¸å…³çš„å‡ ä¸ªå‡½æ•°"><a href="#1-1-å…³äºmallocä»¥åŠç›¸å…³çš„å‡ ä¸ªå‡½æ•°" class="headerlink" title="1.1 å…³äºmallocä»¥åŠç›¸å…³çš„å‡ ä¸ªå‡½æ•°"></a>1.1 å…³äºmallocä»¥åŠç›¸å…³çš„å‡ ä¸ªå‡½æ•°</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">calloc</span><span class="params">(<span class="keyword">size_t</span> nmemb, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">realloc</span><span class="params">(<span class="keyword">void</span> *ptr, <span class="keyword">size_t</span> size)</span></span>;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥è¿™æ ·è®¤ä¸ºï¼ˆwindowä¸‹ï¼‰åŸå‹ï¼š<code>extern void *malloc(unsigned int num_bytes);</code></p><p>å¤´æ–‡ä»¶ï¼š<code>#include &lt;malloc.h&gt;</code>æˆ–è€…<code>#include &lt;alloc.h&gt;</code>ä¸¤è€…çš„å†…å®¹æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚</p><p>å¦‚æœåˆ†é…æˆåŠŸï¼šåˆ™è¿”å›æŒ‡å‘è¢«åˆ†é…å†…å­˜ç©ºé—´çš„æŒ‡é’ˆ</p><p>ä¸ç„¶ï¼Œè¿”å›ç©ºæŒ‡é’ˆNULLã€‚</p><p>åŒæ—¶ï¼Œå½“å†…å­˜ä¸å†ä½¿ç”¨çš„æ—¶å€™ï¼Œåº”ä½¿ç”¨freeï¼ˆï¼‰å‡½æ•°å°†å†…å­˜å—é‡Šæ”¾æ‰ã€‚</p><p>å…³äºï¼š<code>void *</code>,è¡¨ç¤ºæœªç¡®å®šç±»å‹çš„æŒ‡é’ˆã€‚Cï¼ŒC++è§„å®šï¼Œ    <code>void *</code>ç±»å‹å¯ä»¥å¼ºè½¬ä¸ºä»»ä½•å…¶ä»–ç±»å‹çš„çš„æŒ‡é’ˆã€‚</p><p><strong>malloc</strong> returns a void pointer to the allocated space, or <strong>NULL</strong> if there is insufficient memory available. To return a pointer to a type other than <strong>void</strong>, use a type cast on the return value. The storage space pointed to by the return value is guaranteed to be suitably aligned for storage of any type of object. If size is 0, <strong>malloc</strong> allocates a zero-length item in the heap and returns a valid pointer to that item. Always check the return from <strong>malloc</strong>, even if the amount of memory requested is small.</p><p>å…³äºvoid *çš„å…¶ä»–è¯´æ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> * p1;</span><br><span class="line"><span class="keyword">int</span> *p2;</span><br><span class="line">p1 = p2;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯è¯´å…¶ä»–ä»»æ„ç±»å‹éƒ½å¯ä»¥ç›´æ¥èµ‹å€¼ç»™å®ƒï¼Œæ— éœ€è¿›è¡Œå¼ºè½¬ï¼Œä½†æ˜¯åè¿‡æ¥ä¸å¯ä»¥ã€‚</p><p><strong>malloc:</strong></p><p>mallocåˆ†é…çš„å†…å­˜å¤§å°è‡³å°‘ä¸ºsizeå‚æ•°æ‰€æŒ‡å®šçš„å­—èŠ‚æ•°</p><p>mallocçš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€æ®µå¯ç”¨å†…å­˜çš„èµ·å§‹åœ°å€</p><p>å¤šæ¬¡è°ƒç”¨mallocæ‰€åˆ†é…çš„åœ°å€ä¸èƒ½æœ‰é‡å éƒ¨åˆ†ï¼Œé™¤éæŸæ¬¡mallocæ‰€åˆ†é…çš„åœ°å€è¢«é‡Šæ”¾æ‰</p><p>mallocåº”è¯¥å°½å¿«å®Œæˆå†…å­˜åˆ†é…å¹¶è¿”å›ï¼ˆä¸èƒ½ä½¿ç”¨NP-hardçš„å†…å­˜åˆ†é…ç®—æ³•ï¼‰</p><p>å®ç°mallocæ—¶åº”åŒæ—¶å®ç°å†…å­˜å¤§å°è°ƒæ•´å’Œå†…å­˜é‡Šæ”¾å‡½æ•°ï¼ˆreallocå’Œfreeï¼‰</p><p>mallocå’Œfreeå‡½æ•°æ˜¯é…å¯¹çš„ï¼Œå¦‚æœç”³è¯·åä¸é‡Šæ”¾å°±æ˜¯å†…å­˜æ³„éœ²;å¦‚æœæ— æ•…é‡Šæ”¾é‚£å°±æ˜¯ä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œé‡Šæ”¾åªèƒ½é‡Šæ”¾ä¸€æ¬¡ï¼Œå¦‚æœé‡Šæ”¾ä¸¤æ¬¡åŠä¸¤æ¬¡ä»¥ä¸Šä¼šå‡ºç°é”™è¯¯ï¼ˆä½†æ˜¯é‡Šæ”¾ç©ºæŒ‡é’ˆä¾‹å¤–ï¼Œé‡Šæ”¾ç©ºæŒ‡é’ˆå…¶å®ä¹Ÿç­‰äºä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œæ‰€ä»¥ï¼Œé‡Šæ”¾å¤šå°‘æ¬¡éƒ½æ˜¯å¯ä»¥çš„ï¼‰</p><h2 id="1-2-mallocå’Œnew"><a href="#1-2-mallocå’Œnew" class="headerlink" title="1.2 mallocå’Œnew"></a>1.2 mallocå’Œnew</h2><p><strong>newï¼š</strong>è¿”å›æŒ‡å®šç±»å‹çš„æŒ‡é’ˆï¼Œå¹¶ä¸”å¯ä»¥è‡ªåŠ¨è®¡ç®—æ‰€éœ€è¦çš„å¤§å°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *p;</span><br><span class="line">p = <span class="keyword">new</span> <span class="keyword">int</span>; <span class="comment">//è¿”å›ç±»å‹ä¸ºint *ç±»å‹ï¼Œåˆ†é…çš„å¤§å°ä¸ºsizeof(int)</span></span><br><span class="line">p = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">100</span>]; <span class="comment">//è¿”å›ç±»å‹ä¸ºint *ç±»å‹ï¼Œåˆ†é…çš„å¤§å°ä¸ºsizeof(int) * 100</span></span><br></pre></td></tr></table></figure><p><strong>mallocï¼š</strong>å¿…é¡»ç”±æˆ‘ä»¬è®¡ç®—å­—èŠ‚æ•°ï¼Œå¹¶ä¸”åœ¨è¿”å›çš„æ—¶å€™å¼ºè½¬æˆå®é™…æŒ‡å®šç±»å‹çš„æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *p;</span><br><span class="line">p = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br></pre></td></tr></table></figure><ol><li>mallocçš„è¿”å›æ˜¯<code>void *</code>,å¦‚æœæˆ‘ä»¬å†™æˆäº†:<code>p = malloc(sizeof(int));</code>é—´æ¥çš„è¯´æ˜äº†ï¼ˆå°†<code>void *</code>è½¬åŒ–ç»™äº†<code>int *</code>,è¿™ä¸åˆç†ï¼‰</li><li>mallocçš„å®å‚æ˜¯sizeof(int),ç”¨äºæŒ‡æ˜ä¸€ä¸ªæ•´å½¢æ•°æ®éœ€è¦çš„å¤§å°ï¼Œå¦‚æœæˆ‘ä»¬å†™æˆï¼š<code>p =ï¼ˆint *ï¼‰malloc(1),</code>é‚£ä¹ˆå¯ä»¥çœ‹å‡ºï¼šåªæ˜¯ç”³è¯·äº†ä¸€ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œå¦‚æœå‘é‡Œé¢å­˜æ”¾äº†ä¸€ä¸ªæ•´æ•°çš„è¯ï¼Œå°†ä¼šå ç”¨é¢å¤–çš„3ä¸ªå­—èŠ‚ï¼Œå¯èƒ½ä¼šæ”¹å˜åŸæœ‰å†…å­˜ç©ºé—´ä¸­çš„æ•°æ®</li><li>mallocåªç®¡åˆ†é…å†…å­˜ï¼Œå¹¶ä¸èƒ½å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰€ä»¥å¾—åˆ°çš„ä¸€ç‰‡æ–°å†…å­˜ä¸­ï¼Œå…¶å€¼å°†æ˜¯éšæœºçš„ã€‚ä¸€èˆ¬æ„ä¹‰ä¸Šï¼šæˆ‘ä»¬ä¹ æƒ¯æ€§çš„å°†å…¶åˆå§‹åŒ–ä¸ºNULLï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”¨memsetå‡½æ•°çš„ã€‚</li></ol><p>ç®€å•çš„è¯´ï¼š</p><p>malloc å‡½æ•°å…¶å®å°±æ˜¯åœ¨å†…å­˜ä¸­ï¼šæ‰¾ä¸€ç‰‡æŒ‡å®šå¤§å°çš„ç©ºé—´ï¼Œç„¶åå°†è¿™ä¸ªç©ºé—´çš„é¦–åœ°å€ç»™ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œè¿™é‡Œçš„æŒ‡é’ˆå˜é‡å¯ä»¥æ˜¯ä¸€ä¸ªå•ç‹¬çš„æŒ‡é’ˆï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ•°ç»„çš„é¦–åœ°å€ï¼Œ è¿™è¦çœ‹mallocå‡½æ•°ä¸­å‚æ•°sizeçš„å…·ä½“å†…å®¹ã€‚æˆ‘ä»¬è¿™é‡Œmallocåˆ†é…çš„å†…å­˜ç©ºé—´åœ¨é€»è¾‘ä¸Šæ˜¯è¿ç»­çš„ï¼Œè€Œåœ¨ç‰©ç†ä¸Šå¯ä»¥ä¸è¿ç»­ã€‚æˆ‘ä»¬ä½œä¸ºç¨‹åºå‘˜ï¼Œå…³æ³¨çš„ æ˜¯é€»è¾‘ä¸Šçš„è¿ç»­ï¼Œå…¶å®ƒçš„ï¼Œæ“ä½œç³»ç»Ÿä¼šå¸®ç€æˆ‘ä»¬å¤„ç†çš„ã€‚</p><h1 id="Linuxå†…å­˜ç®¡ç†"><a href="#Linuxå†…å­˜ç®¡ç†" class="headerlink" title="Linuxå†…å­˜ç®¡ç†"></a>Linuxå†…å­˜ç®¡ç†</h1><p>ä¸‹é¢æˆ‘ä»¬èŠèŠmallocçš„å…·ä½“å®ç°æœºåˆ¶ï¼š</p><h2 id="è™šæ‹Ÿå†…å­˜åœ°å€ä¸ç‰©ç†å†…å­˜åœ°å€"><a href="#è™šæ‹Ÿå†…å­˜åœ°å€ä¸ç‰©ç†å†…å­˜åœ°å€" class="headerlink" title="è™šæ‹Ÿå†…å­˜åœ°å€ä¸ç‰©ç†å†…å­˜åœ°å€"></a>è™šæ‹Ÿå†…å­˜åœ°å€ä¸ç‰©ç†å†…å­˜åœ°å€</h2><pre><code>ä¸ºäº†ç®€å•ï¼Œç°ä»£æ“ä½œç³»ç»Ÿåœ¨å¤„ç†å†…å­˜åœ°å€æ—¶ï¼Œæ™®éé‡‡ç”¨è™šæ‹Ÿå†…å­˜åœ°å€æŠ€æœ¯ã€‚å³åœ¨æ±‡ç¼–ç¨‹åºï¼ˆæˆ–æœºå™¨è¯­è¨€ï¼‰å±‚é¢ï¼Œå½“æ¶‰åŠå†…å­˜åœ°å€æ—¶ï¼Œ éƒ½æ˜¯ä½¿ç”¨è™šæ‹Ÿå†…å­˜åœ°å€ã€‚é‡‡ç”¨è¿™ç§æŠ€æœ¯æ—¶ï¼Œæ¯ä¸ªè¿›ç¨‹ä»¿ä½›è‡ªå·±ç‹¬äº«ä¸€ç‰‡2Nå­—èŠ‚çš„å†…å­˜ï¼Œå…¶ä¸­Næ˜¯æœºå™¨ä½æ•°ã€‚ä¾‹å¦‚åœ¨64ä½CPUå’Œ64ä½æ“ä½œç³»ç»Ÿä¸‹ï¼Œæ¯ä¸ªè¿›ç¨‹çš„ è™šæ‹Ÿåœ°å€ç©ºé—´ä¸º264Byteã€‚</code></pre><p>ã€€ã€€è¿™ç§è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä½œç”¨ä¸»è¦æ˜¯ç®€åŒ–ç¨‹åºçš„ç¼–å†™åŠæ–¹ä¾¿æ“ä½œç³»ç»Ÿå¯¹è¿›ç¨‹é—´å†…å­˜çš„éš”ç¦»ç®¡ç†ï¼ŒçœŸå®ä¸­çš„è¿›ç¨‹ä¸å¤ªå¯èƒ½ï¼ˆä¹Ÿç”¨ä¸åˆ°ï¼‰å¦‚æ­¤å¤§çš„å†…å­˜ç©ºé—´ï¼Œå®é™…èƒ½ç”¨åˆ°çš„å†…å­˜å–å†³äºç‰©ç†å†…å­˜å¤§å°ã€‚</p><p>ã€€ã€€ç”±äºåœ¨æœºå™¨è¯­è¨€å±‚é¢éƒ½æ˜¯é‡‡ç”¨è™šæ‹Ÿåœ°å€ï¼Œå½“å®é™…çš„æœºå™¨ç ç¨‹åºæ¶‰åŠåˆ°å†…å­˜æ“ä½œæ—¶ï¼Œéœ€è¦æ ¹æ®å½“å‰è¿›ç¨‹è¿è¡Œçš„å®é™…ä¸Šä¸‹æ–‡å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†å†…å­˜åœ°å€ï¼Œæ‰èƒ½å®ç°å¯¹çœŸå®å†…å­˜æ•°æ®çš„æ“ä½œã€‚è¿™ä¸ªè½¬æ¢ä¸€èˆ¬ç”±ä¸€ä¸ªå«<a href="http://en.wikipedia.org/wiki/Memory_management_unit" target="_blank" rel="noopener">MMU</a>ï¼ˆMemory Management Unitï¼‰çš„ç¡¬ä»¶å®Œæˆã€‚ </p><h3 id="é¡µä¸åœ°å€æ„æˆ"><a href="#é¡µä¸åœ°å€æ„æˆ" class="headerlink" title="é¡µä¸åœ°å€æ„æˆ"></a>é¡µä¸åœ°å€æ„æˆ</h3><p>ã€€ã€€åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œä¸è®ºæ˜¯è™šæ‹Ÿå†…å­˜è¿˜æ˜¯ç‰©ç†å†…å­˜ï¼Œéƒ½ä¸æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½è¿›è¡Œç®¡ç†çš„ï¼Œè€Œæ˜¯ä»¥é¡µï¼ˆPageï¼‰ä¸ºå•ä½ã€‚ä¸€ä¸ªå†…å­˜é¡µæ˜¯ä¸€æ®µå›ºå®šå¤§å°çš„è¿ç»­å†…å­˜åœ°å€çš„æ€»ç§°ï¼Œå…·ä½“åˆ°Linuxä¸­ï¼Œå…¸å‹çš„å†…å­˜é¡µå¤§å°ä¸º4096Byteï¼ˆ4Kï¼‰ã€‚</p><p>ã€€ã€€æ‰€ä»¥å†…å­˜åœ°å€å¯ä»¥åˆ†ä¸ºé¡µå·å’Œé¡µå†…åç§»é‡ã€‚ä¸‹é¢ä»¥64ä½æœºå™¨ï¼Œ4Gç‰©ç†å†…å­˜ï¼Œ4Ké¡µå¤§å°ä¸ºä¾‹ï¼Œè™šæ‹Ÿå†…å­˜åœ°å€å’Œç‰©ç†å†…å­˜åœ°å€çš„ç»„æˆå¦‚ä¸‹ï¼š</p><p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1ftmk3vt7fij30e703c0sl.jpg" alt="å†…å­˜åœ°å€æ„æˆ"></p><p>ã€€ã€€ä¸Šé¢æ˜¯è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œä¸‹é¢æ˜¯ç‰©ç†å†…å­˜åœ°å€ã€‚ç”±äºé¡µå¤§å°éƒ½æ˜¯4Kï¼Œæ‰€ä»¥é¡µå†…ä¾¿å®œéƒ½æ˜¯ç”¨ä½12ä½è¡¨ç¤ºï¼Œè€Œå‰©ä¸‹çš„é«˜åœ°å€è¡¨ç¤ºé¡µå·ã€‚</p><p>ã€€ã€€MMUæ˜ å°„å•ä½å¹¶ä¸æ˜¯å­—èŠ‚ï¼Œè€Œæ˜¯é¡µï¼Œè¿™ä¸ªæ˜ å°„é€šè¿‡æŸ¥ä¸€ä¸ªå¸¸é©»å†…å­˜çš„æ•°æ®ç»“æ„<a href="http://en.wikipedia.org/wiki/Page_table" target="_blank" rel="noopener">é¡µè¡¨</a>æ¥å®ç°ã€‚ç°åœ¨è®¡ç®—æœºå…·ä½“çš„å†…å­˜åœ°å€æ˜ å°„æ¯”è¾ƒå¤æ‚ï¼Œä¸ºäº†åŠ å¿«é€Ÿåº¦ä¼šå¼•å…¥ä¸€ç³»åˆ—ç¼“å­˜å’Œä¼˜åŒ–ï¼Œä¾‹å¦‚<a href="http://en.wikipedia.org/wiki/Translation_lookaside_buffer" target="_blank" rel="noopener">TLB</a>ç­‰æœºåˆ¶ã€‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªç»è¿‡ç®€åŒ–çš„å†…å­˜åœ°å€ç¿»è¯‘ç¤ºæ„å›¾ï¼Œè™½ç„¶ç»è¿‡äº†ç®€åŒ–ï¼Œä½†æ˜¯åŸºæœ¬åŸç†ä¸ç°ä»£è®¡ç®—æœºçœŸå®çš„æƒ…å†µçš„ä¸€è‡´çš„ã€‚</p><p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1ftmk40g7otj30e70740sp.jpg" alt="å†…å­˜åœ°å€ç¿»è¯‘"></p><h3 id="å†…å­˜é¡µä¸ç£ç›˜é¡µ"><a href="#å†…å­˜é¡µä¸ç£ç›˜é¡µ" class="headerlink" title="å†…å­˜é¡µä¸ç£ç›˜é¡µ"></a>å†…å­˜é¡µä¸ç£ç›˜é¡µ</h3><p>ã€€ã€€æˆ‘ä»¬çŸ¥é“ä¸€èˆ¬å°†å†…å­˜çœ‹åšç£ç›˜çš„çš„ç¼“å­˜ï¼Œæœ‰æ—¶MMUåœ¨å·¥ä½œæ—¶ï¼Œä¼šå‘ç°é¡µè¡¨è¡¨æ˜æŸä¸ªå†…å­˜é¡µä¸åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œæ­¤æ—¶ä¼šè§¦å‘ä¸€ä¸ªç¼ºé¡µå¼‚ å¸¸ï¼ˆPage Faultï¼‰ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šåˆ°ç£ç›˜ä¸­ç›¸åº”çš„åœ°æ–¹å°†ç£ç›˜é¡µè½½å…¥åˆ°å†…å­˜ä¸­ï¼Œç„¶åé‡æ–°æ‰§è¡Œç”±äºç¼ºé¡µè€Œå¤±è´¥çš„æœºå™¨æŒ‡ä»¤ã€‚å…³äºè¿™éƒ¨åˆ†ï¼Œå› ä¸ºå¯ä»¥çœ‹åšå¯¹mallocå®ç° æ˜¯é€æ˜çš„ï¼Œæ‰€ä»¥ä¸å†è¯¦ç»†è®²è¿°ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹ç›¸å…³ç« èŠ‚ã€‚</p><p>ã€€ã€€æœ€åé™„ä¸Šä¸€å¼ åœ¨ç»´åŸºç™¾ç§‘æ‰¾åˆ°çš„æ›´åŠ ç¬¦åˆçœŸå®åœ°å€ç¿»è¯‘çš„æµç¨‹ä¾›å¤§å®¶å‚è€ƒï¼Œè¿™å¼ å›¾åŠ å…¥äº†TLBå’Œç¼ºé¡µå¼‚å¸¸çš„æµç¨‹ï¼ˆ<a href="http://en.wikipedia.org/wiki/Page_table" target="_blank" rel="noopener">å›¾ç‰‡æ¥æºé¡µ</a>ï¼‰ã€‚</p><p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1ftmk48xkvuj30hd0b9mx8.jpg" alt="è¾ƒä¸ºå®Œæ•´çš„åœ°å€ç¿»è¯‘æµç¨‹"></p><h2 id="Linuxè¿›ç¨‹çº§å†…å­˜ç®¡ç†"><a href="#Linuxè¿›ç¨‹çº§å†…å­˜ç®¡ç†" class="headerlink" title="Linuxè¿›ç¨‹çº§å†…å­˜ç®¡ç†"></a>Linuxè¿›ç¨‹çº§å†…å­˜ç®¡ç†</h2><h3 id="2-2-1-å†…å­˜æ’å¸ƒ"><a href="#2-2-1-å†…å­˜æ’å¸ƒ" class="headerlink" title="ã€€ã€€2.2.1 å†…å­˜æ’å¸ƒ"></a>ã€€ã€€2.2.1 å†…å­˜æ’å¸ƒ</h3><p>ã€€ã€€æ˜ç™½äº†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜çš„å…³ç³»åŠç›¸å…³çš„æ˜ å°„æœºåˆ¶ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å…·ä½“åœ¨ä¸€ä¸ªè¿›ç¨‹å†…æ˜¯å¦‚ä½•æ’å¸ƒå†…å­˜çš„ã€‚</p><p>ã€€ã€€ä»¥Linux 64ä½ç³»ç»Ÿä¸ºä¾‹ã€‚ç†è®ºä¸Šï¼Œ64bitå†…å­˜åœ°å€å¯ç”¨ç©ºé—´ä¸º0x0000000000000000 ~ 0xFFFFFFFFFFFFFFFFï¼Œè¿™æ˜¯ä¸ªç›¸å½“åºå¤§çš„ç©ºé—´ï¼ŒLinuxå®é™…ä¸Šåªç”¨äº†å…¶ä¸­ä¸€å°éƒ¨åˆ†ï¼ˆ256Tï¼‰ã€‚</p><p>ã€€ã€€æ ¹æ®<a href="https://www.kernel.org/doc/Documentation/x86/x86_64/mm.txt" target="_blank" rel="noopener">Linuxå†…æ ¸ç›¸å…³æ–‡æ¡£</a>æè¿°ï¼ŒLinux64ä½æ“ä½œç³»ç»Ÿä»…ä½¿ç”¨ä½47ä½ï¼Œé«˜17ä½åšæ‰©å±•ï¼ˆåªèƒ½æ˜¯å…¨0æˆ–å…¨1ï¼‰ã€‚æ‰€ä»¥ï¼Œå®é™…ç”¨åˆ°çš„åœ°å€ä¸ºç©ºé—´ä¸º0x0000000000000000 ~ 0x00007FFFFFFFFFFFå’Œ0xFFFF800000000000 ~ 0xFFFFFFFFFFFFFFFFï¼Œå…¶ä¸­å‰é¢ä¸ºç”¨æˆ·ç©ºé—´ï¼ˆUser Spaceï¼‰ï¼Œåè€…ä¸ºå†…æ ¸ç©ºé—´ï¼ˆKernel Spaceï¼‰ã€‚å›¾ç¤ºå¦‚ä¸‹ï¼š</p><p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1ftmk4gcr7pj30lj0ejglp.jpg" alt="Linuxè¿›ç¨‹åœ°å€æ’å¸ƒ"></p><p>ã€€ã€€å¯¹ç”¨æˆ·æ¥è¯´ï¼Œä¸»è¦å…³æ³¨çš„ç©ºé—´æ˜¯User Spaceã€‚å°†User Spaceæ”¾å¤§åï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢ä¸»è¦åˆ†ä¸ºå¦‚ä¸‹å‡ æ®µï¼š</p><ul><li>Codeï¼šè¿™æ˜¯æ•´ä¸ªç”¨æˆ·ç©ºé—´çš„æœ€ä½åœ°å€éƒ¨åˆ†ï¼Œå­˜æ”¾çš„æ˜¯æŒ‡ä»¤ï¼ˆä¹Ÿå°±æ˜¯ç¨‹åºæ‰€ç¼–è¯‘æˆçš„å¯æ‰§è¡Œæœºå™¨ç ï¼‰</li><li>Dataï¼šè¿™é‡Œå­˜æ”¾çš„æ˜¯åˆå§‹åŒ–è¿‡çš„å…¨å±€å˜é‡</li><li>BSSï¼šè¿™é‡Œå­˜æ”¾çš„æ˜¯æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡</li><li>Heapï¼šå †ï¼Œè¿™æ˜¯æˆ‘ä»¬æœ¬æ–‡é‡ç‚¹å…³æ³¨çš„åœ°æ–¹ï¼Œå †è‡ªä½åœ°å€å‘é«˜åœ°å€å¢é•¿ï¼Œåé¢è¦è®²åˆ°çš„brkç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨å°±æ˜¯ä»è¿™é‡Œåˆ†é…å†…å­˜</li><li>Mapping Areaï¼šè¿™é‡Œæ˜¯ä¸mmapç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„åŒºåŸŸã€‚å¤§å¤šæ•°å®é™…çš„mallocå®ç°ä¼šè€ƒè™‘é€šè¿‡mmapåˆ†é…è¾ƒå¤§å—çš„å†…å­˜åŒºåŸŸï¼Œæœ¬æ–‡ä¸è®¨è®ºè¿™ç§æƒ…å†µã€‚è¿™ä¸ªåŒºåŸŸè‡ªé«˜åœ°å€å‘ä½åœ°å€å¢é•¿</li><li>Stackï¼šè¿™æ˜¯æ ˆåŒºåŸŸï¼Œè‡ªé«˜åœ°å€å‘ä½åœ°å€å¢é•¿</li></ul><p>ã€€ã€€ä¸‹é¢æˆ‘ä»¬ä¸»è¦å…³æ³¨HeapåŒºåŸŸçš„æ“ä½œã€‚å¯¹æ•´ä¸ªLinuxå†…å­˜æ’å¸ƒæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒå…¶å®ƒèµ„æ–™ã€‚</p><h3 id="Heapå†…å­˜æ¨¡å‹"><a href="#Heapå†…å­˜æ¨¡å‹" class="headerlink" title="Heapå†…å­˜æ¨¡å‹"></a>Heapå†…å­˜æ¨¡å‹</h3><p>ã€€ã€€ä¸€èˆ¬æ¥è¯´ï¼Œmallocæ‰€ç”³è¯·çš„å†…å­˜ä¸»è¦ä»HeapåŒºåŸŸåˆ†é…ï¼ˆæœ¬æ–‡ä¸è€ƒè™‘é€šè¿‡mmapç”³è¯·å¤§å—å†…å­˜çš„æƒ…å†µï¼‰ã€‚</p><p>ã€€ã€€ç”±ä¸Šæ–‡çŸ¥é“ï¼Œè¿›ç¨‹æ‰€é¢å¯¹çš„è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´ï¼Œåªæœ‰æŒ‰é¡µæ˜ å°„åˆ°ç‰©ç†å†…å­˜åœ°å€ï¼Œæ‰èƒ½çœŸæ­£ä½¿ç”¨ã€‚å—ç‰©ç†å­˜å‚¨å®¹é‡é™åˆ¶ï¼Œæ•´ä¸ªå †è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸å¯èƒ½å…¨éƒ¨æ˜ å°„åˆ°å®é™…çš„ç‰©ç†å†…å­˜ã€‚Linuxå¯¹å †çš„ç®¡ç†ç¤ºæ„å¦‚ä¸‹ï¼š</p><p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1ftmk4kperpj30kb06a74h.jpg" alt="Linuxè¿›ç¨‹å †ç®¡ç†"></p><p>ã€€ã€€Linuxç»´æŠ¤ä¸€ä¸ªbreakæŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘å †ç©ºé—´çš„æŸä¸ªåœ°å€ã€‚ä»å †èµ·å§‹åœ°å€åˆ°breakä¹‹é—´çš„åœ°å€ç©ºé—´ä¸ºæ˜ å°„å¥½çš„ï¼Œå¯ä»¥ä¾›è¿›ç¨‹è®¿é—®ï¼›è€Œä»breakå¾€ä¸Šï¼Œæ˜¯æœªæ˜ å°„çš„åœ°å€ç©ºé—´ï¼Œå¦‚æœè®¿é—®è¿™æ®µç©ºé—´åˆ™ç¨‹åºä¼šæŠ¥é”™ã€‚</p><h3 id="brkä¸sbrk"><a href="#brkä¸sbrk" class="headerlink" title="brkä¸sbrk"></a>brkä¸sbrk</h3><p>ã€€ã€€ç”±ä¸Šæ–‡çŸ¥é“ï¼Œè¦å¢åŠ ä¸€ä¸ªè¿›ç¨‹å®é™…çš„å¯ç”¨å †å¤§å°ï¼Œå°±éœ€è¦å°†breakæŒ‡é’ˆå‘é«˜åœ°å€ç§»åŠ¨ã€‚Linuxé€šè¿‡brkå’Œsbrkç³»ç»Ÿè°ƒç”¨æ“ä½œbreakæŒ‡é’ˆã€‚ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">brk</span><span class="params">(<span class="keyword">void</span> *addr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">sbrk</span><span class="params">(<span class="keyword">intptr_t</span> increment)</span></span>;</span><br></pre></td></tr></table></figure><p>ã€€ã€€brkå°†breakæŒ‡é’ˆç›´æ¥è®¾ç½®ä¸ºæŸä¸ªåœ°å€ï¼Œè€Œsbrkå°†breakä»å½“å‰ä½ç½®ç§»åŠ¨incrementæ‰€æŒ‡å®šçš„å¢é‡ã€‚brk åœ¨æ‰§è¡ŒæˆåŠŸæ—¶è¿”å›0ï¼Œå¦åˆ™è¿”å›-1å¹¶è®¾ç½®errnoä¸ºENOMEMï¼›sbrkæˆåŠŸæ—¶è¿”å›breakç§»åŠ¨ä¹‹å‰æ‰€æŒ‡å‘çš„åœ°å€ï¼Œå¦åˆ™è¿”å›(void *)-1ã€‚</p><p>ã€€ã€€ä¸€ä¸ªå°æŠ€å·§æ˜¯ï¼Œå¦‚æœå°†incrementè®¾ç½®ä¸º0ï¼Œåˆ™å¯ä»¥è·å¾—å½“å‰breakçš„åœ°å€ã€‚</p><p>ã€€ã€€å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºLinuxæ˜¯æŒ‰é¡µè¿›è¡Œå†…å­˜æ˜ å°„çš„ï¼Œæ‰€ä»¥å¦‚æœbreakè¢«è®¾ç½®ä¸ºæ²¡æœ‰æŒ‰é¡µå¤§å°å¯¹é½ï¼Œåˆ™ç³»ç»Ÿå®é™…ä¸Šä¼šåœ¨æœ€ åæ˜ å°„ä¸€ä¸ªå®Œæ•´çš„é¡µï¼Œä»è€Œå®é™…å·²æ˜ å°„çš„å†…å­˜ç©ºé—´æ¯”breakæŒ‡å‘çš„åœ°æ–¹è¦å¤§ä¸€äº›ã€‚ä½†æ˜¯ä½¿ç”¨breakä¹‹åçš„åœ°å€æ˜¯å¾ˆå±é™©çš„ï¼ˆå°½ç®¡ä¹Ÿè®¸breakä¹‹åç¡®å®æœ‰ ä¸€å°å—å¯ç”¨å†…å­˜åœ°å€ï¼‰ã€‚</p><h3 id="èµ„æºé™åˆ¶ä¸rlimit"><a href="#èµ„æºé™åˆ¶ä¸rlimit" class="headerlink" title="èµ„æºé™åˆ¶ä¸rlimit"></a>èµ„æºé™åˆ¶ä¸rlimit</h3><p>ã€€ã€€ç³»ç»Ÿå¯¹æ¯ä¸€ä¸ªè¿›ç¨‹æ‰€åˆ†é…çš„èµ„æºä¸æ˜¯æ— é™çš„ï¼ŒåŒ…æ‹¬å¯æ˜ å°„çš„å†…å­˜ç©ºé—´ï¼Œå› æ­¤æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªrlimitè¡¨ç¤ºå½“å‰è¿›ç¨‹å¯ç”¨çš„èµ„æºä¸Šé™ã€‚è¿™ä¸ªé™åˆ¶å¯ä»¥é€šè¿‡getrlimitç³»ç»Ÿè°ƒç”¨å¾—åˆ°ï¼Œä¸‹é¢ä»£ç è·å–å½“å‰è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´çš„rlimitï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> *<span class="title">limit</span> = (<span class="title">struct</span> <span class="title">rlimit</span> *)<span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">rlimit</span>));</span></span><br><span class="line">    getrlimit(RLIMIT_AS, limit);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"soft limit: %ld, hard limit: %ld\n"</span>, limit-&gt;rlim_cur, limit-&gt;rlim_max);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ã€€å…¶ä¸­rlimitæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> &#123;</span></span><br><span class="line">    <span class="keyword">rlim_t</span> rlim_cur; <span class="comment">/* Soft limit */</span></span><br><span class="line">    <span class="keyword">rlim_t</span> rlim_max; <span class="comment">/* Hard limit (ceiling for rlim_cur) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ã€€ã€€æ¯ç§èµ„æºæœ‰è½¯é™åˆ¶å’Œç¡¬é™åˆ¶ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡setrlimitå¯¹rlimitè¿›è¡Œæœ‰æ¡ä»¶è®¾ç½®ã€‚å…¶ä¸­ç¡¬é™åˆ¶ä½œä¸ºè½¯é™åˆ¶çš„ä¸Šé™ï¼Œéç‰¹æƒè¿›ç¨‹åªèƒ½è®¾ç½®è½¯é™åˆ¶ï¼Œä¸”ä¸èƒ½è¶…è¿‡ç¡¬é™åˆ¶ã€‚</p><h1 id="å®ç°malloc"><a href="#å®ç°malloc" class="headerlink" title="å®ç°malloc"></a>å®ç°malloc</h1><h2 id="3-1-ç©å…·å®ç°"><a href="#3-1-ç©å…·å®ç°" class="headerlink" title="ã€€ã€€3.1 ç©å…·å®ç°"></a>ã€€ã€€3.1 ç©å…·å®ç°</h2><p>åœ¨æ­£å¼å¼€å§‹è®¨è®ºmallocçš„å®ç°å‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸Šè¿°çŸ¥è¯†å®ç°ä¸€ä¸ªç®€å•ä½†å‡ ä¹æ²¡æ³•ç”¨äºçœŸå®çš„ç©å…·mallocï¼Œæƒå½“å¯¹ä¸Šé¢çŸ¥è¯†çš„å¤ä¹ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ä¸€ä¸ªç©å…·malloc */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *p;</span><br><span class="line">    p = sbrk(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sbrk(size) == (<span class="keyword">void</span> *)<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ã€€è¿™ä¸ªmallocæ¯æ¬¡éƒ½åœ¨å½“å‰breakçš„åŸºç¡€ä¸Šå¢åŠ sizeæ‰€æŒ‡å®šçš„å­—èŠ‚æ•°ï¼Œå¹¶å°†ä¹‹å‰breakçš„åœ°å€è¿”å›ã€‚è¿™ä¸ªmallocç”±äºå¯¹æ‰€åˆ†é…çš„å†…å­˜ç¼ºä¹è®°å½•ï¼Œä¸ä¾¿äºå†…å­˜é‡Šæ”¾ï¼Œæ‰€ä»¥æ— æ³•ç”¨äºçœŸå®åœºæ™¯ã€‚</p><h2 id="3-2-æ­£å¼å®ç°"><a href="#3-2-æ­£å¼å®ç°" class="headerlink" title="3.2 æ­£å¼å®ç°"></a>3.2 æ­£å¼å®ç°</h2><p>ã€€ã€€ä¸‹é¢ä¸¥è‚ƒç‚¹è®¨è®ºmallocçš„å®ç°æ–¹æ¡ˆã€‚</p><h3 id="3-2-1-æ•°æ®ç»“æ„"><a href="#3-2-1-æ•°æ®ç»“æ„" class="headerlink" title="ã€€ã€€3.2.1 æ•°æ®ç»“æ„"></a>ã€€ã€€3.2.1 æ•°æ®ç»“æ„</h3><pre><code>é¦–å…ˆæˆ‘ä»¬è¦ç¡®å®šæ‰€é‡‡ç”¨çš„æ•°æ®ç»“æ„ã€‚ä¸€ä¸ªç®€å•å¯è¡Œæ–¹æ¡ˆæ˜¯å°†å †å†…å­˜ç©ºé—´ä»¥å—ï¼ˆBlockï¼‰çš„å½¢å¼ç»„ç»‡èµ·æ¥ï¼Œæ¯ä¸ªå—ç”±metaåŒºå’Œ æ•°æ®åŒºç»„æˆï¼ŒmetaåŒºè®°å½•æ•°æ®å—çš„å…ƒä¿¡æ¯ï¼ˆæ•°æ®åŒºå¤§å°ã€ç©ºé—²æ ‡å¿—ä½ã€æŒ‡é’ˆç­‰ç­‰ï¼‰ï¼Œæ•°æ®åŒºæ˜¯çœŸå®åˆ†é…çš„å†…å­˜åŒºåŸŸï¼Œå¹¶ä¸”æ•°æ®åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åœ°å€å³ä¸º mallocè¿”å›çš„åœ°å€ã€‚å¯ä»¥ç”¨å¦‚ä¸‹ç»“æ„ä½“å®šä¹‰ä¸€ä¸ªblockï¼š</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">s_block</span> *<span class="title">t_block</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s_block</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> size; <span class="comment">/* æ•°æ®åŒºå¤§å° */</span></span><br><span class="line">    t_block next; <span class="comment">/* æŒ‡å‘ä¸‹ä¸ªå—çš„æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">free</span>; <span class="comment">/* æ˜¯å¦æ˜¯ç©ºé—²å— */</span></span><br><span class="line">    <span class="keyword">int</span> padding; <span class="comment">/* å¡«å……4å­—èŠ‚ï¼Œä¿è¯metaå—é•¿åº¦ä¸º8çš„å€æ•° */</span></span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">1</span>] <span class="comment">/* è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿå­—æ®µï¼Œè¡¨ç¤ºæ•°æ®å—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œé•¿åº¦ä¸åº”è®¡å…¥meta */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ã€€ã€€ç”±äºæˆ‘ä»¬åªè€ƒè™‘64ä½æœºå™¨ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬åœ¨ç»“æ„ä½“æœ€åå¡«å……ä¸€ä¸ªintï¼Œä½¿å¾—ç»“æ„ä½“æœ¬èº«çš„é•¿åº¦ä¸º8çš„å€æ•°ï¼Œä»¥ä¾¿å†…å­˜å¯¹é½ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1ftmk5xtz1ej30kr07rmx9.jpg" alt="Blockç»“æ„"></p><p>å…³äºé•¿åº¦ä¸º1çš„æ•°ç»„æ³¨æ„ï¼š<a href="http://bbs.csdn.net/topics/300077699" target="_blank" rel="noopener">http://bbs.csdn.net/topics/300077699</a></p><h3 id="3-2-2-å¯»æ‰¾åˆé€‚çš„block"><a href="#3-2-2-å¯»æ‰¾åˆé€‚çš„block" class="headerlink" title="3.2.2 å¯»æ‰¾åˆé€‚çš„block"></a>3.2.2 å¯»æ‰¾åˆé€‚çš„block</h3><p>ã€€ã€€ç°åœ¨è€ƒè™‘å¦‚ä½•åœ¨blocké“¾ä¸­æŸ¥æ‰¾åˆé€‚çš„blockã€‚ä¸€èˆ¬æ¥è¯´æœ‰ä¸¤ç§æŸ¥æ‰¾ç®—æ³•ï¼š</p><ul><li><strong>First fit</strong>ï¼šä»å¤´å¼€å§‹ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ•°æ®åŒºå¤§å°å¤§äºè¦æ±‚sizeçš„å—æ‰€è°“æ­¤æ¬¡åˆ†é…çš„å—</li><li><strong>Best fit</strong>ï¼šä»å¤´å¼€å§‹ï¼Œéå†æ‰€æœ‰å—ï¼Œä½¿ç”¨æ•°æ®åŒºå¤§å°å¤§äºsizeä¸”å·®å€¼æœ€å°çš„å—ä½œä¸ºæ­¤æ¬¡åˆ†é…çš„å—</li></ul><p>ã€€ã€€ä¸¤ç§æ–¹æ³•å„æœ‰åƒç§‹ï¼Œbest fitå…·æœ‰è¾ƒé«˜çš„å†…å­˜ä½¿ç”¨ç‡ï¼ˆpayloadè¾ƒé«˜ï¼‰ï¼Œè€Œfirst fitå…·æœ‰æ›´å¥½çš„è¿è¡Œæ•ˆç‡ã€‚è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨first fitç®—æ³•ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* First fit */</span></span><br><span class="line"><span class="function">t_block <span class="title">find_block</span><span class="params">(t_block *last, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    t_block b = first_block;</span><br><span class="line">    <span class="keyword">while</span>(b &amp;&amp; !(b-&gt;<span class="built_in">free</span> &amp;&amp; b-&gt;size &gt;= size)) &#123;</span><br><span class="line">        *last = b;</span><br><span class="line">        b = b-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ã€€find_blockä»frist_blockå¼€å§‹ï¼ŒæŸ¥æ‰¾ç¬¬ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„blockå¹¶è¿”å›blockèµ·å§‹åœ°å€ï¼Œå¦‚æœæ‰¾ä¸åˆ° è¿™è¿”å›NULLã€‚è¿™é‡Œåœ¨éå†æ—¶ä¼šæ›´æ–°ä¸€ä¸ªå«lastçš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆå§‹ç»ˆæŒ‡å‘å½“å‰éå†çš„blockã€‚è¿™æ˜¯ä¸ºäº†å¦‚æœæ‰¾ä¸åˆ°åˆé€‚çš„blockè€Œå¼€è¾Ÿæ–° blockä½¿ç”¨çš„ï¼Œå…·ä½“ä¼šåœ¨æ¥ä¸‹æ¥çš„ä¸€èŠ‚ç”¨åˆ°ã€‚</p><h3 id="3-2-3-å¼€è¾Ÿæ–°çš„block"><a href="#3-2-3-å¼€è¾Ÿæ–°çš„block" class="headerlink" title="3.2.3 å¼€è¾Ÿæ–°çš„block"></a>3.2.3 å¼€è¾Ÿæ–°çš„block</h3><p>ã€€ã€€å¦‚æœç°æœ‰blockéƒ½ä¸èƒ½æ»¡è¶³sizeçš„è¦æ±‚ï¼Œåˆ™éœ€è¦åœ¨é“¾è¡¨æœ€åå¼€è¾Ÿä¸€ä¸ªæ–°çš„blockã€‚è¿™é‡Œå…³é”®æ˜¯å¦‚ä½•åªä½¿ç”¨sbrkåˆ›å»ºä¸€ä¸ªstructï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLOCK_SIZE 24 <span class="comment">/* ç”±äºå­˜åœ¨è™šæ‹Ÿçš„dataå­—æ®µï¼Œsizeofä¸èƒ½æ­£ç¡®è®¡ç®—metaé•¿åº¦ï¼Œè¿™é‡Œæ‰‹å·¥è®¾ç½® */</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function">t_block <span class="title">extend_heap</span><span class="params">(t_block last, <span class="keyword">size_t</span> s)</span> </span>&#123;</span><br><span class="line">    t_block b;</span><br><span class="line">    b = sbrk(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(sbrk(BLOCK_SIZE + s) == (<span class="keyword">void</span> *)<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    b-&gt;size = s;</span><br><span class="line">    b-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>(last)&#123;</span><br><span class="line">        last-&gt;next = b;</span><br><span class="line">    &#125;</span><br><span class="line">    b-&gt;<span class="built_in">free</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-4-åˆ†è£‚block"><a href="#3-2-4-åˆ†è£‚block" class="headerlink" title="ã€€ã€€3.2.4 åˆ†è£‚block"></a>ã€€ã€€3.2.4 åˆ†è£‚block</h3><p>ã€€ã€€First fitæœ‰ä¸€ä¸ªæ¯”è¾ƒè‡´å‘½çš„ç¼ºç‚¹ï¼Œå°±æ˜¯å¯èƒ½ä¼šè®©å¾ˆå°çš„sizeå æ®å¾ˆå¤§çš„ä¸€å—blockï¼Œæ­¤æ—¶ï¼Œä¸ºäº†æé«˜payloadï¼Œåº”è¯¥åœ¨å‰©ä½™æ•°æ®åŒºè¶³å¤Ÿå¤§çš„æƒ…å†µä¸‹ï¼Œå°†å…¶åˆ†è£‚ä¸ºä¸€ä¸ªæ–°çš„blockï¼Œç¤ºæ„å¦‚ä¸‹ï¼š</p><p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1ftmk8i3q88j30ku0dijrt.jpg" alt="åˆ†è£‚block"></p><p>ã€€ã€€å®ç°ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">split_block</span><span class="params">(t_block b, <span class="keyword">size_t</span> s)</span> </span>&#123;</span><br><span class="line">    t_block <span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">new</span> = b-&gt;data + s;</span><br><span class="line">    <span class="keyword">new</span>-&gt;size = b-&gt;size - s - BLOCK_SIZE ;</span><br><span class="line">    <span class="keyword">new</span>-&gt;next = b-&gt;next;</span><br><span class="line">    <span class="keyword">new</span>-&gt;<span class="built_in">free</span> = <span class="number">1</span>;</span><br><span class="line">    b-&gt;size = s;</span><br><span class="line">    b-&gt;next = <span class="keyword">new</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-5-mallocçš„å®ç°"><a href="#3-2-5-mallocçš„å®ç°" class="headerlink" title="3.2.5 mallocçš„å®ç°"></a>3.2.5 mallocçš„å®ç°</h3><p>ã€€ã€€æœ‰äº†ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒä»¬æ•´åˆæˆä¸€ä¸ªç®€å•ä½†åˆæ­¥å¯ç”¨çš„mallocã€‚æ³¨æ„é¦–å…ˆæˆ‘ä»¬è¦å®šä¹‰ä¸ªblocké“¾è¡¨çš„å¤´first_blockï¼Œåˆå§‹åŒ–ä¸ºNULLï¼›å¦å¤–ï¼Œæˆ‘ä»¬éœ€è¦å‰©ä½™ç©ºé—´è‡³å°‘æœ‰BLOCK_SIZE + 8æ‰æ‰§è¡Œåˆ†è£‚æ“ä½œã€‚</p><p>ã€€ã€€ç”±äºæˆ‘ä»¬å¸Œæœ›mallocåˆ†é…çš„æ•°æ®åŒºæ˜¯æŒ‰8å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥åœ¨sizeä¸ä¸º8çš„å€æ•°æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†sizeè°ƒæ•´ä¸ºå¤§äºsizeçš„æœ€å°çš„8çš„å€æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> align8(<span class="keyword">size_t</span> s) &#123;</span><br><span class="line">    <span class="keyword">if</span>(s &amp; <span class="number">0x7</span> == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ((s &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLOCK_SIZE 24</span></span><br><span class="line"><span class="keyword">void</span> *first_block=<span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">/* other functions... */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    t_block b, last;</span><br><span class="line">    <span class="keyword">size_t</span> s;</span><br><span class="line">    <span class="comment">/* å¯¹é½åœ°å€ */</span></span><br><span class="line">    s = align8(size);</span><br><span class="line">    <span class="keyword">if</span>(first_block) &#123;</span><br><span class="line">        <span class="comment">/* æŸ¥æ‰¾åˆé€‚çš„block */</span></span><br><span class="line">        last = first_block;</span><br><span class="line">        b = find_block(&amp;last, s);</span><br><span class="line">        <span class="keyword">if</span>(b) &#123;</span><br><span class="line">        <span class="comment">/* å¦‚æœå¯ä»¥ï¼Œåˆ™åˆ†è£‚ */</span></span><br><span class="line">            <span class="keyword">if</span> ((b-&gt;size - s) &gt;= ( BLOCK_SIZE + <span class="number">8</span>))&#123;</span><br><span class="line">                split_block(b, s);</span><br><span class="line">            &#125;</span><br><span class="line">            b-&gt;<span class="built_in">free</span> = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* æ²¡æœ‰åˆé€‚çš„blockï¼Œå¼€è¾Ÿä¸€ä¸ªæ–°çš„ */</span></span><br><span class="line">            b = extend_heap(last, s);</span><br><span class="line">            <span class="keyword">if</span>(!b)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        b = extend_heap(<span class="literal">NULL</span>, s);</span><br><span class="line">        <span class="keyword">if</span>(!b)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        first_block = b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> b-&gt;data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-6-callocçš„å®ç°"><a href="#3-2-6-callocçš„å®ç°" class="headerlink" title="3.2.6 callocçš„å®ç°"></a>3.2.6 callocçš„å®ç°</h3><p>ã€€ã€€æœ‰äº†mallocï¼Œå®ç°callocåªè¦ä¸¤æ­¥ï¼š</p><ol><li>mallocä¸€æ®µå†…å­˜</li><li>å°†æ•°æ®åŒºå†…å®¹ç½®ä¸º0</li></ol><p>ã€€ã€€ç”±äºæˆ‘ä»¬çš„æ•°æ®åŒºæ˜¯æŒ‰8å­—èŠ‚å¯¹é½çš„ï¼Œæ‰€ä»¥ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬å¯ä»¥æ¯8å­—èŠ‚ä¸€ç»„ç½®0ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚è®¾ç½®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ–°å»ºä¸€ä¸ªsize_tæŒ‡é’ˆï¼Œå°†å†…å­˜åŒºåŸŸå¼ºåˆ¶çœ‹åšsize_tç±»å‹æ¥å®ç°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">calloc</span><span class="params">(<span class="keyword">size_t</span> number, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> *<span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">size_t</span> s8, i;</span><br><span class="line">    <span class="keyword">new</span> = <span class="built_in">malloc</span>(number * size);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">new</span>) &#123;</span><br><span class="line">        s8 = align8(number * size) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; s8; i++)&#123;</span><br><span class="line">    <span class="keyword">new</span>[i] = <span class="number">0</span>;            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-7-freeçš„å®ç°"><a href="#3-2-7-freeçš„å®ç°" class="headerlink" title="3.2.7 freeçš„å®ç°"></a>3.2.7 freeçš„å®ç°</h3><p>ã€€ã€€freeçš„å®ç°å¹¶ä¸åƒçœ‹ä¸Šå»é‚£ä¹ˆç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬è¦è§£å†³ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š</p><ol><li>å¦‚ä½•éªŒè¯æ‰€ä¼ å…¥çš„åœ°å€æ˜¯æœ‰æ•ˆåœ°å€ï¼Œå³ç¡®å®æ˜¯é€šè¿‡mallocæ–¹å¼åˆ†é…çš„æ•°æ®åŒºé¦–åœ°å€</li><li>å¦‚ä½•è§£å†³ç¢ç‰‡é—®é¢˜</li></ol><p>ã€€ã€€é¦–å…ˆæˆ‘ä»¬è¦ä¿è¯ä¼ å…¥freeçš„åœ°å€æ˜¯æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªæœ‰æ•ˆåŒ…æ‹¬ä¸¤æ–¹é¢ï¼š</p><ul><li>åœ°å€åº”è¯¥åœ¨ä¹‹å‰mallocæ‰€åˆ†é…çš„åŒºåŸŸå†…ï¼Œå³åœ¨first_blockå’Œå½“å‰breakæŒ‡é’ˆèŒƒå›´å†…</li><li>è¿™ä¸ªåœ°å€ç¡®å®æ˜¯ä¹‹å‰é€šè¿‡æˆ‘ä»¬è‡ªå·±çš„mallocåˆ†é…çš„</li></ul><p>ã€€ã€€ç¬¬ä¸€ä¸ªé—®é¢˜æ¯”è¾ƒå¥½è§£å†³ï¼Œåªè¦è¿›è¡Œåœ°å€æ¯”è¾ƒå°±å¯ä»¥äº†ï¼Œå…³é”®æ˜¯ç¬¬äºŒä¸ªé—®é¢˜ã€‚è¿™é‡Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼šä¸€æ˜¯åœ¨ç»“æ„ä½“å†…åŸ‹ä¸€ä¸ªmagic numberå­—æ®µï¼Œfreeä¹‹å‰é€šè¿‡ç›¸å¯¹åç§»æ£€æŸ¥ç‰¹å®šä½ç½®çš„å€¼æ˜¯å¦ä¸ºæˆ‘ä»¬è®¾ç½®çš„magic numberï¼Œå¦ä¸€ç§æ–¹æ³•æ˜¯åœ¨ç»“æ„ä½“å†…å¢åŠ ä¸€ä¸ªmagic pointerï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘æ•°æ®åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼ˆä¹Ÿå°±æ˜¯åœ¨åˆæ³•æ—¶freeæ—¶ä¼ å…¥çš„åœ°å€ï¼‰ï¼Œæˆ‘ä»¬åœ¨freeå‰æ£€æŸ¥magic pointeræ˜¯å¦æŒ‡å‘å‚æ•°æ‰€æŒ‡åœ°å€ã€‚è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ç¬¬äºŒç§æ–¹æ¡ˆï¼š</p><p>ã€€ã€€é¦–å…ˆæˆ‘ä»¬åœ¨ç»“æ„ä½“ä¸­å¢åŠ magic pointerï¼ˆåŒæ—¶è¦ä¿®æ”¹BLOCK_SIZEï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">s_block</span> *<span class="title">t_block</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s_block</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> size; <span class="comment">/* æ•°æ®åŒºå¤§å° */</span></span><br><span class="line">    t_block next; <span class="comment">/* æŒ‡å‘ä¸‹ä¸ªå—çš„æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">free</span>; <span class="comment">/* æ˜¯å¦æ˜¯ç©ºé—²å— */</span></span><br><span class="line">    <span class="keyword">int</span> padding; <span class="comment">/* å¡«å……4å­—èŠ‚ï¼Œä¿è¯metaå—é•¿åº¦ä¸º8çš„å€æ•° */</span></span><br><span class="line">    <span class="keyword">void</span> *ptr; <span class="comment">/* Magic pointerï¼ŒæŒ‡å‘data */</span></span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">1</span>] <span class="comment">/* è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿå­—æ®µï¼Œè¡¨ç¤ºæ•°æ®å—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œé•¿åº¦ä¸åº”è®¡å…¥meta */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ã€€ã€€ç„¶åæˆ‘ä»¬å®šä¹‰æ£€æŸ¥åœ°å€åˆæ³•æ€§çš„å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">t_block <span class="title">get_block</span><span class="params">(<span class="keyword">void</span> *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *tmp;</span><br><span class="line">    tmp = p;</span><br><span class="line">    <span class="keyword">return</span> (p = tmp -= BLOCK_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">valid_addr</span><span class="params">(<span class="keyword">void</span> *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(first_block) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p &gt; first_block &amp;&amp; p &lt; sbrk(<span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> p == (get_block(p))-&gt;ptr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ã€€å½“å¤šæ¬¡mallocå’Œfreeåï¼Œæ•´ä¸ªå†…å­˜æ± å¯èƒ½ä¼šäº§ç”Ÿå¾ˆå¤šç¢ç‰‡blockï¼Œè¿™äº›blockå¾ˆå°ï¼Œç»å¸¸æ— æ³•ä½¿ç”¨ï¼Œç”šè‡³å‡ºç°è®¸å¤šç¢ç‰‡è¿åœ¨ä¸€èµ·ï¼Œè™½ç„¶æ€»ä½“èƒ½æ»¡è¶³æŸæ­¤mallocè¦æ±‚ï¼Œä½†æ˜¯ç”±äºåˆ†å‰²æˆäº†å¤šä¸ªå°blockè€Œæ— æ³•fitï¼Œè¿™å°±æ˜¯ç¢ç‰‡é—®é¢˜ã€‚</p><p>ã€€ã€€ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹å¼æ—¶å½“freeæŸä¸ªblockæ—¶ï¼Œå¦‚æœå‘ç°å®ƒç›¸é‚»çš„blockä¹Ÿæ˜¯freeçš„ï¼Œåˆ™å°†blockå’Œç›¸é‚»blockåˆå¹¶ã€‚ä¸ºäº†æ»¡è¶³è¿™ä¸ªå®ç°ï¼Œéœ€è¦å°†s_blockæ”¹ä¸ºåŒå‘é“¾è¡¨ã€‚ä¿®æ”¹åçš„blockç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">s_block</span> *<span class="title">t_block</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s_block</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> size; <span class="comment">/* æ•°æ®åŒºå¤§å° */</span></span><br><span class="line">    t_block prev; <span class="comment">/* æŒ‡å‘ä¸Šä¸ªå—çš„æŒ‡é’ˆ */</span></span><br><span class="line">    t_block next; <span class="comment">/* æŒ‡å‘ä¸‹ä¸ªå—çš„æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">free</span>; <span class="comment">/* æ˜¯å¦æ˜¯ç©ºé—²å— */</span></span><br><span class="line">    <span class="keyword">int</span> padding; <span class="comment">/* å¡«å……4å­—èŠ‚ï¼Œä¿è¯metaå—é•¿åº¦ä¸º8çš„å€æ•° */</span></span><br><span class="line">    <span class="keyword">void</span> *ptr; <span class="comment">/* Magic pointerï¼ŒæŒ‡å‘data */</span></span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">1</span>] <span class="comment">/* è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿå­—æ®µï¼Œè¡¨ç¤ºæ•°æ®å—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œé•¿åº¦ä¸åº”è®¡å…¥meta */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ã€€ã€€åˆå¹¶æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">t_block <span class="title">fusion</span><span class="params">(t_block b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (b-&gt;next &amp;&amp; b-&gt;next-&gt;<span class="built_in">free</span>) &#123;</span><br><span class="line">        b-&gt;size += BLOCK_SIZE + b-&gt;next-&gt;size;</span><br><span class="line">        b-&gt;next = b-&gt;next-&gt;next;</span><br><span class="line">        <span class="keyword">if</span>(b-&gt;next)&#123;</span><br><span class="line">        b-&gt;next-&gt;prev = b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ã€€æœ‰äº†ä¸Šè¿°æ–¹æ³•ï¼Œfreeçš„å®ç°æ€è·¯å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼šé¦–å…ˆæ£€æŸ¥å‚æ•°åœ°å€çš„åˆæ³•æ€§ï¼Œå¦‚æœä¸åˆæ³•åˆ™ä¸åšä»»ä½•äº‹ï¼›å¦åˆ™ï¼Œå°†æ­¤block çš„freeæ ‡ä¸º1ï¼Œå¹¶ä¸”åœ¨å¯ä»¥çš„æƒ…å†µä¸‹ä¸åé¢çš„blockè¿›è¡Œåˆå¹¶ã€‚å¦‚æœå½“å‰æ˜¯æœ€åä¸€ä¸ªblockï¼Œåˆ™å›é€€breakæŒ‡é’ˆé‡Šæ”¾è¿›ç¨‹å†…å­˜ï¼Œå¦‚æœå½“å‰ blockæ˜¯æœ€åä¸€ä¸ªblockï¼Œåˆ™å›é€€breakæŒ‡é’ˆå¹¶è®¾ç½®first_blockä¸ºNULLã€‚å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span> </span>&#123;</span><br><span class="line">    t_block b;</span><br><span class="line">    <span class="keyword">if</span>(valid_addr(p)) &#123;</span><br><span class="line">        b = get_block(p);</span><br><span class="line">        b-&gt;<span class="built_in">free</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(b-&gt;prev &amp;&amp; b-&gt;prev-&gt;<span class="built_in">free</span>)</span><br><span class="line">        b = fusion(b-&gt;prev);</span><br><span class="line">        <span class="keyword">if</span>(b-&gt;next)</span><br><span class="line">        fusion(b);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(b-&gt;prev)</span><br><span class="line">        b-&gt;prev-&gt;prev = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        first_block = <span class="literal">NULL</span>;</span><br><span class="line">       brk(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-8-reallocçš„å®ç°"><a href="#3-2-8-reallocçš„å®ç°" class="headerlink" title="ã€€3.2.8 reallocçš„å®ç°"></a>ã€€3.2.8 reallocçš„å®ç°</h3><p>ã€€ã€€ä¸ºäº†å®ç°reallocï¼Œæˆ‘ä»¬é¦–å…ˆè¦å®ç°ä¸€ä¸ªå†…å­˜å¤åˆ¶æ–¹æ³•ã€‚å¦‚åŒcallocä¸€æ ·ï¼Œä¸ºäº†æ•ˆç‡ï¼Œæˆ‘ä»¬ä»¥8å­—èŠ‚ä¸ºå•ä½è¿›è¡Œå¤åˆ¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">copy_block</span><span class="params">(t_block src, t_block dst)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> *sdata, *ddata;</span><br><span class="line">    <span class="keyword">size_t</span> i;</span><br><span class="line">    sdata = src-&gt;ptr;</span><br><span class="line">    ddata = dst-&gt;ptr;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; (i * <span class="number">8</span>) &lt; src-&gt;size &amp;&amp; (i * <span class="number">8</span>) &lt; dst-&gt;size; i++)</span><br><span class="line">    ddata[i] = sdata[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ã€€ç„¶åæˆ‘ä»¬å¼€å§‹å®ç°reallocã€‚ä¸€ä¸ªç®€å•ï¼ˆä½†æ˜¯ä½æ•ˆï¼‰çš„æ–¹æ³•æ˜¯mallocä¸€æ®µå†…å­˜ï¼Œç„¶åå°†æ•°æ®å¤åˆ¶è¿‡å»ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥åšçš„æ›´é«˜æ•ˆï¼Œå…·ä½“å¯ä»¥è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ul><li>å¦‚æœå½“å‰blockçš„æ•°æ®åŒºå¤§äºç­‰äºreallocæ‰€è¦æ±‚çš„sizeï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œ</li><li>å¦‚æœæ–°çš„sizeå˜å°äº†ï¼Œè€ƒè™‘split</li><li>å¦‚æœå½“å‰blockçš„æ•°æ®åŒºä¸èƒ½æ»¡è¶³sizeï¼Œä½†æ˜¯å…¶åç»§blockæ˜¯freeçš„ï¼Œå¹¶ä¸”åˆå¹¶åå¯ä»¥æ»¡è¶³ï¼Œåˆ™è€ƒè™‘åšåˆå¹¶</li></ul><p>ã€€ã€€ä¸‹é¢æ˜¯reallocçš„å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">realloc</span><span class="params">(<span class="keyword">void</span> *p, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> s;</span><br><span class="line">    t_block b, <span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">void</span> *newp;</span><br><span class="line">    <span class="keyword">if</span> (!p)&#123;<span class="comment">/* æ ¹æ®æ ‡å‡†åº“æ–‡æ¡£ï¼Œå½“pä¼ å…¥NULLæ—¶ï¼Œç›¸å½“äºè°ƒç”¨malloc */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">malloc</span>(size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(valid_addr(p)) &#123;</span><br><span class="line">        s = align8(size);</span><br><span class="line">        b = get_block(p);</span><br><span class="line">        <span class="keyword">if</span>(b-&gt;size &gt;= s) &#123;</span><br><span class="line">            <span class="keyword">if</span>(b-&gt;size - s &gt;= (BLOCK_SIZE + <span class="number">8</span>))&#123;</span><br><span class="line">                split_block(b,s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* çœ‹æ˜¯å¦å¯è¿›è¡Œåˆå¹¶ */</span></span><br><span class="line">            <span class="keyword">if</span>(b-&gt;next &amp;&amp; b-&gt;next-&gt;<span class="built_in">free</span> &amp;&amp; (b-&gt;size + BLOCK_SIZE + b-&gt;next-&gt;size) &gt;= s) &#123;</span><br><span class="line">            fusion(b);</span><br><span class="line">                <span class="keyword">if</span>(b-&gt;size - s &gt;= (BLOCK_SIZE + <span class="number">8</span>))&#123;</span><br><span class="line">                    split_block(b, s);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* æ–°malloc */</span></span><br><span class="line">                newp = <span class="built_in">malloc</span> (s);</span><br><span class="line">                <span class="keyword">if</span> (!newp)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">new</span> = get_block(newp);</span><br><span class="line">                copy_block(b, <span class="keyword">new</span>);</span><br><span class="line">                <span class="built_in">free</span>(p);</span><br><span class="line">                <span class="keyword">return</span>(newp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-3-é—ç•™é—®é¢˜å’Œä¼˜åŒ–"><a href="#3-3-é—ç•™é—®é¢˜å’Œä¼˜åŒ–" class="headerlink" title="ã€€ã€€3.3 é—ç•™é—®é¢˜å’Œä¼˜åŒ–"></a>ã€€ã€€3.3 é—ç•™é—®é¢˜å’Œä¼˜åŒ–</h2><p>ã€€ã€€ä»¥ä¸Šæ˜¯ä¸€ä¸ªè¾ƒä¸ºç®€é™‹ï¼Œä½†æ˜¯åˆæ­¥å¯ç”¨çš„mallocå®ç°ã€‚è¿˜æœ‰å¾ˆå¤šé—ç•™çš„å¯èƒ½ä¼˜åŒ–ç‚¹ï¼Œä¾‹å¦‚ï¼š</p><ul><li>åŒæ—¶å…¼å®¹32ä½å’Œ64ä½ç³»ç»Ÿ</li><li>åœ¨åˆ†é…è¾ƒå¤§å¿«å†…å­˜æ—¶ï¼Œè€ƒè™‘ä½¿ç”¨mmapè€Œésbrkï¼Œè¿™é€šå¸¸æ›´é«˜æ•ˆ</li><li>å¯ä»¥è€ƒè™‘ç»´æŠ¤å¤šä¸ªé“¾è¡¨è€Œéå•ä¸ªï¼Œæ¯ä¸ªé“¾è¡¨ä¸­çš„blockå¤§å°å‡ä¸ºä¸€ä¸ªèŒƒå›´å†…ï¼Œä¾‹å¦‚8å­—èŠ‚é“¾è¡¨ã€16å­—èŠ‚é“¾è¡¨ã€24-32å­—èŠ‚é“¾è¡¨ç­‰ç­‰ã€‚æ­¤æ—¶å¯ä»¥æ ¹æ®sizeåˆ°å¯¹åº”é“¾è¡¨ä¸­åšåˆ†é…ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘ç¢ç‰‡ï¼Œå¹¶æé«˜æŸ¥è¯¢blockçš„é€Ÿåº¦</li><li>å¯ä»¥è€ƒè™‘é“¾è¡¨ä¸­åªå­˜æ”¾freeçš„blockï¼Œè€Œä¸å­˜æ”¾å·²åˆ†é…çš„blockï¼Œå¯ä»¥å‡å°‘æŸ¥æ‰¾blockçš„æ¬¡æ•°ï¼Œæé«˜æ•ˆç‡</li></ul><p>ã€€ã€€è¿˜æœ‰å¾ˆå¤šå¯èƒ½çš„ä¼˜åŒ–ï¼Œè¿™é‡Œä¸ä¸€ä¸€èµ˜è¿°ã€‚ä¸‹é¢é™„ä¸Šä¸€äº›å‚è€ƒæ–‡çŒ®ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥æ›´æ·±å…¥ç ”ç©¶ã€‚</p><h1 id="4-å…¶å®ƒå‚è€ƒ"><a href="#4-å…¶å®ƒå‚è€ƒ" class="headerlink" title="ã€€ã€€4 å…¶å®ƒå‚è€ƒ"></a>ã€€ã€€4 å…¶å®ƒå‚è€ƒ</h1><ol><li>è¿™ç¯‡æ–‡ç« å¤§é‡å‚è€ƒäº†<a href="http://www.inf.udec.cl/~leo/Malloc_tutorial.pdf" target="_blank" rel="noopener">A malloc Tutorial</a>ï¼Œå…¶ä¸­ä¸€äº›å›¾ç‰‡å’Œä»£ç ç›´æ¥å¼•ç”¨äº†æ–‡ä¸­çš„å†…å®¹ï¼Œè¿™é‡Œç‰¹åˆ«æŒ‡å‡º</li><li><a href="http://csapp.cs.cmu.edu/" target="_blank" rel="noopener">Computer Systems: A Programmerâ€™s Perspective, 2/E</a>ä¸€ä¹¦æœ‰è®¸å¤šå€¼å¾—å‚è€ƒçš„åœ°æ–¹</li><li>å…³äºLinuxçš„è™šæ‹Ÿå†…å­˜æ¨¡å‹ï¼Œ<a href="http://duartes.org/gustavo/blog/post/anatomy-of-a-program-in-memory/" target="_blank" rel="noopener">Anatomy of a Program in Memory</a>æ˜¯å¾ˆå¥½çš„å‚è€ƒèµ„æ–™ï¼Œå¦å¤–ä½œè€…è¿˜æœ‰ä¸€ç¯‡<a href="http://duartes.org/gustavo/blog/post/how-the-kernel-manages-your-memory/" target="_blank" rel="noopener">How the Kernel Manages Your Memory</a>å¯¹äºLinuxå†…æ ¸ä¸­è™šæ‹Ÿå†…å­˜ç®¡ç†çš„éƒ¨åˆ†æœ‰å¾ˆå¥½çš„è®²è§£</li><li>å¯¹äºçœŸå®ä¸–ç•Œçš„mallocå®ç°ï¼Œå¯ä»¥å‚è€ƒ<a href="http://repo.or.cz/w/glibc.git/blob/HEAD:/malloc/malloc.c" target="_blank" rel="noopener">glibcçš„å®ç°</a></li><li>æœ¬æ–‡å†™ä½œè¿‡ç¨‹ä¸­å¤§é‡å‚è€ƒäº†<a href="http://www.wikipedia.org/" target="_blank" rel="noopener">ç»´åŸºç™¾ç§‘</a>ï¼Œå†æ¬¡æ„Ÿè°¢è¿™ä¸ªä¼Ÿå¤§çš„ç½‘ç«™ï¼Œå¹¶ä¸”å‘¼åå¤§å®¶åœ¨æ‰‹å¤´å…è®¸çš„æƒ…å†µä¸‹å¯ä»¥é€‚å½“æåŠ©ç»´åŸºç™¾ç§‘ï¼Œå¸®åŠ©è¿™ä¸ªé€ ç¦äººç±»çš„ç³»ç»Ÿè¿è¡Œä¸‹å»</li></ol><p>æœ¬æ–‡è½¬è½½è‡ªåšå®¢å›­ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="https://www.cnblogs.com/Commence/p/5785912.html" target="_blank" rel="noopener">https://www.cnblogs.com/Commence/p/5785912.html</a>ã€‚çœ‹å®Œåå¯¹å†…å­˜ç®¡ç†çŸ¥è¯†éå¸¸æ¸…æ™°ï¼Œéå¸¸æ„Ÿè°¢åŸåšä¸»çš„ç²¾å½©åˆ†äº«ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;â€‹    å¾ˆå¤šå­¦è¿‡Cçš„äººå¯¹mallocéƒ½ä¸æ˜¯å¾ˆäº†è§£ï¼ŒçŸ¥é“ä½¿ç”¨mallocè¦åŠ å¤´æ–‡ä»¶,çŸ¥é“mallocæ˜¯åˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜ï¼ŒçŸ¥é“å’Œfreeå‡½æ•°æ˜¯ä¸€èµ·ç”¨çš„ã€‚ä½†æ˜¯ä½†æ˜¯ï¼šä¸€éƒ¨åˆ†äººè¿˜æ˜¯å°†ï¼šmallocå½“ä½œç³»ç»Ÿæ‰€æä¾›çš„æˆ–è€…æ˜¯Cçš„å…³é”®å­—ï¼Œäº‹å®ä¸Šï¼šmallocåªæ˜¯Cæ ‡å‡†åº“ä¸­æä¾›çš„ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼Œè€Œä¸”å¾ˆå¤šå¾ˆå¤šäººéƒ½å¯¹mallocçš„å…·ä½“å®ç°æœºåˆ¶ä¸æ˜¯å¾ˆäº†è§£ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="c/malloc/01" scheme="http://xwxz.github.io/categories/c-malloc-01/"/>
    
    
      <category term="cè¯­è¨€" scheme="http://xwxz.github.io/tags/c%E8%AF%AD%E8%A8%80/"/>
    
      <category term="å†…å­˜ç®¡ç†" scheme="http://xwxz.github.io/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
      <category term="malloc" scheme="http://xwxz.github.io/tags/malloc/"/>
    
  </entry>
  
  <entry>
    <title>PHPæºç ä¹‹å®ã€è½¬è½½ã€‘</title>
    <link href="http://xwxz.github.io/php-source-macro-01/"/>
    <id>http://xwxz.github.io/php-source-macro-01/</id>
    <published>2018-07-21T09:47:26.000Z</published>
    <updated>2019-03-05T08:49:36.120Z</updated>
    
    <content type="html"><![CDATA[<p>â€‹    ä½œä¸º PHPerï¼Œæˆ‘ä»¬å‡ ä¹æ¯å¤©éƒ½åœ¨å†™å‡½æ•°ï¼Œæˆ‘ä»¬ä¸€å®šä¼šå¥½å¥‡ï¼Œé‚£äº› PHP å†…ç½®çš„å‡½æ•°ï¼Œæ˜¯é•¿ä»€ä¹ˆæ ·å­çš„ã€‚å¦‚æœå†™è¿‡ PHP æ‰©å±•çš„è¯ï¼Œä¸€å®šçŸ¥é“è¿™ä¸ªå®ï¼š<code>PHP_FUNCTION</code>ã€‚åœ¨å®šä¹‰ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œè¿™æ ·æ¥ä½¿ç”¨è¿™ä¸ªå®ã€‚ä¾‹å¦‚ <code>array_change_key_case</code>ï¼Œå®ƒçš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š<code>PHP_FUNCTION(array_change_key_case)</code>ã€‚æ²¡é”™ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚ä½†æ˜¯ï¼Œåœ¨è¿™ä¸ªç®€å•çš„èƒŒåï¼Œå´æ²¡æœ‰è¿™ä¹ˆç®€å•ã€‚</p><a id="more"></a><h2 id="PHP-FUNCTION-è¿½æ ¹æº¯æº"><a href="#PHP-FUNCTION-è¿½æ ¹æº¯æº" class="headerlink" title="PHP_FUNCTION è¿½æ ¹æº¯æº"></a>PHP_FUNCTION è¿½æ ¹æº¯æº</h2><h3 id="å®"><a href="#å®" class="headerlink" title="å®"></a>å®</h3><p>ç›¸ä¿¡å¯¹è¿™ç¯‡æ–‡ç« æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œä¸€å®šå¤šå°‘å¯¹ C è¯­è¨€ä»¥åŠå®ƒçš„å®å®šä¹‰æœ‰ä¸€å®šçš„äº†è§£ã€‚å¦‚æœæ²¡æœ‰ï¼Œä¹Ÿä¸è¦ç´§ï¼Œæˆ‘è¿™é‡Œæ¥ç®€å•è§£é‡Šä¸€ä¸‹ï¼Œä»€ä¹ˆæ˜¯å®ã€‚</p><p>C è¯­è¨€ä¸­çš„å®ï¼Œæˆ‘è®¤ä¸ºï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ç§ç®€å•çš„å°è£…ã€‚é€šè¿‡å®å®šä¹‰ï¼Œå¯ä»¥å¯¹å¼€å‘è€…éšå»ä¸€äº›ç»†èŠ‚ï¼Œè®©å¼€å‘è€…åœ¨ä½¿ç”¨ç®€å•çš„è¯­æ³•æ¥å®Œæˆé‡å¤çš„å¤æ‚çš„ç¼–ç ã€‚å½“ç„¶ï¼Œå®å®šä¹‰è¿˜æœ‰å…¶å®ƒçš„ç”¨é€”ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬åœ¨ <code>PHP_FUNCTION</code> æ¶‰åŠåˆ°çš„å°±æ˜¯è¿™ä¸ªä½œç”¨ã€‚æœ‰ä¸‹é¢çš„ä»£ç ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEST(test) void test(int a)</span></span><br><span class="line">TEST(haha)</span><br></pre></td></tr></table></figure><p>å®ï¼Œå°±æ˜¯å®Œå…¨çš„æ›¿æ¢ï¼Œå³ä½¿ç”¨åé¢çš„è¯­å¥æ›¿æ¢å‰é¢çš„ã€‚é‚£ä¹ˆå¯¹äºä¸‹é¢çš„ <code>TEST(haha)</code> å°±ç›¸å½“äºä¸‹é¢çš„æ ·å­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">haha</span><span class="params">(<span class="keyword">int</span> a)</span></span></span><br></pre></td></tr></table></figure><h3 id="PHP-FUNCTION-çš„å®šä¹‰"><a href="#PHP-FUNCTION-çš„å®šä¹‰" class="headerlink" title="PHP_FUNCTION çš„å®šä¹‰"></a>PHP_FUNCTION çš„å®šä¹‰</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦å®šä¹‰å‡½æ•°ï¼Œè¿™æ ·ä½¿ç”¨è¿™ä¸ªå®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(array_change_key_case)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨ <code>php-src/main/php.h</code> ä¸­æ‰¾åˆ°äº†ä¸‹é¢çš„å®šä¹‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_FUNCTION ZEND_FUNCTION</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œç”¨ <code>ZEND_FUNCTION</code> æ›¿æ¢äº† <code>PHP_FUNCTION</code> è¿™ä¸ªå®ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬çš„å®šä¹‰å°±ç›¸å½“äºå˜æˆäº†è¿™æ ·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZEND_FUNCTION(array_change_key_case)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç»§ç»­å¾€ä¸‹æ‰¾ï¼Œå› ä¸ºï¼Œè¿™é‡Œè¿˜æ˜¯å®ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰çœ‹åˆ°æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <code>php-src/Zend/zend_API.h</code> ä¸­æ‰¾åˆ°ä¸‹é¢çš„å®šä¹‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_FN(name) zif_##name</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_FUNCTION(name) ZEND_NAMED_FUNCTION(ZEND_FN(name))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_NAMED_FUNCTION(name) void name(INTERNAL_FUNCTION_PARAMETERS)</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨å®å®šä¹‰ä¸­ï¼Œä½¿ç”¨äº†å¦å¤–çš„å®ã€‚ä¸è¦æ€•ï¼Œè¿˜æ˜¯ä¸€ä¸ªè¯ï¼Œæ›¿æ¢ã€‚æˆ‘ä»¬æŒ‰ç…§è¿™æ ·çš„æ­¥éª¤æ¥ã€‚ï¼ˆ<code>##</code> æ˜¯ä¸€ä¸ªè¿æ¥ç¬¦ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼Œæ˜¯å°†å®ƒå‰é¢çš„ä¸åé¢çš„ï¼ŒæŒ‰ç…§å­—ç¬¦ä¸²çš„æ–¹å¼è¿æ¥èµ·æ¥ã€‚</p><ol><li>æ›¿æ¢ <code>ZEND_FUNCTION</code></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZEND_NAMED_FUNCTION(ZEND_FN(name))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æ›¿æ¢ <code>ZEND_FN</code></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZEND_NAMED_FUNCTION(zif_array_change_key_case)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æ›¿æ¢ <code>ZEND_NAMED_FUNCTION</code></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zif_array_change_key_case</span><span class="params">(INTERNAL_FUNCTION_PARAMETERS)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå·²ç»åŸºæœ¬å’Œæˆ‘ä»¬ç†Ÿæ‚‰çš„å‡½æ•°å®šä¹‰å·®ä¸å¤šäº†ï¼Œä¸è¿‡ï¼Œè¿™è¿˜æ²¡å®Œï¼Œä»¥ä¸ºï¼Œè¿™é‡Œè¿˜æœ‰å®ï¼Œé‚£å°±æ˜¯ <code>INTERNAL_FUNCTION_PARAMETERS</code>ã€‚æˆ‘ä»¬æ‰¾åˆ° <code>php-src/Zend/zend.h</code>ï¼Œå¯ä»¥æ‰¾åˆ° <code>INTERNAL_FUNCTION_PARAMETERS</code>çš„å®å®šä¹‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INTERNAL_FUNCTION_PARAMETERS zend_execute_data *execute_data, zval *return_value</span></span><br></pre></td></tr></table></figure><p>å¥½äº†ï¼Œä¾ç„¶æŒ‰ç…§æ›¿æ¢çš„åŸåˆ™ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†å‡½æ•°å®šä¹‰å˜æˆè¿™æ ·äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zif_array_change_key_case</span><span class="params">(zend_execute_data *execute_data, zval *return_value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ï¼Œæ•´ä¸ªå‡½æ•°çš„å®šä¹‰ï¼Œå·²ç»å®Œå…¨æ²¡æœ‰å®äº†ï¼Œè¿™å·²ç»æ˜¯æˆ‘ä»¬åœ¨ç†Ÿæ‚‰ä¸è¿‡çš„ C è¯­è¨€å‡½æ•°çš„å®šä¹‰äº†ã€‚è¿™å°±æ˜¯<br><code>PHP_FUNCTION</code> çš„æ•´ä¸ªå®šä¹‰çš„è¿‡ç¨‹ã€‚</p><h3 id="execute-data-å’Œ-return-value"><a href="#execute-data-å’Œ-return-value" class="headerlink" title="execute_data å’Œ return_value"></a>execute_data å’Œ return_value</h3><p><code>return_value</code>ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å®šä¹‰çš„ PHP å‡½æ•°çš„è¿”å›å€¼ã€‚è€Œ <code>execute_data</code>ï¼ŒæŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œå°±æ˜¯ Zend å†…éƒ¨çš„ä¸€ä¸ªè°ƒç”¨æ ˆï¼Œè€Œåœ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼ŒæŒ‡å‘çš„æ˜¯è¿™ä¸ªå‡½æ•°çš„æ ˆå¸§ã€‚å…·ä½“çš„ç»†èŠ‚ï¼Œæš‚æ—¶åœ¨è¿™é‡Œå…ˆä¸è€ƒè™‘ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥æ¥è¿™é‡Œçœ‹ä¸€ä¸‹</p><p>æ–‡ç« è½¬è½½è‡ªsegmentfaultï¼ŒåŸæ–‡åœ°å€ï¼š<a href="https://segmentfault.com/a/1190000010529733" target="_blank" rel="noopener">https://segmentfault.com/a/1190000010529733</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;â€‹    ä½œä¸º PHPerï¼Œæˆ‘ä»¬å‡ ä¹æ¯å¤©éƒ½åœ¨å†™å‡½æ•°ï¼Œæˆ‘ä»¬ä¸€å®šä¼šå¥½å¥‡ï¼Œé‚£äº› PHP å†…ç½®çš„å‡½æ•°ï¼Œæ˜¯é•¿ä»€ä¹ˆæ ·å­çš„ã€‚å¦‚æœå†™è¿‡ PHP æ‰©å±•çš„è¯ï¼Œä¸€å®šçŸ¥é“è¿™ä¸ªå®ï¼š&lt;code&gt;PHP_FUNCTION&lt;/code&gt;ã€‚åœ¨å®šä¹‰ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œè¿™æ ·æ¥ä½¿ç”¨è¿™ä¸ªå®ã€‚ä¾‹å¦‚ &lt;code&gt;array_change_key_case&lt;/code&gt;ï¼Œå®ƒçš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š&lt;code&gt;PHP_FUNCTION(array_change_key_case)&lt;/code&gt;ã€‚æ²¡é”™ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚ä½†æ˜¯ï¼Œåœ¨è¿™ä¸ªç®€å•çš„èƒŒåï¼Œå´æ²¡æœ‰è¿™ä¹ˆç®€å•ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="php/source/macro/01" scheme="http://xwxz.github.io/categories/php-source-macro-01/"/>
    
    
      <category term="PHP" scheme="http://xwxz.github.io/tags/PHP/"/>
    
      <category term="æºç åˆ†æ" scheme="http://xwxz.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Golangæ˜¯å¦‚ä½•è°ƒåº¦Go Routineçš„ï¼Ÿã€è½¬è½½ã€‘</title>
    <link href="http://xwxz.github.io/golang-goroutine-02/"/>
    <id>http://xwxz.github.io/golang-goroutine-02/</id>
    <published>2017-12-21T16:00:00.000Z</published>
    <updated>2018-08-25T08:08:50.500Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦è®²è§£goæ˜¯å¦‚ä½•è°ƒåº¦runtineçš„ï¼Œç»“åˆå›¾å½¢çš„æ–¹å¼ï¼Œè®©äººæ›´åŠ æ¸…æ™°æ˜äº†ï¼Œè‹±æ–‡åŸæ–‡æˆ³<a href="https://link.zhihu.com/?target=http%3A//morsmachine.dk/go-scheduler" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p><a id="more"></a><h3 id="Go-runtineçš„è°ƒåº¦å™¨"><a href="#Go-runtineçš„è°ƒåº¦å™¨" class="headerlink" title="Go runtineçš„è°ƒåº¦å™¨"></a>Go runtineçš„è°ƒåº¦å™¨</h3><p> åœ¨äº†è§£Goçš„è¿è¡Œæ—¶çš„schedulerä¹‹å‰ï¼Œéœ€è¦å…ˆäº†è§£ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½ä¼šæƒ³ï¼ŒOSå†…æ ¸ä¸æ˜¯å·²ç»æœ‰ä¸€ä¸ªçº¿ç¨‹scheduleräº†å˜›ï¼Ÿ<br> ç†Ÿæ‚‰POSIX APIçš„äººéƒ½çŸ¥é“ï¼ŒPOSIXçš„æ–¹æ¡ˆåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å¯¹Unix processè¿›åœºæ¨¡å‹çš„ä¸€ä¸ªé€»è¾‘æè¿°å’Œæ‰©å±•ï¼Œä¸¤è€…æœ‰å¾ˆå¤šç›¸ä¼¼çš„åœ°æ–¹ã€‚ Threadæœ‰è‡ªå·±çš„ä¿¡å·æ©ç ï¼ŒCPU affinityç­‰ã€‚ä½†æ˜¯å¾ˆå¤šç‰¹å¾å¯¹äºGoç¨‹åºæ¥è¯´éƒ½æ˜¯ç´¯èµ˜ã€‚ å°¤å…¶æ˜¯contextä¸Šä¸‹æ–‡åˆ‡æ¢çš„è€—æ—¶ã€‚å¦ä¸€ä¸ªåŸå› æ˜¯Goçš„åƒåœ¾å›æ”¶éœ€è¦æ‰€æœ‰çš„goroutineåœæ­¢ï¼Œä½¿å¾—å†…å­˜åœ¨ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚åƒåœ¾å›æ”¶çš„æ—¶é—´ç‚¹æ˜¯ä¸ç¡®å®šçš„ï¼Œå¦‚æœä¾é OSè‡ªèº«çš„scheduleræ¥è°ƒåº¦ï¼Œé‚£ä¹ˆä¼šæœ‰å¤§é‡çš„çº¿ç¨‹éœ€è¦åœæ­¢å·¥ä½œã€‚ </p><p>å•ç‹¬çš„å¼€å‘ä¸€ä¸ªGOå¾—è°ƒåº¦å™¨ï¼Œå¯ä»¥æ˜¯å…¶çŸ¥é“åœ¨ä»€ä¹ˆæ—¶å€™å†…å­˜çŠ¶æ€æ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å¼€å§‹åƒåœ¾å›æ”¶æ—¶ï¼Œè¿è¡Œæ—¶åªéœ€è¦ä¸ºå½“æ—¶æ­£åœ¨CPUæ ¸ä¸Šè¿è¡Œçš„é‚£ä¸ªçº¿ç¨‹ç­‰å¾…å³å¯ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ‰€æœ‰çš„çº¿ç¨‹ã€‚</p><p>ç”¨æˆ·ç©ºé—´çº¿ç¨‹å’Œå†…æ ¸ç©ºé—´çº¿ç¨‹ä¹‹é—´çš„æ˜ å°„å…³ç³»æœ‰ï¼šN:1,1:1å’ŒM:N<br> <strong>N:1æ˜¯è¯´</strong>ï¼šå¤šä¸ªï¼ˆNï¼‰ç”¨æˆ·çº¿ç¨‹å§‹ç»ˆåœ¨ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä¸Šè·‘ï¼Œcontextä¸Šä¸‹æ–‡åˆ‡æ¢ç¡®å®å¾ˆå¿«ï¼Œä½†æ˜¯æ— æ³•çœŸæ­£çš„åˆ©ç”¨å¤šæ ¸ã€‚<br> <strong>1:1æ˜¯è¯´</strong>ï¼šä¸€ä¸ªç”¨æˆ·çº¿ç¨‹å°±åªåœ¨ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä¸Šè·‘ï¼Œè¿™æ—¶å¯ä»¥åˆ©ç”¨å¤šæ ¸ï¼Œä½†æ˜¯ä¸Šä¸‹æ–‡switchå¾ˆæ…¢ã€‚<br> <strong>M:Næ˜¯è¯´</strong>ï¼šå¤šä¸ªgoroutineåœ¨å¤šä¸ªå†…æ ¸çº¿ç¨‹ä¸Šè·‘ï¼Œè¿™ä¸ªçœ‹ä¼¼å¯ä»¥é›†é½ä¸Šé¢ä¸¤è€…çš„ä¼˜åŠ¿ï¼Œä½†æ˜¯æ— ç–‘å¢åŠ äº†è°ƒåº¦çš„éš¾åº¦ã€‚</p><p><img src="https://ws1.sinaimg.cn/large/006tNc79ly1ftijg0tvwaj30av02vjrp.jpg" alt="img"></p><p> Goçš„è°ƒåº¦å™¨å†…éƒ¨æœ‰ä¸‰ä¸ªé‡è¦çš„ç»“æ„ï¼šMï¼ŒPï¼ŒS<br> <strong>M:</strong>ä»£è¡¨çœŸæ­£çš„å†…æ ¸OSçº¿ç¨‹ï¼Œå’ŒPOSIXé‡Œçš„threadå·®ä¸å¤šï¼ŒçœŸæ­£å¹²æ´»çš„äºº<br> <strong>G:</strong>ä»£è¡¨ä¸€ä¸ªgoroutineï¼Œå®ƒæœ‰è‡ªå·±çš„æ ˆï¼Œinstruction pointerå’Œå…¶ä»–ä¿¡æ¯ï¼ˆæ­£åœ¨ç­‰å¾…çš„channelç­‰ç­‰ï¼‰ï¼Œç”¨äºè°ƒåº¦ã€‚<br> <strong>P:</strong>ä»£è¡¨è°ƒåº¦çš„ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥æŠŠå®ƒçœ‹åšä¸€ä¸ªå±€éƒ¨çš„è°ƒåº¦å™¨ï¼Œä½¿goä»£ç åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šè·‘ï¼Œå®ƒæ˜¯å®ç°ä»N:1åˆ°N:Mæ˜ å°„çš„å…³é”®ã€‚</p><p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1ftijh62jovj30b40av75n.jpg" alt="img"></p><p> å›¾ä¸­çœ‹ï¼Œæœ‰2ä¸ªç‰©ç†çº¿ç¨‹Mï¼Œæ¯ä¸€ä¸ªMéƒ½æ‹¥æœ‰ä¸€ä¸ªcontextï¼ˆPï¼‰ï¼Œæ¯ä¸€ä¸ªä¹Ÿéƒ½æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„goroutineã€‚<br> Pçš„æ•°é‡å¯ä»¥é€šè¿‡GOMAXPROCS()æ¥è®¾ç½®ï¼Œå®ƒå…¶å®ä¹Ÿå°±ä»£è¡¨äº†çœŸæ­£çš„å¹¶å‘åº¦ï¼Œå³æœ‰å¤šå°‘ä¸ªgoroutineå¯ä»¥åŒæ—¶è¿è¡Œã€‚<br> å›¾ä¸­ç°è‰²çš„é‚£äº›goroutineå¹¶æ²¡æœ‰è¿è¡Œï¼Œè€Œæ˜¯å‡ºäºreadyçš„å°±ç»ªæ€ï¼Œæ­£åœ¨ç­‰å¾…è¢«è°ƒåº¦ã€‚Pç»´æŠ¤ç€è¿™ä¸ªé˜Ÿåˆ—ï¼ˆç§°ä¹‹ä¸ºrunqueueï¼‰ï¼Œ<br> Goè¯­è¨€é‡Œï¼Œå¯åŠ¨ä¸€ä¸ªgoroutineå¾ˆå®¹æ˜“ï¼šgo function å°±è¡Œï¼Œæ‰€ä»¥æ¯æœ‰ä¸€ä¸ªgoè¯­å¥è¢«æ‰§è¡Œï¼Œrunqueueé˜Ÿåˆ—å°±åœ¨å…¶æœ«å°¾åŠ å…¥ä¸€ä¸ª<br> goroutineï¼Œåœ¨ä¸‹ä¸€ä¸ªè°ƒåº¦ç‚¹ï¼Œå°±ä»runqueueä¸­å–å‡ºï¼ˆå¦‚ä½•å†³å®šå–å“ªä¸ªgoroutineï¼Ÿï¼‰ä¸€ä¸ªgoroutineæ‰§è¡Œã€‚</p><p>ä¸ºä½•è¦ç»´æŠ¤å¤šä¸ªä¸Šä¸‹æ–‡Pï¼Ÿå› ä¸ºå½“ä¸€ä¸ªOSçº¿ç¨‹è¢«é˜»å¡æ—¶ï¼ŒPå¯ä»¥è½¬è€ŒæŠ•å¥”å¦ä¸€ä¸ªOSçº¿ç¨‹ï¼<br> å›¾ä¸­çœ‹åˆ°ï¼Œå½“ä¸€ä¸ªOSçº¿ç¨‹M0é™·å…¥é˜»å¡æ—¶ï¼ŒPè½¬è€Œåœ¨OSçº¿ç¨‹M1ä¸Šè¿è¡Œã€‚è°ƒåº¦å™¨ä¿è¯æœ‰è¶³å¤Ÿçš„çº¿ç¨‹æ¥è¿è¡Œæ‰€ä»¥çš„context Pã€‚</p><p><img src="https://ws3.sinaimg.cn/large/006tNc79ly1ftijgiggl3j30fa0b4wfz.jpg" alt="img"></p><p> å›¾ä¸­çš„M1å¯èƒ½æ˜¯è¢«åˆ›å»ºï¼Œæˆ–è€…ä»çº¿ç¨‹ç¼“å­˜ä¸­å–å‡ºã€‚</p><p>å½“MOè¿”å›æ—¶ï¼Œå®ƒå¿…é¡»å°è¯•å–å¾—ä¸€ä¸ªcontext Pæ¥è¿è¡Œgoroutineï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ƒä¼šä»å…¶ä»–çš„OSçº¿ç¨‹é‚£é‡Œstealå·ä¸€ä¸ªcontextè¿‡æ¥ï¼Œ<br> å¦‚æœæ²¡æœ‰å·åˆ°çš„è¯ï¼Œå®ƒå°±æŠŠgoroutineæ”¾åœ¨ä¸€ä¸ªglobal runqueueé‡Œï¼Œç„¶åè‡ªå·±å°±å»ç¡å¤§è§‰äº†ï¼ˆæ”¾å…¥çº¿ç¨‹ç¼“å­˜é‡Œï¼‰ã€‚Contextsä»¬ä¹Ÿä¼šå‘¨æœŸæ€§çš„æ£€æŸ¥global runqueueï¼Œå¦åˆ™global runqueueä¸Šçš„goroutineæ°¸è¿œæ— æ³•æ‰§è¡Œã€‚</p><p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1ftijga28wzj30fa0b4q4c.jpg" alt="img"></p><p> å¦ä¸€ç§æƒ…å†µæ˜¯Pæ‰€åˆ†é…çš„ä»»åŠ¡Gå¾ˆå¿«å°±æ‰§è¡Œå®Œäº†ï¼ˆåˆ†é…ä¸å‡ï¼‰ï¼Œè¿™å°±å¯¼è‡´äº†ä¸€ä¸ªä¸Šä¸‹æ–‡Pé—²ç€æ²¡äº‹å„¿å¹²è€Œç³»ç»Ÿå´ä»»ç„¶å¿™ç¢Œã€‚ä½†æ˜¯å¦‚æœglobal runqueueæ²¡æœ‰ä»»åŠ¡Gäº†ï¼Œé‚£ä¹ˆPå°±ä¸å¾—ä¸ä»å…¶ä»–çš„ä¸Šä¸‹æ–‡Pé‚£é‡Œæ‹¿ä¸€äº›Gæ¥æ‰§è¡Œã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä¸Šä¸‹æ–‡Pä»å…¶ä»–çš„ä¸Šä¸‹æ–‡Pé‚£é‡Œè¦å·ä¸€ä¸ªä»»åŠ¡çš„è¯ï¼Œä¸€èˆ¬å°±â€˜å·â€™run queueçš„ä¸€åŠï¼Œè¿™å°±ç¡®ä¿äº†æ¯ä¸ªOSçº¿ç¨‹éƒ½èƒ½å……åˆ†çš„ä½¿ç”¨ã€‚ </p><p>æ–‡ç« è½¬è½½è‡ªï¼š<a href="https://www.zhihu.com/question/20862617/answer/27964865" target="_blank" rel="noopener">https://www.zhihu.com/question/20862617/answer/27964865</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡ä¸»è¦è®²è§£goæ˜¯å¦‚ä½•è°ƒåº¦runtineçš„ï¼Œç»“åˆå›¾å½¢çš„æ–¹å¼ï¼Œè®©äººæ›´åŠ æ¸…æ™°æ˜äº†ï¼Œè‹±æ–‡åŸæ–‡æˆ³&lt;a href=&quot;https://link.zhihu.com/?target=http%3A//morsmachine.dk/go-scheduler&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;è¿™é‡Œ&lt;/a&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="golang/goroutine/02" scheme="http://xwxz.github.io/categories/golang-goroutine-02/"/>
    
    
      <category term="Golang" scheme="http://xwxz.github.io/tags/Golang/"/>
    
      <category term="routine" scheme="http://xwxz.github.io/tags/routine/"/>
    
  </entry>
  
  <entry>
    <title>GoroutineèƒŒåçš„ç³»ç»ŸçŸ¥è¯†ã€è½¬è½½ã€‘</title>
    <link href="http://xwxz.github.io/golang-goroutine-01/"/>
    <id>http://xwxz.github.io/golang-goroutine-01/</id>
    <published>2017-12-11T04:30:44.000Z</published>
    <updated>2018-08-25T08:08:25.371Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://golang.org/" target="_blank" rel="noopener">Goè¯­è¨€</a> ä»è¯ç”Ÿåˆ°æ™®åŠå·²ç»ä¸‰å¹´äº†ï¼Œå…ˆè¡Œè€…å¤§éƒ½æ˜¯Webå¼€å‘çš„èƒŒæ™¯ï¼Œä¹Ÿæœ‰äº†ä¸€äº›æ™®åŠå‹çš„ä¹¦ç±ï¼Œå¯ç³»ç»Ÿå¼€å‘èƒŒæ™¯çš„äººåœ¨å­¦ä¹ è¿™äº›ä¹¦ç±çš„æ—¶å€™ï¼Œæ€»æœ‰è¯­ç„‰ä¸è¯¦çš„æ„Ÿè§‰ï¼Œç½‘ä¸Šä¹Ÿæœ‰è‹¥å¹²æµä¼ ç”šå¹¿çš„æ–‡ç« ï¼Œå¯å…¶ä¸­æˆ–å¤šæˆ–å°‘æ€»æœ‰äº›ä¸äº‹å®ä¸ç¬¦çš„æŠ€æœ¯æè¿°ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½ä¸ºæ¯”è¾ƒç¼ºå°‘ç³»ç»Ÿç¼–ç¨‹èƒŒæ™¯çš„Webå¼€å‘äººå‘˜ä»‹ç»ä¸€ä¸‹<a href="http://golang.org/doc/effective_go.html#goroutines" target="_blank" rel="noopener">goroutine</a>èƒŒåçš„ç³»ç»ŸçŸ¥è¯†ã€‚</p><a id="more"></a><h2 id="1ã€æ“ä½œç³»ç»Ÿä¸è¿è¡Œåº“"><a href="#1ã€æ“ä½œç³»ç»Ÿä¸è¿è¡Œåº“" class="headerlink" title="1ã€æ“ä½œç³»ç»Ÿä¸è¿è¡Œåº“"></a>1ã€æ“ä½œç³»ç»Ÿä¸è¿è¡Œåº“</h2><pre><code>å¯¹äºæ™®é€šçš„ç”µè„‘ç”¨æˆ·æ¥è¯´ï¼Œèƒ½ç†è§£åº”ç”¨ç¨‹åºæ˜¯è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šå°±è¶³å¤Ÿäº†ï¼Œå¯å¯¹äºå¼€å‘è€…ï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£æˆ‘ä»¬å†™çš„ç¨‹åºæ˜¯å¦‚ä½•åœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šè¿è¡Œèµ·æ¥çš„ï¼Œæ“ä½œç³»ç»Ÿå¦‚ä½•ä¸ºåº”ç”¨ç¨‹åºæä¾›æœåŠ¡ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½åˆ†æ¸…æ¥šå“ªäº›æœåŠ¡æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ï¼Œè€Œå“ªäº›æœåŠ¡æ˜¯ç”±æˆ‘ä»¬æ‰€ä½¿ç”¨çš„è¯­è¨€çš„è¿è¡Œåº“æä¾›çš„ã€‚é™¤äº†å†…å­˜ç®¡ç†ã€æ–‡ä»¶ç®¡ç†ã€è¿›ç¨‹ç®¡ç†ã€å¤–è®¾ç®¡ç†ç­‰ç­‰å†…éƒ¨æ¨¡å—ä»¥å¤–ï¼Œæ“ä½œç³»ç»Ÿè¿˜æä¾›äº†è®¸å¤šå¤–éƒ¨æ¥å£ä¾›åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œè¿™äº›æ¥å£å°±æ˜¯æ‰€è°“çš„â€œç³»ç»Ÿè°ƒç”¨â€ã€‚ä»DOSæ—¶ä»£å¼€å§‹ï¼Œç³»ç»Ÿè°ƒç”¨å°±æ˜¯é€šè¿‡è½¯ä¸­æ–­çš„å½¢å¼æ¥æä¾›ï¼Œä¹Ÿå°±æ˜¯è‘—åçš„[INT 21](http://stanislavs.org/helppc/int_21.html)ï¼Œç¨‹åºæŠŠéœ€è¦è°ƒç”¨çš„åŠŸèƒ½ç¼–å·æ”¾å…¥AHå¯„å­˜å™¨ï¼ŒæŠŠå‚æ•°æ”¾å…¥å…¶ä»–æŒ‡å®šçš„å¯„å­˜å™¨ï¼Œç„¶åè°ƒç”¨INT 21ï¼Œä¸­æ–­è¿”å›åï¼Œç¨‹åºä»æŒ‡å®šçš„å¯„å­˜å™¨(é€šå¸¸æ˜¯AL)é‡Œå–å¾—è¿”å›å€¼ã€‚è¿™æ ·çš„åšæ³•ä¸€ç›´åˆ°å¥”è…¾2ä¹Ÿå°±æ˜¯P6å‡ºæ¥ä¹‹å‰éƒ½æ²¡æœ‰å˜ï¼Œè­¬å¦‚windowsé€šè¿‡INT 2Eæä¾›ç³»ç»Ÿè°ƒç”¨ï¼ŒLinuxåˆ™æ˜¯INT 80ï¼Œåªä¸è¿‡åæ¥çš„å¯„å­˜å™¨æ¯”ä»¥å‰å¤§ä¸€äº›ï¼Œè€Œä¸”å¯èƒ½å†å¤šä¸€å±‚è·³è½¬è¡¨æŸ¥è¯¢ã€‚åæ¥ï¼ŒIntelå’ŒAMDåˆ†åˆ«æä¾›äº†æ•ˆç‡æ›´é«˜çš„[SYSENTER/SYSEXITå’ŒSYSCALL/SYSRET](http://wiki.osdev.org/Sysenter)æŒ‡ä»¤æ¥ä»£æ›¿ä¹‹å‰çš„ä¸­æ–­æ–¹å¼ï¼Œç•¥è¿‡äº†è€—æ—¶çš„ç‰¹æƒçº§åˆ«æ£€æŸ¥ä»¥åŠå¯„å­˜å™¨å‹æ ˆå‡ºæ ˆçš„æ“ä½œï¼Œç›´æ¥å®Œæˆä»RING 3ä»£ç æ®µåˆ°RING 0ä»£ç æ®µçš„è½¬æ¢ã€‚ç³»ç»Ÿè°ƒç”¨éƒ½æä¾›ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿç”¨æ“ä½œç³»ç»Ÿçš„åå­—åŠ ä¸Šå¯¹åº”çš„ä¸­æ–­ç¼–å·åˆ°è°·æ­Œä¸Šä¸€æŸ¥å°±å¯ä»¥å¾—åˆ°å®Œæ•´çš„åˆ—è¡¨ ([Windows](http://j00ru.vexillium.org/ntapi/), [Linux](http://syscalls.kernelgrok.com/))ï¼Œè¿™ä¸ªåˆ—è¡¨å°±æ˜¯æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºä¹‹é—´æ²Ÿé€šçš„åè®®ï¼Œå¦‚æœéœ€è¦è¶…å‡ºæ­¤åè®®çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å°±åªèƒ½åœ¨è‡ªå·±çš„ä»£ç é‡Œå»å®ç°ï¼Œè­¬å¦‚ï¼Œå¯¹äºå†…å­˜ç®¡ç†ï¼Œæ“ä½œç³»ç»Ÿåªæä¾›è¿›ç¨‹çº§åˆ«çš„å†…å­˜æ®µçš„ç®¡ç†ï¼Œè­¬å¦‚Windowsçš„[virtualmemory](http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Memory%20Management/Virtual%20Memory/NtAllocateVirtualMemory.html)ç³»åˆ—ï¼Œæˆ–æ˜¯Linuxçš„[brk](http://linux.die.net/man/2/brk)ï¼Œæ“ä½œç³»ç»Ÿä¸ä¼šå»åœ¨ä¹åº”ç”¨ç¨‹åºå¦‚ä½•ä¸ºæ–°å»ºå¯¹è±¡åˆ†é…å†…å­˜ï¼Œæˆ–æ˜¯å¦‚ä½•åšåƒåœ¾å›æ”¶ï¼Œè¿™äº›éƒ½éœ€è¦åº”ç”¨ç¨‹åºè‡ªå·±å»å®ç°ã€‚å¦‚æœè¶…å‡ºæ­¤åè®®çš„åŠŸèƒ½æ— æ³•è‡ªå·±å®ç°ï¼Œé‚£æˆ‘ä»¬å°±è¯´è¯¥æ“ä½œç³»ç»Ÿä¸æ”¯æŒè¯¥åŠŸèƒ½ï¼Œä¸¾ä¸ªä¾‹å­ï¼ŒLinuxåœ¨2.6ä¹‹å‰æ˜¯ä¸æ”¯æŒå¤šçº¿ç¨‹çš„ï¼Œæ— è®ºå¦‚ä½•åœ¨ç¨‹åºé‡Œæ¨¡æ‹Ÿï¼Œæˆ‘ä»¬éƒ½æ— æ³•åšå‡ºå¤šä¸ªå¯ä»¥åŒæ—¶è¿è¡Œçš„å¹¶ç¬¦åˆPOSIX 1003.1cè¯­ä¹‰æ ‡å‡†çš„è°ƒåº¦å•å…ƒã€‚å¯æ˜¯ï¼Œæˆ‘ä»¬å†™ç¨‹åºå¹¶ä¸éœ€è¦å»è°ƒç”¨ä¸­æ–­æˆ–æ˜¯SYSCALLæŒ‡ä»¤ï¼Œè¿™æ˜¯å› ä¸ºæ“ä½œç³»ç»Ÿæä¾›äº†ä¸€å±‚å°è£…ï¼Œåœ¨Windowsä¸Šï¼Œå®ƒæ˜¯NTDLL.DLLï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„Native APIï¼Œæˆ‘ä»¬ä¸ä½†ä¸éœ€è¦å»ç›´æ¥è°ƒç”¨INT 2Eæˆ–SYSCALLï¼Œå‡†ç¡®çš„è¯´ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥å»è°ƒç”¨INT 2Eæˆ–SYSCALLï¼Œå› ä¸ºWindowså¹¶æ²¡æœ‰å…¬å¼€å…¶è°ƒç”¨è§„èŒƒï¼Œç›´æ¥ä½¿ç”¨INT 2Eæˆ–SYSCALLæ— æ³•ä¿è¯æœªæ¥çš„å…¼å®¹æ€§ã€‚åœ¨Linuxä¸Šåˆ™æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œç³»ç»Ÿè°ƒç”¨çš„åˆ—è¡¨éƒ½æ˜¯å…¬å¼€çš„ï¼Œè€Œä¸”Linuséå¸¸çœ‹é‡å…¼å®¹æ€§ï¼Œä¸ä¼šå»åšä»»ä½•æ›´æ”¹ï¼Œglibcé‡Œç”šè‡³ä¸“é—¨æä¾›äº†[syscall(2)](http://linux.die.net/man/2/syscall)æ¥æ–¹ä¾¿ç”¨æˆ·ç›´æ¥ç”¨ç¼–å·è°ƒç”¨ï¼Œä¸è¿‡ï¼Œä¸ºäº†è§£å†³glibcå’Œå†…æ ¸ä¹‹é—´ä¸åŒç‰ˆæœ¬å…¼å®¹æ€§å¸¦æ¥çš„éº»çƒ¦ï¼Œä»¥åŠä¸ºäº†æé«˜æŸäº›è°ƒç”¨çš„æ•ˆç‡(è­¬å¦‚__NR_ gettimeofday)ï¼ŒLinuxä¸Šè¿˜æ˜¯å¯¹éƒ¨åˆ†ç³»ç»Ÿè°ƒç”¨åšäº†ä¸€å±‚å°è£…ï¼Œå°±æ˜¯[VDSO](http://lwn.net/Articles/446528/) (æ—©æœŸå«[linux-gate.so](http://www.trilithium.com/johan/2005/08/linux-gate/))ã€‚å¯æ˜¯ï¼Œæˆ‘ä»¬å†™ç¨‹åºä¹Ÿå¾ˆå°‘ç›´æ¥è°ƒç”¨NTDLLæˆ–è€…VDSOï¼Œè€Œæ˜¯é€šè¿‡æ›´ä¸Šä¸€å±‚çš„å°è£…ï¼Œè¿™ä¸€å±‚å¤„ç†äº†å‚æ•°å‡†å¤‡å’Œè¿”å›å€¼æ ¼å¼è½¬æ¢ã€ä»¥åŠå‡ºé”™å¤„ç†å’Œé”™è¯¯ä»£ç è½¬æ¢ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ‰€ä½¿ç”¨è¯­è¨€çš„è¿è¡Œåº“ï¼Œå¯¹äºCè¯­è¨€ï¼ŒLinuxä¸Šæ˜¯glibcï¼ŒWindowsä¸Šæ˜¯kernel32(æˆ–è°ƒç”¨msvcrt)ï¼Œå¯¹äºå…¶ä»–è¯­è¨€ï¼Œè­¬å¦‚Javaï¼Œåˆ™æ˜¯JREï¼Œè¿™äº›â€œå…¶ä»–è¯­è¨€â€çš„è¿è¡Œåº“é€šå¸¸æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨glibcæˆ–kernel32ã€‚â€œè¿è¡Œåº“â€è¿™ä¸ªè¯å…¶å®ä¸æ­¢åŒ…æ‹¬ç”¨äºå’Œç¼–è¯‘åçš„ç›®æ ‡æ‰§è¡Œç¨‹åºè¿›è¡Œé“¾æ¥çš„åº“æ–‡ä»¶ï¼Œä¹ŸåŒ…æ‹¬äº†è„šæœ¬è¯­è¨€æˆ–å­—èŠ‚ç è§£é‡Šå‹è¯­è¨€çš„è¿è¡Œç¯å¢ƒï¼Œè­¬å¦‚Pythonï¼ŒC#çš„CLRï¼ŒJavaçš„JREã€‚å¯¹ç³»ç»Ÿè°ƒç”¨çš„å°è£…åªæ˜¯è¿è¡Œåº“çš„å¾ˆå°ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œè¿è¡Œåº“é€šå¸¸è¿˜æä¾›äº†è¯¸å¦‚å­—ç¬¦ä¸²å¤„ç†ã€æ•°å­¦è®¡ç®—ã€å¸¸ç”¨æ•°æ®ç»“æ„å®¹å™¨ç­‰ç­‰ä¸éœ€è¦æ“ä½œç³»ç»Ÿæ”¯æŒçš„åŠŸèƒ½ï¼ŒåŒæ—¶ï¼Œè¿è¡Œåº“ä¹Ÿä¼šå¯¹æ“ä½œç³»ç»Ÿæ”¯æŒçš„åŠŸèƒ½æä¾›æ›´æ˜“ç”¨æ›´é«˜çº§çš„å°è£…ï¼Œè­¬å¦‚å¸¦ç¼“å­˜å’Œæ ¼å¼çš„IOã€çº¿ç¨‹æ± ã€‚</code></pre><p>æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬è¯´â€œæŸæŸè¯­è¨€æ–°å¢äº†æŸæŸåŠŸèƒ½â€çš„æ—¶å€™ï¼Œé€šå¸¸æ˜¯è¿™ä¹ˆå‡ ç§å¯èƒ½ï¼š</p><ol><li>æ”¯æŒæ–°çš„è¯­ä¹‰æˆ–è¯­æ³•ï¼Œä»è€Œä¾¿äºæˆ‘ä»¬æè¿°å’Œè§£å†³é—®é¢˜ã€‚è­¬å¦‚Javaçš„æ³›å‹ã€Annotationã€lambdaè¡¨è¾¾å¼ã€‚</li><li>æä¾›äº†æ–°çš„å·¥å…·æˆ–ç±»åº“ï¼Œå‡å°‘äº†æˆ‘ä»¬å¼€å‘çš„ä»£ç é‡ã€‚è­¬å¦‚Python 2.7çš„argparse</li><li><p>å¯¹ç³»ç»Ÿè°ƒç”¨æœ‰äº†æ›´è‰¯å¥½æ›´å…¨é¢çš„å°è£…ï¼Œä½¿æˆ‘ä»¬å¯ä»¥åšåˆ°ä»¥å‰åœ¨è¿™ä¸ªè¯­è¨€ç¯å¢ƒé‡Œåšä¸åˆ°æˆ–å¾ˆéš¾åšåˆ°çš„äº‹æƒ…ã€‚è­¬å¦‚Java NIO</p><pre><code>ä½†ä»»ä½•ä¸€é—¨è¯­è¨€ï¼ŒåŒ…æ‹¬å…¶è¿è¡Œåº“å’Œè¿è¡Œç¯å¢ƒï¼Œéƒ½ä¸å¯èƒ½åˆ›é€ å‡ºæ“ä½œç³»ç»Ÿä¸æ”¯æŒçš„åŠŸèƒ½ï¼ŒGoè¯­è¨€ä¹Ÿæ˜¯è¿™æ ·ï¼Œä¸ç®¡å®ƒçš„ç‰¹æ€§æè¿°çœ‹èµ·æ¥å¤šä¹ˆç‚«ä¸½ï¼Œé‚£å¿…ç„¶éƒ½æ˜¯å…¶ä»–è¯­è¨€ä¹Ÿå¯ä»¥åšåˆ°çš„ï¼Œåªä¸è¿‡Goæä¾›äº†æ›´æ–¹ä¾¿æ›´æ¸…æ™°çš„è¯­ä¹‰å’Œæ”¯æŒï¼Œæé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚</code></pre></li></ol><h2 id="2ã€å¹¶å‘ä¸å¹¶è¡Œ-Concurrency-and-Parallelism"><a href="#2ã€å¹¶å‘ä¸å¹¶è¡Œ-Concurrency-and-Parallelism" class="headerlink" title="2ã€å¹¶å‘ä¸å¹¶è¡Œ (Concurrency and Parallelism)"></a>2ã€å¹¶å‘ä¸å¹¶è¡Œ (Concurrency and Parallelism)</h2><p><strong>å¹¶å‘</strong>æ˜¯æŒ‡ç¨‹åºçš„é€»è¾‘ç»“æ„ã€‚éå¹¶å‘çš„ç¨‹åºå°±æ˜¯ä¸€æ ¹ç«¹ç«¿æ…åˆ°åº•ï¼Œåªæœ‰ä¸€ä¸ªé€»è¾‘æ§åˆ¶æµï¼Œä¹Ÿå°±æ˜¯é¡ºåºæ‰§è¡Œçš„(Sequential)ç¨‹åºï¼Œåœ¨ä»»ä½•æ—¶åˆ»ï¼Œç¨‹åºåªä¼šå¤„åœ¨è¿™ä¸ªé€»è¾‘æ§åˆ¶æµçš„æŸä¸ªä½ç½®ã€‚è€Œå¦‚æœæŸä¸ªç¨‹åºæœ‰å¤šä¸ªç‹¬ç«‹çš„é€»è¾‘æ§åˆ¶æµï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åŒæ—¶å¤„ç†(deal)å¤šä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬å°±è¯´è¿™ä¸ªç¨‹åºæ˜¯å¹¶å‘çš„ã€‚è¿™é‡Œçš„â€œåŒæ—¶â€ï¼Œå¹¶ä¸ä¸€å®šè¦æ˜¯çœŸæ­£åœ¨æ—¶é’Ÿçš„æŸä¸€æ—¶åˆ»(é‚£æ˜¯è¿è¡ŒçŠ¶æ€è€Œä¸æ˜¯é€»è¾‘ç»“æ„)ï¼Œè€Œæ˜¯æŒ‡ï¼šå¦‚æœæŠŠè¿™äº›é€»è¾‘æ§åˆ¶æµç”»æˆæ—¶åºæµç¨‹å›¾ï¼Œå®ƒä»¬åœ¨æ—¶é—´çº¿ä¸Šæ˜¯å¯ä»¥é‡å çš„ã€‚</p><p><strong>å¹¶è¡Œ</strong>æ˜¯æŒ‡ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ã€‚å¦‚æœä¸€ä¸ªç¨‹åºåœ¨æŸä¸€æ—¶åˆ»è¢«å¤šä¸ªCPUæµæ°´çº¿åŒæ—¶è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯´è¿™ä¸ªç¨‹åºæ˜¯ä»¥å¹¶è¡Œçš„å½¢å¼åœ¨è¿è¡Œã€‚ï¼ˆä¸¥æ ¼æ„ä¹‰ä¸Šè®²ï¼Œæˆ‘ä»¬ä¸èƒ½è¯´æŸç¨‹åºæ˜¯â€œå¹¶è¡Œâ€çš„ï¼Œå› ä¸ºâ€œå¹¶è¡Œâ€ä¸æ˜¯æè¿°ç¨‹åºæœ¬èº«ï¼Œè€Œæ˜¯æè¿°ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ï¼Œä½†è¿™ç¯‡å°æ–‡é‡Œå°±ä¸é‚£ä¹ˆå’¬æ–‡åš¼å­—ï¼Œä»¥ä¸‹è¯´åˆ°â€œå¹¶è¡Œâ€çš„æ—¶å€™ï¼Œå°±æ˜¯æŒ‡ä»£â€œä»¥å¹¶è¡Œçš„å½¢å¼è¿è¡Œâ€ï¼‰æ˜¾ç„¶ï¼Œå¹¶è¡Œä¸€å®šæ˜¯éœ€è¦ç¡¬ä»¶æ”¯æŒçš„ã€‚</p><p>è€Œä¸”ä¸éš¾ç†è§£ï¼š</p><ol><li>å¹¶å‘æ˜¯å¹¶è¡Œçš„å¿…è¦æ¡ä»¶ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºæœ¬èº«å°±ä¸æ˜¯å¹¶å‘çš„ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªé€»è¾‘æ§åˆ¶æµï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å¯èƒ½è®©å…¶è¢«å¹¶è¡Œå¤„ç†ã€‚</li><li>å¹¶å‘ä¸æ˜¯å¹¶è¡Œçš„å……åˆ†æ¡ä»¶ï¼Œä¸€ä¸ªå¹¶å‘çš„ç¨‹åºï¼Œå¦‚æœåªè¢«ä¸€ä¸ªCPUæµæ°´çº¿è¿›è¡Œå¤„ç†(é€šè¿‡åˆ†æ—¶)ï¼Œé‚£ä¹ˆå®ƒå°±ä¸æ˜¯å¹¶è¡Œçš„ã€‚</li><li>å¹¶å‘åªæ˜¯æ›´ç¬¦åˆç°å®é—®é¢˜æœ¬è´¨çš„è¡¨è¾¾æ–¹å¼ï¼Œå¹¶å‘çš„æœ€åˆç›®çš„æ˜¯ç®€åŒ–ä»£ç é€»è¾‘ï¼Œè€Œä¸æ˜¯ä½¿ç¨‹åºè¿è¡Œçš„æ›´å¿«ï¼›</li></ol><p>è¿™å‡ æ®µç•¥å¾®æŠ½è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­æ¥æŠŠè¿™äº›æ¦‚å¿µå®ä¾‹åŒ–ï¼šç”¨Cè¯­è¨€å†™ä¸€ä¸ªæœ€ç®€å•çš„HelloWorldï¼Œå®ƒå°±æ˜¯éå¹¶å‘çš„ï¼Œå¦‚æœæˆ‘ä»¬å»ºç«‹å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹é‡Œæ‰“å°ä¸€ä¸ªHelloWorldï¼Œé‚£ä¹ˆè¿™ä¸ªç¨‹åºå°±æ˜¯å¹¶å‘çš„ï¼Œå¦‚æœè¿™ä¸ªç¨‹åºè¿è¡Œåœ¨è€å¼çš„å•æ ¸CPUä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªå¹¶å‘ç¨‹åºè¿˜ä¸æ˜¯å¹¶è¡Œçš„ï¼Œå¦‚æœæˆ‘ä»¬ç”¨å¤šæ ¸å¤šCPUä¸”æ”¯æŒå¤šä»»åŠ¡çš„æ“ä½œç³»ç»Ÿæ¥è¿è¡Œå®ƒï¼Œé‚£ä¹ˆè¿™ä¸ªå¹¶å‘ç¨‹åºå°±æ˜¯å¹¶è¡Œçš„ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªç•¥å¾®å¤æ‚çš„ä¾‹å­ï¼Œæ›´èƒ½è¯´æ˜å¹¶å‘ä¸ä¸€å®šå¯ä»¥å¹¶è¡Œï¼Œè€Œä¸”å¹¶å‘ä¸æ˜¯ä¸ºäº†æ•ˆç‡ï¼Œå°±æ˜¯Goè¯­è¨€ä¾‹å­é‡Œè®¡ç®—ç´ æ•°çš„<a href="http://golang.org/doc/play/sieve.go" target="_blank" rel="noopener">sieve.go</a>ã€‚æˆ‘ä»¬ä»å°åˆ°å¤§é’ˆå¯¹æ¯ä¸€ä¸ªå› å­å¯åŠ¨ä¸€ä¸ªä»£ç ç‰‡æ®µï¼Œå¦‚æœå½“å‰éªŒè¯çš„æ•°èƒ½è¢«å½“å‰å› å­é™¤å°½ï¼Œåˆ™è¯¥æ•°ä¸æ˜¯ç´ æ•°ï¼Œå¦‚æœä¸èƒ½ï¼Œåˆ™æŠŠè¯¥æ•°å‘é€ç»™ä¸‹ä¸€ä¸ªå› å­çš„ä»£ç ç‰‡æ®µï¼Œç›´åˆ°æœ€åä¸€ä¸ªå› å­ä¹Ÿæ— æ³•é™¤å°½ï¼Œåˆ™è¯¥æ•°ä¸ºç´ æ•°ï¼Œæˆ‘ä»¬å†å¯åŠ¨ä¸€ä¸ªå®ƒçš„ä»£ç ç‰‡æ®µï¼Œç”¨äºéªŒè¯æ›´å¤§çš„æ•°å­—ã€‚è¿™æ˜¯ç¬¦åˆæˆ‘ä»¬è®¡ç®—ç´ æ•°çš„é€»è¾‘çš„ï¼Œè€Œä¸”æ¯ä¸ªå› å­çš„ä»£ç å¤„ç†ç‰‡æ®µéƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ç¨‹åºéå¸¸çš„ç®€æ´ï¼Œä½†å®ƒæ— æ³•è¢«å¹¶è¡Œï¼Œå› ä¸ºæ¯ä¸ªç‰‡æ®µéƒ½ä¾èµ–äºå‰ä¸€ä¸ªç‰‡æ®µçš„å¤„ç†ç»“æœå’Œè¾“å‡ºã€‚</p><p>å¹¶å‘å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åšåˆ°ï¼š</p><ol><li>æ˜¾å¼åœ°å®šä¹‰å¹¶è§¦å‘å¤šä¸ªä»£ç ç‰‡æ®µï¼Œä¹Ÿå°±æ˜¯é€»è¾‘æ§åˆ¶æµï¼Œç”±åº”ç”¨ç¨‹åºæˆ–æ“ä½œç³»ç»Ÿå¯¹å®ƒä»¬è¿›è¡Œè°ƒåº¦ã€‚å®ƒä»¬å¯ä»¥æ˜¯ç‹¬ç«‹æ— å…³çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸äº’ä¾èµ–éœ€è¦äº¤äº’çš„ï¼Œè­¬å¦‚ä¸Šé¢æåˆ°çš„ç´ æ•°è®¡ç®—ï¼Œå…¶å®å®ƒä¹Ÿæ˜¯ä¸ªç»å…¸çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„é—®é¢˜ï¼šä¸¤ä¸ªé€»è¾‘æ§åˆ¶æµAå’ŒBï¼ŒAäº§ç”Ÿè¾“å‡ºï¼Œå½“æœ‰äº†è¾“å‡ºåï¼ŒBå–å¾—Açš„è¾“å‡ºè¿›è¡Œå¤„ç†ã€‚çº¿ç¨‹åªæ˜¯å®ç°å¹¶å‘çš„å…¶ä¸­ä¸€ä¸ªæ‰‹æ®µï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿è¡Œåº“æˆ–æ˜¯åº”ç”¨ç¨‹åºæœ¬èº«ä¹Ÿæœ‰å¤šç§æ‰‹æ®µæ¥å®ç°å¹¶å‘ï¼Œè¿™æ˜¯ä¸‹èŠ‚çš„ä¸»è¦å†…å®¹ã€‚</li><li>éšå¼åœ°æ”¾ç½®å¤šä¸ªä»£ç ç‰‡æ®µï¼Œåœ¨ç³»ç»Ÿäº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘æ‰§è¡Œç›¸åº”çš„ä»£ç ç‰‡æ®µï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶é©±åŠ¨çš„æ–¹å¼ï¼Œè­¬å¦‚æŸä¸ªç«¯å£æˆ–ç®¡é“æ¥æ”¶åˆ°äº†æ•°æ®(å¤šè·¯IOçš„æƒ…å†µä¸‹)ï¼Œå†è­¬å¦‚è¿›ç¨‹æ¥æ”¶åˆ°äº†æŸä¸ªä¿¡å·(signal)ã€‚</li></ol><p>å¹¶è¡Œå¯ä»¥åœ¨å››ä¸ªå±‚é¢ä¸Šåšåˆ°ï¼š</p><ol><li>å¤šå°æœºå™¨ã€‚è‡ªç„¶æˆ‘ä»¬å°±æœ‰äº†å¤šä¸ªCPUæµæ°´çº¿ï¼Œè­¬å¦‚Hadoopé›†ç¾¤é‡Œçš„MapReduceä»»åŠ¡ã€‚</li><li>å¤šCPUã€‚ä¸ç®¡æ˜¯çœŸçš„å¤šé¢—CPUè¿˜æ˜¯å¤šæ ¸è¿˜æ˜¯è¶…çº¿ç¨‹ï¼Œæ€»ä¹‹æˆ‘ä»¬æœ‰äº†å¤šä¸ªCPUæµæ°´çº¿ã€‚</li><li>å•CPUæ ¸é‡Œçš„ILP(Instruction-level parallelism)ï¼ŒæŒ‡ä»¤çº§å¹¶è¡Œã€‚é€šè¿‡å¤æ‚çš„åˆ¶é€ å·¥è‰ºå’Œå¯¹æŒ‡ä»¤çš„è§£æä»¥åŠåˆ†æ”¯é¢„æµ‹å’Œä¹±åºæ‰§è¡Œï¼Œç°åœ¨çš„CPUå¯ä»¥åœ¨å•ä¸ªæ—¶é’Ÿå‘¨æœŸå†…æ‰§è¡Œå¤šæ¡æŒ‡ä»¤ï¼Œä»è€Œï¼Œå³ä½¿æ˜¯éå¹¶å‘çš„ç¨‹åºï¼Œä¹Ÿå¯èƒ½æ˜¯ä»¥å¹¶è¡Œçš„å½¢å¼æ‰§è¡Œã€‚</li><li>å•æŒ‡ä»¤å¤šæ•°æ®(Single instruction, multiple data. SIMD)ï¼Œä¸ºäº†å¤šåª’ä½“æ•°æ®çš„å¤„ç†ï¼Œç°åœ¨çš„CPUçš„æŒ‡ä»¤é›†æ”¯æŒå•æ¡æŒ‡ä»¤å¯¹å¤šæ¡æ•°æ®è¿›è¡Œæ“ä½œã€‚</li></ol><p>å…¶ä¸­ï¼Œ1ç‰µæ¶‰åˆ°åˆ†å¸ƒå¼å¤„ç†ï¼ŒåŒ…æ‹¬æ•°æ®çš„åˆ†å¸ƒå’Œä»»åŠ¡çš„åŒæ­¥ç­‰ç­‰ï¼Œè€Œä¸”æ˜¯åŸºäºç½‘ç»œçš„ã€‚3å’Œ4é€šå¸¸æ˜¯ç¼–è¯‘å™¨å’ŒCPUçš„å¼€å‘äººå‘˜éœ€è¦è€ƒè™‘çš„ã€‚è¿™é‡Œæˆ‘ä»¬è¯´çš„å¹¶è¡Œä¸»è¦é’ˆå¯¹ç¬¬2ç§ï¼šå•å°æœºå™¨å†…çš„å¤šæ ¸CPUå¹¶è¡Œã€‚</p><p>å…³äºå¹¶å‘ä¸å¹¶è¡Œçš„é—®é¢˜ï¼ŒGoè¯­è¨€çš„ä½œè€…Rob Pikeä¸“é—¨å°±æ­¤å†™è¿‡ä¸€ä¸ªå¹»ç¯ç‰‡ï¼š<a href="http://talks.golang.org/2012/waza.slide" target="_blank" rel="noopener">http://talks.golang.org/2012/waza.slide</a>ã€‚åœ¨CMUé‚£æœ¬è‘—åçš„ã€ŠComputer Systems: A Programmerâ€™s Perspectiveã€‹é‡Œçš„è¿™å¼ å›¾ä¹Ÿéå¸¸ç›´è§‚æ¸…æ™°ï¼š</p><p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1ftigdxysyrj30e804n0sy.jpg" alt="Figure 12.30  Relationships between  the sets of sequential,  concurrent, and parallel  programs.  All programs  Concurrent programs  Sequential prcgrams  parallel  programs "></p><h2 id="3ã€çº¿ç¨‹çš„è°ƒåº¦"><a href="#3ã€çº¿ç¨‹çš„è°ƒåº¦" class="headerlink" title="3ã€çº¿ç¨‹çš„è°ƒåº¦"></a>3ã€çº¿ç¨‹çš„è°ƒåº¦</h2><p>ä¸Šä¸€èŠ‚ä¸»è¦è¯´çš„æ˜¯å¹¶å‘å’Œå¹¶è¡Œçš„æ¦‚å¿µï¼Œè€Œçº¿ç¨‹æ˜¯æœ€ç›´è§‚çš„å¹¶å‘çš„å®ç°ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬ä¸»è¦è¯´æ“ä½œç³»ç»Ÿå¦‚ä½•è®©å¤šä¸ªçº¿ç¨‹å¹¶å‘çš„æ‰§è¡Œï¼Œå½“ç„¶åœ¨å¤šCPUçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å¹¶è¡Œçš„æ‰§è¡Œã€‚æˆ‘ä»¬ä¸è®¨è®ºè¿›ç¨‹ï¼Œè¿›ç¨‹çš„æ„ä¹‰æ˜¯â€œéš”ç¦»çš„æ‰§è¡Œç¯å¢ƒâ€ï¼Œè€Œä¸æ˜¯â€œå•ç‹¬çš„æ‰§è¡Œåºåˆ—â€ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦ç†è§£IA-32 CPUçš„æŒ‡ä»¤æ§åˆ¶æ–¹å¼ï¼Œè¿™æ ·æ‰èƒ½ç†è§£å¦‚ä½•åœ¨å¤šä¸ªæŒ‡ä»¤åºåˆ—(ä¹Ÿå°±æ˜¯é€»è¾‘æ§åˆ¶æµ)ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚CPUé€šè¿‡CS:EIPå¯„å­˜å™¨çš„å€¼ç¡®å®šä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®ï¼Œä½†æ˜¯CPUå¹¶ä¸å…è®¸ç›´æ¥ä½¿ç”¨MOVæŒ‡ä»¤æ¥æ›´æ”¹EIPçš„å€¼ï¼Œå¿…é¡»é€šè¿‡JMPç³»åˆ—æŒ‡ä»¤ã€CALL/RETæŒ‡ä»¤ã€æˆ–INTä¸­æ–­æŒ‡ä»¤æ¥å®ç°ä»£ç çš„è·³è½¬ï¼›åœ¨æŒ‡ä»¤åºåˆ—é—´åˆ‡æ¢çš„æ—¶å€™ï¼Œé™¤äº†æ›´æ”¹EIPä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜è¦ä¿è¯ä»£ç å¯èƒ½ä¼šä½¿ç”¨åˆ°çš„å„ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œå°¤å…¶æ˜¯æ ˆæŒ‡é’ˆSS:ESPï¼Œä»¥åŠEFLAGSæ ‡å¿—ä½ç­‰ï¼Œéƒ½èƒ½å¤Ÿæ¢å¤åˆ°ç›®æ ‡æŒ‡ä»¤åºåˆ—ä¸Šæ¬¡æ‰§è¡Œåˆ°è¿™ä¸ªä½ç½®æ—¶å€™çš„çŠ¶æ€ã€‚</p><p>çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿå¯¹å¤–æä¾›çš„æœåŠ¡ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®©æ“ä½œç³»ç»Ÿå¯åŠ¨çº¿ç¨‹ï¼Œå¹¶è´Ÿè´£éšåçš„çº¿ç¨‹è°ƒåº¦å’Œåˆ‡æ¢ã€‚æˆ‘ä»¬å…ˆè€ƒè™‘å•é¢—å•æ ¸CPUï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¸åº”ç”¨ç¨‹åºå…¶å®æ˜¯ä¹Ÿæ˜¯åœ¨å…±äº«åŒä¸€ä¸ªCPUï¼Œå½“EIPåœ¨åº”ç”¨ç¨‹åºä»£ç æ®µçš„æ—¶å€™ï¼Œå†…æ ¸å¹¶æ²¡æœ‰æ§åˆ¶æƒï¼Œå†…æ ¸å¹¶ä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ï¼Œå†…æ ¸åªæ˜¯ä»¥å®æ¨¡å¼è¿è¡Œçš„ï¼Œä»£ç æ®µæƒé™ä¸ºRING 0çš„å†…å­˜ä¸­çš„ç¨‹åºï¼Œåªæœ‰å½“äº§ç”Ÿä¸­æ–­æˆ–æ˜¯åº”ç”¨ç¨‹åºå‘¼å«ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼Œæ§åˆ¶æƒæ‰è½¬ç§»åˆ°å†…æ ¸ï¼Œåœ¨å†…æ ¸é‡Œï¼Œæ‰€æœ‰ä»£ç éƒ½åœ¨åŒä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œä¸ºäº†ç»™ä¸åŒçš„çº¿ç¨‹æä¾›æœåŠ¡ï¼Œå†…æ ¸ä¼šä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹å»ºç«‹ä¸€ä¸ªå†…æ ¸å †æ ˆï¼Œè¿™æ˜¯çº¿ç¨‹åˆ‡æ¢çš„å…³é”®ã€‚é€šå¸¸ï¼Œå†…æ ¸ä¼šåœ¨æ—¶é’Ÿä¸­æ–­é‡Œæˆ–ç³»ç»Ÿè°ƒç”¨è¿”å›å‰(è€ƒè™‘åˆ°æ€§èƒ½ï¼Œé€šå¸¸æ˜¯åœ¨ä¸é¢‘ç¹å‘ç”Ÿçš„ç³»ç»Ÿè°ƒç”¨è¿”å›å‰)ï¼Œå¯¹æ•´ä¸ªç³»ç»Ÿçš„çº¿ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œè®¡ç®—å½“å‰çº¿ç¨‹çš„å‰©ä½™æ—¶é—´ç‰‡ï¼Œå¦‚æœéœ€è¦åˆ‡æ¢ï¼Œå°±åœ¨â€œå¯è¿è¡Œâ€çš„çº¿ç¨‹é˜Ÿåˆ—é‡Œè®¡ç®—ä¼˜å…ˆçº§ï¼Œé€‰å‡ºç›®æ ‡çº¿ç¨‹åï¼Œåˆ™ä¿å­˜å½“å‰çº¿ç¨‹çš„è¿è¡Œç¯å¢ƒï¼Œå¹¶æ¢å¤ç›®æ ‡çº¿ç¨‹çš„è¿è¡Œç¯å¢ƒï¼Œå…¶ä¸­æœ€é‡è¦çš„ï¼Œå°±æ˜¯åˆ‡æ¢å †æ ˆæŒ‡é’ˆESPï¼Œç„¶åå†æŠŠEIPæŒ‡å‘ç›®æ ‡çº¿ç¨‹ä¸Šæ¬¡è¢«ç§»å‡ºCPUæ—¶çš„æŒ‡ä»¤ã€‚Linuxå†…æ ¸åœ¨å®ç°çº¿ç¨‹åˆ‡æ¢æ—¶ï¼Œè€äº†ä¸ªèŠ±æªï¼Œå®ƒå¹¶ä¸æ˜¯ç›´æ¥JMPï¼Œè€Œæ˜¯å…ˆæŠŠESPåˆ‡æ¢ä¸ºç›®æ ‡çº¿ç¨‹çš„å†…æ ¸æ ˆï¼ŒæŠŠç›®æ ‡çº¿ç¨‹çš„ä»£ç åœ°å€å‹æ ˆï¼Œç„¶åJMPåˆ°<a href="http://lxr.linux.no/linux+v3.8.2/arch/x86/kernel/process_32.c#L248" target="_blank" rel="noopener">__switch_to()</a>ï¼Œç›¸å½“äºä¼ªé€ äº†ä¸€ä¸ªCALL <strong>switch_to()æŒ‡ä»¤ï¼Œç„¶åï¼Œåœ¨</strong>switch_to()çš„æœ€åä½¿ç”¨RETæŒ‡ä»¤è¿”å›ï¼Œè¿™æ ·å°±æŠŠæ ˆé‡Œçš„ç›®æ ‡çº¿ç¨‹çš„ä»£ç åœ°å€æ”¾å…¥äº†EIPï¼Œæ¥ä¸‹æ¥CPUå°±å¼€å§‹æ‰§è¡Œç›®æ ‡çº¿ç¨‹çš„ä»£ç äº†ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä¸Šæ¬¡åœåœ¨<a href="http://lxr.linux.no/linux+v3.8.2/arch/x86/include/asm/switch_to.h#L31" target="_blank" rel="noopener">switch_to</a>è¿™ä¸ªå®å±•å¼€çš„åœ°æ–¹ã€‚</p><p>è¿™é‡Œéœ€è¦è¡¥å……å‡ ç‚¹ï¼š</p><p>(1) è™½ç„¶IA-32æä¾›äº†TSS (<a href="http://en.wikipedia.org/wiki/Task_state_segment" target="_blank" rel="noopener">Task State Segment</a>)ï¼Œè¯•å›¾ç®€åŒ–æ“ä½œç³»ç»Ÿè¿›è¡Œçº¿ç¨‹è°ƒåº¦çš„æµç¨‹ï¼Œä½†ç”±äºå…¶æ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”å¹¶ä¸æ˜¯é€šç”¨æ ‡å‡†ï¼Œä¸åˆ©äºç§»æ¤ï¼Œæ‰€ä»¥ä¸»æµæ“ä½œç³»ç»Ÿéƒ½æ²¡æœ‰å»åˆ©ç”¨TSSã€‚æ›´ä¸¥æ ¼çš„è¯´ï¼Œå…¶å®è¿˜æ˜¯ç”¨äº†TSSï¼Œå› ä¸ºåªæœ‰é€šè¿‡TSSæ‰èƒ½æŠŠå †æ ˆåˆ‡æ¢åˆ°å†…æ ¸å †æ ˆæŒ‡é’ˆSS0:ESP0ï¼Œä½†é™¤æ­¤ä¹‹å¤–çš„TSSçš„åŠŸèƒ½å°±å®Œå…¨æ²¡æœ‰è¢«ä½¿ç”¨äº†ã€‚</p><p>(2) çº¿ç¨‹ä»ç”¨æˆ·æ€è¿›å…¥å†…æ ¸çš„æ—¶å€™ï¼Œç›¸å…³çš„å¯„å­˜å™¨ä»¥åŠç”¨æˆ·æ€ä»£ç æ®µçš„EIPå·²ç»ä¿å­˜äº†ä¸€æ¬¡ï¼Œæ‰€ä»¥ï¼Œåœ¨ä¸Šé¢æ‰€è¯´çš„å†…æ ¸æ€çº¿ç¨‹åˆ‡æ¢æ—¶ï¼Œéœ€è¦ä¿å­˜å’Œæ¢å¤çš„å†…å®¹å¹¶ä¸å¤šã€‚</p><p>(3) ä»¥ä¸Šæè¿°çš„éƒ½æ˜¯æŠ¢å å¼(preemptively)çš„è°ƒåº¦æ–¹å¼ï¼Œå†…æ ¸ä»¥åŠå…¶ä¸­çš„ç¡¬ä»¶é©±åŠ¨ä¹Ÿä¼šåœ¨ç­‰å¾…å¤–éƒ¨èµ„æºå¯ç”¨çš„æ—¶å€™ä¸»åŠ¨è°ƒç”¨<a href="http://lxr.linux.no/linux+v3.8.2/kernel/sched/core.c#L2845" target="_blank" rel="noopener">schedule()</a>ï¼Œç”¨æˆ·æ€çš„ä»£ç ä¹Ÿå¯ä»¥é€šè¿‡<a href="http://linux.die.net/man/2/sched_yield" target="_blank" rel="noopener">sched_yield()</a>ç³»ç»Ÿè°ƒç”¨ä¸»åŠ¨å‘èµ·è°ƒåº¦ï¼Œè®©å‡ºCPUã€‚</p><p>ç°åœ¨æˆ‘ä»¬ä¸€å°æ™®é€šçš„PCæˆ–æœåŠ¡é‡Œé€šå¸¸éƒ½æœ‰å¤šé¢—CPU (physical package)ï¼Œæ¯é¢—CPUåˆæœ‰å¤šä¸ªæ ¸ (processor core)ï¼Œæ¯ä¸ªæ ¸åˆå¯ä»¥æ”¯æŒè¶…çº¿ç¨‹ (two logical processors for each core)ï¼Œä¹Ÿå°±æ˜¯é€»è¾‘å¤„ç†å™¨ã€‚æ¯ä¸ªé€»è¾‘å¤„ç†å™¨éƒ½æœ‰è‡ªå·±çš„ä¸€å¥—å®Œæ•´çš„å¯„å­˜å™¨ï¼Œå…¶ä¸­åŒ…æ‹¬äº†CS:EIPå’ŒSS:ESPï¼Œä»è€Œï¼Œä»¥æ“ä½œç³»ç»Ÿå’Œåº”ç”¨çš„è§’åº¦æ¥çœ‹ï¼Œæ¯ä¸ªé€»è¾‘å¤„ç†å™¨éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„æµæ°´çº¿ã€‚åœ¨å¤šå¤„ç†å™¨çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹åˆ‡æ¢çš„åŸç†å’Œæµç¨‹å…¶å®å’Œå•å¤„ç†å™¨æ—¶æ˜¯åŸºæœ¬ä¸€è‡´çš„ï¼Œå†…æ ¸ä»£ç åªæœ‰ä¸€ä»½ï¼Œå½“æŸä¸ªCPUä¸Šå‘ç”Ÿæ—¶é’Ÿä¸­æ–­æˆ–æ˜¯ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè¯¥CPUçš„CS:EIPå’Œæ§åˆ¶æƒåˆå›åˆ°äº†å†…æ ¸ï¼Œå†…æ ¸æ ¹æ®è°ƒåº¦ç­–ç•¥çš„ç»“æœè¿›è¡Œçº¿ç¨‹åˆ‡æ¢ã€‚ä½†åœ¨è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬çš„ç¨‹åºç”¨çº¿ç¨‹å®ç°äº†å¹¶å‘ï¼Œé‚£ä¹ˆæ“ä½œç³»ç»Ÿå¯ä»¥ä½¿æˆ‘ä»¬çš„ç¨‹åºåœ¨å¤šä¸ªCPUä¸Šå®ç°å¹¶è¡Œã€‚</p><p>è¿™é‡Œä¹Ÿéœ€è¦è¡¥å……ä¸¤ç‚¹ï¼š</p><p>(1) å¤šæ ¸çš„åœºæ™¯é‡Œï¼Œå„ä¸ªæ ¸ä¹‹é—´å¹¶ä¸æ˜¯å®Œå…¨å¯¹ç­‰çš„ï¼Œè­¬å¦‚åœ¨åŒä¸€ä¸ªæ ¸ä¸Šçš„ä¸¤ä¸ªè¶…çº¿ç¨‹æ˜¯å…±äº«L1/L2ç¼“å­˜çš„ï¼›åœ¨æœ‰NUMAæ”¯æŒçš„åœºæ™¯é‡Œï¼Œæ¯ä¸ªæ ¸è®¿é—®å†…å­˜ä¸åŒåŒºåŸŸçš„å»¶è¿Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼›æ‰€ä»¥ï¼Œå¤šæ ¸åœºæ™¯é‡Œçš„çº¿ç¨‹è°ƒåº¦åˆå¼•å…¥äº†â€œè°ƒåº¦åŸŸâ€(<a href="http://lwn.net/Articles/80911/" target="_blank" rel="noopener">scheduling domains</a>)çš„æ¦‚å¿µï¼Œä½†è¿™ä¸å½±å“æˆ‘ä»¬ç†è§£çº¿ç¨‹åˆ‡æ¢æœºåˆ¶ã€‚</p><p>(2) å¤šæ ¸çš„åœºæ™¯ä¸‹ï¼Œä¸­æ–­å‘ç»™å“ªä¸ªCPUï¼Ÿè½¯ä¸­æ–­(åŒ…æ‹¬é™¤ä»¥0ï¼Œç¼ºé¡µå¼‚å¸¸ï¼ŒINTæŒ‡ä»¤)è‡ªç„¶æ˜¯åœ¨è§¦å‘è¯¥ä¸­æ–­çš„CPUä¸Šäº§ç”Ÿï¼Œè€Œç¡¬ä¸­æ–­åˆ™åˆåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æ¯ä¸ªCPUè‡ªå·±äº§ç”Ÿçš„ä¸­æ–­ï¼Œè­¬å¦‚æ—¶é’Ÿï¼Œè¿™æ˜¯æ¯ä¸ªCPUå¤„ç†è‡ªå·±çš„ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯å¤–éƒ¨ä¸­æ–­ï¼Œè­¬å¦‚IOï¼Œå¯ä»¥é€šè¿‡APICæ¥æŒ‡å®šå…¶é€ç»™å“ªä¸ªCPUï¼›å› ä¸ºè°ƒåº¦ç¨‹åºåªèƒ½æ§åˆ¶å½“å‰çš„CPUï¼Œæ‰€ä»¥ï¼Œå¦‚æœIOä¸­æ–­æ²¡æœ‰è¿›è¡Œå‡åŒ€çš„åˆ†é…çš„è¯ï¼Œé‚£ä¹ˆå’ŒIOç›¸å…³çš„çº¿ç¨‹å°±åªèƒ½åœ¨æŸäº›CPUä¸Šè¿è¡Œï¼Œå¯¼è‡´CPUè´Ÿè½½ä¸å‡ï¼Œè¿›è€Œå½±å“æ•´ä¸ªç³»ç»Ÿçš„æ•ˆç‡ã€‚</p><h2 id="4ã€å¹¶å‘ç¼–ç¨‹æ¡†æ¶"><a href="#4ã€å¹¶å‘ç¼–ç¨‹æ¡†æ¶" class="headerlink" title="4ã€å¹¶å‘ç¼–ç¨‹æ¡†æ¶"></a>4ã€å¹¶å‘ç¼–ç¨‹æ¡†æ¶</h2><p>ä»¥ä¸Šå¤§æ¦‚ä»‹ç»äº†ä¸€ä¸ªç”¨å¤šçº¿ç¨‹æ¥å®ç°å¹¶å‘çš„ç¨‹åºæ˜¯å¦‚ä½•è¢«æ“ä½œç³»ç»Ÿè°ƒåº¦ä»¥åŠå¹¶è¡Œæ‰§è¡Œ(åœ¨æœ‰å¤šä¸ªé€»è¾‘å¤„ç†å™¨æ—¶)ï¼ŒåŒæ—¶å¤§å®¶ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä»£ç ç‰‡æ®µæˆ–è€…è¯´é€»è¾‘æ§åˆ¶æµçš„è°ƒåº¦å’Œåˆ‡æ¢å…¶å®å¹¶ä¸ç¥ç§˜ï¼Œç†è®ºä¸Šï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ä¾èµ–æ“ä½œç³»ç»Ÿå’Œå…¶æä¾›çš„çº¿ç¨‹ï¼Œåœ¨è‡ªå·±ç¨‹åºçš„ä»£ç æ®µé‡Œå®šä¹‰å¤šä¸ªç‰‡æ®µï¼Œç„¶ååœ¨æˆ‘ä»¬è‡ªå·±ç¨‹åºé‡Œå¯¹å…¶è¿›è¡Œè°ƒåº¦å’Œåˆ‡æ¢ã€‚</p><p>ä¸ºäº†æè¿°æ–¹ä¾¿ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥æŠŠâ€œä»£ç ç‰‡æ®µâ€ç§°ä¸ºâ€œä»»åŠ¡â€ã€‚</p><p>å’Œå†…æ ¸çš„å®ç°ç±»ä¼¼ï¼Œåªæ˜¯æˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘ä¸­æ–­å’Œç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬çš„ç¨‹åºæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯æœ¬èº«å°±æ˜¯è°ƒåº¦ç¨‹åºschedule()ï¼Œæˆ‘ä»¬éœ€è¦ç»´æŠ¤ä¸€ä¸ªä»»åŠ¡çš„åˆ—è¡¨ï¼Œæ ¹æ®æˆ‘ä»¬å®šä¹‰çš„ç­–ç•¥ï¼Œå…ˆè¿›å…ˆå‡ºæˆ–æ˜¯æœ‰ä¼˜å…ˆçº§ç­‰ç­‰ï¼Œæ¯æ¬¡ä»åˆ—è¡¨é‡ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»»åŠ¡ï¼Œç„¶åæ¢å¤å„ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œå¹¶ä¸”JMPåˆ°è¯¥ä»»åŠ¡ä¸Šæ¬¡è¢«æš‚åœçš„åœ°æ–¹ï¼Œæ‰€æœ‰è¿™äº›éœ€è¦ä¿å­˜çš„ä¿¡æ¯éƒ½å¯ä»¥ä½œä¸ºè¯¥ä»»åŠ¡çš„å±æ€§ï¼Œå­˜æ”¾åœ¨ä»»åŠ¡åˆ—è¡¨é‡Œã€‚</p><p>çœ‹èµ·æ¥å¾ˆç®€å•å•Šï¼Œå¯æ˜¯æˆ‘ä»¬è¿˜éœ€è¦è§£å†³å‡ ä¸ªé—®é¢˜ï¼š</p><p>(1) æˆ‘ä»¬è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œæ˜¯æ²¡æœ‰ä¸­æ–­æˆ–ç³»ç»Ÿè°ƒç”¨è¿™æ ·çš„æœºåˆ¶æ¥æ‰“æ–­ä»£ç æ‰§è¡Œçš„ï¼Œé‚£ä¹ˆï¼Œä¸€æ—¦æˆ‘ä»¬çš„schedule()ä»£ç æŠŠæ§åˆ¶æƒäº¤ç»™äº†ä»»åŠ¡çš„ä»£ç ï¼Œæˆ‘ä»¬ä¸‹æ¬¡çš„è°ƒåº¦åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Ÿç­”æ¡ˆæ˜¯ï¼Œä¸ä¼šå‘ç”Ÿï¼Œåªæœ‰é ä»»åŠ¡ä¸»åŠ¨è°ƒç”¨schedule()ï¼Œæˆ‘ä»¬æ‰æœ‰æœºä¼šè¿›è¡Œè°ƒåº¦ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œçš„ä»»åŠ¡ä¸èƒ½åƒçº¿ç¨‹ä¸€æ ·ä¾èµ–å†…æ ¸è°ƒåº¦ä»è€Œæ¯«æ— é¡¾å¿Œçš„æ‰§è¡Œï¼Œæˆ‘ä»¬çš„ä»»åŠ¡é‡Œä¸€å®šè¦æ˜¾å¼çš„è°ƒç”¨schedule()ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„åä½œå¼(cooperative)è°ƒåº¦ã€‚(è™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°æ¥æ¨¡æ‹Ÿå†…æ ¸é‡Œçš„æ—¶é’Ÿä¸­æ–­å¹¶å–å¾—æ§åˆ¶æƒï¼Œå¯é—®é¢˜åœ¨äºï¼Œä¿¡å·å¤„ç†å‡½æ•°æ˜¯ç”±å†…æ ¸è°ƒç”¨çš„ï¼Œåœ¨å…¶ç»“æŸçš„æ—¶å€™ï¼Œå†…æ ¸é‡æ–°è·å¾—æ§åˆ¶æƒï¼Œéšåè¿”å›ç”¨æˆ·æ€å¹¶ç»§ç»­æ²¿ç€ä¿¡å·å‘ç”Ÿæ—¶è¢«ä¸­æ–­çš„ä»£ç è·¯å¾„æ‰§è¡Œï¼Œä»è€Œæˆ‘ä»¬æ— æ³•åœ¨ä¿¡å·å¤„ç†å‡½æ•°å†…è¿›è¡Œä»»åŠ¡åˆ‡æ¢)</p><p>(2) å †æ ˆã€‚å’Œå†…æ ¸è°ƒåº¦çº¿ç¨‹çš„åŸç†ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸ºæ¯ä¸ªä»»åŠ¡å•ç‹¬åˆ†é…å †æ ˆï¼Œå¹¶ä¸”æŠŠå…¶å †æ ˆä¿¡æ¯ä¿å­˜åœ¨ä»»åŠ¡å±æ€§é‡Œï¼Œåœ¨ä»»åŠ¡åˆ‡æ¢æ—¶ä¹Ÿä¿å­˜æˆ–æ¢å¤å½“å‰çš„SS:ESPã€‚ä»»åŠ¡å †æ ˆçš„ç©ºé—´å¯ä»¥æ˜¯åœ¨å½“å‰çº¿ç¨‹çš„å †æ ˆä¸Šåˆ†é…ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨å †ä¸Šåˆ†é…ï¼Œä½†é€šå¸¸æ˜¯åœ¨å †ä¸Šåˆ†é…æ¯”è¾ƒå¥½ï¼šå‡ ä¹æ²¡æœ‰å¤§å°æˆ–ä»»åŠ¡æ€»æ•°çš„é™åˆ¶ã€å †æ ˆå¤§å°å¯ä»¥åŠ¨æ€æ‰©å±•(gccæœ‰split stackï¼Œä½†å¤ªå¤æ‚äº†)ã€ä¾¿äºæŠŠä»»åŠ¡åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¤§æ¦‚çŸ¥é“äº†å¦‚ä½•æ„é€ ä¸€ä¸ªå¹¶å‘çš„ç¼–ç¨‹æ¡†æ¶ï¼Œå¯å¦‚ä½•è®©ä»»åŠ¡å¯ä»¥å¹¶è¡Œçš„åœ¨å¤šä¸ªé€»è¾‘å¤„ç†å™¨ä¸Šæ‰§è¡Œå‘¢ï¼Ÿåªæœ‰å†…æ ¸æ‰æœ‰è°ƒåº¦CPUçš„æƒé™ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¿…é¡»é€šè¿‡ç³»ç»Ÿè°ƒç”¨åˆ›å»ºçº¿ç¨‹ï¼Œæ‰å¯ä»¥å®ç°å¹¶è¡Œã€‚åœ¨å¤šçº¿ç¨‹å¤„ç†å¤šä»»åŠ¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘å‡ ä¸ªé—®é¢˜ï¼š</p><p>(1) å¦‚æœæŸä¸ªä»»åŠ¡å‘èµ·äº†ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè­¬å¦‚é•¿æ—¶é—´ç­‰å¾…IOï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¢«å†…æ ¸æ”¾å…¥äº†ç­‰å¾…è°ƒåº¦çš„é˜Ÿåˆ—ï¼Œå²‚ä¸æ˜¯è®©å…¶ä»–ä»»åŠ¡éƒ½æ²¡æœ‰æœºä¼šæ‰§è¡Œï¼Ÿ</p><p>åœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªè§£å†³åŠæ³•ï¼Œå°±æ˜¯ä½¿ç”¨éé˜»å¡çš„IOç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶è®©å‡ºCPUï¼Œç„¶ååœ¨schedule()é‡Œç»Ÿä¸€è¿›è¡Œè½®è¯¢ï¼Œæœ‰æ•°æ®æ—¶åˆ‡æ¢å›è¯¥fdå¯¹åº”çš„ä»»åŠ¡ï¼›æ•ˆç‡ç•¥ä½çš„åšæ³•æ˜¯ä¸è¿›è¡Œç»Ÿä¸€è½®è¯¢ï¼Œè®©å„ä¸ªä»»åŠ¡åœ¨è½®åˆ°è‡ªå·±æ‰§è¡Œæ—¶å†æ¬¡ç”¨éé˜»å¡æ–¹å¼è¿›è¡ŒIOï¼Œç›´åˆ°æœ‰æ•°æ®å¯ç”¨ã€‚</p><p>å¦‚æœæˆ‘ä»¬é‡‡ç”¨å¤šçº¿ç¨‹æ¥æ„é€ æˆ‘ä»¬æ•´ä¸ªçš„ç¨‹åºï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°è£…ç³»ç»Ÿè°ƒç”¨çš„æ¥å£ï¼Œå½“æŸä¸ªä»»åŠ¡è¿›å…¥ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å°±æŠŠå½“å‰çº¿ç¨‹ç•™ç»™å®ƒ(æš‚æ—¶)ç‹¬äº«ï¼Œå¹¶å¼€å¯æ–°çš„çº¿ç¨‹æ¥å¤„ç†å…¶ä»–ä»»åŠ¡ã€‚</p><p>(2) ä»»åŠ¡åŒæ­¥ã€‚è­¬å¦‚æˆ‘ä»¬ä¸ŠèŠ‚æåˆ°çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä¾‹å­ï¼Œå¦‚ä½•è®©æ¶ˆè´¹è€…åœ¨æ•°æ®è¿˜æ²¡æœ‰è¢«ç”Ÿäº§å‡ºæ¥çš„æ—¶å€™è¿›å…¥ç­‰å¾…ï¼Œå¹¶ä¸”åœ¨æ•°æ®å¯ç”¨æ—¶è§¦å‘æ¶ˆè´¹è€…ç»§ç»­æ‰§è¡Œå‘¢ï¼Ÿ</p><p>åœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªç»“æ„ï¼Œå…¶ä¸­æœ‰å˜é‡ç”¨äºå­˜æ”¾äº¤äº’æ•°æ®æœ¬èº«ï¼Œä»¥åŠæ•°æ®çš„å½“å‰å¯ç”¨çŠ¶æ€ï¼Œä»¥åŠè´Ÿè´£è¯»å†™æ­¤æ•°æ®çš„ä¸¤ä¸ªä»»åŠ¡çš„ç¼–å·ã€‚ç„¶åæˆ‘ä»¬çš„å¹¶å‘ç¼–ç¨‹æ¡†æ¶å†æä¾›readå’Œwriteæ–¹æ³•ä¾›ä»»åŠ¡è°ƒç”¨ï¼Œåœ¨readæ–¹æ³•é‡Œï¼Œæˆ‘ä»¬å¾ªç¯æ£€æŸ¥æ•°æ®æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœæ•°æ®è¿˜ä¸å¯ç”¨ï¼Œæˆ‘ä»¬å°±è°ƒç”¨schedule()è®©å‡ºCPUè¿›å…¥ç­‰å¾…ï¼›åœ¨writeæ–¹æ³•é‡Œï¼Œæˆ‘ä»¬å¾€ç»“æ„é‡Œå†™å…¥æ•°æ®ï¼Œæ›´æ”¹æ•°æ®å¯ç”¨çŠ¶æ€ï¼Œç„¶åè¿”å›ï¼›åœ¨schedule()é‡Œï¼Œæˆ‘ä»¬æ£€æŸ¥æ•°æ®å¯ç”¨çŠ¶æ€ï¼Œå¦‚æœå¯ç”¨ï¼Œåˆ™æ¿€æ´»éœ€è¦è¯»å–æ­¤æ•°æ®çš„ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡ç»§ç»­å¾ªç¯æ£€æµ‹æ•°æ®æ˜¯å¦å¯ç”¨ï¼Œå‘ç°å¯ç”¨ï¼Œè¯»å–ï¼Œæ›´æ”¹çŠ¶æ€ä¸ºä¸å¯ç”¨ï¼Œè¿”å›ã€‚ä»£ç çš„ç®€å•é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chan</span> &#123;</span></span><br><span class="line">     <span class="keyword">bool</span> ready,</span><br><span class="line">     <span class="keyword">int</span> data</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read</span> <span class="params">(struct chan *c)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (c-&gt;ready) &#123;</span><br><span class="line">             c-&gt;ready = <span class="literal">false</span>;</span><br><span class="line">             <span class="keyword">return</span> c-&gt;data;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             schedule();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write</span> <span class="params">(struct chan *c, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (c-&gt;ready) &#123;</span><br><span class="line">             schedule(); </span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             c-&gt;data = i;</span><br><span class="line">             c-&gt;ready = <span class="literal">true</span>;</span><br><span class="line">             schedule(); <span class="comment">// optional</span></span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶ï¼Œå¦‚æœæ˜¯å¤šçº¿ç¨‹çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡çº¿ç¨‹åº“æˆ–ç³»ç»Ÿè°ƒç”¨æä¾›çš„åŒæ­¥æœºåˆ¶æ¥ä¿æŠ¤å¯¹è¿™ä¸ªç»“æ„ä½“å†…æ•°æ®çš„è®¿é—®ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯æœ€ç®€åŒ–çš„ä¸€ä¸ªå¹¶å‘æ¡†æ¶çš„è®¾è®¡è€ƒè™‘ï¼Œåœ¨æˆ‘ä»¬å®é™…å¼€å‘å·¥ä½œä¸­é‡åˆ°çš„å¹¶å‘æ¡†æ¶å¯èƒ½ç”±äºè¯­è¨€å’Œè¿è¡Œåº“çš„ä¸åŒè€Œæœ‰æ‰€ä¸åŒï¼Œåœ¨åŠŸèƒ½å’Œæ˜“ç”¨æ€§ä¸Šä¹Ÿå¯èƒ½å„æœ‰å–èˆï¼Œä½†åº•å±‚çš„åŸç†éƒ½æ˜¯æ®Šé€”åŒå½’ã€‚</p><p>è­¬å¦‚ï¼Œglicé‡Œçš„<a href="http://linux.die.net/man/3/swapcontext" target="_blank" rel="noopener">getcontext/setcontext/swapcontext</a>ç³»åˆ—åº“å‡½æ•°å¯ä»¥æ–¹ä¾¿çš„ç”¨æ¥ä¿å­˜å’Œæ¢å¤ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ï¼›Windowsæä¾›äº†Fiberç³»åˆ—çš„SDK APIï¼›è¿™äºŒè€…éƒ½ä¸æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œ<a href="http://linux.die.net/man/2/getcontext" target="_blank" rel="noopener">getcontextå’Œsetcontext</a>çš„man pageè™½ç„¶æ˜¯åœ¨section 2ï¼Œä½†é‚£åªæ˜¯SVR4æ—¶çš„å†å²é—ç•™é—®é¢˜ï¼Œå…¶å®ç°ä»£ç æ˜¯åœ¨glibcè€Œä¸æ˜¯kernelï¼›<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682402(v=vs.85" target="_blank" rel="noopener">CreateFiber</a>.aspx)æ˜¯åœ¨kernel32é‡Œæä¾›çš„ï¼ŒNTDLLé‡Œå¹¶æ²¡æœ‰å¯¹åº”çš„NtCreateFiberã€‚</p><p>åœ¨å…¶ä»–è¯­è¨€é‡Œï¼Œæˆ‘ä»¬æ‰€è°“çš„â€œä»»åŠ¡â€æ›´å¤šæ—¶å€™è¢«ç§°ä¸ºâ€œåç¨‹â€ï¼Œä¹Ÿå°±æ˜¯Coroutineã€‚è­¬å¦‚C++é‡Œæœ€å¸¸ç”¨çš„æ˜¯Boost.Coroutineï¼›Javaå› ä¸ºæœ‰ä¸€å±‚å­—èŠ‚ç è§£é‡Šï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œä½†ä¹Ÿæœ‰æ”¯æŒåç¨‹çš„JVMè¡¥ä¸ï¼Œæˆ–æ˜¯åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç ä»¥æ”¯æŒåç¨‹çš„é¡¹ç›®ï¼›PHPå’ŒPythonçš„generatorå’Œyieldå…¶å®å·²ç»æ˜¯åç¨‹çš„æ”¯æŒï¼Œåœ¨æ­¤ä¹‹ä¸Šå¯ä»¥å°è£…å‡ºæ›´é€šç”¨çš„åç¨‹æ¥å£å’Œè°ƒåº¦ï¼›å¦å¤–è¿˜æœ‰åŸç”Ÿæ”¯æŒåç¨‹çš„Erlangç­‰ï¼Œç¬”è€…ä¸æ‡‚ï¼Œå°±ä¸è¯´äº†ï¼Œå…·ä½“å¯å‚è§Wikipediaçš„é¡µé¢ï¼š<a href="http://en.wikipedia.org/wiki/Coroutine" target="_blank" rel="noopener">http://en.wikipedia.org/wiki/Coroutine</a></p><p>ç”±äºä¿å­˜å’Œæ¢å¤ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€éœ€è¦è®¿é—®CPUå¯„å­˜å™¨ï¼Œæ‰€ä»¥ç›¸å…³çš„è¿è¡Œåº“ä¹Ÿéƒ½ä¼šåˆ—å‡ºæ‰€æ”¯æŒçš„CPUåˆ—è¡¨ã€‚</p><p>ä»æ“ä½œç³»ç»Ÿå±‚é¢æä¾›åç¨‹ä»¥åŠå…¶å¹¶è¡Œè°ƒåº¦çš„ï¼Œå¥½åƒåªæœ‰OS Xå’ŒiOSçš„<a href="http://developer.apple.com/library/ios/#documentation/Performance/Reference/GCD_libdispatch_Ref/Reference/reference.html" target="_blank" rel="noopener">Grand Central Dispatch</a>ï¼Œå…¶å¤§éƒ¨åˆ†åŠŸèƒ½ä¹Ÿæ˜¯åœ¨è¿è¡Œåº“é‡Œå®ç°çš„ã€‚</p><h2 id="5ã€goroutine"><a href="#5ã€goroutine" class="headerlink" title="5ã€goroutine"></a>5ã€goroutine</h2><p>Goè¯­è¨€é€šè¿‡goroutineæä¾›äº†ç›®å‰ä¸ºæ­¢æ‰€æœ‰(æˆ‘æ‰€äº†è§£çš„)è¯­è¨€é‡Œå¯¹äºå¹¶å‘ç¼–ç¨‹çš„æœ€æ¸…æ™°æœ€ç›´æ¥çš„æ”¯æŒï¼ŒGoè¯­è¨€çš„æ–‡æ¡£é‡Œå¯¹å…¶ç‰¹æ€§ä¹Ÿæè¿°çš„éå¸¸å…¨é¢ç”šè‡³è¶…è¿‡äº†ï¼Œåœ¨è¿™é‡Œï¼ŒåŸºäºæˆ‘ä»¬ä¸Šé¢çš„ç³»ç»ŸçŸ¥è¯†ä»‹ç»ï¼Œåˆ—ä¸¾ä¸€ä¸‹goroutineçš„ç‰¹æ€§ï¼Œç®—æ˜¯å°ç»“ï¼š</p><p>(1) goroutineæ˜¯Goè¯­è¨€è¿è¡Œåº“çš„åŠŸèƒ½ï¼Œä¸æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„åŠŸèƒ½ï¼Œgoroutineä¸æ˜¯ç”¨çº¿ç¨‹å®ç°çš„ã€‚å…·ä½“å¯å‚è§Goè¯­è¨€æºç é‡Œçš„<a href="http://golang.org/src/pkg/runtime/proc.c" target="_blank" rel="noopener">pkg/runtime/proc.c</a></p><p>(2) goroutineå°±æ˜¯ä¸€æ®µä»£ç ï¼Œä¸€ä¸ªå‡½æ•°å…¥å£ï¼Œä»¥åŠåœ¨å †ä¸Šä¸ºå…¶åˆ†é…çš„ä¸€ä¸ªå †æ ˆã€‚æ‰€ä»¥å®ƒéå¸¸å»‰ä»·ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾çš„åˆ›å»ºä¸Šä¸‡ä¸ªgoroutineï¼Œä½†å®ƒä»¬å¹¶ä¸æ˜¯è¢«æ“ä½œç³»ç»Ÿæ‰€è°ƒåº¦æ‰§è¡Œ</p><p>(3) é™¤äº†è¢«ç³»ç»Ÿè°ƒç”¨é˜»å¡çš„çº¿ç¨‹å¤–ï¼ŒGoè¿è¡Œåº“æœ€å¤šä¼šå¯åŠ¨$GOMAXPROCSä¸ªçº¿ç¨‹æ¥è¿è¡Œgoroutine</p><p>(4) goroutineæ˜¯åä½œå¼è°ƒåº¦çš„ï¼Œå¦‚æœgoroutineä¼šæ‰§è¡Œå¾ˆé•¿æ—¶é—´ï¼Œè€Œä¸”ä¸æ˜¯é€šè¿‡ç­‰å¾…è¯»å–æˆ–å†™å…¥channelçš„æ•°æ®æ¥åŒæ­¥çš„è¯ï¼Œå°±éœ€è¦ä¸»åŠ¨è°ƒç”¨<a href="http://golang.org/pkg/runtime/#Gosched" target="_blank" rel="noopener">Gosched()</a>æ¥è®©å‡ºCPU</p><p>(5) å’Œæ‰€æœ‰å…¶ä»–å¹¶å‘æ¡†æ¶é‡Œçš„åç¨‹ä¸€æ ·ï¼Œgoroutineé‡Œæ‰€è°“â€œæ— é”â€çš„ä¼˜ç‚¹åªåœ¨å•çº¿ç¨‹ä¸‹æœ‰æ•ˆï¼Œå¦‚æœ$GOMAXPROCS &gt; 1å¹¶ä¸”åç¨‹é—´éœ€è¦é€šä¿¡ï¼ŒGoè¿è¡Œåº“ä¼šè´Ÿè´£åŠ é”ä¿æŠ¤æ•°æ®ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆsieve.goè¿™æ ·çš„ä¾‹å­åœ¨å¤šCPUå¤šçº¿ç¨‹æ—¶åè€Œæ›´æ…¢çš„åŸå› </p><p>(6) Webç­‰æœåŠ¡ç«¯ç¨‹åºè¦å¤„ç†çš„è¯·æ±‚ä»æœ¬è´¨ä¸Šæ¥è®²æ˜¯å¹¶è¡Œå¤„ç†çš„é—®é¢˜ï¼Œæ¯ä¸ªè¯·æ±‚åŸºæœ¬ç‹¬ç«‹ï¼Œäº’ä¸ä¾èµ–ï¼Œå‡ ä¹æ²¡æœ‰æ•°æ®äº¤äº’ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªå¹¶å‘ç¼–ç¨‹çš„æ¨¡å‹ï¼Œè€Œå¹¶å‘ç¼–ç¨‹æ¡†æ¶åªæ˜¯è§£å†³äº†å…¶è¯­ä¹‰è¡¨è¿°çš„å¤æ‚æ€§ï¼Œå¹¶ä¸æ˜¯ä»æ ¹æœ¬ä¸Šæé«˜å¤„ç†çš„æ•ˆç‡ï¼Œä¹Ÿè®¸æ˜¯å¹¶å‘è¿æ¥å’Œå¹¶å‘ç¼–ç¨‹çš„è‹±æ–‡éƒ½æ˜¯concurrentå§ï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿâ€œå¹¶å‘ç¼–ç¨‹æ¡†æ¶å’Œcoroutineå¯ä»¥é«˜æ•ˆå¤„ç†å¤§é‡å¹¶å‘è¿æ¥â€çš„è¯¯è§£ã€‚</p><p>(7) Goè¯­è¨€è¿è¡Œåº“å°è£…äº†å¼‚æ­¥IOï¼Œæ‰€ä»¥å¯ä»¥å†™å‡ºè²Œä¼¼å¹¶å‘æ•°å¾ˆå¤šçš„æœåŠ¡ç«¯ï¼Œå¯å³ä½¿æˆ‘ä»¬é€šè¿‡è°ƒæ•´$GOMAXPROCSæ¥å……åˆ†åˆ©ç”¨å¤šæ ¸CPUå¹¶è¡Œå¤„ç†ï¼Œå…¶æ•ˆç‡ä¹Ÿä¸å¦‚æˆ‘ä»¬åˆ©ç”¨IOäº‹ä»¶é©±åŠ¨è®¾è®¡çš„ã€æŒ‰ç…§äº‹åŠ¡ç±»å‹åˆ’åˆ†å¥½åˆé€‚æ¯”ä¾‹çš„çº¿ç¨‹æ± ã€‚åœ¨å“åº”æ—¶é—´ä¸Šï¼Œåä½œå¼è°ƒåº¦æ˜¯ç¡¬ä¼¤ã€‚</p><p>(8) goroutineæœ€å¤§çš„ä»·å€¼æ˜¯å…¶å®ç°äº†å¹¶å‘åç¨‹å’Œå®é™…å¹¶è¡Œæ‰§è¡Œçš„çº¿ç¨‹çš„æ˜ å°„ä»¥åŠåŠ¨æ€æ‰©å±•ï¼Œéšç€å…¶è¿è¡Œåº“çš„ä¸æ–­å‘å±•å’Œå®Œå–„ï¼Œå…¶æ€§èƒ½ä¸€å®šä¼šè¶Šæ¥è¶Šå¥½ï¼Œå°¤å…¶æ˜¯åœ¨CPUæ ¸æ•°è¶Šæ¥è¶Šå¤šçš„æœªæ¥ï¼Œç»ˆæœ‰ä¸€å¤©æˆ‘ä»¬ä¼šä¸ºäº†ä»£ç çš„ç®€æ´å’Œå¯ç»´æŠ¤æ€§è€Œæ”¾å¼ƒé‚£ä¸€ç‚¹ç‚¹æ€§èƒ½çš„å·®åˆ«ã€‚</p><p>æ–‡ç« è½¬è½½è‡ªï¼š<a href="http://www.sizeofvoid.net/goroutine-under-the-hood/" target="_blank" rel="noopener">http://www.sizeofvoid.net/goroutine-under-the-hood/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://golang.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Goè¯­è¨€&lt;/a&gt; ä»è¯ç”Ÿåˆ°æ™®åŠå·²ç»ä¸‰å¹´äº†ï¼Œå…ˆè¡Œè€…å¤§éƒ½æ˜¯Webå¼€å‘çš„èƒŒæ™¯ï¼Œä¹Ÿæœ‰äº†ä¸€äº›æ™®åŠå‹çš„ä¹¦ç±ï¼Œå¯ç³»ç»Ÿå¼€å‘èƒŒæ™¯çš„äººåœ¨å­¦ä¹ è¿™äº›ä¹¦ç±çš„æ—¶å€™ï¼Œæ€»æœ‰è¯­ç„‰ä¸è¯¦çš„æ„Ÿè§‰ï¼Œç½‘ä¸Šä¹Ÿæœ‰è‹¥å¹²æµä¼ ç”šå¹¿çš„æ–‡ç« ï¼Œå¯å…¶ä¸­æˆ–å¤šæˆ–å°‘æ€»æœ‰äº›ä¸äº‹å®ä¸ç¬¦çš„æŠ€æœ¯æè¿°ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½ä¸ºæ¯”è¾ƒç¼ºå°‘ç³»ç»Ÿç¼–ç¨‹èƒŒæ™¯çš„Webå¼€å‘äººå‘˜ä»‹ç»ä¸€ä¸‹&lt;a href=&quot;http://golang.org/doc/effective_go.html#goroutines&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;goroutine&lt;/a&gt;èƒŒåçš„ç³»ç»ŸçŸ¥è¯†ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="golang/goroutine/01" scheme="http://xwxz.github.io/categories/golang-goroutine-01/"/>
    
    
      <category term="Golang" scheme="http://xwxz.github.io/tags/Golang/"/>
    
      <category term="routine" scheme="http://xwxz.github.io/tags/routine/"/>
    
  </entry>
  
  <entry>
    <title>GolangåŸºç¡€è¯­æ³•ã€åŸåˆ›ã€‘</title>
    <link href="http://xwxz.github.io/golang-grammar-01/"/>
    <id>http://xwxz.github.io/golang-grammar-01/</id>
    <published>2017-11-30T16:00:00.000Z</published>
    <updated>2018-08-25T08:07:53.987Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡åŸºäºGOå®˜ç½‘ä¸Šçš„ä¾‹å­å†™å°±ï¼Œä¸»è¦å¸®åŠ©è‡ªå·±åœ¨å­¦ä¹ goè¯­è¨€çš„è¿‡ç¨‹ä¸­è®°å¿†ï¼Œæ›´å¤šçš„æ˜¯è‡ªå·±å¯¹å…¶ä¸­ä¸€äº›æ¦‚å¿µçš„ç†è§£ã€‚</p><a id="more"></a><h2 id="1-1-GoåŸºç¡€è¯­æ³•"><a href="#1-1-GoåŸºç¡€è¯­æ³•" class="headerlink" title="1.1 GoåŸºç¡€è¯­æ³•"></a>1.1 GoåŸºç¡€è¯­æ³•</h2><h3 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h3><p>å‡½æ•°å£°æ˜å…³é”®å­—funcï¼ŒåŒ…æ‹¬å‡½æ•°åã€å‚æ•°åˆ—è¡¨ï¼ˆå‚æ•°å å‚æ•°ç±»å‹ï¼‰ã€å‡½æ•°è¿”å›å€¼ï¼Œï¼ˆéœ€è¦æŒ‡æ˜è¿”å›ç±»å‹ï¼Œå¯ä»¥æŒ‡å®šè¿”å›å˜é‡åï¼‰ã€‚å…·ä½“æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">funcName</span><span class="params">(a , b <span class="keyword">int</span>)</span> <span class="params">(sum <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">sum = a + b</span><br><span class="line"><span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŸºæœ¬æ•°æ®ç±»å‹"><a href="#åŸºæœ¬æ•°æ®ç±»å‹" class="headerlink" title="åŸºæœ¬æ•°æ®ç±»å‹"></a>åŸºæœ¬æ•°æ®ç±»å‹</h3><p> <strong>intã€int8ã€int16ã€int32ã€int64ã€uintã€uint8ã€uint16ã€uint32ã€uint64ã€ uintptr ã€byteï¼ˆint8ï¼‰ã€runeï¼ˆint32ï¼‰ã€float32ã€float64ã€complex64ã€complex128ã€ stringã€ bool</strong> </p><p>intï¼Œuint å’Œ uintptr ç±»å‹åœ¨32ä½çš„ç³»ç»Ÿä¸Šä¸€èˆ¬æ˜¯32ä½ï¼Œè€Œåœ¨64ä½ç³»ç»Ÿä¸Šæ˜¯64ä½ã€‚å½“ä½ éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ•´æ•°ç±»å‹æ—¶ï¼Œä½ åº”è¯¥é¦–é€‰ intï¼Œä»…å½“æœ‰ç‰¹åˆ«çš„ç†ç”±æ‰ä½¿ç”¨å®šé•¿æ•´æ•°ç±»å‹æˆ–è€…æ— ç¬¦å·æ•´æ•°ç±»å‹ã€‚</p><h3 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h3><p>å˜é‡å£°æ˜é‡‡ç”¨<strong>var</strong>å…³é”®å­—ï¼Œå¦‚æœå£°æ˜æ—¶æŒ‡å®šäº†åˆå§‹å€¼ï¼Œåˆ™å¯ä»¥ä¸å†™å˜é‡ç±»å‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name <span class="keyword">string</span> = <span class="string">"xxx"</span></span><br></pre></td></tr></table></figure><p>æˆ–çŸ­å˜é‡å£°æ˜ï¼Œåœ¨å‡½æ•°ä¸­ï¼Œ := ç®€æ´èµ‹å€¼è¯­å¥åœ¨æ˜ç¡®ç±»å‹çš„åœ°æ–¹ï¼Œå¯ä»¥ç”¨äºæ›¿ä»£ var å®šä¹‰ã€‚å‡½æ•°å¤–çš„æ¯ä¸ªè¯­å¥éƒ½å¿…é¡»ä»¥å…³é”®å­—å¼€å§‹ï¼ˆ var ã€ func ã€ç­‰ç­‰ï¼‰ï¼Œ := ç»“æ„ä¸èƒ½ä½¿ç”¨åœ¨å‡½æ•°å¤–ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name := <span class="string">"xxx"</span></span><br></pre></td></tr></table></figure><p>var è¯­å¥å®šä¹‰äº†ä¸€ä¸ªå˜é‡çš„åˆ—è¡¨ï¼›è·Ÿå‡½æ•°çš„å‚æ•°åˆ—è¡¨ä¸€æ ·ï¼Œç±»å‹åœ¨åé¢ã€‚ var è¯­å¥å¯ä»¥å®šä¹‰åœ¨åŒ…æˆ–å‡½æ•°çº§åˆ«ã€‚</p><h3 id="å¾ªç¯for"><a href="#å¾ªç¯for" class="headerlink" title="å¾ªç¯for"></a>å¾ªç¯for</h3><p>Goä¸­åªæœ‰ä¸€ç§forå¾ªç¯ï¼ŒåŸºæœ¬çš„ for å¾ªç¯åŒ…å«ä¸‰ä¸ªç”±åˆ†å·åˆ†å¼€çš„ç»„æˆéƒ¨åˆ†ï¼š</p><ul><li>åˆå§‹åŒ–è¯­å¥ï¼šåœ¨ç¬¬ä¸€æ¬¡å¾ªç¯æ‰§è¡Œå‰è¢«æ‰§è¡Œ</li><li>å¾ªç¯æ¡ä»¶è¡¨è¾¾å¼ï¼šæ¯è½®è¿­ä»£å¼€å§‹å‰è¢«æ±‚å€¼</li><li>åç½®è¯­å¥ï¼šæ¯è½®è¿­ä»£åè¢«æ‰§è¡Œ</li></ul><p>ä¸”å¾ªç¯æ¡ä»¶ä¸èƒ½æœ‰åœ†æ‹¬å·ï¼Œå¾ªç¯ä½“éœ€è¦å¤§æ‹¬å·ï¼Œå…¶è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sum :=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i:=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++ &#123;</span><br><span class="line">sum++</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå‰ç½®æ¡ä»¶ã€åç½®æ¡ä»¶å’Œåˆ†å·éƒ½å»æ‰ï¼Œè¿™å°±é€€åŒ–ä¸ºCè¯­è¨€ä¸­çš„whileå¾ªç¯äº†ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sum := <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> sum &lt; <span class="number">100</span> &#123;</span><br><span class="line">    sum++</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡ä»¶if"><a href="#æ¡ä»¶if" class="headerlink" title="æ¡ä»¶if"></a>æ¡ä»¶if</h3><p>Goä¸­çš„ifè¯­å¥åŒå¾ªç¯ä¸€æ ·ï¼Œä¸éœ€è¦åœ†æ‹¬å·ï¼Œå…·ä½“æ‰§è¡Œè¯­å¥éœ€è¦å¤§æ‹¬å·ï¼Œå…¶è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> i &lt; <span class="number">10</span> &#123;</span><br><span class="line"><span class="comment">//todo something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="if-çš„ä¾¿æ·è¯­å¥"><a href="#if-çš„ä¾¿æ·è¯­å¥" class="headerlink" title="if çš„ä¾¿æ·è¯­å¥"></a>if çš„ä¾¿æ·è¯­å¥</h4><p>è·Ÿ for ä¸€æ ·ï¼Œ if è¯­å¥å¯ä»¥åœ¨æ¡ä»¶ä¹‹å‰æ‰§è¡Œä¸€ä¸ªç®€å•è¯­å¥ã€‚</p><p>ç”±è¿™ä¸ªè¯­å¥å®šä¹‰çš„å˜é‡çš„ä½œç”¨åŸŸä»…åœ¨ if èŒƒå›´ä¹‹å†…ã€‚åŒ…æ‹¬åœ¨ if çš„ä¾¿æ·è¯­å¥å®šä¹‰çš„å˜é‡åŒæ ·å¯ä»¥åœ¨ä»»ä½•å¯¹åº”çš„ else å—ä¸­ä½¿ç”¨ã€‚</p><h3 id="åŒ…çš„å®šä¹‰"><a href="#åŒ…çš„å®šä¹‰" class="headerlink" title="åŒ…çš„å®šä¹‰"></a>åŒ…çš„å®šä¹‰</h3><p>packageæ˜¯golangæœ€åŸºæœ¬çš„åˆ†å‘å•ä½å’Œå·¥ç¨‹ç®¡ç†ä¸­ä¾èµ–å…³ç³»çš„ä½“ç°ã€‚æ¯ä¸ªgolangæºä»£ç æ–‡ä»¶å¼€å¤´éƒ½æ‹¥æœ‰ä¸€ä¸ªpackageå£°æ˜ï¼Œè¡¨ç¤ºè¯¥golangä»£ç æ‰€å±çš„packageã€‚</p><p>è¦ç”Ÿæˆgolangå¯æ‰§è¡Œç¨‹åºï¼Œå¿…é¡»å»ºç«‹ä¸€ä¸ªåä¸º<strong>main</strong>çš„packageï¼Œå¹¶ä¸”åœ¨è¯¥packageä¸­å¿…é¡»åŒ…å«ä¸€ä¸ªåä¸º<strong>main()</strong>çš„å‡½æ•°ã€‚</p><p>åœ¨golangå·¥ç¨‹ä¸­ï¼ŒåŒä¸€ä¸ªè·¯å¾„ä¸‹åªèƒ½å­˜åœ¨ä¸€ä¸ªpackageï¼Œä¸€ä¸ªpackageå¯ä»¥æ‹†æˆå¤šä¸ªæºæ–‡ä»¶ç»„æˆ</p><p>æŒ‰ç…§æƒ¯ä¾‹ï¼ŒåŒ…åä¸å¯¼å…¥è·¯å¾„çš„æœ€åä¸€ä¸ªç›®å½•ä¸€è‡´ã€‚</p><h3 id="åŒ…çš„å¯¼å…¥"><a href="#åŒ…çš„å¯¼å…¥" class="headerlink" title="åŒ…çš„å¯¼å…¥"></a>åŒ…çš„å¯¼å…¥</h3><p>åŒ…çš„å¯¼å…¥ä½¿ç”¨importå…³é”®å­—</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="comment">//æˆ–è€…ä½¿ç”¨æ‰“åŒ…çš„å¯¼å…¥è¯­å¥</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"math"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="å¯¼å‡ºå"><a href="#å¯¼å‡ºå" class="headerlink" title="å¯¼å‡ºå"></a>å¯¼å‡ºå</h3><p>åœ¨ Go ä¸­ï¼Œé¦–å­—æ¯å¤§å†™çš„åç§°æ˜¯è¢«å¯¼å‡ºçš„ã€‚</p><p>åœ¨å¯¼å…¥åŒ…ä¹‹åï¼Œä½ åªèƒ½è®¿é—®åŒ…æ‰€å¯¼å‡ºçš„åå­—ï¼Œä»»ä½•æœªå¯¼å‡ºçš„åå­—æ˜¯ä¸èƒ½è¢«åŒ…å¤–çš„ä»£ç è®¿é—®çš„ã€‚</p><p>Foo å’Œ FOO éƒ½æ˜¯è¢«å¯¼å‡ºçš„åç§°ã€‚åç§° foo æ˜¯ä¸ä¼šè¢«å¯¼å‡ºçš„ã€‚</p><h3 id="é›¶å€¼"><a href="#é›¶å€¼" class="headerlink" title="é›¶å€¼"></a>é›¶å€¼</h3><p>å˜é‡åœ¨å®šä¹‰æ—¶æ²¡æœ‰æ˜ç¡®çš„åˆå§‹åŒ–æ—¶ä¼šèµ‹å€¼ä¸ºé›¶å€¼ ã€‚</p><p>é›¶å€¼æ˜¯ï¼š</p><ol><li>æ•°å€¼ç±»å‹ä¸º 0 ï¼Œ</li><li>å¸ƒå°”ç±»å‹ä¸º false ï¼Œ</li><li>å­—ç¬¦ä¸²ä¸º â€œâ€ ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ã€‚</li></ol><h3 id="ç±»å‹è½¬æ¢"><a href="#ç±»å‹è½¬æ¢" class="headerlink" title="ç±»å‹è½¬æ¢"></a>ç±»å‹è½¬æ¢</h3><p>è¡¨è¾¾å¼ T(v) å°†å€¼ v è½¬æ¢ä¸ºç±»å‹ T ã€‚</p><p>ä¸€äº›å…³äºæ•°å€¼çš„è½¬æ¢ä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="keyword">int</span> = <span class="number">42</span></span><br><span class="line"><span class="keyword">var</span> f <span class="keyword">float64</span> = <span class="keyword">float64</span>(i)</span><br><span class="line"><span class="keyword">var</span> u <span class="keyword">uint</span> = <span class="keyword">uint</span>(f)</span><br><span class="line"><span class="comment">//æˆ–è€…ï¼Œæ›´åŠ ç®€å•çš„å½¢å¼ï¼š</span></span><br><span class="line">i := <span class="number">42</span></span><br><span class="line">f := <span class="keyword">float64</span>(i)</span><br><span class="line">u := <span class="keyword">uint</span>(f)</span><br></pre></td></tr></table></figure><p>ä¸ C ä¸åŒçš„æ˜¯ Go çš„åœ¨ä¸åŒç±»å‹ä¹‹é—´çš„èµ‹å€¼æ—¶éœ€è¦æ˜¾å¼è½¬æ¢ã€‚</p><h3 id="å¸¸é‡"><a href="#å¸¸é‡" class="headerlink" title="å¸¸é‡"></a>å¸¸é‡</h3><p>å¸¸é‡çš„å®šä¹‰ä¸å˜é‡ç±»ä¼¼ï¼Œåªä¸è¿‡ä½¿ç”¨ const å…³é”®å­—ã€‚</p><p>å¸¸é‡å¯ä»¥æ˜¯å­—ç¬¦ã€å­—ç¬¦ä¸²ã€å¸ƒå°”æˆ–æ•°å­—ç±»å‹çš„å€¼ã€‚</p><p>å¸¸é‡ä¸èƒ½ä½¿ç”¨ := è¯­æ³•å®šä¹‰ã€‚</p><h3 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h3><p>ä½ å¯èƒ½å·²ç»çŸ¥é“ switch è¯­å¥ä¼šé•¿ä»€ä¹ˆæ ·äº†ã€‚</p><p>é™¤éä»¥ fallthrough è¯­å¥ç»“æŸï¼Œå¦åˆ™åˆ†æ”¯ä¼šè‡ªåŠ¨ç»ˆæ­¢ã€‚</p><p>switch çš„æ¡ä»¶ä»ä¸Šåˆ°ä¸‹çš„æ‰§è¡Œï¼Œå½“åŒ¹é…æˆåŠŸçš„æ—¶å€™åœæ­¢ã€‚</p><p>æ²¡æœ‰æ¡ä»¶çš„ switch</p><p>æ²¡æœ‰æ¡ä»¶çš„ switch åŒ switch true ä¸€æ ·ã€‚</p><p>è¿™ä¸€æ„é€ ä½¿å¾—å¯ä»¥ç”¨æ›´æ¸…æ™°çš„å½¢å¼æ¥ç¼–å†™é•¿çš„ if-then-else é“¾ã€‚</p><h3 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h3><p>defer è¯­å¥ä¼šå»¶è¿Ÿå‡½æ•°çš„æ‰§è¡Œç›´åˆ°ä¸Šå±‚å‡½æ•°è¿”å›ã€‚</p><p>å»¶è¿Ÿè°ƒç”¨çš„å‚æ•°ä¼šç«‹åˆ»ç”Ÿæˆï¼Œä½†æ˜¯åœ¨ä¸Šå±‚å‡½æ•°è¿”å›å‰å‡½æ•°éƒ½ä¸ä¼šè¢«è°ƒç”¨ã€‚</p><h3 id="deferæ ˆ"><a href="#deferæ ˆ" class="headerlink" title="deferæ ˆ"></a>deferæ ˆ</h3><p>å»¶è¿Ÿçš„å‡½æ•°è°ƒç”¨è¢«å‹å…¥ä¸€ä¸ªæ ˆä¸­ã€‚å½“å‡½æ•°è¿”å›æ—¶ï¼Œ ä¼šæŒ‰ç…§åè¿›å…ˆå‡ºçš„é¡ºåºè°ƒç”¨è¢«å»¶è¿Ÿçš„å‡½æ•°è°ƒç”¨ã€‚</p><h3 id="æŒ‡é’ˆ"><a href="#æŒ‡é’ˆ" class="headerlink" title="æŒ‡é’ˆ"></a>æŒ‡é’ˆ</h3><p>Go å…·æœ‰æŒ‡é’ˆã€‚ æŒ‡é’ˆä¿å­˜äº†å˜é‡çš„å†…å­˜åœ°å€ã€‚</p><p>ç±»å‹ *T æ˜¯æŒ‡å‘ç±»å‹ T çš„å€¼çš„æŒ‡é’ˆã€‚å…¶é›¶å€¼æ˜¯ nil ã€‚&amp; ç¬¦å·ä¼šç”Ÿæˆä¸€ä¸ªæŒ‡å‘å…¶ä½œç”¨å¯¹è±¡çš„æŒ‡é’ˆã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p *<span class="keyword">int</span></span><br><span class="line">i := <span class="number">42</span></span><br><span class="line">p = &amp;i</span><br></pre></td></tr></table></figure><ul><li>ç¬¦å·è¡¨ç¤ºæŒ‡é’ˆæŒ‡å‘çš„åº•å±‚çš„å€¼ã€‚</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(*p) <span class="comment">// é€šè¿‡æŒ‡é’ˆ p è¯»å– i</span></span><br><span class="line">*p = <span class="number">21</span>         <span class="comment">// é€šè¿‡æŒ‡é’ˆ p è®¾ç½® i</span></span><br></pre></td></tr></table></figure><p>è¿™ä¹Ÿå°±æ˜¯é€šå¸¸æ‰€è¯´çš„â€œé—´æ¥å¼•ç”¨â€æˆ–â€œéç›´æ¥å¼•ç”¨â€ã€‚</p><p><strong>ä¸ C ä¸åŒï¼ŒGo æ²¡æœ‰æŒ‡é’ˆè¿ç®—ã€‚</strong></p><h3 id="ç»“æ„ä½“"><a href="#ç»“æ„ä½“" class="headerlink" title="ç»“æ„ä½“"></a>ç»“æ„ä½“</h3><p>ä¸€ä¸ªç»“æ„ä½“ï¼ˆ struct ï¼‰å°±æ˜¯ä¸€ä¸ªå­—æ®µçš„é›†åˆã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</span><br><span class="line">X <span class="keyword">int</span></span><br><span class="line">Y <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(Vertex&#123;<span class="number">1</span>, <span class="number">2</span>&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æ„ä½“å­—æ®µä½¿ç”¨ç‚¹å·æ¥è®¿é—®ã€‚</p><p>ç»“æ„ä½“å­—æ®µå¯ä»¥é€šè¿‡ç»“æ„ä½“æŒ‡é’ˆæ¥è®¿é—®ã€‚</p><p>é€šè¿‡æŒ‡é’ˆé—´æ¥çš„è®¿é—®æ˜¯é€æ˜çš„ã€‚</p><h3 id="ç»“æ„ä½“æ–‡æ³•"><a href="#ç»“æ„ä½“æ–‡æ³•" class="headerlink" title="ç»“æ„ä½“æ–‡æ³•"></a>ç»“æ„ä½“æ–‡æ³•</h3><p>ç»“æ„ä½“æ–‡æ³•è¡¨ç¤ºé€šè¿‡ç»“æ„ä½“å­—æ®µçš„å€¼ä½œä¸ºåˆ—è¡¨æ¥æ–°åˆ†é…ä¸€ä¸ªç»“æ„ä½“ã€‚</p><p>ä½¿ç”¨ Name: è¯­æ³•å¯ä»¥ä»…åˆ—å‡ºéƒ¨åˆ†å­—æ®µã€‚ï¼ˆå­—æ®µåçš„é¡ºåºæ— å…³ã€‚ï¼‰</p><p>ç‰¹æ®Šçš„å‰ç¼€ &amp; è¿”å›ä¸€ä¸ªæŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆã€‚ </p><h3 id="æ•°ç»„"><a href="#æ•°ç»„" class="headerlink" title="æ•°ç»„"></a>æ•°ç»„</h3><p>ç±»å‹ [n]T æ˜¯ä¸€ä¸ªæœ‰ n ä¸ªç±»å‹ä¸º T çš„å€¼çš„æ•°ç»„ã€‚</p><p>ä¸‹é¢è¡¨è¾¾å¼å®šä¹‰å˜é‡ a æ˜¯ä¸€ä¸ªæœ‰åä¸ªæ•´æ•°çš„æ•°ç»„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a [<span class="number">10</span>]<span class="keyword">int</span></span><br></pre></td></tr></table></figure><p>æ•°ç»„çš„é•¿åº¦æ˜¯å…¶ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤æ•°ç»„ä¸èƒ½æ”¹å˜å¤§å°ã€‚ è¿™çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªåˆ¶çº¦ï¼Œä½†æ˜¯è¯·ä¸è¦æ‹…å¿ƒï¼› Go æä¾›äº†æ›´åŠ ä¾¿åˆ©çš„æ–¹å¼æ¥ä½¿ç”¨æ•°ç»„ã€‚</p><h4 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h4><p>ä¸€ä¸ª slice ä¼šæŒ‡å‘ä¸€ä¸ªåºåˆ—çš„å€¼ï¼Œå¹¶ä¸”åŒ…å«äº†é•¿åº¦ä¿¡æ¯ã€‚</p><p>[]T æ˜¯ä¸€ä¸ªå…ƒç´ ç±»å‹ä¸º T çš„ sliceã€‚</p><p>len(s) è¿”å› slice s çš„é•¿åº¦ã€‚</p><p>slice å¯ä»¥åŒ…å«ä»»æ„çš„ç±»å‹ï¼ŒåŒ…æ‹¬å¦ä¸€ä¸ª sliceã€‚</p><h4 id="å¯¹-slice-åˆ‡ç‰‡"><a href="#å¯¹-slice-åˆ‡ç‰‡" class="headerlink" title="å¯¹ slice åˆ‡ç‰‡"></a>å¯¹ slice åˆ‡ç‰‡</h4><p>slice å¯ä»¥é‡æ–°åˆ‡ç‰‡ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ slice å€¼æŒ‡å‘ç›¸åŒçš„æ•°ç»„ã€‚</p><p>å¦‚è¡¨è¾¾å¼ï¼šs[lo:hi]ï¼Œè¡¨ç¤ºä» lo åˆ° hi-1 çš„ slice å…ƒç´ ï¼Œå«å‰ç«¯ï¼Œä¸åŒ…å«åç«¯ã€‚å› æ­¤ s[lo:lo]æ˜¯ç©ºçš„ï¼Œè€Œs[lo:lo+1]æœ‰ä¸€ä¸ªå…ƒç´ ã€‚</p><h4 id="æ„é€ -slice"><a href="#æ„é€ -slice" class="headerlink" title="æ„é€  slice"></a>æ„é€  slice</h4><p>slice ç”±å‡½æ•° <strong>make</strong> åˆ›å»ºã€‚è¿™ä¼šåˆ†é…ä¸€ä¸ªå…¨æ˜¯é›¶å€¼çš„æ•°ç»„å¹¶ä¸”è¿”å›ä¸€ä¸ª slice æŒ‡å‘è¿™ä¸ªæ•°ç»„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>)  <span class="comment">// len(a)=5</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†æŒ‡å®šå®¹é‡ï¼Œå¯ä¼ é€’ç¬¬ä¸‰ä¸ªå‚æ•°åˆ° makeï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">5</span>) <span class="comment">// len(b)=0, cap(b)=5</span></span><br><span class="line">b = b[:<span class="built_in">cap</span>(b)] <span class="comment">// len(b)=5, cap(b)=5</span></span><br><span class="line">b = b[<span class="number">1</span>:] <span class="comment">// len(b)=4, cap(b)=4</span></span><br></pre></td></tr></table></figure><h4 id="slice-çš„é›¶å€¼æ˜¯-nil"><a href="#slice-çš„é›¶å€¼æ˜¯-nil" class="headerlink" title="slice çš„é›¶å€¼æ˜¯ nil"></a>slice çš„é›¶å€¼æ˜¯ nil</h4><p>ä¸€ä¸ª nil çš„ slice çš„é•¿åº¦å’Œå®¹é‡æ˜¯ 0ã€‚</p><h4 id="å‘-slice-æ·»åŠ å…ƒç´ "><a href="#å‘-slice-æ·»åŠ å…ƒç´ " class="headerlink" title="å‘ slice æ·»åŠ å…ƒç´ "></a>å‘ slice æ·»åŠ å…ƒç´ </h4><p>å‘ slice çš„æœ«å°¾æ·»åŠ å…ƒç´ æ˜¯ä¸€ç§å¸¸è§çš„æ“ä½œï¼Œå› æ­¤ Go æä¾›äº†ä¸€ä¸ªå†…å»ºå‡½æ•° <strong>append</strong> ã€‚ å†…å»ºå‡½æ•°çš„<a href="https://go-zh.org/pkg/builtin/#append" target="_blank" rel="noopener">æ–‡æ¡£</a>å¯¹ append æœ‰è¯¦ç»†ä»‹ç»ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(s []T, vs ...T)</span> []<span class="title">T</span></span></span><br></pre></td></tr></table></figure><p>append çš„ç¬¬ä¸€ä¸ªå‚æ•° s æ˜¯ä¸€ä¸ªå…ƒç´ ç±»å‹ä¸º T çš„ slice ï¼Œå…¶ä½™ç±»å‹ä¸º T çš„å€¼å°†ä¼šé™„åŠ åˆ°è¯¥ slice çš„æœ«å°¾ã€‚</p><p>append çš„ç»“æœæ˜¯ä¸€ä¸ªåŒ…å«åŸ slice æ‰€æœ‰å…ƒç´ åŠ ä¸Šæ–°æ·»åŠ çš„å…ƒç´ çš„ sliceã€‚</p><p>å¦‚æœ s çš„åº•å±‚æ•°ç»„å¤ªå°ï¼Œè€Œä¸èƒ½å®¹çº³æ‰€æœ‰å€¼æ—¶ï¼Œä¼šåˆ†é…ä¸€ä¸ªæ›´å¤§çš„æ•°ç»„ã€‚ è¿”å›çš„ slice ä¼šæŒ‡å‘è¿™ä¸ªæ–°åˆ†é…çš„æ•°ç»„ã€‚</p><h3 id="range"><a href="#range" class="headerlink" title="range"></a>range</h3><p>for å¾ªç¯çš„ range æ ¼å¼å¯ä»¥å¯¹ slice æˆ–è€… map è¿›è¡Œè¿­ä»£å¾ªç¯ã€‚</p><p>å½“ä½¿ç”¨ for å¾ªç¯éå†ä¸€ä¸ª slice æ—¶ï¼Œæ¯æ¬¡è¿­ä»£ range å°†è¿”å›ä¸¤ä¸ªå€¼ã€‚ ç¬¬ä¸€ä¸ªæ˜¯å½“å‰ä¸‹æ ‡ï¼ˆåºå·ï¼‰ï¼Œç¬¬äºŒä¸ªæ˜¯è¯¥ä¸‹æ ‡æ‰€å¯¹åº”å…ƒç´ çš„ä¸€ä¸ªæ‹·è´ã€‚</p><p>å¯ä»¥é€šè¿‡èµ‹å€¼ç»™ _ æ¥å¿½ç•¥åºå·å’Œå€¼ã€‚</p><p>å¦‚æœåªéœ€è¦ç´¢å¼•å€¼ï¼Œå»æ‰ â€œ , value â€ çš„éƒ¨åˆ†å³å¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    pow := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> pow &#123;</span><br><span class="line">    pow[i] = <span class="number">1</span> &lt;&lt; <span class="keyword">uint</span>(i)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, value := <span class="keyword">range</span> pow &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"%d\n"</span>, value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>map æ˜ å°„é”®åˆ°å€¼ã€‚</p><p>map åœ¨ä½¿ç”¨ä¹‹å‰å¿…é¡»ç”¨ <strong>make</strong> æ¥åˆ›å»ºï¼›</p><p>å€¼ä¸º nil çš„ map æ˜¯ç©ºçš„ï¼Œå¹¶ä¸”ä¸èƒ½å¯¹å…¶èµ‹å€¼ã€‚</p><p>map çš„æ–‡æ³•è·Ÿç»“æ„ä½“æ–‡æ³•ç›¸ä¼¼ï¼Œä¸è¿‡å¿…é¡»æœ‰é”®åã€‚</p><p>è‹¥é¡¶çº§ç±»å‹åªæ˜¯ä¸€ä¸ªç±»å‹åï¼Œä½ å¯ä»¥åœ¨æ–‡æ³•çš„å…ƒç´ ä¸­çœç•¥å®ƒã€‚</p><h4 id="ä¿®æ”¹-map"><a href="#ä¿®æ”¹-map" class="headerlink" title="ä¿®æ”¹ map"></a>ä¿®æ”¹ map</h4><p>åœ¨ map m ä¸­æ’å…¥æˆ–ä¿®æ”¹ä¸€ä¸ªå…ƒç´ ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">m[<span class="string">"name"</span>] = <span class="string">"Golang"</span></span><br></pre></td></tr></table></figure><p>è·å¾—å…ƒç´ ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name := m[<span class="string">"name"</span>]</span><br></pre></td></tr></table></figure><p>åˆ é™¤å…ƒç´ ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">delete</span>(m, <span class="string">"name"</span>)</span><br></pre></td></tr></table></figure><p>é€šè¿‡åŒèµ‹å€¼æ£€æµ‹æŸä¸ªé”®å­˜åœ¨ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name, ok = m[<span class="string">"name"</span>]</span><br></pre></td></tr></table></figure><p>å¦‚æœ name åœ¨ m ä¸­ï¼Œ ok ä¸º trueã€‚å¦åˆ™ï¼Œ ok ä¸º falseï¼Œå¹¶ä¸” name æ˜¯ map çš„å…ƒç´ ç±»å‹çš„é›¶å€¼ã€‚</p><p>åŒæ ·çš„ï¼Œå½“ä» map ä¸­è¯»å–æŸä¸ªä¸å­˜åœ¨çš„é”®æ—¶ï¼Œç»“æœæ˜¯ map çš„å…ƒç´ ç±»å‹çš„é›¶å€¼ã€‚</p><h3 id="å‡½æ•°å€¼"><a href="#å‡½æ•°å€¼" class="headerlink" title="å‡½æ•°å€¼"></a>å‡½æ•°å€¼</h3><p>å‡½æ•°ä¹Ÿæ˜¯å€¼ã€‚ä»–ä»¬å¯ä»¥åƒå…¶ä»–å€¼ä¸€æ ·ä¼ é€’ï¼Œæ¯”å¦‚ï¼Œå‡½æ•°å€¼å¯ä»¥ä½œä¸ºå‡½æ•°çš„å‚æ•°æˆ–è€…è¿”å›å€¼ã€‚</p><h3 id="å‡½æ•°çš„é—­åŒ…"><a href="#å‡½æ•°çš„é—­åŒ…" class="headerlink" title="å‡½æ•°çš„é—­åŒ…"></a>å‡½æ•°çš„é—­åŒ…</h3><p>Go å‡½æ•°å¯ä»¥æ˜¯ä¸€ä¸ªé—­åŒ…ã€‚é—­åŒ…æ˜¯ä¸€ä¸ªå‡½æ•°å€¼ï¼Œå®ƒå¼•ç”¨äº†å‡½æ•°ä½“ä¹‹å¤–çš„å˜é‡ã€‚ è¿™ä¸ªå‡½æ•°å¯ä»¥å¯¹è¿™ä¸ªå¼•ç”¨çš„å˜é‡è¿›è¡Œè®¿é—®å’Œèµ‹å€¼ï¼›æ¢å¥è¯è¯´è¿™ä¸ªå‡½æ•°è¢«â€œç»‘å®šâ€åœ¨è¿™ä¸ªå˜é‡ä¸Šã€‚</p><p>ä¾‹å¦‚ï¼Œå‡½æ•° adder è¿”å›ä¸€ä¸ªé—­åŒ…ã€‚æ¯ä¸ªè¿”å›çš„é—­åŒ…éƒ½è¢«ç»‘å®šåˆ°å…¶å„è‡ªçš„ sum å˜é‡ä¸Šã€‚</p><p>ç»ƒä¹ ï¼šæ–æ³¢çº³å¥‘é—­åŒ…</p><p>ç°åœ¨æ¥é€šè¿‡å‡½æ•°åšäº›æœ‰è¶£çš„äº‹æƒ…ã€‚</p><p>å®ç°ä¸€ä¸ª fibonacci å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼ˆä¸€ä¸ªé—­åŒ…ï¼‰å¯ä»¥è¿”å›è¿ç»­çš„æ–æ³¢çº³å¥‘æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// fibonacci å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªè¿”å› int çš„å‡½æ•°ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">()</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    first := <span class="number">0</span></span><br><span class="line">    second := <span class="number">0</span></span><br><span class="line">    index :=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span>&#123;</span><br><span class="line">        sum := first + second</span><br><span class="line">        <span class="keyword">switch</span> index &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        first = <span class="number">0</span></span><br><span class="line">        second = <span class="number">1</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        first = <span class="number">0</span></span><br><span class="line">        second = <span class="number">1</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        first = second</span><br><span class="line">        second = sum</span><br><span class="line">        &#125;</span><br><span class="line">        index++</span><br><span class="line">        <span class="keyword">return</span> sum</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    f := fibonacci()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"[%v]=&gt;%v\n"</span>,i,f())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h3><p>Go æ²¡æœ‰ç±»ã€‚ç„¶è€Œï¼Œä»ç„¶å¯ä»¥åœ¨ç»“æ„ä½“ç±»å‹ä¸Šå®šä¹‰æ–¹æ³•ã€‚</p><p>æ–¹æ³•æ¥æ”¶è€… å‡ºç°åœ¨ func å…³é”®å­—å’Œæ–¹æ³•åä¹‹é—´çš„å‚æ•°ä¸­ã€‚æ ¼å¼ä¸ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(å˜é‡ ç±»å‹)</span> <span class="title">funcName</span><span class="params">(param1 type1,param2 type2)</span><span class="params">(return_param, return_type)</span></span> &#123;</span><br><span class="line"><span class="comment">//xxx</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥å¯¹åŒ…ä¸­çš„ <strong>ä»»æ„</strong> ç±»å‹å®šä¹‰ä»»æ„æ–¹æ³•ï¼Œè€Œä¸ä»…ä»…æ˜¯é’ˆå¯¹ç»“æ„ä½“ã€‚</p><p>ä½†æ˜¯ï¼Œä¸èƒ½å¯¹æ¥è‡ªå…¶ä»–åŒ…çš„ç±»å‹æˆ–åŸºç¡€ç±»å‹å®šä¹‰æ–¹æ³•ã€‚</p><h4 id="æ¥æ”¶è€…ä¸ºæŒ‡é’ˆçš„æ–¹æ³•"><a href="#æ¥æ”¶è€…ä¸ºæŒ‡é’ˆçš„æ–¹æ³•" class="headerlink" title="æ¥æ”¶è€…ä¸ºæŒ‡é’ˆçš„æ–¹æ³•"></a>æ¥æ”¶è€…ä¸ºæŒ‡é’ˆçš„æ–¹æ³•</h4><p>æ–¹æ³•å¯ä»¥ä¸å‘½åç±»å‹æˆ–å‘½åç±»å‹çš„æŒ‡é’ˆå…³è”ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</span><br><span class="line">X, Y <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">Scale</span><span class="params">(f <span class="keyword">float64</span>)</span></span> &#123;</span><br><span class="line">v.X = v.X * f</span><br><span class="line">v.Y = v.Y * f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> math.Sqrt(v.Xv.X + v.Yv.Y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">v := &amp;Vertex&#123;<span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line">fmt.Printf(<span class="string">"Before scaling: %+v, Abs: %v\n"</span>, v, v.Abs())</span><br><span class="line">v.Scale(<span class="number">5</span>)</span><br><span class="line">fmt.Printf(<span class="string">"After scaling: %+v, Abs: %v\n"</span>, v, v.Abs())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆšåˆšçœ‹åˆ°çš„ä¸¤ä¸ª Abs æ–¹æ³•ã€‚ä¸€ä¸ªæ˜¯åœ¨ *Vertex æŒ‡é’ˆç±»å‹ä¸Šï¼Œè€Œå¦ä¸€ä¸ªåœ¨ MyFloat å€¼ç±»å‹ä¸Šã€‚ æœ‰ä¸¤ä¸ªåŸå› éœ€è¦ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…ã€‚é¦–å…ˆé¿å…åœ¨æ¯ä¸ªæ–¹æ³•è°ƒç”¨ä¸­æ‹·è´å€¼ï¼ˆå¦‚æœå€¼ç±»å‹æ˜¯å¤§çš„ç»“æ„ä½“çš„è¯ä¼šæ›´æœ‰æ•ˆç‡ï¼‰ã€‚å…¶æ¬¡ï¼Œæ–¹æ³•å¯ä»¥ä¿®æ”¹æ¥æ”¶è€…æŒ‡å‘çš„å€¼ã€‚</p><p>å°è¯•ä¿®æ”¹ Abs çš„å®šä¹‰ï¼ŒåŒæ—¶ Scale æ–¹æ³•ä½¿ç”¨ Vertex ä»£æ›¿ *Vertex ä½œä¸ºæ¥æ”¶è€…ã€‚</p><p>å½“ v æ˜¯ Vertex çš„æ—¶å€™ Scale æ–¹æ³•æ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚Scale ä¿®æ”¹ vã€‚å½“ v æ˜¯ä¸€ä¸ªå€¼ï¼ˆéæŒ‡é’ˆï¼‰ï¼Œæ–¹æ³•çœ‹åˆ°çš„æ˜¯ Vertex çš„å‰¯æœ¬ï¼Œå¹¶ä¸”æ— æ³•ä¿®æ”¹åŸå§‹å€¼ã€‚</p><p>Abs çš„å·¥ä½œæ–¹å¼æ˜¯ä¸€æ ·çš„ã€‚åªä¸è¿‡ï¼Œä»…ä»…è¯»å– vã€‚æ‰€ä»¥è¯»å–çš„æ˜¯åŸå§‹å€¼ï¼ˆé€šè¿‡æŒ‡é’ˆï¼‰è¿˜æ˜¯é‚£ä¸ªå€¼çš„å‰¯æœ¬å¹¶æ²¡æœ‰å…³ç³»ã€‚</p><h3 id="æ¥å£"><a href="#æ¥å£" class="headerlink" title="æ¥å£"></a>æ¥å£</h3><p>æ¥å£ç±»å‹æ˜¯ç”±ä¸€ç»„æ–¹æ³•å®šä¹‰çš„é›†åˆã€‚</p><p>æ¥å£ç±»å‹çš„å€¼å¯ä»¥å­˜æ”¾å®ç°è¿™äº›æ–¹æ³•çš„ä»»ä½•å€¼</p><h4 id="æ¥å£å®šä¹‰"><a href="#æ¥å£å®šä¹‰" class="headerlink" title="æ¥å£å®šä¹‰"></a>æ¥å£å®šä¹‰</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Abser <span class="keyword">interface</span> &#123;</span><br><span class="line">Abs() <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ¥å£å®ç°"><a href="#æ¥å£å®ç°" class="headerlink" title="æ¥å£å®ç°"></a>æ¥å£å®ç°</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyFloat <span class="keyword">float64</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f MyFloat)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> f &lt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">float64</span>(-f)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">float64</span>(f)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="éšå¼æ¥å£"><a href="#éšå¼æ¥å£" class="headerlink" title="éšå¼æ¥å£"></a>éšå¼æ¥å£</h4><p>ç±»å‹é€šè¿‡å®ç°æ¥å£ä¸­çš„æ–¹æ³•æ¥å®ç°æ¥å£ã€‚ æ²¡æœ‰æ˜¾å¼å£°æ˜çš„å¿…è¦ï¼›æ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰å…³é”®å­—â€œimplementâ€œã€‚</p><p>éšå¼æ¥å£è§£è—•äº†å®ç°æ¥å£çš„åŒ…å’Œå®šä¹‰æ¥å£çš„åŒ…ï¼šäº’ä¸ä¾èµ–ã€‚</p><p>å› æ­¤ï¼Œä¹Ÿå°±æ— éœ€åœ¨æ¯ä¸€ä¸ªå®ç°ä¸Šå¢åŠ æ–°çš„æ¥å£åç§°ï¼Œè¿™æ ·åŒæ—¶ä¹Ÿé¼“åŠ±äº†æ˜ç¡®çš„æ¥å£å®šä¹‰ã€‚</p><h4 id="Stringers"><a href="#Stringers" class="headerlink" title="Stringers"></a>Stringers</h4><p>ä¸€ä¸ªæ™®éå­˜åœ¨çš„æ¥å£æ˜¯ <a href="https://go-zh.org/pkg/fmt/" target="_blank" rel="noopener">fmt</a> åŒ…ä¸­å®šä¹‰çš„ <a href="https://go-zh.org/pkg/fmt/#Stringer" target="_blank" rel="noopener">Stringer</a>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Stringer <span class="keyword">interface</span> &#123;</span><br><span class="line">     String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Stringer æ˜¯ä¸€ä¸ªå¯ä»¥ç”¨å­—ç¬¦ä¸²æè¿°è‡ªå·±çš„ç±»å‹ã€‚<code>fmt</code>åŒ… ï¼ˆè¿˜æœ‰è®¸å¤šå…¶ä»–åŒ…ï¼‰ä½¿ç”¨è¿™ä¸ªæ¥è¿›è¡Œè¾“å‡ºã€‚</p><h3 id="é”™è¯¯"><a href="#é”™è¯¯" class="headerlink" title="é”™è¯¯"></a>é”™è¯¯</h3><p>Go ç¨‹åºä½¿ç”¨ error å€¼æ¥è¡¨ç¤ºé”™è¯¯çŠ¶æ€ã€‚</p><p>ä¸ fmt.Stringer ç±»ä¼¼ï¼Œ error ç±»å‹æ˜¯ä¸€ä¸ªå†…å»ºæ¥å£ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</span><br><span class="line">     Error() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆä¸ fmt.Stringer ç±»ä¼¼ï¼Œfmt åŒ…åœ¨è¾“å‡ºæ—¶ä¹Ÿä¼šè¯•å›¾åŒ¹é… errorã€‚ï¼‰</p><p>é€šå¸¸å‡½æ•°ä¼šè¿”å›ä¸€ä¸ª error å€¼ï¼Œè°ƒç”¨çš„å®ƒçš„ä»£ç åº”å½“åˆ¤æ–­è¿™ä¸ªé”™è¯¯æ˜¯å¦ç­‰äº nilï¼Œ æ¥è¿›è¡Œé”™è¯¯å¤„ç†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">i, err := strconv.Atoi(<span class="string">"42"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"couldn't convert number: %v\n"</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"Converted integer:"</span>, i)</span><br></pre></td></tr></table></figure><p>error ä¸º nil æ—¶è¡¨ç¤ºæˆåŠŸï¼›é nil çš„ error è¡¨ç¤ºé”™è¯¯ã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ErrNegativeSqrt <span class="keyword">float64</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e ErrNegativeSqrt)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> e &lt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"cannot Sqrt negative number:%v"</span>,<span class="keyword">float64</span>(e))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sqrt</span><span class="params">(x <span class="keyword">float64</span>)</span> <span class="params">(<span class="keyword">float64</span>, error)</span></span> &#123;</span><br><span class="line">    i := ErrNegativeSqrt(x)</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>, i</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> math.Sqrt(x),<span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(Sqrt(<span class="number">2</span>))</span><br><span class="line">fmt.Println(Sqrt(<span class="number">-2</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Readers"><a href="#Readers" class="headerlink" title="Readers"></a>Readers</h3><p>io åŒ…æŒ‡å®šäº† io.Reader æ¥å£ï¼Œ å®ƒè¡¨ç¤ºä»æ•°æ®æµç»“å°¾è¯»å–ã€‚</p><p>Go æ ‡å‡†åº“åŒ…å«äº†è¿™ä¸ªæ¥å£çš„<a href="https://go-zh.org/search?q=Read#Global" target="_blank" rel="noopener">è®¸å¤šå®ç°</a>ï¼Œ åŒ…æ‹¬æ–‡ä»¶ã€ç½‘ç»œè¿æ¥ã€å‹ç¼©ã€åŠ å¯†ç­‰ç­‰ã€‚</p><p>io.Reader æ¥å£æœ‰ä¸€ä¸ª Read æ–¹æ³•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(T)</span> <span class="title">Read</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span></span><br></pre></td></tr></table></figure><p>Read ç”¨æ•°æ®å¡«å……æŒ‡å®šçš„å­—èŠ‚ sliceï¼Œå¹¶ä¸”è¿”å›å¡«å……çš„å­—èŠ‚æ•°å’Œé”™è¯¯ä¿¡æ¯ã€‚ åœ¨é‡åˆ°æ•°æ®æµç»“å°¾æ—¶ï¼Œè¿”å› io.EOF é”™è¯¯ã€‚</p><p>ä¾‹å­ä»£ç åˆ›å»ºäº†ä¸€ä¸ª <a href="https://go-zh.org/pkg/strings/#Reader" target="_blank" rel="noopener">strings.Reader</a>ã€‚ å¹¶ä¸”ä»¥æ¯æ¬¡ 8 å­—èŠ‚çš„é€Ÿåº¦è¯»å–å®ƒçš„è¾“å‡ºã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"io"</span></span><br><span class="line"><span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r := strings.NewReader(<span class="string">"Hello, Reader!"</span>)</span><br><span class="line">    b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        n, err := r.Read(b)</span><br><span class="line">        fmt.Printf(<span class="string">"n = %v err = %v b = %v\n"</span>, n, err, b)</span><br><span class="line">        fmt.Printf(<span class="string">"b[:n] = %q\n"</span>, b[:n])</span><br><span class="line">        <span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡åŸºäºGOå®˜ç½‘ä¸Šçš„ä¾‹å­å†™å°±ï¼Œä¸»è¦å¸®åŠ©è‡ªå·±åœ¨å­¦ä¹ goè¯­è¨€çš„è¿‡ç¨‹ä¸­è®°å¿†ï¼Œæ›´å¤šçš„æ˜¯è‡ªå·±å¯¹å…¶ä¸­ä¸€äº›æ¦‚å¿µçš„ç†è§£ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="golang/grammar/01" scheme="http://xwxz.github.io/categories/golang-grammar-01/"/>
    
    
      <category term="Golang" scheme="http://xwxz.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>LNMPç¯å¢ƒè§£è¯´ ã€åŸåˆ›ã€‘</title>
    <link href="http://xwxz.github.io/LNMP-env-01/lnmp-envrionment/"/>
    <id>http://xwxz.github.io/LNMP-env-01/lnmp-envrionment/</id>
    <published>2017-11-07T04:30:33.000Z</published>
    <updated>2019-09-12T04:03:47.411Z</updated>
    
    <content type="html"><![CDATA[<p>â€‹    ä½œä¸ºä¸€ä¸ªPHPerï¼Œæ²¡æœ‰æ‰‹åŠ¨æ­è¿‡å‡ æ¬¡LNMPç¯å¢ƒï¼Œéƒ½ä¸ç®—æ˜¯ä¸€ä¸ªçœŸæ­£çš„PHPerã€‚æ­¤æ–‡ä¸»è¦ä»¥å®é™…ç€æ‰‹æ­å»ºä¸€å¥—lnmpç¯å¢ƒä¸ºä¸»çº¿ï¼Œä»‹ç»å…¶ä¸­æ¶‰åŠåˆ°çš„æŠ€æœ¯ç‚¹ã€‚åŒ…æ‹¬phpé…ç½®ã€php-fpmé…ç½®ã€nginxé…ç½®ã€mysqlé…ç½®ã€‚ä»¥åŠè¿™ä»–ä»¬ä¹‹é—´çš„å…³ç³»ã€‚</p><a id="more"></a><h2 id="2-å‡†å¤‡å·¥ä½œ"><a href="#2-å‡†å¤‡å·¥ä½œ" class="headerlink" title="2 å‡†å¤‡å·¥ä½œ"></a>2 å‡†å¤‡å·¥ä½œ</h2><h3 id="2-1-è½¯ä»¶ä¸‹è½½"><a href="#2-1-è½¯ä»¶ä¸‹è½½" class="headerlink" title="2.1 è½¯ä»¶ä¸‹è½½"></a>2.1 è½¯ä»¶ä¸‹è½½</h3><ol><li>Linux: CentOS6.5</li><li>Nginx: 1.13.4ï¼Œä¸‹è½½åœ°å€ï¼š<a href="http://nginx.org/download/nginx-1.13.4.tar.gz" target="_blank" rel="noopener">http://nginx.org/download/nginx-1.13.4.tar.gz</a></li><li>Mysql: 5.6.37ï¼Œä¸‹è½½åœ°å€ï¼š<a href="https://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-5.6.37.tar.gz" target="_blank" rel="noopener">https://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-5.6.37.tar.gz</a></li><li>PHP: 5.5.38ï¼Œä¸‹è½½åœ°å€ï¼š<a href="http://cn2.php.net/distributions/php-5.5.38.tar.gz" target="_blank" rel="noopener">http://cn2.php.net/distributions/php-5.5.38.tar.gz</a></li></ol><p>åœ¨/usr/localç›®å½•ä¸‹åˆ›å»ºæˆ‘ä»¬çš„LNMPå®‰è£…ç›®å½•ï¼Œæˆ‘ä»¬è¿™é‡Œå®šä¹‰ä¸ºlnmpã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/<span class="built_in">local</span>/lnmp/src</span><br><span class="line">wget -P /usr/<span class="built_in">local</span>/lnmp/src http://nginx.org/download/nginx-1.13.4.tar.gz</span><br><span class="line">wget -P /usr/<span class="built_in">local</span>/lnmp/src https://github.com/mysql/mysql-server/archive/mysql-5.6.37.tar.gz</span><br><span class="line">wget -P /usr/<span class="built_in">local</span>/lnmp/src http://cn2.php.net/distributions/php-5.5.38.tar.gz</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿çŸ¥é“æˆ‘ä»¬å®‰è£…çš„è½¯ä»¶ç‰ˆæœ¬ï¼Œæ•…ç›®å½•å‘½åå‡é‡‡ç”¨è½¯ä»¶å-ä¸‰ä½ç‰ˆæœ¬å·çš„å½¢å¼ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/<span class="built_in">local</span>/lnmp/php-5.5.38</span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/lnmp/mysql-5.6.37</span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/lnmp/nginx-1.10.3</span><br></pre></td></tr></table></figure><h3 id="2-2-å·¥å…·å®‰è£…"><a href="#2-2-å·¥å…·å®‰è£…" class="headerlink" title="2.2 å·¥å…·å®‰è£…"></a>2.2 å·¥å…·å®‰è£…</h3><pre><code>æœ¬å®éªŒæ‰€æœ‰çš„å®‰è£…éƒ½æ˜¯æ ¹æ®æºç è¿›è¡Œç¼–è¯‘å®‰è£…ï¼Œç¼–è¯‘æ­¤ä¸‰è½¯ä»¶ï¼Œéœ€è¦ä½¿ç”¨åˆ°çš„å·¥å…·æœ‰:</code></pre><p><strong>cmake</strong></p><pre><code>cmakeæ˜¯ä¸€æ¬¾å¼€æºè·¨å¹³å°çš„ç¼–è¯‘å·¥å…·ï¼Œå…¶åŒ…å«ç¼–è¯‘æ„å»ºã€æµ‹è¯•æ‰“åŒ…ç­‰ä¸€ä½“çš„å·¥å…·åŒ…ã€‚å…¶[å®˜ç½‘](https://cmake.org/)ã€‚mysqlå®˜æ–¹æ–‡æ¡£è®°è½½è¯´mysql 5.6ç‰ˆæœ¬æºç ç¼–è¯‘å®‰è£…éœ€è¦ä½¿ç”¨cmakeã€‚å…¶ä¸‹è½½åœ°å€ï¼š[https://cmake.org/files/v3.9/cmake-3.9.1.tar.gz](https://cmake.org/files/v3.9/cmake-3.9.1.tar.gz) ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å»githubï¼š[https://github.com/Kitware/CMake/archive/v3.9.1.tar.gz](https://github.com/Kitware/CMake/archive/v3.9.1.tar.gz) ï¼Œè¿™é‡Œä¹Ÿæé†’å¤§å®¶ï¼Œæ‰€æœ‰å¼€æºè½¯ä»¶åŸºæœ¬éƒ½å¯ä»¥åœ¨githubä¸Šæ‰¾åˆ°ï¼Œå¼€æºçš„ä¸–ç•Œå°±æ˜¯è¿™ä¹ˆå¥½ã€‚æ„Ÿæ©ï¼</code></pre><p><strong>GCC(version &gt;= 4.2.1)</strong></p><pre><code>ä½œä¸ºRDåº”è¯¥éƒ½å¬è¯´è¿‡GCCï¼ˆthe GNU Compiler Collectionï¼‰ï¼Œå³GNUç¼–è¯‘å¥—ä»¶é›†åˆï¼Œæ˜¯ç”± GNU å¼€å‘çš„ç¼–ç¨‹è¯­è¨€ç¼–è¯‘å™¨ã€‚å®ƒæ˜¯ä»¥[GPL](https://baike.baidu.com/item/GPL)è®¸å¯è¯æ‰€å‘è¡Œçš„è‡ªç”±è½¯ä»¶ã€‚å…¶åŒ…æ‹¬Cã€C++ã€Objective-Cã€Fortranã€Javaã€Adaå’ŒGoè¯­è¨€çš„å‰ç«¯ï¼Œä¹ŸåŒ…æ‹¬äº†è¿™äº›è¯­è¨€çš„åº“ï¼ˆå¦‚libstdc++ã€libgcjç­‰ç­‰ï¼‰ã€‚GCCçš„åˆè¡·æ˜¯ä¸ºGNUæ“ä½œç³»ç»Ÿä¸“é—¨ç¼–å†™çš„ä¸€æ¬¾ç¼–è¯‘å™¨ã€‚GNUç³»ç»Ÿæ˜¯å½»åº•çš„è‡ªç”±è½¯ä»¶ã€‚æ­¤å¤„ï¼Œâ€œè‡ªç”±â€çš„å«ä¹‰æ˜¯å®ƒå°Šé‡ç”¨æˆ·çš„è‡ªç”±ã€‚è¿™é‡Œä¸å±•å¼€è®²è§£ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»æŸ¥é˜…ç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œç»™å‡º[å®˜ç½‘](http://gcc.gnu.org/)</code></pre><p><strong>make(version &gt;= 3.75)</strong></p><pre><code>åˆå«GNU Makeï¼Œæ­¤è½¯ä»¶æ˜¯GNUç³»åˆ—çš„ç¼–è¯‘è½¯ä»¶ï¼Œå…¶[å®˜ç½‘](http://www.gnu.org/software/make/)ï¼Œå…¶[ä½¿ç”¨æ‰‹å†Œ](http://www.gnu.org/software/make/manual/make.html)ï¼Œæ—¢ç„¶åœ¨linuxä¸‹ç¼–è¯‘è½¯ä»¶ï¼Œæ­¤è½¯ä»¶å‡ ä¹æ˜¯å°‘ä¸äº†çš„ã€‚</code></pre><p><strong>autoconf:</strong></p><pre><code>åˆä¸€æ¬¾GNUä¸‹çš„è½¯ä»¶ï¼ŒAutoconfæ˜¯ä¸€ä¸ªç”¨äºåŒ…ï¼Œä»¥é€‚åº”å¤šç§[Unix](https://baike.baidu.com/item/Unix/219943)ç±»ç³»ç»Ÿçš„ [shellè„šæœ¬](https://baike.baidu.com/item/shell%E8%84%9A%E6%9C%AC/572265)çš„å·¥å…·ï¼Œå…¶[å®˜ç½‘](http://www.gnu.org/software/autoconf/autoconf.html)ï¼Œ[ä½¿ç”¨æ‰‹å†Œ](http://www.gnu.org/software/autoconf/manual/autoconf.html)ï¼Œæ­¤è½¯ä»¶å’ŒmakeåŸºæœ¬ç»“å¯¹å‡ºç°ã€‚    </code></pre><p><strong>bison(version &gt;= 2.1)</strong></p><pre><code>GNU bison æ˜¯å±äº [GNU](https://baike.baidu.com/item/GNU) é¡¹ç›®çš„ä¸€ä¸ª[è¯­æ³•åˆ†æå™¨](https://baike.baidu.com/item/%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%E5%99%A8)ç”Ÿæˆå™¨ã€‚Bison æŠŠä¸€ä¸ªå…³äºâ€œå‘å‰æŸ¥çœ‹ ä»å·¦åˆ°å³ æœ€å³â€(LALR) ä¸Šä¸‹æ–‡æ— å…³æ–‡æ³•çš„æè¿°è½¬åŒ–æˆå¯ä»¥åˆ†æè¯¥æ–‡æ³•çš„ C æˆ– [C++](https://baike.baidu.com/item/C%2B%2B) ç¨‹åºã€‚å®ƒä¹Ÿå¯ä»¥ä¸ºäºŒä¹‰æ–‡æ³•ç”Ÿæˆ â€œé€šç”¨çš„ ä»å·¦åˆ°å³ æœ€å³â€ (GLR)è¯­æ³•åˆ†æå™¨ã€‚å…¶[å®˜ç½‘](http://www.gnu.org/software/bison/)ï¼Œ[ä½¿ç”¨æ‰‹å†Œ](http://www.gnu.org/software/bison/manual/)</code></pre><blockquote><p>mysqlæºç ç¼–è¯‘å®‰è£…ä¾èµ– <a href="https://dev.mysql.com/doc/refman/5.6/en/source-installation.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/source-installation.html</a></p></blockquote><h2 id="3-Nginxå®‰è£…"><a href="#3-Nginxå®‰è£…" class="headerlink" title="3 Nginxå®‰è£…"></a>3 Nginxå®‰è£…</h2><h3 id="3-1-ç¼–è¯‘å®‰è£…"><a href="#3-1-ç¼–è¯‘å®‰è£…" class="headerlink" title="3.1 ç¼–è¯‘å®‰è£…"></a>3.1 ç¼–è¯‘å®‰è£…</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è§£å‹æºç æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/lnmp/src</span><br><span class="line">tar -zxf nginx-1.13.4.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-1.13.4</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œconfigureï¼ŒæŒ‡å®šå®‰è£…ç›®å½•ä¸º /usr/local/lnmp/nginx-1.13.4</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/lnmp/nginx-1.13.4</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿›å…¥nginxå®‰è£…ç›®å½•ï¼Œæ£€æµ‹æ˜¯å¦å®‰è£…æˆåŠŸ</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/lnmp/nginx-1.13.4</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼Œè‹¥å‡ºç°é”™è¯¯ï¼Œè·Ÿè¿›é”™è¯¯è¿›è¡Œä¿®æ­£</span></span><br><span class="line">nginx -t</span><br></pre></td></tr></table></figure><h3 id="3-2-è½¯ä»¶é…ç½®"><a href="#3-2-è½¯ä»¶é…ç½®" class="headerlink" title="3.2 è½¯ä»¶é…ç½®"></a>3.2 è½¯ä»¶é…ç½®</h3><p>ä¸ºäº†èƒ½å¤Ÿè®©æˆ‘ä»¬çš„è½¯ä»¶è¿è¡Œèµ·æ¥ï¼Œæˆ‘ä»¬æœ€å¼€å§‹åªåšæœ€ç®€å•çš„é…ç½®ã€‚</p><h4 id="3-2-1-nginx-conf"><a href="#3-2-1-nginx-conf" class="headerlink" title="3.2.1 nginx.conf"></a>3.2.1 nginx.conf</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="attribute">pid</span> logs/nginx.pid;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"><span class="comment">#æ—¥å¿—æ ¼å¼</span></span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">    <span class="attribute">include</span> vhost/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-2-vhost"><a href="#3-2-2-vhost" class="headerlink" title="3.2.2 vhost"></a>3.2.2 vhost</h4><p>å› ä¸ºè½¯ä»¶å¯èƒ½è¿è¡Œä¸æ­¢ä¸€ä¸ªç½‘ç«™ï¼Œæ•…æˆ‘ä»¬åœ¨nginxçš„confç›®å½•ä¸‹åˆ›å»ºvhostç›®å½•ï¼Œç”¨äºå­˜æ”¾è™šæ‹Ÿä¸»æœºã€‚åŒæ—¶ä¸ºäº†æŠŠä¸šåŠ¡é¡¹ç›®ä¸è¿è¡Œç¯å¢ƒåˆ†å¼€ï¼Œè¿™é‡Œæˆ‘ä»¬å°†ä»£ç ç›®å½•å»ºåœ¨/data0/www/htdocs/lnmp.comç›®å½•ä¸‹ï¼Œæˆ‘ä»¬çš„ç½‘ç«™å°±å«lnmp.comå§ã€‚</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">9091</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    <span class="attribute">access_log</span>  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span>   /data0/www/htdocs/lnmp.com;</span><br><span class="line">        <span class="attribute">index</span>  index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line">    <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="attribute">root</span>           /data0/www/htdocs/lnmp.com;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span>   <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">        <span class="attribute">fastcgi_index</span>  index.php;</span><br><span class="line">        <span class="attribute">fastcgi_param</span>  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="attribute">include</span>        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-æµ‹è¯•"><a href="#3-3-æµ‹è¯•" class="headerlink" title="3.3 æµ‹è¯•"></a>3.3 æµ‹è¯•</h3><p>æ£€æµ‹å®‰è£…æ˜¯å¦æˆåŠŸï¼Œè¿›å…¥ /usr/local/lnmp/nginx-1.13.4/sbinç›®å½•ï¼Œæ‰§è¡Œ <code>./nginx -t</code>å‘½ä»¤ï¼Œè‹¥è¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼Œåˆ™è¡¨ç¤ºå®‰è£…æˆåŠŸã€‚</p><blockquote><p>nginx: the configuration file /usr/local/lnmp/nginx-1.13.4/conf/nginx.conf syntax is ok<br>nginx: configuration file /usr/local/lnmp/nginx-1.13.4/conf/nginx.conf test is successful</p></blockquote><p>å¦åˆ™ï¼Œè·Ÿè¿›æç¤ºè¿›è¡Œä¿®æ­£ï¼Œå¦‚æˆ‘ä¿®æ”¹å®Œé…ç½®æ–‡ä»¶æ‰§è¡Œæ—¶ï¼ŒæŠ¥é”™å¦‚ä¸‹</p><blockquote><p>nginx: [emerg] unexpected â€œ}â€ in /usr/local/lnmp/nginx-1.13.4/conf/nginx.conf:72<br>nginx: configuration file /usr/local/lnmp/nginx-1.13.4/conf/nginx.conf test failed</p></blockquote><p>æç¤ºå¾ˆæ˜æ˜¾ï¼Œå› ä¸ºnginx.confæ–‡ä»¶72è¡Œé‡åˆ°äº†ä¸æ¥å—çš„â€}â€ç¬¦å·ï¼Œæ‰“å¼€æ–‡ä»¶å‘ç°å…¶å®åœ¨include vhost/*.confåå¿˜è®°æ·»åŠ åˆ†å·ï¼Œæ·»åŠ ä¸Šåˆ†å·ï¼Œå†æ¬¡æ‰§è¡Œï¼Œæç¤ºæˆåŠŸã€‚</p><h3 id="3-3-ä½¿ç”¨è§£è¯»"><a href="#3-3-ä½¿ç”¨è§£è¯»" class="headerlink" title="3.3 ä½¿ç”¨è§£è¯»"></a>3.3 ä½¿ç”¨è§£è¯»</h3><p>nginxå®‰è£…å®Œæ¯•åï¼Œç›®å½•å¦‚ä¸‹:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ client_body_temp</span><br><span class="line">â”œâ”€â”€ conf //æ­¤ç›®å½•ä¸ºå­˜æ”¾é…ç½®æ–‡ä»¶ç›®å½•</span><br><span class="line">â”‚Â Â  â””â”€â”€ vhost</span><br><span class="line">â”œâ”€â”€ fastcgi_temp</span><br><span class="line">â”œâ”€â”€ html //å­˜æ”¾ç½‘ç«™ä»£ç çš„ç›®å½•ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šæœ‰è‡ªå·±çš„ç½‘ç«™ç›®å½•ï¼Œè¿™é‡Œå¯ä»¥å­˜æ”¾ä¸€äº›ç»Ÿä¸€çš„4xxã€5xxé¡µé¢ã€‚</span><br><span class="line">â”œâ”€â”€ logs //é»˜è®¤å­˜æ”¾nginxè¿è¡Œæ—¥å¿—çš„åœ°æ–¹</span><br><span class="line">â”œâ”€â”€ proxy_temp</span><br><span class="line">â”œâ”€â”€ sbin //æ­¤ç›®å½•æ˜¯å­˜æ”¾æ‰§è¡Œå‘½ä»¤çš„ç›®å½•</span><br><span class="line">â”œâ”€â”€ scgi_temp</span><br><span class="line">â””â”€â”€ uwsgi_temp</span><br></pre></td></tr></table></figure><h4 id="3-3-1-sbin"><a href="#3-3-1-sbin" class="headerlink" title="3.3.1 sbin"></a>3.3.1 sbin</h4><p>è¿™é‡Œæˆ‘ä»¬å…ˆè¯´sbinç›®å½•ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªæ–‡ä»¶nginxå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶ç”¨äºç®¡ç†nginxçš„å¯åŠ¨ã€åœæ­¢ã€é‡å¯ã€‚</p><p>nginxå‘½ä»¤æ”¯æŒä»¥ä¸‹å‚æ•°ï¼š </p><blockquote><p><strong>-v ï¼š</strong>æ˜¾ç¤ºç‰ˆæœ¬å·å¹¶é€€å‡º</p><p><strong>-Vï¼š</strong>æ˜¾ç¤ºç‰ˆæœ¬å·ï¼ŒåŒæ—¶æ˜¾ç¤ºç¼–è¯‘æ—¶é€‰é¡¹å¹¶é€€å‡º</p><p><strong>-tï¼š</strong>æµ‹è¯•é…ç½®æ–‡ä»¶ï¼Œå¹¶é€€å‡º</p><p><strong>-Tï¼š</strong>æµ‹è¯•é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†å…¶è¾“å‡ºï¼Œç„¶åé€€å‡º</p><p><strong>-s signalï¼š</strong>å‘é€ä¿¡å·ç»™nginx masterï¼Œç”¨äºå¹³æ»‘åœæ­¢ï¼Œé€€å‡ºï¼Œå¹³æ»‘é‡å¯ï¼Œé‡å¯ã€‚signalåŒ…æ‹¬ï¼ˆstop|quit|reload|reopenï¼‰</p><p><strong>-cï¼š</strong>æŒ‡å®šnginxçš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä¸ºconf/nginx.conf</p><p><strong>-gï¼š</strong>è®¾ç½®é…ç½®æ–‡ä»¶ä¹‹å¤–çš„å…¨å±€æŒ‡ä»¤ï¼Œç”¨çš„æ¯”è¾ƒå°‘</p></blockquote><p><strong>nginxå¯åŠ¨</strong></p><p>ä½¿ç”¨é»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/lnmp/nginx-1.13.4/sbin/nginx</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/lnmp/nginx-1.13.4/sbin/nginx -c /path/é…ç½®æ–‡ä»¶</span><br></pre></td></tr></table></figure><p><strong>nginxåœæ­¢</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/lnmp/nginx-1.13.4/sbin/nginx -s stop</span><br></pre></td></tr></table></figure><p>å¯¹äºnginxçš„å…³é—­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨killå‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -QUIT ä¸»è¿›ç¨‹pid æˆ– <span class="built_in">kill</span> -QUIT `cat /path/pid` ä»å®¹å…³é—­</span><br><span class="line"><span class="built_in">kill</span> -TERM ä¸»è¿›ç¨‹pid æˆ– <span class="built_in">kill</span> -TERM `cat /path/pid` å¿«é€Ÿå…³é—­</span><br><span class="line"><span class="built_in">kill</span> -INT ä¸»è¿›ç¨‹pid æˆ– <span class="built_in">kill</span> -INT `cat /path/pid`   å¿«é€Ÿå…³é—­</span><br><span class="line">pKill -9 ä¸»è¿›ç¨‹pid æˆ– pkill -9 `cat /path/pid`     å¼ºåˆ¶å…³é—­</span><br></pre></td></tr></table></figure><p>ä½†æˆ‘ä»¬æ¨èä½¿ç”¨./nginx -s stopå‘½ä»¤</p><p><strong>nginxé‡å¯</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/lnmp/nginx-1.13.4/sbin/nginx -s reload</span><br></pre></td></tr></table></figure><p>å¯¹äºé‡å¯ï¼Œè¿˜å¯ä»¥ä½¿ç”¨killå‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -USR2 `cat /path/pid`</span><br><span class="line"><span class="comment">#å¦‚æœ¬æ–‡ä¸­çš„ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="built_in">kill</span> -USR2 `cat /usr/<span class="built_in">local</span>/lnmp/nginx-1.13.4/logs/nginx.pid`</span><br></pre></td></tr></table></figure><h4 id="3-3-2-conf"><a href="#3-3-2-conf" class="headerlink" title="3.3.2 conf"></a>3.3.2 conf</h4><p>nginxé…ç½®æ–‡ä»¶ä¸»è¦ä¸ºnginx.confï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ¥è¯¦ç»†è§£è¯»ä¸‹å…¶ä¸­çš„ç›¸å…³é…ç½®æŒ‡ä»¤åŠå«ä¹‰ã€‚</p><p>nginxçš„å¼ºå¤§éƒ½æ˜¯é é…ç½®æ–‡ä»¶æ¥å®ç°ï¼Œnginxå°±æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œnginxè¯»å…¥ä¸€ä¸ªé…ç½®æ–‡ä»¶nginx.conf(nginx.confå¯èƒ½includeåŒ…å«è‹¥å¹²å­é…ç½®æ–‡ä»¶)æ¥å®ç°å„ç§å„æ ·çš„åŠŸèƒ½ã€‚æˆ‘ä»¬åˆ†æ®µæ¥ä»‹ç»nginx.confæ–‡ä»¶ã€‚</p><h5 id="3-3-2-1-å…¨å±€é…ç½®æ®µ"><a href="#3-3-2-1-å…¨å±€é…ç½®æ®µ" class="headerlink" title="3.3.2.1 å…¨å±€é…ç½®æ®µ"></a>3.3.2.1 å…¨å±€é…ç½®æ®µ</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"><span class="attribute">pid</span>        logs/nginx.pid; </span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº›æ˜¯é…ç½®æ–‡ä»¶å¼€å§‹çš„é»˜è®¤è¡Œã€‚é€šå¸¸çš„ç¯å¢ƒä¸‹ï¼Œä½ ä¸éœ€è¦ä¿®æ”¹è¿™äº›é€‰é¡¹ã€‚è¿™ä¸€éƒ¨åˆ†æœ‰å‡ ä¸ªæ–¹é¢éœ€è¦æˆ‘ä»¬æ³¨æ„ï¼š</p><ul><li>æ‰€æœ‰ä»¥#å·å¼€çš„è¡Œæ˜¯æ³¨é‡Šï¼Œnginxä¸ä¼šè§£æã€‚é»˜è®¤çš„é…ç½®æ–‡ä»¶æœ‰è®¸å¤šè¯´æ˜è§£é‡Šçš„æ³¨é‡Šå—</li><li>æŒ‡ä»¤æ˜¯ä»¥ä¸€ä¸ªå˜é‡åå¼€å¤´(ä¾‹å¦‚ï¼Œworker_processesæˆ–pid),ç„¶ååŒ…å«ä¸€ä¸ªå‚æ•°(ä¾‹å¦‚ï¼Œ1æˆ– logs/nginx.pid)æˆ–è€…å¤šä¸ªå‚æ•°(ä¾‹å¦‚ï¼Œâ€logs/error.log noticeâ€)</li><li>æ‰€æœ‰æŒ‡ä»¤ä»¥åˆ†å·ç»“å°¾</li><li>æŸäº›æŒ‡ä»¤ï¼Œåƒä¸Šé¢çš„<code>events</code>å¯ä»¥åŒ…å«å¤šä¸ªå­æŒ‡ä»¤ä½œä¸ºå‚æ•°ã€‚è¿™äº›å­æŒ‡ä»¤ä»¥èŠ±æ‹¬å·åŒ…å›´ã€‚</li><li>è™½ç„¶nginxä¸è§£æç©ºç™½ç¬¦(ä¾‹å¦‚tabï¼Œç©ºæ ¼ï¼Œå’Œæ¢è¡Œç¬¦)ï¼Œä½†æ˜¯è‰¯å¥½çš„ç¼©è¿›èƒ½æé«˜ä½ ç»´æŠ¤é•¿æœŸè¿è¡Œé…ç½®æ–‡ä»¶çš„æ•ˆç‡ã€‚è‰¯å¥½çš„ç¼©è¿›ä½¿é…ç½®æ–‡ä»¶è¯»èµ·æ¥æ›´æµç•…ï¼Œèƒ½è®©ä½ å¾ˆå®¹æ˜“æ˜ç™½é…ç½®çš„ç­–ç•¥ï¼Œå³ä½¿å‡ ä¸ªæœˆå‰ã€‚</li></ul><h5 id="3-3-2-2-httpæ®µ"><a href="#3-3-2-2-httpæ®µ" class="headerlink" title="3.3.2.2 httpæ®µ"></a>3.3.2.2 httpæ®µ</h5><p>å®˜æ–¹å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:http &#123; ... &#125;</span><br><span class="line">Default:â€”</span><br><span class="line">Context:main</span><br></pre></td></tr></table></figure><p>æœ¬å®è·µç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#log å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttp://nginx.org/en/docs/http/ngx_http_log_module.html#access_log</span></span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzipå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttp://nginx.org/en/docs/http/ngx_http_gzip_module.html</span></span><br><span class="line">    <span class="attribute">gzip</span>  <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">gzip_min_length</span> <span class="number">1000</span>;</span><br><span class="line"><span class="attribute">gzip_proxied</span>    expired <span class="literal">no</span>-cache <span class="literal">no</span>-store private auth;</span><br><span class="line"><span class="attribute">gzip_types</span>      text/plain application/xml;</span><br><span class="line"><span class="attribute">gzip_comp_level</span> <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">include</span> vhost/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€œhttp { }â€å—çš„å¼€å¤´åƒé…ç½®æ–‡ä»¶çš„å¼€å¤´ä¸€æ ·éƒ½æ˜¯æ ‡å‡†é…ç½®ä¸éœ€è¦ä¿®æ”¹ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦æŠŠæ³¨æ„åŠ›æ”¾åœ¨è¿™äº›å…ƒç´ ä¸Š:</p><ul><li>è¿™éƒ¨åˆ†å†…å®¹çš„å¼€å§‹â€includeâ€è¯­å¥åŒ…å«/usr/local/lnmp/nginx-1.13.4/conf/mime.typesæ–‡ä»¶åˆ°nginx.confæ–‡ä»¶includeè¯­å¥æ‰€åœ¨ä½ç½®ã€‚includeå¯¹ningx.confæ–‡ä»¶çš„å¯è¯»æ€§å’Œç»„ç»‡æ€§å¾ˆæœ‰ç”¨ã€‚</li><li>ä¸èƒ½è¿‡å¤šä½¿ç”¨includeï¼Œå¦‚æœå¤ªå¤šé€’å½’åœ°includeæ–‡ä»¶ä¼šäº§ç”Ÿæ··ä¹±ï¼Œæ‰€ä»¥éœ€è¦åˆç†æœ‰é™åˆ¶åœ°ä½¿ç”¨includeæ¥ä¿è¯é…ç½®æ–‡ä»¶çš„æ¸…æ™°å’Œå¯ç®¡ç†ã€‚</li><li>ä½ å¯ä»¥å»æ‰log_formatæŒ‡ä»¤å‰çš„æ³¨é‡Šå¹¶ä¿®æ”¹è¿™å‡ è¡Œè®¾ç½®çš„å˜é‡ä¸ºä½ æƒ³è®°å½•çš„ä¿¡æ¯ã€‚</li><li>gzipæŒ‡ä»¤å‘Šè¯‰nginxä½¿ç”¨gzipå‹ç¼©çš„æ–¹å¼æ¥é™ä½å¸¦å®½ä½¿ç”¨å’ŒåŠ å¿«ä¼ è¾“é€Ÿåº¦ã€‚å¦‚æœæƒ³ä½¿ç”¨gzipå‹ç¼©ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹é…ç½®åˆ°é…ç½®æ–‡ä»¶çš„gzipä½ç½®ã€‚</li><li>include vhost/*.conf;è¡¨ç¤ºåŒ…å«çš„è™šæ‹Ÿä¸»æœºé…ç½®ï¼Œè¿™å°†åœ¨ä¸‹ä¸€æ®µè®²è§£ã€‚</li></ul><h5 id="3-3-2-3-serveræ®µ"><a href="#3-3-2-3-serveræ®µ" class="headerlink" title="3.3.2.3 serveræ®µ"></a>3.3.2.3 serveræ®µ</h5><p>è™šæ‹Ÿä¸»æœºé…ç½®æŒ‡ä»¤å—ä¸ºserverï¼Œå…¶åŒ…å«ä¸httpæŒ‡ä»¤å—ä¸­ï¼Œä¸ºäº†æ–¹é¢æˆ‘ä»¬é…ç½®ï¼Œæˆ‘ä»¬å°†å…¶ç‹¬ç«‹å‡ºæ¥ï¼Œé€šè¿‡includeæŒ‡ä»¤å°†å…¶åŒ…å«è¿›å…¥httpæŒ‡ä»¤å—ä¸­å»ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:server &#123; ... &#125;</span><br><span class="line">Default:â€”</span><br><span class="line">Context:http</span><br></pre></td></tr></table></figure><p>æœ¬å®è·µé…ç½®ç¤ºä¾‹ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">9091</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span>  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">root</span>   /data0/www/htdocs/lnmp.com;</span><br><span class="line">      <span class="attribute">index</span>  index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">    <span class="comment">#    proxy_pass   http://127.0.0.1;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">      <span class="attribute">root</span>           /data0/www/htdocs/lnmp.com;</span><br><span class="line">      <span class="attribute">fastcgi_pass</span>   <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">      <span class="attribute">fastcgi_index</span>  index.php;</span><br><span class="line">      <span class="attribute">fastcgi_param</span>  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">      <span class="attribute">include</span>        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># deny access to .htaccess files, if Apache's document root</span></span><br><span class="line">    <span class="comment"># concurs with nginx's one</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">    <span class="comment">#    deny  all;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>listenï¼š</strong>æŒ‡ä»¤å‘Šè¯‰nginxåœ¨ä¸€ä¸ªç‰¹å®šçš„hostnameï¼Œipæˆ–è€…tcpç«¯å£ç›‘å¬è¿æ¥ã€‚é»˜è®¤ï¼ŒhttpæœåŠ¡è¿è¡Œåœ¨80ç«¯å£ã€‚ä»¥ä¸‹è¿™äº›listenæŒ‡ä»¤éƒ½æ˜¯æœ‰æ•ˆçš„</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; listen     127.0.0.1:80;</span><br><span class="line">&gt; listen     localhost:80;</span><br><span class="line">&gt; listen     12.34.56.79:80;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p><strong>server_nameï¼š</strong>æŒ‡ä»¤å¯ä»¥è®¾ç½®åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœºï¼Œæ ¹æ®è¯·æ±‚å¤´éƒ¨çš„å†…å®¹ï¼Œä¸€ä¸ªipçš„æœåŠ¡å™¨å¯ä»¥é…ç½®å¤šä¸ªåŸŸåã€‚ä»¥ä¸‹è¿™äº›é…ç½®å‡æ˜¯å¯ä»¥çš„</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; server_name lnmp.com www.lnmp.com;</span><br><span class="line">&gt; server_name *.lnmp.com;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>å¤šä¸ªåŸŸåä¹‹é—´ä»¥ç©ºæ ¼åˆ†éš”ã€‚nginxå…è®¸ä¸€ä¸ªè™šæ‹Ÿä¸»æœºæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªåå­—ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€šé…ç¬¦â€*â€æ¥è®¾ç½®è™šæ‹Ÿä¸»æœºçš„åå­—ã€‚</p></blockquote><blockquote><p><strong>access_logï¼š</strong>ç”¨äºé…ç½®è™šæ‹Ÿä¸»æœºæ—¥å¿—ï¼Œä»¥ä¸‹é…ç½®å‡å¯ä»¥ã€‚ç¬¬ä¸€ä¸ªä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œæ—¥å¿—å­˜å‚¨åœ¨/usr/local/lnmp/nginx-1.13.4/logs/lnmp.access.logä¸­ï¼Œç¬¬äºŒä¸ªä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œç¬¬ä¸‰ä¸ªè¡¨ç¤ºä¸è®°å½•æ—¥å¿—åˆ°æ–‡ä»¶ã€‚ç¬¬ä¸€è¡Œå‚æ•°æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºæ—¥å¿—æ–‡ä»¶ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºæ—¥å¿—ç±»å‹</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; access_log  logs/lnmp.access.log  main;</span><br><span class="line">&gt; access_log  /data0/www/logs/lnmp.access.log main;</span><br><span class="line">&gt; access_log  off;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p><strong>locationæŒ‡ä»¤</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¯­æ³•:location [ = | ~ | ~* | ^~ ] uri &#123; ... &#125;</span><br><span class="line">     location @name &#123; ... &#125;</span><br><span class="line">é»˜è®¤: â€”</span><br><span class="line">è¿è¡Œä¸Šä¸‹æ–‡: server, location</span><br></pre></td></tr></table></figure><p><strong>è¯­æ³•è§£é‡Šï¼š</strong></p><p><strong>~</strong>      ï¼šæ³¢æµªçº¿è¡¨ç¤ºæ‰§è¡Œä¸€ä¸ªæ­£åˆ™åŒ¹é…ï¼ŒåŒºåˆ†å¤§å°å†™</p><p><strong>~*</strong>    ï¼šè¡¨ç¤ºæ‰§è¡Œä¸€ä¸ªæ­£åˆ™åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™</p><p><strong>^~</strong>    ï¼š^~è¡¨ç¤ºæ™®é€šå­—ç¬¦åŒ¹é…ï¼Œå¦‚æœè¯¥é€‰é¡¹åŒ¹é…ï¼ŒåªåŒ¹é…è¯¥é€‰é¡¹ï¼Œä¸åŒ¹é…åˆ«çš„é€‰é¡¹ï¼Œä¸€èˆ¬ç”¨æ¥åŒ¹é…ç›®å½•</p><p><strong>=</strong>      ï¼šè¿›è¡Œæ™®é€šå­—ç¬¦ç²¾ç¡®åŒ¹é…</p><p><strong>@</strong>     ï¼šâ€@â€ å®šä¹‰ä¸€ä¸ªå‘½åçš„ locationï¼Œä½¿ç”¨åœ¨å†…éƒ¨å®šå‘æ—¶ï¼Œä¾‹å¦‚ error_page, try_files</p><p><strong>locationåˆ†ç±»ï¼š</strong></p><ol><li><p>æ™®é€šlocationï¼ˆæ— ä»»ä½•å‰ç¼€çš„ã€â€=â€ã€â€^~ â€œã€â€@â€å‡è¡¨ç¤ºæ™®é€šlocationï¼‰</p><p>1ï¼‰ä¸¥æ ¼ç²¾ç¡®åŒ¹é…</p><p>2ï¼‰æœ€é•¿å‰ç¼€åŒ¹é…</p></li><li>æ­£åˆ™locationï¼ˆâ€œ~ â€å’Œâ€œ~* â€å‰ç¼€è¡¨ç¤ºæ­£åˆ™locationï¼‰</li></ol><p>æ³¨ï¼šâ€œ^~ â€ç¬¦å·ï¼ˆ^ è¡¨ç¤ºâ€œéâ€ï¼Œ~ è¡¨ç¤ºâ€œæ­£åˆ™â€ï¼Œå­—ç¬¦æ„æ€æ˜¯ï¼šä¸è¦ç»§ç»­åŒ¹é…æ­£åˆ™ï¼‰</p><p><strong>locationåŒ¹é…é¡ºåºï¼š</strong></p><p>æ­£åˆ™ location åŒ¹é…è®©æ­¥æ™®é€š location çš„ä¸¥æ ¼ç²¾ç¡®åŒ¹é…ç»“æœï¼›ä½†è¦†ç›–æ™®é€š location çš„æœ€å¤§å‰ç¼€åŒ¹é…ç»“æœã€‚è¯¦ç»†è§£é‡Šä¸‹å°±æ˜¯ï¼šä¼˜å…ˆæ™®é€šlocationåŒ¹é…ä¸­çš„ä¸¥æ ¼ç²¾ç¡®åŒ¹é…ï¼Œè‹¥æ²¡æœ‰å‘½ä¸­ä¸¥æ ¼ç²¾ç¡®åŒ¹é…ï¼Œåˆ™è¿›è¡Œæœ€é•¿å‰ç¼€åŒ¹é…ï¼Œè‹¥å‘½ä¸­ä¸€ä¸ªæœ€é•¿å‰ç¼€åŒ¹é…ï¼Œåˆ™å…ˆæš‚æ—¶å°†å…¶å®šä¸ºä¼˜å…ˆé€‰æ‹©ï¼Œæ¥ç€è¿›è¡Œæ­£åˆ™åŒ¹é…ï¼Œè‹¥æ­£åˆ™åŒ¹é…å‘½ä¸­ï¼Œåˆ™ä½¿ç”¨æ­£åˆ™åŒ¹é…åˆ°çš„ç»“æœè¦†ç›–ä¹‹å‰çš„æœ€é•¿å‰ç¼€åŒ¹é…ç»“æœã€‚è¿™é‡Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ™®é€šlocationéƒ½ä¼šè¿›è¡Œåç»­çš„æ­£åˆ™æœç´¢åŒ¹é…ï¼Œè‹¥æœ€é•¿å‰ç¼€åŒ¹é…ç»“æœæ˜¯â€^~â€ å’Œ â€œ=â€ï¼Œåˆ™ä¼šé˜»æ­¢åç»­çš„æ­£åˆ™åŒ¹é…ï¼Œç›´æ¥ä½¿ç”¨æ­¤ç»“æœã€‚</p><p><strong>locationç‰©ç†ä½ç½®ï¼š</strong></p><p>å¯¹äºlocationä¹‹é—´çš„é…ç½®é¡ºåºï¼Œæ™®é€šlocation ä¸å…¶æ— å…³ï¼Œæ­£åˆ™location ä¸å…¶æœ‰å…³çš„ã€‚</p><p><strong>locationç¤ºä¾‹ï¼š</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> = / &#123;</span><br><span class="line">    [ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    [ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> /documents/ &#123;</span><br><span class="line">    [ configuration C ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /images/ &#123;</span><br><span class="line">    [ configuration D ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~* \.(gif|jpg|jpeg)$</span> &#123;</span><br><span class="line">    [ configuration E ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>â€œ/â€œ è¯·æ±‚å°†ä¼šåŒ¹é…é…ç½®Aï¼Œå› ä¸ºå…¶ä¸ºæ™®é€šlocationé‡Œçš„ä¸¥æ ¼ç²¾ç¡®åŒ¹é…ï¼Œç»“æŸåŒ¹é…ã€‚</li><li>â€œ/index.htmlâ€ å°†ä¼šåŒ¹é…é…ç½®Bï¼Œæ­¤ä¸ºå‰ç¼€å­—ç¬¦ä¸²åŒ¹é…ï¼ˆæ™®é€šåŒ¹é…ä¹‹åçš„æ­£åˆ™æœç´¢æ²¡æœ‰åŒ¹é…åˆ°ï¼‰</li><li>â€œ/documents/index.htmlâ€ å°†ä¼šåŒ¹é…é…ç½®Cï¼Œå…ˆè¿›è¡Œæ™®é€šåŒ¹é…ï¼Œå‘½ä¸­Cï¼Œåç»­è¿›è¡Œæ­£åˆ™åŒ¹é…ï¼Œæ²¡æœ‰å‘½ä¸­ï¼Œæ•…ä½¿ç”¨æœ€é•¿å‰ç¼€åŒ¹é…åˆ°çš„ç»“æœï¼Œæ‰€ä»¥æœ€ç»ˆåŒ¹é…Cã€‚</li><li>â€œ/images/1.gifâ€ å°†ä¼šåŒ¹é…é…ç½®Dï¼Œæ™®é€šlocationæœ€é•¿å‰ç¼€åŒ¹é…æˆåŠŸåï¼Œä¸åœ¨åŒ¹é…æ­£åˆ™åŒ¹é…</li><li>â€œ/documents/1.jpgâ€ å°†ä¼šåŒ¹é…é…ç½®Eï¼Œæœ€é•¿å‰ç¼€åŒ¹é…åˆ°Cï¼Œç»§ç»­æœç´¢æ­£åˆ™ï¼Œåæ­£åˆ™åŒ¹é…åˆ°Eï¼Œåˆ™æœ€ç»ˆåŒ¹é…åˆ°E</li></ol><p>æ›´å¤šnginxé…ç½®æŒ‡ä»¤è¯·ç§»æ­¥å®˜æ–¹æ–‡æ¡£ï¼š<a href="http://nginx.org/en/docs/" target="_blank" rel="noopener">http://nginx.org/en/docs/</a></p><h2 id="4-mysqlå®‰è£…"><a href="#4-mysqlå®‰è£…" class="headerlink" title="4 mysqlå®‰è£…"></a>4 mysqlå®‰è£…</h2><h3 id="4-1-ç¼–è¯‘å®‰è£…"><a href="#4-1-ç¼–è¯‘å®‰è£…" class="headerlink" title="4.1 ç¼–è¯‘å®‰è£…"></a>4.1 ç¼–è¯‘å®‰è£…</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ·»åŠ mysqlç”¨æˆ·ç»„</span></span><br><span class="line">groupadd mysql</span><br><span class="line"><span class="comment">#æ·»åŠ mysqlç”¨æˆ·ï¼Œä¸”è®¾ç½®å…¶ç»„ä¸ºmysqlï¼ŒåŒæ—¶è®¾ç½®å…¶shellä¸ºç©º</span></span><br><span class="line">useradd -r -g mysql -s /bin/<span class="literal">false</span> mysql</span><br><span class="line"><span class="comment">#è¿›å…¥æºç ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/lnmp/src</span><br><span class="line"><span class="comment">#è§£å‹mysqlå‹ç¼©åŒ…</span></span><br><span class="line">tar -zxf mysql-5.6.37.tar.gz</span><br><span class="line"><span class="built_in">cd</span> mysql-5.6.37</span><br><span class="line">mkdir bld</span><br><span class="line"><span class="built_in">cd</span> bld</span><br><span class="line"><span class="comment">#ç¼–è¯‘çš„å‚æ•°å¯ä»¥å‚è€ƒ:http://dev.mysql.com/doc/refman/5.5/en/source-configuration-option s.html</span></span><br><span class="line">cmake -DCMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span>/lnmp/mysql-5.6.37 ..</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">chown -R mysql .</span><br><span class="line">chgrp -R mysql .</span><br><span class="line"><span class="comment">#åˆå§‹åŒ–æ•°æ®åº“ï¼Œæ­¤æ“ä½œä¼šåœ¨å®‰è£…ç›®å½•ä¸‹åŒæ—¶ç”Ÿæˆmy.cnfæ–‡ä»¶</span></span><br><span class="line">scripts/mysql_install_db --user=mysql</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯åŠ¨mysql</span></span><br><span class="line">/usr/<span class="built_in">local</span>/lnmp/mysql-5.6.37/bin/mysqld --user=mysql --explicit_defaults_for_timestamp</span><br><span class="line"><span class="comment">#åœæ‰mysql</span></span><br><span class="line">/usr/<span class="built_in">local</span>/lnmp/mysql-5.6.37/bin/mysqladmin shutdown</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#åœ¨æµ‹è¯•åº“åˆ›å»ºæµ‹è¯•ç”¨æˆ·è¡¨</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span> (<span class="string">`id`</span> <span class="built_in">bigint</span> <span class="keyword">unsigned</span> auto_increment <span class="keyword">comment</span> <span class="string">'ä¸»é”®'</span>,<span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="string">''</span> <span class="keyword">comment</span> <span class="string">'å§“å'</span>,<span class="string">`age`</span> tinyint <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="number">0</span> <span class="keyword">comment</span> <span class="string">'å¹´é¾„'</span>, primary <span class="keyword">key</span> <span class="keyword">id</span>(<span class="string">`id`</span>) ) <span class="keyword">ENGINE</span> = <span class="keyword">innodb</span> AUTO_INCREMENT = <span class="number">1</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8;</span><br><span class="line"></span><br><span class="line">#æ’å…¥æ•°æ®</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="string">`id`</span>,<span class="string">`name`</span>,<span class="string">`age`</span>) <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'å®‰çªæ‹‰'</span>,<span class="number">34</span>),(<span class="number">1</span>,<span class="string">'ç‹æ˜­å›'</span>,<span class="number">34</span>);</span><br></pre></td></tr></table></figure><h3 id="4-2-é…ç½®"><a href="#4-2-é…ç½®" class="headerlink" title="4.2 é…ç½®"></a>4.2 é…ç½®</h3><p><a href="http://dev.mysql.com/doc/refman/5.6/en/server-configuration-defaults.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ï¼Œmysqlå¯åŠ¨æ—¶ï¼Œéœ€è¦åŠ è½½my.cnfé…ç½®æ–‡ä»¶ï¼ŒåŠ è½½æŸ¥æ‰¾è·¯å¾„ä¸ºï¼š/etc/my.cnf &gt; $basedir/my.cnf æœ¬å®è·µä¸­æŸ¥æ‰¾è·¯å¾„ä¸º/usr/local/lnmp/mysql-5.6.37/my.cnf</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line"><span class="attr">socket</span> = /tmp/mysql.sock</span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line"><span class="attr">socket</span> = /tmp/mysql.sock</span><br><span class="line"><span class="attr">basedir</span> = /usr/local/lnmp/mysql-<span class="number">5.6</span>.<span class="number">37</span></span><br><span class="line"><span class="attr">datadir</span> = /usr/local/lnmp/mysql-<span class="number">5.6</span>.<span class="number">37</span>/data</span><br><span class="line"><span class="attr">pid-file</span> = /usr/local/lnmp/mysql-<span class="number">5.6</span>.<span class="number">37</span>/data/mysql.pid</span><br><span class="line"><span class="attr">user</span> = mysql</span><br><span class="line"><span class="attr">bind-address</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="comment">#è¡¨ç¤ºæ˜¯æœ¬æœºçš„åºå·ä¸º1,ä¸€èˆ¬æ¥è®²å°±æ˜¯masterçš„æ„æ€</span></span><br><span class="line"><span class="attr">server-id</span> = <span class="number">1</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#skip-name-resolve</span></span><br><span class="line"><span class="comment"># ç¦æ­¢MySQLå¯¹å¤–éƒ¨è¿æ¥è¿›è¡ŒDNSè§£æï¼Œä½¿ç”¨è¿™ä¸€é€‰é¡¹å¯ä»¥æ¶ˆé™¤MySQLè¿›è¡ŒDNSè§£æçš„æ—¶é—´ã€‚ä½†éœ€è¦æ³¨æ„ï¼Œå¦‚æœå¼€å¯è¯¥é€‰é¡¹ï¼Œ</span></span><br><span class="line"><span class="comment"># åˆ™æ‰€æœ‰è¿œç¨‹ä¸»æœºè¿æ¥æˆæƒéƒ½è¦ä½¿ç”¨IPåœ°å€æ–¹å¼ï¼Œå¦åˆ™MySQLå°†æ— æ³•æ­£å¸¸å¤„ç†è¿æ¥è¯·æ±‚</span></span><br><span class="line"><span class="comment">#skip-networking</span></span><br><span class="line"><span class="attr">back_log</span> = <span class="number">600</span></span><br><span class="line"><span class="comment"># MySQLèƒ½æœ‰çš„è¿æ¥æ•°é‡ã€‚å½“ä¸»è¦MySQLçº¿ç¨‹åœ¨ä¸€ä¸ªå¾ˆçŸ­æ—¶é—´å†…å¾—åˆ°éå¸¸å¤šçš„è¿æ¥è¯·æ±‚ï¼Œè¿™å°±èµ·ä½œç”¨ï¼Œ</span></span><br><span class="line"><span class="comment"># ç„¶åä¸»çº¿ç¨‹èŠ±äº›æ—¶é—´(å°½ç®¡å¾ˆçŸ­)æ£€æŸ¥è¿æ¥å¹¶ä¸”å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ã€‚back_logå€¼æŒ‡å‡ºåœ¨MySQLæš‚æ—¶åœæ­¢å›ç­”æ–°è¯·æ±‚ä¹‹å‰çš„çŸ­æ—¶é—´å†…å¤šå°‘ä¸ªè¯·æ±‚å¯ä»¥è¢«å­˜åœ¨å †æ ˆä¸­ã€‚</span></span><br><span class="line"><span class="comment"># å¦‚æœæœŸæœ›åœ¨ä¸€ä¸ªçŸ­æ—¶é—´å†…æœ‰å¾ˆå¤šè¿æ¥ï¼Œä½ éœ€è¦å¢åŠ å®ƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœMySQLçš„è¿æ¥æ•°æ®è¾¾åˆ°max_connectionsæ—¶ï¼Œæ–°æ¥çš„è¯·æ±‚å°†ä¼šè¢«å­˜åœ¨å †æ ˆä¸­ï¼Œ</span></span><br><span class="line"><span class="comment"># ä»¥ç­‰å¾…æŸä¸€è¿æ¥é‡Šæ”¾èµ„æºï¼Œè¯¥å †æ ˆçš„æ•°é‡å³back_logï¼Œå¦‚æœç­‰å¾…è¿æ¥çš„æ•°é‡è¶…è¿‡back_logï¼Œå°†ä¸è¢«æˆäºˆè¿æ¥èµ„æºã€‚</span></span><br><span class="line"><span class="comment"># å¦å¤–ï¼Œè¿™å€¼ï¼ˆback_logï¼‰é™äºæ‚¨çš„æ“ä½œç³»ç»Ÿå¯¹åˆ°æ¥çš„TCP/IPè¿æ¥çš„ä¾¦å¬é˜Ÿåˆ—çš„å¤§å°ã€‚</span></span><br><span class="line"><span class="comment"># ä½ çš„æ“ä½œç³»ç»Ÿåœ¨è¿™ä¸ªé˜Ÿåˆ—å¤§å°ä¸Šæœ‰å®ƒè‡ªå·±çš„é™åˆ¶ï¼ˆå¯ä»¥æ£€æŸ¥ä½ çš„OSæ–‡æ¡£æ‰¾å‡ºè¿™ä¸ªå˜é‡çš„æœ€å¤§å€¼ï¼‰ï¼Œè¯•å›¾è®¾å®šback_logé«˜äºä½ çš„æ“ä½œç³»ç»Ÿçš„é™åˆ¶å°†æ˜¯æ— æ•ˆçš„ã€‚</span></span><br><span class="line"><span class="attr">max_connections</span> = <span class="number">1000</span></span><br><span class="line"><span class="comment"># MySQLçš„æœ€å¤§è¿æ¥æ•°ï¼Œå¦‚æœæœåŠ¡å™¨çš„å¹¶å‘è¿æ¥è¯·æ±‚é‡æ¯”è¾ƒå¤§ï¼Œå»ºè®®è°ƒé«˜æ­¤å€¼ï¼Œä»¥å¢åŠ å¹¶è¡Œè¿æ¥æ•°é‡ï¼Œå½“ç„¶è¿™å»ºç«‹åœ¨æœºå™¨èƒ½æ”¯æ’‘çš„æƒ…å†µä¸‹ï¼Œå› ä¸ºå¦‚æœè¿æ¥æ•°è¶Šå¤šï¼Œä»‹äºMySQLä¼šä¸ºæ¯ä¸ªè¿æ¥æä¾›è¿æ¥ç¼“å†²åŒºï¼Œå°±ä¼šå¼€é”€è¶Šå¤šçš„å†…å­˜ï¼Œæ‰€ä»¥è¦é€‚å½“è°ƒæ•´è¯¥å€¼ï¼Œä¸èƒ½ç›²ç›®æé«˜è®¾å€¼ã€‚å¯ä»¥è¿‡'conn%'é€šé…ç¬¦æŸ¥çœ‹å½“å‰çŠ¶æ€çš„è¿æ¥æ•°é‡ï¼Œä»¥å®šå¤ºè¯¥å€¼çš„å¤§å°ã€‚</span></span><br><span class="line"><span class="attr">max_connect_errors</span> = <span class="number">6000</span></span><br><span class="line"><span class="comment"># å¯¹äºåŒä¸€ä¸»æœºï¼Œå¦‚æœæœ‰è¶…å‡ºè¯¥å‚æ•°å€¼ä¸ªæ•°çš„ä¸­æ–­é”™è¯¯è¿æ¥ï¼Œåˆ™è¯¥ä¸»æœºå°†è¢«ç¦æ­¢è¿æ¥ã€‚å¦‚éœ€å¯¹è¯¥ä¸»æœºè¿›è¡Œè§£ç¦ï¼Œæ‰§è¡Œï¼šFLUSH HOSTã€‚</span></span><br><span class="line"><span class="attr">open_files_limit</span> = <span class="number">65535</span></span><br><span class="line"><span class="comment"># MySQLæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ï¼Œé»˜è®¤æœ€å°1024;å½“open_files_limitæ²¡æœ‰è¢«é…ç½®çš„æ—¶å€™ï¼Œæ¯”è¾ƒmax_connections*5å’Œulimit -nçš„å€¼ï¼Œå“ªä¸ªå¤§ç”¨å“ªä¸ªï¼Œ</span></span><br><span class="line"><span class="comment"># å½“open_file_limitè¢«é…ç½®çš„æ—¶å€™ï¼Œæ¯”è¾ƒopen_files_limitå’Œmax_connections*5çš„å€¼ï¼Œå“ªä¸ªå¤§ç”¨å“ªä¸ªã€‚</span></span><br><span class="line"><span class="attr">table_open_cache</span> = <span class="number">128</span></span><br><span class="line"><span class="comment"># MySQLæ¯æ‰“å¼€ä¸€ä¸ªè¡¨ï¼Œéƒ½ä¼šè¯»å…¥ä¸€äº›æ•°æ®åˆ°table_open_cacheç¼“å­˜ä¸­ï¼Œå½“MySQLåœ¨è¿™ä¸ªç¼“å­˜ä¸­æ‰¾ä¸åˆ°ç›¸åº”ä¿¡æ¯æ—¶ï¼Œæ‰ä¼šå»ç£ç›˜ä¸Šè¯»å–ã€‚é»˜è®¤å€¼64</span></span><br><span class="line"><span class="comment"># å‡å®šç³»ç»Ÿæœ‰200ä¸ªå¹¶å‘è¿æ¥ï¼Œåˆ™éœ€å°†æ­¤å‚æ•°è®¾ç½®ä¸º200*N(Nä¸ºæ¯ä¸ªè¿æ¥æ‰€éœ€çš„æ–‡ä»¶æè¿°ç¬¦æ•°ç›®)ï¼›</span></span><br><span class="line"><span class="comment"># å½“æŠŠtable_open_cacheè®¾ç½®ä¸ºå¾ˆå¤§æ—¶ï¼Œå¦‚æœç³»ç»Ÿå¤„ç†ä¸äº†é‚£ä¹ˆå¤šæ–‡ä»¶æè¿°ç¬¦ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°å®¢æˆ·ç«¯å¤±æ•ˆï¼Œè¿æ¥ä¸ä¸Š</span></span><br><span class="line"><span class="attr">max_allowed_packet</span> = <span class="number">4</span>M</span><br><span class="line"><span class="comment"># æ¥å—çš„æ•°æ®åŒ…å¤§å°ï¼›å¢åŠ è¯¥å˜é‡çš„å€¼ååˆ†å®‰å…¨ï¼Œè¿™æ˜¯å› ä¸ºä»…å½“éœ€è¦æ—¶æ‰ä¼šåˆ†é…é¢å¤–å†…å­˜ã€‚ä¾‹å¦‚ï¼Œä»…å½“ä½ å‘å‡ºé•¿æŸ¥è¯¢æˆ–MySQLdå¿…é¡»è¿”å›å¤§çš„ç»“æœè¡Œæ—¶MySQLdæ‰ä¼šåˆ†é…æ›´å¤šå†…å­˜ã€‚</span></span><br><span class="line"><span class="comment"># è¯¥å˜é‡ä¹‹æ‰€ä»¥å–è¾ƒå°é»˜è®¤å€¼æ˜¯ä¸€ç§é¢„é˜²æªæ–½ï¼Œä»¥æ•è·å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é”™è¯¯ä¿¡æ¯åŒ…ï¼Œå¹¶ç¡®ä¿ä¸ä¼šå› å¶ç„¶ä½¿ç”¨å¤§çš„ä¿¡æ¯åŒ…è€Œå¯¼è‡´å†…å­˜æº¢å‡ºã€‚</span></span><br><span class="line"><span class="attr">binlog_cache_size</span> = <span class="number">1</span>M</span><br><span class="line"><span class="comment"># ä¸€ä¸ªäº‹åŠ¡ï¼Œåœ¨æ²¡æœ‰æäº¤çš„æ—¶å€™ï¼Œäº§ç”Ÿçš„æ—¥å¿—ï¼Œè®°å½•åˆ°Cacheä¸­ï¼›ç­‰åˆ°äº‹åŠ¡æäº¤éœ€è¦æäº¤çš„æ—¶å€™ï¼Œåˆ™æŠŠæ—¥å¿—æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚é»˜è®¤binlog_cache_sizeå¤§å°32K</span></span><br><span class="line"><span class="attr">max_heap_table_size</span> = <span class="number">8</span>M</span><br><span class="line"><span class="comment"># å®šä¹‰äº†ç”¨æˆ·å¯ä»¥åˆ›å»ºçš„å†…å­˜è¡¨(memory table)çš„å¤§å°ã€‚è¿™ä¸ªå€¼ç”¨æ¥è®¡ç®—å†…å­˜è¡¨çš„æœ€å¤§è¡Œæ•°å€¼ã€‚è¿™ä¸ªå˜é‡æ”¯æŒåŠ¨æ€æ”¹å˜</span></span><br><span class="line"><span class="attr">tmp_table_size</span> = <span class="number">16</span>M</span><br><span class="line"><span class="comment"># MySQLçš„heapï¼ˆå †ç§¯ï¼‰è¡¨ç¼“å†²å¤§å°ã€‚æ‰€æœ‰è”åˆåœ¨ä¸€ä¸ªDMLæŒ‡ä»¤å†…å®Œæˆï¼Œå¹¶ä¸”å¤§å¤šæ•°è”åˆç”šè‡³å¯ä»¥ä¸ç”¨ä¸´æ—¶è¡¨å³å¯ä»¥å®Œæˆã€‚</span></span><br><span class="line"><span class="comment"># å¤§å¤šæ•°ä¸´æ—¶è¡¨æ˜¯åŸºäºå†…å­˜çš„(HEAP)è¡¨ã€‚å…·æœ‰å¤§çš„è®°å½•é•¿åº¦çš„ä¸´æ—¶è¡¨ (æ‰€æœ‰åˆ—çš„é•¿åº¦çš„å’Œ)æˆ–åŒ…å«BLOBåˆ—çš„è¡¨å­˜å‚¨åœ¨ç¡¬ç›˜ä¸Šã€‚</span></span><br><span class="line"><span class="comment"># å¦‚æœæŸä¸ªå†…éƒ¨heapï¼ˆå †ç§¯ï¼‰è¡¨å¤§å°è¶…è¿‡tmp_table_sizeï¼ŒMySQLå¯ä»¥æ ¹æ®éœ€è¦è‡ªåŠ¨å°†å†…å­˜ä¸­çš„heapè¡¨æ”¹ä¸ºåŸºäºç¡¬ç›˜çš„MyISAMè¡¨ã€‚è¿˜å¯ä»¥é€šè¿‡è®¾ç½®tmp_table_sizeé€‰é¡¹æ¥å¢åŠ ä¸´æ—¶è¡¨çš„å¤§å°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœè°ƒé«˜è¯¥å€¼ï¼ŒMySQLåŒæ—¶å°†å¢åŠ heapè¡¨çš„å¤§å°ï¼Œå¯è¾¾åˆ°æé«˜è”æ¥æŸ¥è¯¢é€Ÿåº¦çš„æ•ˆæœ</span></span><br><span class="line"><span class="attr">read_buffer_size</span> = <span class="number">2</span>M</span><br><span class="line"><span class="comment"># MySQLè¯»å…¥ç¼“å†²åŒºå¤§å°ã€‚å¯¹è¡¨è¿›è¡Œé¡ºåºæ‰«æçš„è¯·æ±‚å°†åˆ†é…ä¸€ä¸ªè¯»å…¥ç¼“å†²åŒºï¼ŒMySQLä¼šä¸ºå®ƒåˆ†é…ä¸€æ®µå†…å­˜ç¼“å†²åŒºã€‚read_buffer_sizeå˜é‡æ§åˆ¶è¿™ä¸€ç¼“å†²åŒºçš„å¤§å°ã€‚</span></span><br><span class="line"><span class="comment"># å¦‚æœå¯¹è¡¨çš„é¡ºåºæ‰«æè¯·æ±‚éå¸¸é¢‘ç¹ï¼Œå¹¶ä¸”ä½ è®¤ä¸ºé¢‘ç¹æ‰«æè¿›è¡Œå¾—å¤ªæ…¢ï¼Œå¯ä»¥é€šè¿‡å¢åŠ è¯¥å˜é‡å€¼ä»¥åŠå†…å­˜ç¼“å†²åŒºå¤§å°æé«˜å…¶æ€§èƒ½</span></span><br><span class="line"><span class="attr">read_rnd_buffer_size</span> = <span class="number">8</span>M</span><br><span class="line"><span class="comment"># MySQLçš„éšæœºè¯»ç¼“å†²åŒºå¤§å°ã€‚å½“æŒ‰ä»»æ„é¡ºåºè¯»å–è¡Œæ—¶(ä¾‹å¦‚ï¼ŒæŒ‰ç…§æ’åºé¡ºåº)ï¼Œå°†åˆ†é…ä¸€ä¸ªéšæœºè¯»ç¼“å­˜åŒºã€‚è¿›è¡Œæ’åºæŸ¥è¯¢æ—¶ï¼Œ</span></span><br><span class="line"><span class="comment"># MySQLä¼šé¦–å…ˆæ‰«æä¸€éè¯¥ç¼“å†²ï¼Œä»¥é¿å…ç£ç›˜æœç´¢ï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œå¦‚æœéœ€è¦æ’åºå¤§é‡æ•°æ®ï¼Œå¯é€‚å½“è°ƒé«˜è¯¥å€¼ã€‚ä½†MySQLä¼šä¸ºæ¯ä¸ªå®¢æˆ·è¿æ¥å‘æ”¾è¯¥ç¼“å†²ç©ºé—´ï¼Œæ‰€ä»¥åº”å°½é‡é€‚å½“è®¾ç½®è¯¥å€¼ï¼Œä»¥é¿å…å†…å­˜å¼€é”€è¿‡å¤§</span></span><br><span class="line"><span class="attr">sort_buffer_size</span> = <span class="number">8</span>M</span><br><span class="line"><span class="comment"># MySQLæ‰§è¡Œæ’åºä½¿ç”¨çš„ç¼“å†²å¤§å°ã€‚å¦‚æœæƒ³è¦å¢åŠ ORDER BYçš„é€Ÿåº¦ï¼Œé¦–å…ˆçœ‹æ˜¯å¦å¯ä»¥è®©MySQLä½¿ç”¨ç´¢å¼•è€Œä¸æ˜¯é¢å¤–çš„æ’åºé˜¶æ®µã€‚</span></span><br><span class="line"><span class="comment"># å¦‚æœä¸èƒ½ï¼Œå¯ä»¥å°è¯•å¢åŠ sort_buffer_sizeå˜é‡çš„å¤§å°</span></span><br><span class="line"><span class="attr">join_buffer_size</span> = <span class="number">8</span>M</span><br><span class="line"><span class="comment"># è”åˆæŸ¥è¯¢æ“ä½œæ‰€èƒ½ä½¿ç”¨çš„ç¼“å†²åŒºå¤§å°ï¼Œå’Œsort_buffer_sizeä¸€æ ·ï¼Œè¯¥å‚æ•°å¯¹åº”çš„åˆ†é…å†…å­˜ä¹Ÿæ˜¯æ¯è¿æ¥ç‹¬äº«</span></span><br><span class="line"><span class="attr">thread_cache_size</span> = <span class="number">8</span></span><br><span class="line"><span class="comment"># è¿™ä¸ªå€¼ï¼ˆé»˜è®¤8ï¼‰è¡¨ç¤ºå¯ä»¥é‡æ–°åˆ©ç”¨ä¿å­˜åœ¨ç¼“å­˜ä¸­çº¿ç¨‹çš„æ•°é‡ï¼Œå½“æ–­å¼€è¿æ¥æ—¶å¦‚æœç¼“å­˜ä¸­è¿˜æœ‰ç©ºé—´ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯çš„çº¿ç¨‹å°†è¢«æ”¾åˆ°ç¼“å­˜ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment"># å¦‚æœçº¿ç¨‹é‡æ–°è¢«è¯·æ±‚ï¼Œé‚£ä¹ˆè¯·æ±‚å°†ä»ç¼“å­˜ä¸­è¯»å–,å¦‚æœç¼“å­˜ä¸­æ˜¯ç©ºçš„æˆ–è€…æ˜¯æ–°çš„è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°†è¢«é‡æ–°åˆ›å»º,å¦‚æœæœ‰å¾ˆå¤šæ–°çš„çº¿ç¨‹ï¼Œ</span></span><br><span class="line"><span class="comment"># å¢åŠ è¿™ä¸ªå€¼å¯ä»¥æ”¹å–„ç³»ç»Ÿæ€§èƒ½.é€šè¿‡æ¯”è¾ƒConnectionså’ŒThreads_createdçŠ¶æ€çš„å˜é‡ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªå˜é‡çš„ä½œç”¨ã€‚(â€“&gt;è¡¨ç¤ºè¦è°ƒæ•´çš„å€¼)</span></span><br><span class="line"><span class="comment"># æ ¹æ®ç‰©ç†å†…å­˜è®¾ç½®è§„åˆ™å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment"># 1G  â€”&gt; 8</span></span><br><span class="line"><span class="comment"># 2G  â€”&gt; 16</span></span><br><span class="line"><span class="comment"># 3G  â€”&gt; 32</span></span><br><span class="line"><span class="comment"># å¤§äº3G  â€”&gt; 64</span></span><br><span class="line"><span class="attr">query_cache_size</span> = <span class="number">8</span>M</span><br><span class="line"><span class="comment">#MySQLçš„æŸ¥è¯¢ç¼“å†²å¤§å°ï¼ˆä»4.0.1å¼€å§‹ï¼ŒMySQLæä¾›äº†æŸ¥è¯¢ç¼“å†²æœºåˆ¶ï¼‰ä½¿ç”¨æŸ¥è¯¢ç¼“å†²ï¼ŒMySQLå°†SELECTè¯­å¥å’ŒæŸ¥è¯¢ç»“æœå­˜æ”¾åœ¨ç¼“å†²åŒºä¸­ï¼Œ</span></span><br><span class="line"><span class="comment"># ä»Šåå¯¹äºåŒæ ·çš„SELECTè¯­å¥ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰ï¼Œå°†ç›´æ¥ä»ç¼“å†²åŒºä¸­è¯»å–ç»“æœã€‚æ ¹æ®MySQLç”¨æˆ·æ‰‹å†Œï¼Œä½¿ç”¨æŸ¥è¯¢ç¼“å†²æœ€å¤šå¯ä»¥è¾¾åˆ°238%çš„æ•ˆç‡ã€‚</span></span><br><span class="line"><span class="comment"># é€šè¿‡æ£€æŸ¥çŠ¶æ€å€¼'Qcache_%'ï¼Œå¯ä»¥çŸ¥é“query_cache_sizeè®¾ç½®æ˜¯å¦åˆç†ï¼šå¦‚æœQcache_lowmem_prunesçš„å€¼éå¸¸å¤§ï¼Œåˆ™è¡¨æ˜ç»å¸¸å‡ºç°ç¼“å†²ä¸å¤Ÿçš„æƒ…å†µï¼Œ</span></span><br><span class="line"><span class="comment"># å¦‚æœQcache_hitsçš„å€¼ä¹Ÿéå¸¸å¤§ï¼Œåˆ™è¡¨æ˜æŸ¥è¯¢ç¼“å†²ä½¿ç”¨éå¸¸é¢‘ç¹ï¼Œæ­¤æ—¶éœ€è¦å¢åŠ ç¼“å†²å¤§å°ï¼›å¦‚æœQcache_hitsçš„å€¼ä¸å¤§ï¼Œåˆ™è¡¨æ˜ä½ çš„æŸ¥è¯¢é‡å¤ç‡å¾ˆä½ï¼Œ</span></span><br><span class="line"><span class="comment"># è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨æŸ¥è¯¢ç¼“å†²åè€Œä¼šå½±å“æ•ˆç‡ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä¸ç”¨æŸ¥è¯¢ç¼“å†²ã€‚æ­¤å¤–ï¼Œåœ¨SELECTè¯­å¥ä¸­åŠ å…¥SQL_NO_CACHEå¯ä»¥æ˜ç¡®è¡¨ç¤ºä¸ä½¿ç”¨æŸ¥è¯¢ç¼“å†²</span></span><br><span class="line"><span class="attr">query_cache_limit</span> = <span class="number">2</span>M</span><br><span class="line"><span class="comment">#æŒ‡å®šå•ä¸ªæŸ¥è¯¢èƒ½å¤Ÿä½¿ç”¨çš„ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤1M</span></span><br><span class="line"><span class="attr">key_buffer_size</span> = <span class="number">4</span>M</span><br><span class="line"><span class="comment">#æŒ‡å®šç”¨äºç´¢å¼•çš„ç¼“å†²åŒºå¤§å°ï¼Œå¢åŠ å®ƒå¯å¾—åˆ°æ›´å¥½å¤„ç†çš„ç´¢å¼•(å¯¹æ‰€æœ‰è¯»å’Œå¤šé‡å†™)ï¼Œåˆ°ä½ èƒ½è´Ÿæ‹…å¾—èµ·é‚£æ ·å¤šã€‚å¦‚æœä½ ä½¿å®ƒå¤ªå¤§ï¼Œ</span></span><br><span class="line"><span class="comment"># ç³»ç»Ÿå°†å¼€å§‹æ¢é¡µå¹¶ä¸”çœŸçš„å˜æ…¢äº†ã€‚å¯¹äºå†…å­˜åœ¨4GBå·¦å³çš„æœåŠ¡å™¨è¯¥å‚æ•°å¯è®¾ç½®ä¸º384Mæˆ–512Mã€‚é€šè¿‡æ£€æŸ¥çŠ¶æ€å€¼Key_read_requestså’ŒKey_readsï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ä»¥çŸ¥é“key_buffer_sizeè®¾ç½®æ˜¯å¦åˆç†ã€‚æ¯”ä¾‹key_reads/key_read_requestsåº”è¯¥å°½å¯èƒ½çš„ä½ï¼Œ</span></span><br><span class="line"><span class="comment"># è‡³å°‘æ˜¯1:100ï¼Œ1:1000æ›´å¥½(ä¸Šè¿°çŠ¶æ€å€¼å¯ä»¥ä½¿ç”¨SHOW STATUS LIKE 'key_read%'è·å¾—)ã€‚æ³¨æ„ï¼šè¯¥å‚æ•°å€¼è®¾ç½®çš„è¿‡å¤§åè€Œä¼šæ˜¯æœåŠ¡å™¨æ•´ä½“æ•ˆç‡é™ä½</span></span><br><span class="line"><span class="attr">ft_min_word_len</span> = <span class="number">4</span></span><br><span class="line"><span class="comment"># åˆ†è¯è¯æ±‡æœ€å°é•¿åº¦ï¼Œé»˜è®¤4</span></span><br><span class="line"><span class="attr">transaction_isolation</span> = REPEATABLE-READ</span><br><span class="line"><span class="comment"># MySQLæ”¯æŒ4ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯ï¼š</span></span><br><span class="line"><span class="comment"># READ-UNCOMMITTED, READ-COMMITTED, REPEATABLE-READ, SERIALIZABLE.</span></span><br><span class="line"><span class="comment"># å¦‚æ²¡æœ‰æŒ‡å®šï¼ŒMySQLé»˜è®¤é‡‡ç”¨çš„æ˜¯REPEATABLE-READï¼ŒORACLEé»˜è®¤çš„æ˜¯READ-COMMITTED</span></span><br><span class="line"><span class="attr">log_bin</span> = mysql-bin</span><br><span class="line"><span class="attr">binlog_format</span> = mixed</span><br><span class="line"><span class="comment">#è¶…è¿‡30å¤©çš„binlogåˆ é™¤</span></span><br><span class="line"><span class="attr">expire_logs_days</span> = <span class="number">30</span> </span><br><span class="line"><span class="comment">#é”™è¯¯æ—¥å¿—è·¯å¾„</span></span><br><span class="line"><span class="attr">log_error</span> = /usr/local/lnmp/mysql-<span class="number">5.6</span>.<span class="number">37</span>/data/mysql.err</span><br><span class="line"><span class="attr">slow_query_log</span> = <span class="number">1</span></span><br><span class="line"><span class="comment">#æ…¢æŸ¥è¯¢æ—¶é—´ è¶…è¿‡1ç§’åˆ™ä¸ºæ…¢æŸ¥è¯¢</span></span><br><span class="line"><span class="attr">long_query_time</span> = <span class="number">1</span> </span><br><span class="line"><span class="attr">slow_query_log_file</span> = /usr/local/lnmp/mysql-<span class="number">5.6</span>.<span class="number">37</span>/data/mysql-slow.log</span><br><span class="line"><span class="attr">performance_schema</span> = <span class="number">0</span></span><br><span class="line">explicit_defaults_for_timestamp</span><br><span class="line"><span class="comment">#ä¸åŒºåˆ†å¤§å°å†™</span></span><br><span class="line"><span class="comment">#lower_case_table_names = 1 </span></span><br><span class="line"><span class="comment">#MySQLé€‰é¡¹ä»¥é¿å…å¤–éƒ¨é”å®šã€‚è¯¥é€‰é¡¹é»˜è®¤å¼€å¯</span></span><br><span class="line">skip-external-locking </span><br><span class="line"><span class="comment">#é»˜è®¤å­˜å‚¨å¼•æ“</span></span><br><span class="line"><span class="attr">default-storage-engine</span> = InnoDB </span><br><span class="line"><span class="attr">innodb_file_per_table</span> = <span class="number">1</span></span><br><span class="line"><span class="comment"># InnoDBä¸ºç‹¬ç«‹è¡¨ç©ºé—´æ¨¡å¼ï¼Œæ¯ä¸ªæ•°æ®åº“çš„æ¯ä¸ªè¡¨éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ•°æ®ç©ºé—´</span></span><br><span class="line"><span class="comment"># ç‹¬ç«‹è¡¨ç©ºé—´ä¼˜ç‚¹ï¼š</span></span><br><span class="line"><span class="comment"># 1ï¼æ¯ä¸ªè¡¨éƒ½æœ‰è‡ªå·²ç‹¬ç«‹çš„è¡¨ç©ºé—´ã€‚</span></span><br><span class="line"><span class="comment"># 2ï¼æ¯ä¸ªè¡¨çš„æ•°æ®å’Œç´¢å¼•éƒ½ä¼šå­˜åœ¨è‡ªå·²çš„è¡¨ç©ºé—´ä¸­ã€‚</span></span><br><span class="line"><span class="comment"># 3ï¼å¯ä»¥å®ç°å•è¡¨åœ¨ä¸åŒçš„æ•°æ®åº“ä¸­ç§»åŠ¨ã€‚</span></span><br><span class="line"><span class="comment"># 4ï¼ç©ºé—´å¯ä»¥å›æ”¶ï¼ˆé™¤drop tableæ“ä½œå¤„ï¼Œè¡¨ç©ºä¸èƒ½è‡ªå·²å›æ”¶ï¼‰</span></span><br><span class="line"><span class="comment"># ç¼ºç‚¹ï¼š</span></span><br><span class="line"><span class="comment"># å•è¡¨å¢åŠ è¿‡å¤§ï¼Œå¦‚è¶…è¿‡100G</span></span><br><span class="line"><span class="comment"># ç»“è®ºï¼š</span></span><br><span class="line"><span class="comment"># å…±äº«è¡¨ç©ºé—´åœ¨Insertæ“ä½œä¸Šå°‘æœ‰ä¼˜åŠ¿ã€‚å…¶å®ƒéƒ½æ²¡ç‹¬ç«‹è¡¨ç©ºé—´è¡¨ç°å¥½ã€‚å½“å¯ç”¨ç‹¬ç«‹è¡¨ç©ºé—´æ—¶ï¼Œè¯·åˆç†è°ƒæ•´ï¼šinnodb_open_files</span></span><br><span class="line"><span class="attr">innodb_open_files</span> = <span class="number">500</span></span><br><span class="line"><span class="comment"># é™åˆ¶Innodbèƒ½æ‰“å¼€çš„è¡¨çš„æ•°æ®ï¼Œå¦‚æœåº“é‡Œçš„è¡¨ç‰¹åˆ«å¤šçš„æƒ…å†µï¼Œè¯·å¢åŠ è¿™ä¸ªã€‚è¿™ä¸ªå€¼é»˜è®¤æ˜¯300</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="number">64</span>M</span><br><span class="line"><span class="comment"># InnoDBä½¿ç”¨ä¸€ä¸ªç¼“å†²æ± æ¥ä¿å­˜ç´¢å¼•å’ŒåŸå§‹æ•°æ®, ä¸åƒMyISAM.</span></span><br><span class="line"><span class="comment"># è¿™é‡Œä½ è®¾ç½®è¶Šå¤§,ä½ åœ¨å­˜å–è¡¨é‡Œé¢æ•°æ®æ—¶æ‰€éœ€è¦çš„ç£ç›˜I/Oè¶Šå°‘.</span></span><br><span class="line"><span class="comment"># åœ¨ä¸€ä¸ªç‹¬ç«‹ä½¿ç”¨çš„æ•°æ®åº“æœåŠ¡å™¨ä¸Š,ä½ å¯ä»¥è®¾ç½®è¿™ä¸ªå˜é‡åˆ°æœåŠ¡å™¨ç‰©ç†å†…å­˜å¤§å°çš„80%</span></span><br><span class="line"><span class="comment"># ä¸è¦è®¾ç½®è¿‡å¤§,å¦åˆ™,ç”±äºç‰©ç†å†…å­˜çš„ç«äº‰å¯èƒ½å¯¼è‡´æ“ä½œç³»ç»Ÿçš„æ¢é¡µé¢ ç°¸.</span></span><br><span class="line"><span class="comment"># æ³¨æ„åœ¨32ä½ç³»ç»Ÿä¸Šä½ æ¯ä¸ªè¿›ç¨‹å¯èƒ½è¢«é™åˆ¶åœ¨ 2-3.5G ç”¨æˆ·å±‚é¢å†…å­˜é™åˆ¶,</span></span><br><span class="line"><span class="comment"># æ‰€ä»¥ä¸è¦è®¾ç½®çš„å¤ªé«˜.</span></span><br><span class="line"><span class="attr">innodb_write_io_threads</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">innodb_read_io_threads</span> = <span class="number">4</span></span><br><span class="line"><span class="comment"># innodbä½¿ç”¨åå°çº¿ç¨‹å¤„ç†æ•°æ®é¡µä¸Šçš„è¯»å†™ I/O(è¾“å…¥è¾“å‡º)è¯·æ±‚,æ ¹æ®ä½ çš„ CPU æ ¸æ•°æ¥æ›´æ”¹,é»˜è®¤æ˜¯4</span></span><br><span class="line"><span class="comment"># æ³¨:è¿™ä¸¤ä¸ªå‚æ•°ä¸æ”¯æŒåŠ¨æ€æ”¹å˜,éœ€è¦æŠŠè¯¥å‚æ•°åŠ å…¥åˆ°my.cnfé‡Œï¼Œä¿®æ”¹å®Œåé‡å¯MySQLæœåŠ¡,å…è®¸å€¼çš„èŒƒå›´ä» 1-64</span></span><br><span class="line"><span class="attr">innodb_thread_concurrency</span> = <span class="number">0</span></span><br><span class="line"><span class="comment"># é»˜è®¤è®¾ç½®ä¸º 0,è¡¨ç¤ºä¸é™åˆ¶å¹¶å‘æ•°ï¼Œè¿™é‡Œæ¨èè®¾ç½®ä¸º0ï¼Œæ›´å¥½å»å‘æŒ¥CPUå¤šæ ¸å¤„ç†èƒ½åŠ›ï¼Œæé«˜å¹¶å‘é‡</span></span><br><span class="line"><span class="attr">innodb_purge_threads</span> = <span class="number">1</span></span><br><span class="line"><span class="comment"># InnoDBä¸­çš„æ¸…é™¤æ“ä½œæ˜¯ä¸€ç±»å®šæœŸå›æ”¶æ— ç”¨æ•°æ®çš„æ“ä½œã€‚åœ¨ä¹‹å‰çš„å‡ ä¸ªç‰ˆæœ¬ä¸­ï¼Œæ¸…é™¤æ“ä½œæ˜¯ä¸»çº¿ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ„å‘³ç€è¿è¡Œæ—¶å®ƒå¯èƒ½ä¼šå µå¡å…¶å®ƒçš„æ•°æ®åº“æ“ä½œã€‚</span></span><br><span class="line"><span class="comment"># ä»MySQL5.5.Xç‰ˆæœ¬å¼€å§‹ï¼Œè¯¥æ“ä½œè¿è¡Œäºç‹¬ç«‹çš„çº¿ç¨‹ä¸­,å¹¶æ”¯æŒæ›´å¤šçš„å¹¶å‘æ•°ã€‚ç”¨æˆ·å¯é€šè¿‡è®¾ç½®innodb_purge_threadsé…ç½®å‚æ•°æ¥é€‰æ‹©æ¸…é™¤æ“ä½œæ˜¯å¦ä½¿ç”¨å•</span></span><br><span class="line"><span class="comment"># ç‹¬çº¿ç¨‹,é»˜è®¤æƒ…å†µä¸‹å‚æ•°è®¾ç½®ä¸º0(ä¸ä½¿ç”¨å•ç‹¬çº¿ç¨‹),è®¾ç½®ä¸º 1 æ—¶è¡¨ç¤ºä½¿ç”¨å•ç‹¬çš„æ¸…é™¤çº¿ç¨‹ã€‚å»ºè®®ä¸º1</span></span><br><span class="line"><span class="attr">innodb_flush_log_at_trx_commit</span> = <span class="number">2</span></span><br><span class="line"><span class="comment"># 0ï¼šå¦‚æœinnodb_flush_log_at_trx_commitçš„å€¼ä¸º0,log bufferæ¯ç§’å°±ä¼šè¢«åˆ·å†™æ—¥å¿—æ–‡ä»¶åˆ°ç£ç›˜ï¼Œæäº¤äº‹åŠ¡çš„æ—¶å€™ä¸åšä»»ä½•æ“ä½œï¼ˆæ‰§è¡Œæ˜¯ç”±mysqlçš„master threadçº¿ç¨‹æ¥æ‰§è¡Œçš„ã€‚</span></span><br><span class="line"><span class="comment"># ä¸»çº¿ç¨‹ä¸­æ¯ç§’ä¼šå°†é‡åšæ—¥å¿—ç¼“å†²å†™å…¥ç£ç›˜çš„é‡åšæ—¥å¿—æ–‡ä»¶(REDO LOG)ä¸­ã€‚ä¸è®ºäº‹åŠ¡æ˜¯å¦å·²ç»æäº¤ï¼‰é»˜è®¤çš„æ—¥å¿—æ–‡ä»¶æ˜¯ib_logfile0,ib_logfile1</span></span><br><span class="line"><span class="comment"># 1ï¼šå½“è®¾ä¸ºé»˜è®¤å€¼1çš„æ—¶å€™ï¼Œæ¯æ¬¡æäº¤äº‹åŠ¡çš„æ—¶å€™ï¼Œéƒ½ä¼šå°†log bufferåˆ·å†™åˆ°æ—¥å¿—ã€‚</span></span><br><span class="line"><span class="comment"># 2ï¼šå¦‚æœè®¾ä¸º2,æ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¼šå†™æ—¥å¿—ï¼Œä½†å¹¶ä¸ä¼šæ‰§è¡Œåˆ·çš„æ“ä½œã€‚æ¯ç§’å®šæ—¶ä¼šåˆ·åˆ°æ—¥å¿—æ–‡ä»¶ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸èƒ½ä¿è¯100%æ¯ç§’ä¸€å®šéƒ½ä¼šåˆ·åˆ°ç£ç›˜ï¼Œè¿™è¦å–å†³äºè¿›ç¨‹çš„è°ƒåº¦ã€‚</span></span><br><span class="line"><span class="comment"># æ¯æ¬¡äº‹åŠ¡æäº¤çš„æ—¶å€™å°†æ•°æ®å†™å…¥äº‹åŠ¡æ—¥å¿—ï¼Œè€Œè¿™é‡Œçš„å†™å…¥ä»…æ˜¯è°ƒç”¨äº†æ–‡ä»¶ç³»ç»Ÿçš„å†™å…¥æ“ä½œï¼Œè€Œæ–‡ä»¶ç³»ç»Ÿæ˜¯æœ‰ ç¼“å­˜çš„ï¼Œæ‰€ä»¥è¿™ä¸ªå†™å…¥å¹¶ä¸èƒ½ä¿è¯æ•°æ®å·²ç»å†™å…¥åˆ°ç‰©ç†ç£ç›˜</span></span><br><span class="line"><span class="comment"># é»˜è®¤å€¼1æ˜¯ä¸ºäº†ä¿è¯å®Œæ•´çš„ACIDã€‚å½“ç„¶ï¼Œä½ å¯ä»¥å°†è¿™ä¸ªé…ç½®é¡¹è®¾ä¸º1ä»¥å¤–çš„å€¼æ¥æ¢å–æ›´é«˜çš„æ€§èƒ½ï¼Œä½†æ˜¯åœ¨ç³»ç»Ÿå´©æºƒçš„æ—¶å€™ï¼Œä½ å°†ä¼šä¸¢å¤±1ç§’çš„æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment"># è®¾ä¸º0çš„è¯ï¼Œmysqldè¿›ç¨‹å´©æºƒçš„æ—¶å€™ï¼Œå°±ä¼šä¸¢å¤±æœ€å1ç§’çš„äº‹åŠ¡ã€‚è®¾ä¸º2,åªæœ‰åœ¨æ“ä½œç³»ç»Ÿå´©æºƒæˆ–è€…æ–­ç”µçš„æ—¶å€™æ‰ä¼šä¸¢å¤±æœ€å1ç§’çš„æ•°æ®ã€‚InnoDBåœ¨åšæ¢å¤çš„æ—¶å€™ä¼šå¿½ç•¥è¿™ä¸ªå€¼ã€‚</span></span><br><span class="line"><span class="comment"># æ€»ç»“</span></span><br><span class="line"><span class="comment"># è®¾ä¸º1å½“ç„¶æ˜¯æœ€å®‰å…¨çš„ï¼Œä½†æ€§èƒ½é¡µæ˜¯æœ€å·®çš„ï¼ˆç›¸å¯¹å…¶ä»–ä¸¤ä¸ªå‚æ•°è€Œè¨€ï¼Œä½†ä¸æ˜¯ä¸èƒ½æ¥å—ï¼‰ã€‚å¦‚æœå¯¹æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§è¦æ±‚ä¸é«˜ï¼Œå®Œå…¨å¯ä»¥è®¾ä¸º2ï¼Œå¦‚æœåªæœ€æ±‚æ€§èƒ½ï¼Œä¾‹å¦‚é«˜å¹¶å‘å†™çš„æ—¥å¿—æœåŠ¡å™¨ï¼Œè®¾ä¸º0æ¥è·å¾—æ›´é«˜æ€§èƒ½</span></span><br><span class="line"><span class="attr">innodb_log_buffer_size</span> = <span class="number">2</span>M</span><br><span class="line"><span class="comment"># æ­¤å‚æ•°ç¡®å®šäº›æ—¥å¿—æ–‡ä»¶æ‰€ç”¨çš„å†…å­˜å¤§å°ï¼Œä»¥Mä¸ºå•ä½ã€‚ç¼“å†²åŒºæ›´å¤§èƒ½æé«˜æ€§èƒ½ï¼Œä½†æ„å¤–çš„æ•…éšœå°†ä¼šä¸¢å¤±æ•°æ®ã€‚MySQLå¼€å‘äººå‘˜å»ºè®®è®¾ç½®ä¸º1ï¼8Mä¹‹é—´</span></span><br><span class="line"><span class="attr">innodb_log_file_size</span> = <span class="number">32</span>M</span><br><span class="line"><span class="comment"># æ­¤å‚æ•°ç¡®å®šæ•°æ®æ—¥å¿—æ–‡ä»¶çš„å¤§å°ï¼Œæ›´å¤§çš„è®¾ç½®å¯ä»¥æé«˜æ€§èƒ½ï¼Œä½†ä¹Ÿä¼šå¢åŠ æ¢å¤æ•…éšœæ•°æ®åº“æ‰€éœ€çš„æ—¶é—´</span></span><br><span class="line"><span class="attr">innodb_log_files_in_group</span> = <span class="number">3</span></span><br><span class="line"><span class="comment"># ä¸ºæé«˜æ€§èƒ½ï¼ŒMySQLå¯ä»¥ä»¥å¾ªç¯æ–¹å¼å°†æ—¥å¿—æ–‡ä»¶å†™åˆ°å¤šä¸ªæ–‡ä»¶ã€‚æ¨èè®¾ç½®ä¸º3</span></span><br><span class="line"><span class="attr">innodb_max_dirty_pages_pct</span> = <span class="number">90</span></span><br><span class="line"><span class="comment"># innodbä¸»çº¿ç¨‹åˆ·æ–°ç¼“å­˜æ± ä¸­çš„æ•°æ®ï¼Œä½¿è„æ•°æ®æ¯”ä¾‹å°äº90%</span></span><br><span class="line"><span class="attr">innodb_lock_wait_timeout</span> = <span class="number">120</span> </span><br><span class="line"><span class="comment"># InnoDBäº‹åŠ¡åœ¨è¢«å›æ»šä¹‹å‰å¯ä»¥ç­‰å¾…ä¸€ä¸ªé”å®šçš„è¶…æ—¶ç§’æ•°ã€‚InnoDBåœ¨å®ƒè‡ªå·±çš„é”å®šè¡¨ä¸­è‡ªåŠ¨æ£€æµ‹äº‹åŠ¡æ­»é”å¹¶ä¸”å›æ»šäº‹åŠ¡ã€‚InnoDBç”¨LOCK TABLESè¯­å¥æ³¨æ„åˆ°é”å®šè®¾ç½®ã€‚é»˜è®¤å€¼æ˜¯50ç§’</span></span><br><span class="line"><span class="attr">bulk_insert_buffer_size</span> = <span class="number">8</span>M</span><br><span class="line"><span class="comment"># æ‰¹é‡æ’å…¥ç¼“å­˜å¤§å°ï¼Œ è¿™ä¸ªå‚æ•°æ˜¯é’ˆå¯¹MyISAMå­˜å‚¨å¼•æ“æ¥è¯´çš„ã€‚é€‚ç”¨äºåœ¨ä¸€æ¬¡æ€§æ’å…¥100-1000+æ¡è®°å½•æ—¶ï¼Œ æé«˜æ•ˆç‡ã€‚é»˜è®¤å€¼æ˜¯8Mã€‚å¯ä»¥é’ˆå¯¹æ•°æ®é‡çš„å¤§å°ï¼Œç¿»å€å¢åŠ ã€‚</span></span><br><span class="line"><span class="attr">myisam_sort_buffer_size</span> = <span class="number">8</span>M</span><br><span class="line"><span class="comment"># MyISAMè®¾ç½®æ¢å¤è¡¨ä¹‹æ—¶ä½¿ç”¨çš„ç¼“å†²åŒºçš„å°ºå¯¸ï¼Œå½“åœ¨REPAIR TABLEæˆ–ç”¨CREATE INDEXåˆ›å»ºç´¢å¼•æˆ–ALTER TABLEè¿‡ç¨‹ä¸­æ’åº MyISAMç´¢å¼•åˆ†é…çš„ç¼“å†²åŒº</span></span><br><span class="line"><span class="attr">myisam_max_sort_file_size</span> = <span class="number">10</span>G</span><br><span class="line"><span class="comment"># å¦‚æœä¸´æ—¶æ–‡ä»¶ä¼šå˜å¾—è¶…è¿‡ç´¢å¼•ï¼Œä¸è¦ä½¿ç”¨å¿«é€Ÿæ’åºç´¢å¼•æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªç´¢å¼•ã€‚æ³¨é‡Šï¼šè¿™ä¸ªå‚æ•°ä»¥å­—èŠ‚çš„å½¢å¼ç»™å‡º</span></span><br><span class="line"><span class="attr">myisam_repair_threads</span> = <span class="number">1</span></span><br><span class="line"><span class="comment"># å¦‚æœè¯¥å€¼å¤§äº1ï¼Œåœ¨Repair by sortingè¿‡ç¨‹ä¸­å¹¶è¡Œåˆ›å»ºMyISAMè¡¨ç´¢å¼•(æ¯ä¸ªç´¢å¼•åœ¨è‡ªå·±çš„çº¿ç¨‹å†…) </span></span><br><span class="line"><span class="attr">interactive_timeout</span> = <span class="number">28800</span></span><br><span class="line"><span class="comment"># æœåŠ¡å™¨å…³é—­äº¤äº’å¼è¿æ¥å‰ç­‰å¾…æ´»åŠ¨çš„ç§’æ•°ã€‚äº¤äº’å¼å®¢æˆ·ç«¯å®šä¹‰ä¸ºåœ¨mysql_real_connect()ä¸­ä½¿ç”¨CLIENT_INTERACTIVEé€‰é¡¹çš„å®¢æˆ·ç«¯ã€‚é»˜è®¤å€¼ï¼š28800ç§’ï¼ˆ8å°æ—¶ï¼‰</span></span><br><span class="line"><span class="attr">wait_timeout</span> = <span class="number">28800</span></span><br><span class="line"><span class="comment"># æœåŠ¡å™¨å…³é—­éäº¤äº’è¿æ¥ä¹‹å‰ç­‰å¾…æ´»åŠ¨çš„ç§’æ•°ã€‚åœ¨çº¿ç¨‹å¯åŠ¨æ—¶ï¼Œæ ¹æ®å…¨å±€wait_timeoutå€¼æˆ–å…¨å±€interactive_timeoutå€¼åˆå§‹åŒ–ä¼šè¯wait_timeoutå€¼ï¼Œ</span></span><br><span class="line"><span class="comment"># å–å†³äºå®¢æˆ·ç«¯ç±»å‹(ç”±mysql_real_connect()çš„è¿æ¥é€‰é¡¹CLIENT_INTERACTIVEå®šä¹‰)ã€‚å‚æ•°é»˜è®¤å€¼ï¼š28800ç§’ï¼ˆ8å°æ—¶ï¼‰</span></span><br><span class="line"><span class="comment"># MySQLæœåŠ¡å™¨æ‰€æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°æ˜¯æœ‰ä¸Šé™çš„ï¼Œå› ä¸ºæ¯ä¸ªè¿æ¥çš„å»ºç«‹éƒ½ä¼šæ¶ˆè€—å†…å­˜ï¼Œå› æ­¤æˆ‘ä»¬å¸Œæœ›å®¢æˆ·ç«¯åœ¨è¿æ¥åˆ°MySQL Serverå¤„ç†å®Œç›¸åº”çš„æ“ä½œåï¼Œ</span></span><br><span class="line"><span class="comment"># åº”è¯¥æ–­å¼€è¿æ¥å¹¶é‡Šæ”¾å ç”¨çš„å†…å­˜ã€‚å¦‚æœä½ çš„MySQL Serveræœ‰å¤§é‡çš„é—²ç½®è¿æ¥ï¼Œä»–ä»¬ä¸ä»…ä¼šç™½ç™½æ¶ˆè€—å†…å­˜ï¼Œè€Œä¸”å¦‚æœè¿æ¥ä¸€ç›´åœ¨ç´¯åŠ è€Œä¸æ–­å¼€ï¼Œ</span></span><br><span class="line"><span class="comment"># æœ€ç»ˆè‚¯å®šä¼šè¾¾åˆ°MySQL Serverçš„è¿æ¥ä¸Šé™æ•°ï¼Œè¿™ä¼šæŠ¥'too many connections'çš„é”™è¯¯ã€‚å¯¹äºwait_timeoutçš„å€¼è®¾å®šï¼Œåº”è¯¥æ ¹æ®ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µæ¥åˆ¤æ–­ã€‚</span></span><br><span class="line"><span class="comment"># åœ¨ç³»ç»Ÿè¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå¯ä»¥é€šè¿‡show processlistå‘½ä»¤æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„è¿æ¥çŠ¶æ€ï¼Œå¦‚æœå‘ç°æœ‰å¤§é‡çš„sleepçŠ¶æ€çš„è¿æ¥è¿›ç¨‹ï¼Œåˆ™è¯´æ˜è¯¥å‚æ•°è®¾ç½®çš„è¿‡å¤§ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ä»¥è¿›è¡Œé€‚å½“çš„è°ƒæ•´å°äº›ã€‚è¦åŒæ—¶è®¾ç½®interactive_timeoutå’Œwait_timeoutæ‰ä¼šç”Ÿæ•ˆã€‚</span></span><br><span class="line"><span class="section">[mysqldump]</span></span><br><span class="line">quick</span><br><span class="line"><span class="comment">#æœåŠ¡å™¨å‘é€å’Œæ¥å—çš„æœ€å¤§åŒ…é•¿åº¦</span></span><br><span class="line"><span class="attr">max_allowed_packet</span> = <span class="number">16</span>M </span><br><span class="line"><span class="section">[myisamchk]</span></span><br><span class="line"><span class="attr">key_buffer_size</span> = <span class="number">8</span>M</span><br><span class="line"><span class="attr">sort_buffer_size</span> = <span class="number">8</span>M</span><br><span class="line"><span class="attr">read_buffer</span> = <span class="number">4</span>M</span><br><span class="line"><span class="attr">write_buffer</span> = <span class="number">4</span>M</span><br></pre></td></tr></table></figure><p>è¿™äº›é…ç½®åœ¨é»˜è®¤ç”Ÿæˆçš„æ–‡ä»¶ä¸­éƒ½æ²¡æœ‰ï¼Œmysqlæ”¯æŒå¯åŠ¨æ—¶è®¾ç½®å‚æ•°ã€‚</p><h3 id="4-3-å¯åŠ¨"><a href="#4-3-å¯åŠ¨" class="headerlink" title="4.3 å¯åŠ¨"></a>4.3 å¯åŠ¨</h3><p>å¯¹äºmysqlçš„å¯åŠ¨ï¼Œæ–¹å¼æ¯”è¾ƒå¤š</p><p><strong>mysqld_safeå¯åŠ¨</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/lnmp/mysql-5.6.37/bin/mysqld_safe --user=mysql</span><br></pre></td></tr></table></figure><p><strong>mysqldå¯åŠ¨</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/lnmp/mysql-5.6.37/bin/mysqld --user=mysql --explicit_defaults_for_timestamp</span><br></pre></td></tr></table></figure><p><strong>init.då¯åŠ¨</strong>ï¼šéœ€è¦å°†support-files/mysql.serveræ‹·è´åˆ°/etc/init.d/mysql.server</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp support-files/mysql.server /etc/init.d/mysql.server</span><br><span class="line">/etc/init.d/mysql.server [start|stop|restart|reload|force-reload|status]</span><br></pre></td></tr></table></figure><h2 id="5-PHPå®‰è£…"><a href="#5-PHPå®‰è£…" class="headerlink" title="5 PHPå®‰è£…"></a>5 PHPå®‰è£…</h2><h3 id="5-1-ç¼–è¯‘å®‰è£…"><a href="#5-1-ç¼–è¯‘å®‰è£…" class="headerlink" title="5.1 ç¼–è¯‘å®‰è£…"></a>5.1 ç¼–è¯‘å®‰è£…</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è§£å‹æºæ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/lnmp/src</span><br><span class="line">tar -zxf php-5.5.38.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> php-5.5.38</span><br><span class="line"><span class="comment">#é…ç½®ç¼–è¯‘é€‰é¡¹ï¼ˆè¿™é‡Œé»˜è®¤ç¼–è¯‘pdoï¼Œfpmï¼Œmysqlæ¨¡å—ï¼Œæ›´å¤šç¼–è¯‘é€‰é¡¹å¯ä»¥é€šè¿‡configure --help æŸ¥çœ‹ï¼‰</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/lnmp/php-5.5.38 --<span class="built_in">enable</span>-fpm --<span class="built_in">enable</span>-mysqlnd --with-mysql --with-mysqli --with-pdo-mysql</span><br><span class="line"></span><br><span class="line">make </span><br><span class="line"><span class="comment">#makeå®Œæˆåï¼Œä¼šæç¤ºè¿›è¡Œmake testï¼Œè¿™ä¸€æ­¥å¯ä»¥ä¸åšï¼Œä½†æ˜¯å»ºè®®åšä¸€ä¸‹</span></span><br><span class="line">make <span class="built_in">test</span> </span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h3 id="5-2-é…ç½®PHP"><a href="#5-2-é…ç½®PHP" class="headerlink" title="5.2 é…ç½®PHP"></a>5.2 é…ç½®PHP</h3><pre><code>PHPé…ç½®åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯fpmçš„é…ç½®ï¼Œå› ä¸ºæˆ‘ä»¬nginxå’Œphpè¿›è¡Œäº¤äº’æ˜¯é‡‡ç”¨fpmçš„å½¢å¼è¿›è¡Œçš„ï¼›å¦ä¸€éƒ¨åˆ†ä¸ºphp.iniï¼Œphpå…¨å±€é…ç½®ã€‚php.iniå»æºç ç›®å½•æ‹·è´ä¸€ä»½ä¾¿å¯ã€‚</code></pre><p><strong>php.ini</strong></p><p>å­˜æ”¾ç›®å½•ï¼š/usr/local/lnmp/php-5.5.38/libï¼ŒåŸºæœ¬ä¸Šå®‰è£…å®Œæ¯•ï¼Œæ‹·è´åˆ°æ­¤ç›®å½•åŸºæœ¬ä¸éœ€è¦ä¿®æ”¹å³å¯è¿è¡Œï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•ç½—åˆ—ä¸€äº›åŸºæœ¬çš„é…ç½®ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[PHP]</span></span><br><span class="line"><span class="comment">; è¾“å‡ºç¼“å­˜å…è®¸ä½ ç”š åœ¨è¾“å‡ºæ­£ å†…å®¹ä¹‹åå‘é€ header(æ ‡å¤´ï¼ŒåŒ…æ‹¬cookies)    ; æˆ–è€…åœ¨è¿™ å°†æŒ‡ç¤ºè®¾ä¸º On  ä½¿å¾—æ‰€æœ‰ ä»¶çš„è¾“å‡ºç¼“å­˜æ‰“å¼€ã€‚</span></span><br><span class="line"><span class="attr">output_buffering</span> = <span class="literal">Off</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">; å¼ºåˆ¶flush(åˆ·æ–°)è®©PHP å‘Šè¯‰è¾“å‡ºå±‚åœ¨æ¯ä¸ªè¾“å‡ºå—ä¹‹å åŠ¨åˆ·æ–° èº«æ•°æ®ï¼Œå»ºè®®ä»…åœ¨debugè¿‡ç¨‹ä¸­æ‰“å¼€ã€‚</span></span><br><span class="line"><span class="attr">implicit_flush</span> = <span class="literal">Off</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">; æ¯ä¸ªè„šæœ¬çš„æœ€ æ‰§ æ—¶é—´, æŒ‰ç§’è®¡</span></span><br><span class="line"><span class="attr">max_execution_time</span> = <span class="number">30</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">; ä¸ªè„šæœ¬æœ€å¤šå¯ä½¿çš„å†…å­˜æ€»å¤§å°(è¿™é‡Œæ˜¯8MB)</span></span><br><span class="line"><span class="attr">memory_limit</span> = <span class="number">1024</span> </span><br><span class="line"></span><br><span class="line"><span class="section">[Date]</span></span><br><span class="line">date.timezone =Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment">; E_ALL - æ‰€æœ‰çš„é”™è¯¯å’Œè­¦å‘Š  </span></span><br><span class="line"><span class="comment">; E_ERROR - è‡´å‘½æ€§è¿ æ—¶é”™  </span></span><br><span class="line"><span class="comment">; E_WARNING - è¿ æ—¶è­¦å‘Š( è‡´å‘½æ€§é”™)  </span></span><br><span class="line"><span class="comment">; E_PARSE - ç¼–è¯‘æ—¶è§£æé”™è¯¯  </span></span><br><span class="line"><span class="comment">; E_NOTICE - è¿ æ—¶æé†’</span></span><br><span class="line"><span class="comment">; error_reporting = E_ALL &amp; ~E_NOTICE ; æ˜¾ç¤ºæ‰€æœ‰çš„é”™è¯¯ï¼Œé™¤ æé†’  </span></span><br><span class="line"><span class="comment">; error_reporting = E_COMPILE_ERROR|E_ERROR|E_CORE_ERROR ; ä»…æ˜¾ç¤ºé”™ è¯¯ </span></span><br><span class="line"><span class="comment">; æ˜¾ç¤ºæ‰€æœ‰çš„é”™è¯¯ï¼Œé™¤äº†æé†’  </span></span><br><span class="line"><span class="attr">error_reporting</span> = E_ALL &amp; ~E_NOTICE </span><br><span class="line"><span class="comment">; æ˜¾ç¤ºå‡ºé”™è¯¯ä¿¡æ¯(ä½œä¸ºè¾“å‡ºçš„ä¸€éƒ¨åˆ†)</span></span><br><span class="line"><span class="attr">display_errors</span> = <span class="literal">On</span></span><br><span class="line"><span class="attr">log_errors</span> = <span class="literal">Off</span></span><br><span class="line"><span class="attr">error_log</span> = logs/error.log</span><br><span class="line"><span class="attr">default_mimetype</span> = <span class="string">"text/html"</span></span><br><span class="line"><span class="comment">;default_charset = "iso-8859-1"</span></span><br><span class="line"><span class="comment">; å­˜æ”¾å¯åŠ è½½çš„æ‰©å……åº“(æ¨¡å—)çš„ å½•</span></span><br><span class="line"><span class="attr">extension_dir</span> = <span class="string">"./"</span></span><br><span class="line"><span class="comment">;extension=msql.so</span></span><br><span class="line"><span class="comment">; è¿™æ¡æŒ‡ç¤ºå‘Šè¯‰PHPæ˜¯å¦å£°æ˜argvå’Œargcå˜é‡æ•° (æ³¨:è¿™ argvä¸ºæ•°ç»„,argcä¸ºå˜é‡æ•°)</span></span><br><span class="line"><span class="attr">register_argc_argv</span>=<span class="literal">On</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; PHPå°†æ¥å—çš„POSTæ•°æ®æœ€å¤§å¤§å°ã€‚</span></span><br><span class="line"><span class="attr">post_max_size</span> = <span class="number">8</span>M</span><br><span class="line"></span><br><span class="line"><span class="comment">; æ˜¯å¦å…è®¸HTTPæ–¹å¼æ–‡ä»¶ä¸Šè½½</span></span><br><span class="line"><span class="attr">file_uploads</span> = <span class="literal">On</span> </span><br><span class="line"><span class="comment">; å­˜æ”¾ç”¨HTTPåè®®ä¸Šè½½çš„æ–‡ä»¶çš„ä¸´æ—¶ç›®å½•(åœ¨æ²¡æŒ‡å®šæ—¶ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„)</span></span><br><span class="line"><span class="attr">upload_tmp_dir</span> = /tmp</span><br><span class="line"><span class="attr">upload_max_filesize</span> = <span class="number">2</span>M </span><br><span class="line"><span class="section">[Session]</span>  </span><br><span class="line"><span class="comment">; äºä¿å­˜/å–å›æ•°æ®çš„æ§åˆ¶æ–¹å¼   </span></span><br><span class="line">session.save_handler = files</span><br><span class="line"><span class="comment">; è¿™æ˜¯æ•°æ®æ–‡ä»¶å°†ä¿å­˜çš„è·¯å¾„   </span></span><br><span class="line">session.save_path = /tmp</span><br><span class="line"><span class="comment">; æ˜¯å¦ä½¿ç”¨cookies  </span></span><br><span class="line">session.use_cookies = 1</span><br><span class="line">session.name = PHPSESSID</span><br><span class="line"><span class="comment">; åœ¨è¯·æ±‚å¯åŠ¨æ—¶åˆå§‹åŒ–session</span></span><br><span class="line">session.auto_start = 0 </span><br><span class="line"><span class="comment">; ä¸ºæŒ‰ç§’è®°çš„cookieçš„ä¿å­˜æ—¶é—´,æˆ–ä¸º0æ—¶,ç›´åˆ°æµè§ˆå™¨è¢«é‡å¯  </span></span><br><span class="line">session.cookie_lifetime = 0 </span><br><span class="line"><span class="comment">; cookieçš„æœ‰æ•ˆè·¯å¾„  </span></span><br><span class="line">session.cookie_path = / </span><br><span class="line"><span class="comment">; cookieçš„æœ‰æ•ˆåŸŸ</span></span><br><span class="line">session.cookie_domain = </span><br><span class="line"><span class="comment">; äºè¿æ¥æ•°æ®çš„æ§åˆ¶å™¨; phpæ˜¯PHPçš„æ ‡å‡†æ§åˆ¶å™¨</span></span><br><span class="line">session.serialize_handler = php </span><br><span class="line"><span class="comment">; æŒ‰ç™¾åˆ† çš„'garbage collection(ç¢ æ•´ )'è¿›ç¨‹  </span></span><br><span class="line">session.gc_probability = 1 </span><br><span class="line"><span class="comment">; åœ¨æ¯æ¬¡ session åˆå§‹åŒ–çš„æ—¶å€™å¼€å§‹çš„å¯èƒ½æ€§ã€‚  </span></span><br><span class="line"><span class="comment">; åœ¨è¿™é‡Œæ•°å­—æ‰€æŒ‡çš„ç§’æ•°åï¼Œä¿å­˜çš„æ•°æ®å°†è¢«è§†ä¸º'ç¢ç‰‡(garbage)'å¹¶ç”±gcè¿›ç¨‹æ¸…ç†æ‰</span></span><br><span class="line">session.gc_maxlifetime = 1440</span><br><span class="line"><span class="comment">; è®¾ä¸º&#123;nocache,private,public&#125;,ä»¥å†³å®šHTTPçš„ç¼“å­˜çš„é—®é¢˜  </span></span><br><span class="line">session.cache_limiter = nocache </span><br><span class="line"><span class="comment">; æ–‡æ¡£åœ¨nåˆ†é’Ÿåè¿‡æ—¶</span></span><br><span class="line">session.cache_expire = 180</span><br></pre></td></tr></table></figure><p><strong>php-fpm.conf</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="attr">pid</span> = run/php-fpm.pid</span><br><span class="line"><span class="attr">error_log</span> = log/php-fpm.log</span><br><span class="line"></span><br><span class="line"><span class="comment">; Possible Values: alert, error, warning, notice, debug</span></span><br><span class="line"><span class="attr">log_level</span> = notice</span><br><span class="line"><span class="attr">emergency_restart_interval</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">process_control_timeout</span> = <span class="number">0</span></span><br><span class="line">process.max = 128</span><br><span class="line"><span class="comment">;process.priority = -19</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; php-fpmè¿è¡Œæ¨¡å¼ï¼Œé»˜è®¤ä¸ºåå°è¿è¡Œ</span></span><br><span class="line"><span class="attr">daemonize</span> = <span class="literal">yes</span></span><br><span class="line"><span class="comment">;rlimit_core = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; fpmä½¿ç”¨çš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œé»˜è®¤æ²¡æœ‰è®¾ç½®ï¼Œè¿›è¡Œè‡ªåŠ¨é€‰æ‹©</span></span><br><span class="line"><span class="comment">;events.mechanism = epoll</span></span><br><span class="line"><span class="section">[www]</span></span><br><span class="line"><span class="attr">user</span> = www</span><br><span class="line"><span class="attr">group</span> = www</span><br><span class="line"><span class="attr">listen</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span></span><br><span class="line"><span class="comment">;listen.backlog = 65535</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; è®¾ç½®å…è®¸é“¾æ¥çš„å®¢æˆ·ç«¯IPï¼Œé»˜è®¤ä¸ºä»»ä½•</span></span><br><span class="line"><span class="comment">;listen.allowed_clients = 127.0.0.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; å­è¿›ç¨‹æ§åˆ¶æ¨¡å¼ï¼Œåˆ†ä¸ºä¸‰ç§ï¼š</span></span><br><span class="line"><span class="comment">; staticå›ºå®šæ¨¡å¼ï¼šå­è¿›ç¨‹æ•°ä¸€ç›´ç­‰äºpm.max_children</span></span><br><span class="line"><span class="comment">; dynamicåŠ¨æ€æ¨¡å¼ï¼šå…¶å­è¿›ç¨‹æ•°é‡æ ¹æ®max_childrenã€start_serversã€min_spare_serversã€max_spare_serverså†³å®šï¼Œä½†è‡³å°‘ä¼šæœ‰ä¸€ä¸ªå­˜åœ¨</span></span><br><span class="line"><span class="comment">; ondemandæŒ‰éœ€å‹ï¼šå½“è¯·æ±‚æ¥æ—¶æ‰åˆ›å»ºï¼Œæœ€å¤§å­˜åœ¨æ•°å–å†³äºmax_childrenï¼Œprocess_idle_timeoutæŒ‡ä»¤è¡¨ç¤ºç©ºé—²æŒ‡å®šæ—¶é—´åé€€å‡º</span></span><br><span class="line"><span class="attr">pm</span> = dynamic</span><br><span class="line"></span><br><span class="line"><span class="comment">; æœ€å¤§å­è¿›ç¨‹æ•°</span></span><br><span class="line">pm.max_children = 5</span><br><span class="line"></span><br><span class="line"><span class="comment">; å¯åŠ¨æ—¶åˆ›å»ºçš„å­è¿›ç¨‹æ•°ï¼Œé»˜è®¤å€¼ä¸ºmin_spare_servers + (max_spare_servers - min_spare_servers) / 2</span></span><br><span class="line">pm.start_servers = 2</span><br><span class="line">pm.min_spare_servers = 1</span><br><span class="line">pm.max_spare_servers = 3</span><br><span class="line"><span class="comment">;pm.process_idle_timeout = 500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; å¤„ç†å®Œå¤šå°‘ä¸ªè¯·æ±‚åé‡å¯</span></span><br><span class="line"><span class="comment">;pm.max_requests = 500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; è¯·æ±‚æ—¥å¿—è®°å½•æ–‡ä»¶</span></span><br><span class="line"><span class="comment">;access.log = log/$pool.access.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; è¯·æ±‚æ—¥å¿—æ–‡ä»¶æ ¼å¼</span></span><br><span class="line"><span class="comment">;access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %&#123;mili&#125;d %&#123;kilo&#125;M %C%%"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; æ…¢æ—¥å¿—</span></span><br><span class="line"><span class="comment">;slowlog = log/$pool.log.slow</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;request_slowlog_timeout = 0</span></span><br><span class="line"><span class="comment">;request_terminate_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; æ‰“å¼€æ–‡ä»¶æ•°ï¼Œé»˜è®¤ä¸ºç³»ç»Ÿä¸Šé™</span></span><br><span class="line"><span class="comment">;rlimit_files = 1024</span></span><br></pre></td></tr></table></figure><h2 id="6-é‡åˆ°çš„é—®é¢˜"><a href="#6-é‡åˆ°çš„é—®é¢˜" class="headerlink" title="6 é‡åˆ°çš„é—®é¢˜"></a>6 é‡åˆ°çš„é—®é¢˜</h2><h3 id="6-1-nginxåˆ°php"><a href="#6-1-nginxåˆ°php" class="headerlink" title="6.1 nginxåˆ°php"></a>6.1 nginxåˆ°php</h3><blockquote><p><strong>é—®é¢˜æè¿°ï¼š</strong>2017/08/12 23:27:22 [error] 13752#0: *10 FastCGI sent in stderr: â€œPrimary script unknownâ€ while reading response header from upstream, client: 127.0.0.1, server: localhost, request: â€œGET /index.php HTTP/1.1â€, upstream: â€œfastcgi://127.0.0.1:9000â€, host: â€œ127.0.0.1:9091â€</p></blockquote><p>è¿™é‡Œçš„é—®é¢˜æ˜¯nginxé…ç½®é‡Œåˆ°fpmçš„ä»£ç†é…ç½®æœ‰é—®é¢˜ï¼š</p><blockquote><p>fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</p></blockquote><p>å°†æ­¤å¤„ä¿®æ”¹ä¸º</p><blockquote><p>fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</p></blockquote><p><strong>è¯´æ˜ï¼š</strong></p><blockquote><p>$document_root ä»£è¡¨å½“å‰è¯·æ±‚åœ¨rootæŒ‡ä»¤ä¸­æŒ‡å®šçš„å€¼ï¼Œä¸Šé¢é…ç½®ä¸­çš„$document_rootå°±æ˜¯é’ˆå¯¹/data0/www/htdocs/lnmp.comç›®å½•ä¸‹çš„phpæ–‡ä»¶è¿›è¡Œè§£æ</p></blockquote><h3 id="6-2-å…¶ä»–é—®é¢˜"><a href="#6-2-å…¶ä»–é—®é¢˜" class="headerlink" title="6.2 å…¶ä»–é—®é¢˜"></a>6.2 å…¶ä»–é—®é¢˜</h3><p>åœ¨å®‰è£…è¿‡ç¨‹ä¸­è‹¥é‡åˆ°å…¶ä»–é—®é¢˜ï¼Œå‡å¯ä»¥æ ¹æ®é”™è¯¯æç¤ºä¿¡æ¯æ‰¾åˆ°ç­”æ¡ˆï¼Œgoogleã€ç™¾åº¦éƒ½å¯ä»¥å¸®åŠ©ä½ è§£å†³é—®é¢˜ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;â€‹    ä½œä¸ºä¸€ä¸ªPHPerï¼Œæ²¡æœ‰æ‰‹åŠ¨æ­è¿‡å‡ æ¬¡LNMPç¯å¢ƒï¼Œéƒ½ä¸ç®—æ˜¯ä¸€ä¸ªçœŸæ­£çš„PHPerã€‚æ­¤æ–‡ä¸»è¦ä»¥å®é™…ç€æ‰‹æ­å»ºä¸€å¥—lnmpç¯å¢ƒä¸ºä¸»çº¿ï¼Œä»‹ç»å…¶ä¸­æ¶‰åŠåˆ°çš„æŠ€æœ¯ç‚¹ã€‚åŒ…æ‹¬phpé…ç½®ã€php-fpmé…ç½®ã€nginxé…ç½®ã€mysqlé…ç½®ã€‚ä»¥åŠè¿™ä»–ä»¬ä¹‹é—´çš„å…³ç³»ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="LNMP/env/01" scheme="http://xwxz.github.io/categories/LNMP-env-01/"/>
    
      <category term="lnmp/envrionment" scheme="http://xwxz.github.io/categories/LNMP-env-01/lnmp-envrionment/"/>
    
    
      <category term="PHP" scheme="http://xwxz.github.io/tags/PHP/"/>
    
      <category term="Nginx" scheme="http://xwxz.github.io/tags/Nginx/"/>
    
      <category term="Linux" scheme="http://xwxz.github.io/tags/Linux/"/>
    
      <category term="MySQL" scheme="http://xwxz.github.io/tags/MySQL/"/>
    
      <category term="LNMP" scheme="http://xwxz.github.io/tags/LNMP/"/>
    
  </entry>
  
</feed>
